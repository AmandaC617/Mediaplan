<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªå‹•åŒ–åª’é«”ææ¡ˆå¼•æ“ (å°ç£å¸‚å ´ç‰¹åŒ–ç‰ˆ MVP)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%);
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #818cf8 100%);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(0,0,0,0.1);
        }
        .btn-primary:disabled {
            background: #a5b4fc;
            cursor: not-allowed;
            transform: translateY(0);
            box-shadow: none;
        }
        #proposalOutput h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e3a8a;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #60a5fa;
            padding-bottom: 0.5rem;
        }
        #proposalOutput h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1d4ed8;
            margin-top: 1.25rem;
            margin-bottom: 0.75rem;
        }
        #proposalOutput p, #proposalOutput li, #proposalOutput td, #proposalOutput th {
            color: #374151;
            line-height: 1.7;
        }
        #proposalOutput p, #proposalOutput ul {
             margin-bottom: 1rem;
        }
        #proposalOutput ul {
            list-style-type: disc;
            padding-left: 1.5rem;
        }
        #proposalOutput strong {
            color: #1e40af;
            font-weight: 600;
        }
        .status-update {
            transition: all 0.5s ease;
            overflow: hidden;
            max-height: 0;
            opacity: 0;
        }
        .status-update.active {
            max-height: 100px; /* or a suitable max-height */
            opacity: 1;
            margin-top: 1rem;
        }
        .input-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 1.5rem;
        }
        @media (min-width: 1024px) {
            .input-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        #proposalOutput table {
            width: 100%;
            margin-top: 1rem;
            margin-bottom: 1rem;
            border-collapse: collapse;
        }
        #proposalOutput th, #proposalOutput td {
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            text-align: left;
        }
        #proposalOutput th {
            background-color: #f9fafb;
            font-weight: 600;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-6xl mx-auto">
        <div class="card p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">è‡ªå‹•åŒ–åª’é«”ææ¡ˆå¼•æ“</h1>
                <p class="mt-2 text-gray-600">v2.7 é‡é»æ¨™è¨»ç‰ˆ (MVP)</p>
            </div>

            <!-- Module 1: ä½¿ç”¨è€…èˆ‡é…ç½®ä»‹é¢ ('é§•é§›è‰™') -->
            <div class="space-y-6">
                 <!-- API é‡‘é‘°è¼¸å…¥ -->
                <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <label for="apiKeyInput" class="block text-sm font-medium text-yellow-800 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 8a6 6 0 11-12 0 6 6 0 0112 0zM7 8a1 1 0 11-2 0 1 1 0 012 0zm5 0a1 1 0 11-2 0 1 1 0 012 0zm5 0a1 1 0 11-2 0 1 1 0 012 0z" clip-rule="evenodd"></path></svg>
                        Google Gemini API é‡‘é‘° <span class="text-red-500 ml-1">*</span>
                    </label>
                    <input type="password" id="apiKeyInput" class="mt-1 block w-full px-3 py-2 border border-yellow-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ API é‡‘é‘°">
                    <p class="mt-2 text-xs text-yellow-700">æ­¤é‡‘é‘°åƒ…å­˜æ–¼æ‚¨ç›®å‰çš„ç€è¦½å™¨åˆ†é ï¼Œé—œé–‰å¾Œå³æ¶ˆå¤±ï¼Œä¸æœƒè¢«å„²å­˜ã€‚</p>
                </div>

                <!-- AI æ¨¡å‹é¸æ“‡ -->
                <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                    <label for="modelSelection" class="block text-sm font-medium text-green-800 flex items-center mb-2">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
                        AI æ¨¡å‹é¸æ“‡
                    </label>
                    <div class="space-y-3">
                        <div class="flex items-center">
                            <input type="radio" id="modelAuto" name="modelSelection" value="auto" class="mr-2" checked>
                            <label for="modelAuto" class="text-sm text-green-700">
                                <span class="font-medium">è‡ªå‹•é¸æ“‡</span> - ç³»çµ±è‡ªå‹•é¸æ“‡æœ€ä½³æ¨¡å‹ï¼ˆæ¨è–¦ï¼‰
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="modelPro" name="modelSelection" value="pro" class="mr-2">
                            <label for="modelPro" class="text-sm text-green-700">
                                <span class="font-medium">Gemini 1.5 Pro</span> - æ·±åº¦åˆ†ææ¨¡å‹ï¼Œé©åˆè¤‡é›œç­–ç•¥è¦åŠƒ
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="modelFlash" name="modelSelection" value="flash" class="mr-2">
                            <label for="modelFlash" class="text-sm text-green-700">
                                <span class="font-medium">Gemini 1.5 Flash</span> - å¿«é€Ÿå›æ‡‰ï¼Œé©åˆä¸€èˆ¬åˆ†æ
                            </label>
                        </div>
                    </div>
                    <p class="mt-2 text-xs text-green-600">
                        <strong>Pro æ¨¡å‹ç‰¹è‰²ï¼š</strong>æ”¯æ´æ›´é•·çš„ä¸Šä¸‹æ–‡ã€æ›´æ·±å…¥çš„æ¨ç†èƒ½åŠ›ã€æ›´å¥½çš„å¤šèªè¨€ç†è§£
                    </p>
                </div>

                <!-- ç³»çµ±ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
                <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <!-- ç¶²è·¯ç‹€æ…‹ -->
                            <div class="flex items-center">
                                <div id="networkStatus" class="w-3 h-3 rounded-full bg-green-500 mr-2"></div>
                                <span id="networkText" class="text-sm text-blue-800">ç¶²è·¯é€£æ¥æ­£å¸¸</span>
                            </div>
                            <!-- API ç‹€æ…‹ -->
                            <div class="flex items-center">
                                <div id="apiStatus" class="w-3 h-3 rounded-full bg-gray-400 mr-2"></div>
                                <span id="apiText" class="text-sm text-blue-800">API æœªæ¸¬è©¦</span>
                            </div>
                            <!-- ç•¶å‰æ¨¡å‹ -->
                            <div class="flex items-center">
                                <div id="modelStatus" class="w-3 h-3 rounded-full bg-purple-500 mr-2"></div>
                                <span id="modelText" class="text-sm text-blue-800">æ¨¡å‹æœªé¸æ“‡</span>
                            </div>
                        </div>
                        <!-- ç³»çµ±ç‰ˆæœ¬ -->
                        <div class="text-xs text-blue-600">
                            ç³»çµ±ç‰ˆæœ¬: v2.7 | æœ€å¾Œæ›´æ–°: 2024-12-19
                        </div>
                    </div>
                </div>
                
                <div class="border-t border-gray-200 pt-6">
                    <div class="input-grid">
                        <div>
                            <label for="targetBrand" class="block text-sm font-medium text-gray-700">ç›®æ¨™å“ç‰Œ / ç”¢å“ <span class="text-red-500">*</span></label>
                            <input type="text" id="targetBrand" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="ä¾‹å¦‚ï¼šgogoro, æ˜Ÿå®‡èˆªç©º">
                        </div>
                        <div>
                            <label for="competitorBrand" class="block text-sm font-medium text-gray-700">ä¸»è¦ç«¶çˆ­å°æ‰‹ <span class="text-red-500">*</span></label>
                            <input type="text" id="competitorBrand" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="ä¾‹å¦‚ï¼šå…‰é™½, é•·æ¦®èˆªç©º">
                        </div>
                         <div>
                            <label for="industry" class="block text-sm font-medium text-gray-700 mb-2">ç”¢æ¥­é¡åˆ¥ <span class="text-red-500">*</span></label>
                            <select id="industry" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">è«‹é¸æ“‡ç”¢æ¥­é¡åˆ¥</option>
                                <optgroup label="ç§‘æŠ€ç”¢æ¥­">
                                    <option value="è»Ÿé«”é–‹ç™¼">è»Ÿé«”é–‹ç™¼</option>
                                    <option value="é›»å­å•†å‹™">é›»å­å•†å‹™</option>
                                    <option value="äººå·¥æ™ºæ…§">äººå·¥æ™ºæ…§</option>
                                    <option value="ç‰©è¯ç¶²">ç‰©è¯ç¶²</option>
                                    <option value="å€å¡Šéˆ">å€å¡Šéˆ</option>
                                    <option value="é›²ç«¯æœå‹™">é›²ç«¯æœå‹™</option>
                                    <option value="æ•¸ä½è¡ŒéŠ·">æ•¸ä½è¡ŒéŠ·</option>
                                    <option value="éŠæˆ²ç”¢æ¥­">éŠæˆ²ç”¢æ¥­</option>
                                    <option value="ç¡¬é«”è£½é€ ">ç¡¬é«”è£½é€ </option>
                                    <option value="ç¶²è·¯æœå‹™">ç¶²è·¯æœå‹™</option>
                                </optgroup>
                                <optgroup label="æ¶ˆè²»å“ç”¢æ¥­">
                                    <option value="ç¾å¦ä¿é¤Š">ç¾å¦ä¿é¤Š</option>
                                    <option value="æœé£¾æ™‚å°š">æœé£¾æ™‚å°š</option>
                                    <option value="é£Ÿå“é£²æ–™">é£Ÿå“é£²æ–™</option>
                                    <option value="å®¶å±…ç”¨å“">å®¶å±…ç”¨å“</option>
                                    <option value="é‹å‹•ç”¨å“">é‹å‹•ç”¨å“</option>
                                    <option value="æ¯å¬°ç”¨å“">æ¯å¬°ç”¨å“</option>
                                    <option value="å¯µç‰©ç”¨å“">å¯µç‰©ç”¨å“</option>
                                    <option value="å€‹äººè­·ç†">å€‹äººè­·ç†</option>
                                </optgroup>
                                <optgroup label="é‡‘èæœå‹™">
                                    <option value="éŠ€è¡Œæ¥­">éŠ€è¡Œæ¥­</option>
                                    <option value="ä¿éšªæ¥­">ä¿éšªæ¥­</option>
                                    <option value="æŠ•è³‡ç†è²¡">æŠ•è³‡ç†è²¡</option>
                                    <option value="æ”¯ä»˜æœå‹™">æ”¯ä»˜æœå‹™</option>
                                    <option value="FinTech">FinTech</option>
                                    <option value="æˆ¿åœ°ç”¢">æˆ¿åœ°ç”¢</option>
                                </optgroup>
                                <optgroup label="æ•™è‚²èˆ‡åŸ¹è¨“">
                                    <option value="ç·šä¸Šæ•™è‚²">ç·šä¸Šæ•™è‚²</option>
                                    <option value="èªè¨€å­¸ç¿’">èªè¨€å­¸ç¿’</option>
                                    <option value="è·æ¥­åŸ¹è¨“">è·æ¥­åŸ¹è¨“</option>
                                    <option value="å…’ç«¥æ•™è‚²">å…’ç«¥æ•™è‚²</option>
                                    <option value="é«˜ç­‰æ•™è‚²">é«˜ç­‰æ•™è‚²</option>
                                    <option value="æŠ€èƒ½åŸ¹è¨“">æŠ€èƒ½åŸ¹è¨“</option>
                                </optgroup>
                                <optgroup label="å¥åº·é†«ç™‚">
                                    <option value="é†«ç™‚æœå‹™">é†«ç™‚æœå‹™</option>
                                    <option value="å¥åº·ç®¡ç†">å¥åº·ç®¡ç†</option>
                                    <option value="å¥èº«é‹å‹•">å¥èº«é‹å‹•</option>
                                    <option value="ç‡Ÿé¤Šä¿å¥">ç‡Ÿé¤Šä¿å¥</option>
                                    <option value="å¿ƒç†å¥åº·">å¿ƒç†å¥åº·</option>
                                    <option value="é†«ç¾æ•´å½¢">é†«ç¾æ•´å½¢</option>
                                </optgroup>
                                <optgroup label="äº¤é€šé‹è¼¸">
                                    <option value="å…±äº«äº¤é€š">å…±äº«äº¤é€š</option>
                                    <option value="ç‰©æµé…é€">ç‰©æµé…é€</option>
                                    <option value="æ—…éŠæœå‹™">æ—…éŠæœå‹™</option>
                                    <option value="èˆªç©ºé‹è¼¸">èˆªç©ºé‹è¼¸</option>
                                    <option value="æ±½è»Šç”¢æ¥­">æ±½è»Šç”¢æ¥­</option>
                                    <option value="å¤§çœ¾é‹è¼¸">å¤§çœ¾é‹è¼¸</option>
                                </optgroup>
                                <optgroup label="å¨›æ¨‚åª’é«”">
                                    <option value="å½±è¦–è£½ä½œ">å½±è¦–è£½ä½œ</option>
                                    <option value="éŸ³æ¨‚ç”¢æ¥­">éŸ³æ¨‚ç”¢æ¥­</option>
                                    <option value="å‡ºç‰ˆæ¥­">å‡ºç‰ˆæ¥­</option>
                                    <option value="ç›´æ’­å¹³å°">ç›´æ’­å¹³å°</option>
                                    <option value="çŸ­å½±ç‰‡">çŸ­å½±ç‰‡</option>
                                    <option value="Podcast">Podcast</option>
                                </optgroup>
                                <optgroup label="å…¶ä»–ç”¢æ¥­">
                                    <option value="æ”¿åºœæ©Ÿé—œ">æ”¿åºœæ©Ÿé—œ</option>
                                    <option value="éç‡Ÿåˆ©çµ„ç¹”">éç‡Ÿåˆ©çµ„ç¹”</option>
                                    <option value="è£½é€ æ¥­">è£½é€ æ¥­</option>
                                    <option value="èƒ½æºç”¢æ¥­">èƒ½æºç”¢æ¥­</option>
                                    <option value="ç’°ä¿ç”¢æ¥­">ç’°ä¿ç”¢æ¥­</option>
                                    <option value="è¾²æ¥­ç§‘æŠ€">è¾²æ¥­ç§‘æŠ€</option>
                                </optgroup>
                            </select>
                        </div>
                        <div>
                            <label for="industryStatus" class="block text-sm font-medium text-gray-700 mb-2">ç”¢æ¥­ç‹€æ…‹ <span class="text-red-500">*</span></label>
                            <select id="industryStatus" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">è«‹é¸æ“‡ç”¢æ¥­ç‹€æ…‹</option>
                                <option value="æ–°å‰µæœŸ">æ–°å‰µæœŸ - å¸‚å ´å‰›èµ·æ­¥ï¼Œç«¶çˆ­è¼ƒå°‘</option>
                                <option value="æˆé•·æœŸ">æˆé•·æœŸ - å¸‚å ´å¿«é€Ÿæ“´å¼µï¼Œç«¶çˆ­åŠ åŠ‡</option>
                                <option value="æˆç†ŸæœŸ">æˆç†ŸæœŸ - å¸‚å ´ç©©å®šï¼Œç«¶çˆ­æ¿€çƒˆ</option>
                                <option value="è¡°é€€æœŸ">è¡°é€€æœŸ - å¸‚å ´èç¸®ï¼Œéœ€è¦è½‰å‹</option>
                                <option value="è½‰å‹æœŸ">è½‰å‹æœŸ - ç”¢æ¥­çµæ§‹èª¿æ•´ï¼Œæ–°æ©Ÿæœƒå‡ºç¾</option>
                                <option value="å¾©ç”¦æœŸ">å¾©ç”¦æœŸ - å¸‚å ´é‡æ–°æ´»çµ¡</option>
                                <option value="å‰µæ–°æœŸ">å‰µæ–°æœŸ - æŠ€è¡“çªç ´å¸¶ä¾†æ–°æ©Ÿæœƒ</option>
                                <option value="æ•´åˆæœŸ">æ•´åˆæœŸ - ç”¢æ¥­ä½µè³¼æ•´åˆéšæ®µ</option>
                            </select>
                        </div>
                         <div>
                            <label for="businessModel" class="block text-sm font-medium text-gray-700">å•†æ¥­æ¨¡å¼ <span class="text-red-500">*</span></label>
                             <select id="businessModel" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="B2C">B2C (ä¼æ¥­å°æ¶ˆè²»è€…)</option>
                                <option value="B2B">B2B (ä¼æ¥­å°ä¼æ¥­)</option>
                            </select>
                        </div>
                         <div>
                            <label for="salesChannels" class="block text-sm font-medium text-gray-700">ä¸»è¦éŠ·å”®é€šè·¯</label>
                            <input type="text" id="salesChannels" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="ä¾‹å¦‚ï¼šç·šä¸Šå®˜ç¶²ã€MOMOã€å¯¦é«”é–€å¸‚">
                        </div>
                        <div>
                            <label for="targetAudience" class="block text-sm font-medium text-gray-700">ç›®æ¨™äººç¾¤æè¿°</label>
                            <input type="text" id="targetAudience" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="ä¾‹å¦‚ï¼š25-35æ­²éƒ½æœƒå¥³æ€§ã€ç§‘æŠ€æ¥­æ¡è³¼ä¸»ç®¡">
                        </div>
                        <div class="md:col-span-2">
                            <label for="marketingProblems" class="block text-sm font-medium text-gray-700">å“ç‰Œè¡ŒéŠ·å•é¡Œæè¿° <span class="text-blue-500">ğŸ’¡</span></label>
                            <textarea id="marketingProblems" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="è«‹æè¿°æ‚¨ç›®å‰é‡åˆ°çš„è¡ŒéŠ·å•é¡Œæˆ–æŒ‘æˆ°ï¼Œä¾‹å¦‚ï¼š&#10;â€¢ å“ç‰ŒçŸ¥ååº¦ä¸è¶³ï¼Œæ¶ˆè²»è€…å°æˆ‘å€‘ä¸ç†Ÿæ‚‰&#10;â€¢ ç«¶çˆ­å°æ‰‹å»£å‘ŠæŠ•æ”¾é‡å¤§ï¼Œæˆ‘å€‘é›£ä»¥çªåœ&#10;â€¢ ç›®æ¨™äººç¾¤å°æˆ‘å€‘çš„ç”¢å“åƒ¹å€¼èªçŸ¥ä¸æ¸…&#10;â€¢ è½‰æ›ç‡åä½ï¼Œå»£å‘Šé»æ“Šå¤šä½†è³¼è²·å°‘&#10;â€¢ é ç®—æœ‰é™ï¼Œä¸çŸ¥é“å¦‚ä½•æœ€å¤§åŒ–æ•ˆç›Š"></textarea>
                            <p class="mt-1 text-xs text-gray-500">è©³ç´°æè¿°å•é¡Œå°‡å¹«åŠ© AI æä¾›æ›´ç²¾æº–çš„ç­–ç•¥å»ºè­°</p>
                        </div>
                         <div class="md:col-span-3">
                            <label for="advertisingBudget" class="block text-sm font-medium text-gray-700">é è¨ˆå»£å‘Šé ç®— (å°å¹£)</label>
                            <input type="number" id="advertisingBudget" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="ä¾‹å¦‚ï¼š300000">
                        </div>
                        <div>
                            <label for="adObjective" class="block text-sm font-medium text-gray-700">å»£å‘Šç›®æ¨™èˆ‡ç›®çš„ <span class="text-red-500">*</span></label>
                            <select id="adObjective" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="å“ç‰ŒçŸ¥ååº¦">å“ç‰ŒçŸ¥ååº¦</option>
                                <option value="éŠ·å”®æå‡">éŠ·å”®æå‡</option>
                                <option value="æœƒå“¡æ‹›å‹Ÿ">æœƒå“¡æ‹›å‹Ÿ</option>
                                <option value="æ´»å‹•æ¨å»£">æ´»å‹•æ¨å»£</option>
                                <option value="APPä¸‹è¼‰">APPä¸‹è¼‰</option>
                                <option value="å…¶ä»–">å…¶ä»–</option>
                            </select>
                        </div>
                        <div>
                            <label for="adFormat" class="block text-sm font-medium text-gray-700 mb-2">å»£å‘Šå½¢å¼</label>
                            <div class="space-y-3">
                                <div class="flex items-center">
                                    <input type="checkbox" id="aiRecommendMedia" class="mr-2">
                                    <label for="aiRecommendMedia" class="text-sm text-gray-700">è«‹ AI å»ºè­°æœ€é©åˆçš„åª’é«”çµ„åˆ</label>
                                </div>
                                <div id="mediaSelection" class="space-y-2">
                                    <div class="grid grid-cols-2 gap-3">
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="æ•¸ä½å»£å‘Š" class="mr-2">
                                            <span class="text-sm">æ•¸ä½å»£å‘Š</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="ç¤¾ç¾¤åª’é«”å»£å‘Š" class="mr-2">
                                            <span class="text-sm">ç¤¾ç¾¤åª’é«”å»£å‘Š</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="æœå°‹å¼•æ“å»£å‘Š" class="mr-2">
                                            <span class="text-sm">æœå°‹å¼•æ“å»£å‘Š</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="å½±éŸ³å»£å‘Š" class="mr-2">
                                            <span class="text-sm">å½±éŸ³å»£å‘Š</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="å±•ç¤ºå»£å‘Š" class="mr-2">
                                            <span class="text-sm">å±•ç¤ºå»£å‘Š</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="åŸç”Ÿå»£å‘Š" class="mr-2">
                                            <span class="text-sm">åŸç”Ÿå»£å‘Š</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="å½±éŸ¿è€…è¡ŒéŠ·" class="mr-2">
                                            <span class="text-sm">å½±éŸ¿è€…è¡ŒéŠ·</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="å…§å®¹è¡ŒéŠ·" class="mr-2">
                                            <span class="text-sm">å…§å®¹è¡ŒéŠ·</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="æ•´åˆè¡ŒéŠ·" class="mr-2">
                                            <span class="text-sm">æ•´åˆè¡ŒéŠ·</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="æˆ¶å¤–å»£å‘Š" class="mr-2">
                                            <span class="text-sm">æˆ¶å¤–å»£å‘Š</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="é›»è¦–å»£å‘Š" class="mr-2">
                                            <span class="text-sm">é›»è¦–å»£å‘Š</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="å»£æ’­å»£å‘Š" class="mr-2">
                                            <span class="text-sm">å»£æ’­å»£å‘Š</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="é›œèªŒå»£å‘Š" class="mr-2">
                                            <span class="text-sm">é›œèªŒå»£å‘Š</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="å ±ç´™å»£å‘Š" class="mr-2">
                                            <span class="text-sm">å ±ç´™å»£å‘Š</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="æ´»å‹•è¡ŒéŠ·" class="mr-2">
                                            <span class="text-sm">æ´»å‹•è¡ŒéŠ·</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="competitors" class="block text-sm font-medium text-gray-700 mb-2">ä¸»è¦ç«¶çˆ­å°æ‰‹</label>
                    <textarea id="competitors" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è«‹åˆ—å‡ºä¸»è¦ç«¶çˆ­å°æ‰‹çš„å“ç‰Œåç¨±èˆ‡ç”¢å“åç¨±ï¼Œä¾‹å¦‚ï¼š&#10;Apple iPhone 15&#10;Samsung Galaxy S24&#10;Google Pixel 8"></textarea>
                </div>

                <!-- é‡é»æ¨™è¨»å€å¡Š -->
                <div class="border-t border-gray-200 pt-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        é‡é»æ¨™è¨»èˆ‡æ™‚é–“è¦åŠƒ
                    </h3>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- è¡ŒéŠ·æ™‚é–“æ®µ -->
                        <div class="space-y-4">
                            <div>
                                <label for="marketingTimeline" class="block text-sm font-medium text-gray-700 mb-2">è¡ŒéŠ·æ™‚é–“æ®µè¦åŠƒ <span class="text-blue-500">ğŸ“…</span></label>
                                <div class="space-y-3">
                                    <div class="flex items-center space-x-4">
                                        <div class="flex-1">
                                            <label class="block text-xs text-gray-600 mb-1">é–‹å§‹æ—¥æœŸ</label>
                                            <input type="date" id="campaignStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        </div>
                                        <div class="flex-1">
                                            <label class="block text-xs text-gray-600 mb-1">çµæŸæ—¥æœŸ</label>
                                            <input type="date" id="campaignEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        </div>
                                    </div>
                                    <div>
                                        <label for="campaignDuration" class="block text-xs text-gray-600 mb-1">æ´»å‹•æŒçºŒæ™‚é–“</label>
                                        <select id="campaignDuration" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="">è«‹é¸æ“‡æ´»å‹•æŒçºŒæ™‚é–“</option>
                                            <option value="çŸ­æœŸ(1-2é€±)">çŸ­æœŸ(1-2é€±)</option>
                                            <option value="ä¸­æœŸ(1-3å€‹æœˆ)">ä¸­æœŸ(1-3å€‹æœˆ)</option>
                                            <option value="é•·æœŸ(3-6å€‹æœˆ)">é•·æœŸ(3-6å€‹æœˆ)</option>
                                            <option value="å¹´åº¦è¨ˆç•«(6-12å€‹æœˆ)">å¹´åº¦è¨ˆç•«(6-12å€‹æœˆ)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="keyMilestones" class="block text-xs text-gray-600 mb-1">é‡è¦é‡Œç¨‹ç¢‘</label>
                                        <textarea id="keyMilestones" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è«‹åˆ—å‡ºé‡è¦çš„è¡ŒéŠ·é‡Œç¨‹ç¢‘ï¼Œä¾‹å¦‚ï¼š&#10;â€¢ ç”¢å“ä¸Šå¸‚æ—¥æœŸ&#10;â€¢ é‡è¦ç¯€æ…¶æ´»å‹•&#10;â€¢ ç«¶å“æ–°å“ç™¼è¡¨æ™‚é–“&#10;â€¢ ç”¢æ¥­å±•è¦½æœƒæœŸ"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ç«¶çˆ­å°æ‰‹åˆ†ææ¯”è¼ƒ -->
                        <div class="space-y-4">
                            <div>
                                <label for="competitorAnalysis" class="block text-sm font-medium text-gray-700 mb-2">ç«¶çˆ­å°æ‰‹åˆ†ææ¯”è¼ƒ <span class="text-red-500">âš”ï¸</span></label>
                                <div class="space-y-3">
                                    <div>
                                        <label for="competitorTimeline" class="block text-xs text-gray-600 mb-1">ç«¶çˆ­å°æ‰‹è¿‘æœŸæ´»å‹•æ™‚é–“ç·š</label>
                                        <textarea id="competitorTimeline" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è«‹æè¿°ç«¶çˆ­å°æ‰‹è¿‘æœŸçš„è¡ŒéŠ·æ´»å‹•ï¼Œä¾‹å¦‚ï¼š&#10;â€¢ 2024å¹´3æœˆï¼šAppleç™¼è¡¨iPhone 15ç³»åˆ—&#10;â€¢ 2024å¹´4æœˆï¼šSamsungæ¨å‡ºGalaxy S24å»£å‘Š&#10;â€¢ 2024å¹´5æœˆï¼šGoogle Pixel 8ä¿ƒéŠ·æ´»å‹•"></textarea>
                                    </div>
                                    <div>
                                        <label for="competitiveAdvantage" class="block text-xs text-gray-600 mb-1">æˆ‘å€‘çš„ç«¶çˆ­å„ªå‹¢</label>
                                        <textarea id="competitiveAdvantage" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è«‹æè¿°ç›¸å°æ–¼ç«¶çˆ­å°æ‰‹çš„å„ªå‹¢ï¼Œä¾‹å¦‚ï¼š&#10;â€¢ åƒ¹æ ¼å„ªå‹¢ï¼šæ¯”ç«¶å“ä¾¿å®œ20%&#10;â€¢ æŠ€è¡“å„ªå‹¢ï¼šç¨å®¶å°ˆåˆ©æŠ€è¡“&#10;â€¢ æœå‹™å„ªå‹¢ï¼š24å°æ™‚å®¢æœæ”¯æ´&#10;â€¢ å“ç‰Œå„ªå‹¢ï¼šåœ¨åœ°åŒ–å“ç‰Œå½¢è±¡"></textarea>
                                    </div>
                                    <div>
                                        <label for="competitiveGaps" class="block text-xs text-gray-600 mb-1">éœ€è¦å½Œè£œçš„å·®è·</label>
                                        <textarea id="competitiveGaps" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è«‹æè¿°éœ€è¦å½Œè£œçš„ç«¶çˆ­å·®è·ï¼Œä¾‹å¦‚ï¼š&#10;â€¢ å“ç‰ŒçŸ¥ååº¦ä¸å¦‚ç«¶å“&#10;â€¢ é€šè·¯è¦†è“‹ç‡è¼ƒä½&#10;â€¢ ç”¢å“åŠŸèƒ½éœ€è¦å¼·åŒ–&#10;â€¢ å®¢æˆ¶æœå‹™éœ€è¦æ”¹å–„"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å¸‚å ´æ™‚æ©Ÿèˆ‡æ©Ÿæœƒé» -->
                    <div class="mt-6">
                        <label for="marketOpportunities" class="block text-sm font-medium text-gray-700 mb-2">å¸‚å ´æ™‚æ©Ÿèˆ‡æ©Ÿæœƒé» <span class="text-green-500">ğŸ¯</span></label>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <div>
                                <label for="seasonalFactors" class="block text-xs text-gray-600 mb-1">å­£ç¯€æ€§å› ç´ </label>
                                <select id="seasonalFactors" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">è«‹é¸æ“‡å­£ç¯€æ€§å› ç´ </option>
                                    <option value="æ˜¥ç¯€æœŸé–“">æ˜¥ç¯€æœŸé–“</option>
                                    <option value="æš‘å‡æ—ºå­£">æš‘å‡æ—ºå­£</option>
                                    <option value="é–‹å­¸å­£">é–‹å­¸å­£</option>
                                    <option value="è–èª•ç¯€">è–èª•ç¯€</option>
                                    <option value="é›™11è³¼ç‰©ç¯€">é›™11è³¼ç‰©ç¯€</option>
                                    <option value="å¹´çµ‚ä¿ƒéŠ·">å¹´çµ‚ä¿ƒéŠ·</option>
                                    <option value="ç„¡æ˜é¡¯å­£ç¯€æ€§">ç„¡æ˜é¡¯å­£ç¯€æ€§</option>
                                    <option value="å…¶ä»–">å…¶ä»–</option>
                                </select>
                            </div>
                            <div>
                                <label for="marketTrends" class="block text-xs text-gray-600 mb-1">å¸‚å ´è¶¨å‹¢</label>
                                <textarea id="marketTrends" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è«‹æè¿°ç•¶å‰å¸‚å ´è¶¨å‹¢ï¼Œä¾‹å¦‚ï¼š&#10;â€¢ æ¶ˆè²»è€…åå¥½ç’°ä¿ç”¢å“&#10;â€¢ ç·šä¸Šè³¼ç‰©éœ€æ±‚å¢åŠ &#10;â€¢ å¥åº·æ„è­˜æå‡"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- é‡é»æ¨™è¨»è¨­å®š -->
                    <div class="mt-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">é‡é»æ¨™è¨»è¨­å®š <span class="text-purple-500">ğŸ“Œ</span></label>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                            <div class="flex items-center space-x-3 p-3 border rounded-lg">
                                <input type="checkbox" id="highlightTimeline" class="w-4 h-4 text-blue-600">
                                <label for="highlightTimeline" class="text-sm text-gray-700">ç”Ÿæˆæ™‚é–“ç·šè¦–è¦ºåŒ–</label>
                            </div>
                            <div class="flex items-center space-x-3 p-3 border rounded-lg">
                                <input type="checkbox" id="highlightCompetitors" class="w-4 h-4 text-blue-600">
                                <label for="highlightCompetitors" class="text-sm text-gray-700">ç«¶çˆ­å°æ‰‹æ¯”è¼ƒåˆ†æ</label>
                            </div>
                            <div class="flex items-center space-x-3 p-3 border rounded-lg">
                                <input type="checkbox" id="highlightOpportunities" class="w-4 h-4 text-blue-600">
                                <label for="highlightOpportunities" class="text-sm text-gray-700">å¸‚å ´æ©Ÿæœƒé»åˆ†æ</label>
                            </div>
                            <div class="flex items-center space-x-3 p-3 border rounded-lg">
                                <input type="checkbox" id="highlightMilestones" class="w-4 h-4 text-blue-600">
                                <label for="highlightMilestones" class="text-sm text-gray-700">é‡è¦é‡Œç¨‹ç¢‘æé†’</label>
                            </div>
                            <div class="flex items-center space-x-3 p-3 border rounded-lg">
                                <input type="checkbox" id="highlightRisks" class="w-4 h-4 text-blue-600">
                                <label for="highlightRisks" class="text-sm text-gray-700">é¢¨éšªè©•ä¼°èˆ‡å»ºè­°</label>
                            </div>
                            <div class="flex items-center space-x-3 p-3 border rounded-lg">
                                <input type="checkbox" id="highlightKPIs" class="w-4 h-4 text-blue-600">
                                <label for="highlightKPIs" class="text-sm text-gray-700">é—œéµç¸¾æ•ˆæŒ‡æ¨™</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="targetMarkets" class="block text-sm font-medium text-gray-700 mb-2">ç›®æ¨™å¸‚å ´</label>
                    <select id="targetMarkets" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="å°ç£">å°ç£</option>
                        <option value="å°ç£,é¦™æ¸¯">å°ç£ + é¦™æ¸¯</option>
                        <option value="å°ç£,æ–°åŠ å¡">å°ç£ + æ–°åŠ å¡</option>
                        <option value="å°ç£,é¦¬ä¾†è¥¿äº">å°ç£ + é¦¬ä¾†è¥¿äº</option>
                        <option value="å°ç£,æ³°åœ‹">å°ç£ + æ³°åœ‹</option>
                        <option value="å°ç£,è¶Šå—">å°ç£ + è¶Šå—</option>
                        <option value="å°ç£,è²å¾‹è³“">å°ç£ + è²å¾‹è³“</option>
                        <option value="å°ç£,å°å°¼">å°ç£ + å°å°¼</option>
                        <option value="å°ç£,æ—¥æœ¬">å°ç£ + æ—¥æœ¬</option>
                        <option value="å°ç£,éŸ“åœ‹">å°ç£ + éŸ“åœ‹</option>
                        <option value="å°ç£,ä¸­åœ‹">å°ç£ + ä¸­åœ‹</option>
                        <option value="å°ç£,ç¾åœ‹">å°ç£ + ç¾åœ‹</option>
                        <option value="å°ç£,åŠ æ‹¿å¤§">å°ç£ + åŠ æ‹¿å¤§</option>
                        <option value="å°ç£,æ¾³æ´²">å°ç£ + æ¾³æ´²</option>
                        <option value="å°ç£,è‹±åœ‹">å°ç£ + è‹±åœ‹</option>
                        <option value="å°ç£,å¾·åœ‹">å°ç£ + å¾·åœ‹</option>
                        <option value="å°ç£,æ³•åœ‹">å°ç£ + æ³•åœ‹</option>
                        <option value="å…¨çƒ">å…¨çƒç­–ç•¥</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label for="targetLanguages" class="block text-sm font-medium text-gray-700 mb-2">ç›®æ¨™èªè¨€</label>
                    <select id="targetLanguages" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="ç¹é«”ä¸­æ–‡">ç¹é«”ä¸­æ–‡</option>
                        <option value="ç¹é«”ä¸­æ–‡,ç°¡é«”ä¸­æ–‡">ç¹é«”ä¸­æ–‡ + ç°¡é«”ä¸­æ–‡</option>
                        <option value="ç¹é«”ä¸­æ–‡,è‹±æ–‡">ç¹é«”ä¸­æ–‡ + è‹±æ–‡</option>
                        <option value="ç¹é«”ä¸­æ–‡,æ—¥æ–‡">ç¹é«”ä¸­æ–‡ + æ—¥æ–‡</option>
                        <option value="ç¹é«”ä¸­æ–‡,éŸ“æ–‡">ç¹é«”ä¸­æ–‡ + éŸ“æ–‡</option>
                        <option value="ç¹é«”ä¸­æ–‡,æ³°æ–‡">ç¹é«”ä¸­æ–‡ + æ³°æ–‡</option>
                        <option value="ç¹é«”ä¸­æ–‡,è¶Šå—æ–‡">ç¹é«”ä¸­æ–‡ + è¶Šå—æ–‡</option>
                        <option value="ç¹é«”ä¸­æ–‡,å°å°¼æ–‡">ç¹é«”ä¸­æ–‡ + å°å°¼æ–‡</option>
                        <option value="ç¹é«”ä¸­æ–‡,é¦¬ä¾†æ–‡">ç¹é«”ä¸­æ–‡ + é¦¬ä¾†æ–‡</option>
                        <option value="ç¹é«”ä¸­æ–‡,è²å¾‹è³“æ–‡">ç¹é«”ä¸­æ–‡ + è²å¾‹è³“æ–‡</option>
                        <option value="ç¹é«”ä¸­æ–‡,å¾·æ–‡">ç¹é«”ä¸­æ–‡ + å¾·æ–‡</option>
                        <option value="ç¹é«”ä¸­æ–‡,æ³•æ–‡">ç¹é«”ä¸­æ–‡ + æ³•æ–‡</option>
                        <option value="ç¹é«”ä¸­æ–‡,è¥¿ç­ç‰™æ–‡">ç¹é«”ä¸­æ–‡ + è¥¿ç­ç‰™æ–‡</option>
                        <option value="å¤šèªè¨€">å¤šèªè¨€ç­–ç•¥</option>
                    </select>
                </div>


                <button id="generateBtn" class="btn-primary px-8 py-3 rounded-lg text-lg font-semibold w-full">
                    ç”Ÿæˆ AI åˆ†æå ±å‘Š
                </button>
            </div>

            <!-- å‹•æ…‹ç‹€æ…‹æ›´æ–°å€åŸŸ -->

            <!-- Module 4: è¼¸å‡ºèˆ‡äº¤ä»˜æ¨¡çµ„ ('æ¸²æŸ“å±¤') -->
            <div id="proposalOutput" class="mt-8 p-6 bg-white rounded-lg shadow-lg">
                <div class="text-center text-gray-500">
                    <svg class="mx-auto h-12 w-12 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <p>AI åˆ†æå ±å‘Šå°‡åœ¨æ­¤è™•é¡¯ç¤º</p>
                </div>
                
                <!-- æ–°å¢ï¼šå ±å‘Šå°å‡ºåŠŸèƒ½ -->
                <div id="exportControls" class="mt-4 flex flex-wrap gap-3 justify-center" style="display: none;">
                    <button id="exportPDF" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V8z" clip-rule="evenodd"></path>
                        </svg>
                        åŒ¯å‡º PDF
                    </button>
                    <button id="exportWord" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                        </svg>
                        åŒ¯å‡º Word
                    </button>
                    <button id="exportPPT" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
                        </svg>
                        åŒ¯å‡ºç°¡å ±
                    </button>
                    <button id="shareReport" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"></path>
                        </svg>
                        åˆ†äº«å ±å‘Š
                    </button>
                </div>
            </div>
            
            <!-- Positioning åœ–è¡¨å€åŸŸ -->
            <div id="positioningChartContainer" class="mt-8 border-t-2 border-gray-200 pt-6" style="display: none;">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">å“ç‰Œå®šä½åˆ†æåœ–è¡¨</h2>
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <canvas id="positioningChart" width="400" height="400"></canvas>
                </div>
            </div>
        </div>
        <footer class="text-center mt-4 text-sm text-gray-500">
            <p>æœ¬åŸå‹ç”± Google Gemini é©…å‹•ï¼Œæ‰€æœ‰åˆ†æçš†ç‚ºå³æ™‚ç”Ÿæˆã€‚</p>
        </footer>
    </div>

    <script type="module">
        // --- Module 1: ä»‹é¢æ§åˆ¶èˆ‡è³‡æ–™æ”¶é›† ('æ§åˆ¶å±¤') ---
        const apiKeyInput = document.getElementById('apiKeyInput');
        const targetBrandInput = document.getElementById('targetBrand');
        const competitorBrandInput = document.getElementById('competitorBrand');
        const industryInput = document.getElementById('industry');
        const industryStatusInput = document.getElementById('industryStatus');
        const businessModelInput = document.getElementById('businessModel');
        const salesChannelsInput = document.getElementById('salesChannels');
        const targetAudienceInput = document.getElementById('targetAudience');
        const advertisingBudgetInput = document.getElementById('advertisingBudget');
        const proposalOutput = document.getElementById('proposalOutput');
        const adObjectiveInput = document.getElementById('adObjective');
        const aiRecommendMediaInput = document.getElementById('aiRecommendMedia');
        const mediaSelectionDiv = document.getElementById('mediaSelection');
        const competitorsInput = document.getElementById('competitors');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const targetMarketsInput = document.getElementById('targetMarkets');
        const targetLanguagesInput = document.getElementById('targetLanguages');
        const generateBtn = document.getElementById('generateBtn');

        // é‡é»æ¨™è¨»ç›¸é—œå…ƒç´ 
        const campaignStartDateInput = document.getElementById('campaignStartDate');
        const campaignEndDateInput = document.getElementById('campaignEndDate');
        const campaignDurationInput = document.getElementById('campaignDuration');
        const keyMilestonesInput = document.getElementById('keyMilestones');
        const competitorTimelineInput = document.getElementById('competitorTimeline');
        const competitiveAdvantageInput = document.getElementById('competitiveAdvantage');
        const competitiveGapsInput = document.getElementById('competitiveGaps');
        const seasonalFactorsInput = document.getElementById('seasonalFactors');
        const marketTrendsInput = document.getElementById('marketTrends');
        const highlightTimelineInput = document.getElementById('highlightTimeline');
        const highlightCompetitorsInput = document.getElementById('highlightCompetitors');
        const highlightOpportunitiesInput = document.getElementById('highlightOpportunities');
        const highlightMilestonesInput = document.getElementById('highlightMilestones');
        const highlightRisksInput = document.getElementById('highlightRisks');
        const highlightKPIsInput = document.getElementById('highlightKPIs');

        // æ–°å¢é€²åº¦è¿½è¹¤è®Šæ•¸
        let currentStep = 0;
        let totalSteps = 10;
        let apiTestResult = null;

        // æ–°å¢é€²åº¦æ¢å…ƒç´ 
        const progressContainer = document.createElement('div');
        progressContainer.id = 'progressContainer';
        progressContainer.className = 'mt-4 p-4 bg-blue-50 rounded-lg hidden';
        progressContainer.innerHTML = `
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-blue-800">AI åˆ†æé€²åº¦</span>
                <span id="progressText" class="text-sm text-blue-600">0 / ${totalSteps}</span>
            </div>
            <div class="w-full bg-blue-200 rounded-full h-2">
                <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <div id="currentStepText" class="mt-2 text-sm text-blue-700"></div>
            <div id="apiStatus" class="mt-2 text-sm"></div>
        `;
        
        // å°‡é€²åº¦å®¹å™¨æ·»åŠ åˆ°ç”ŸæˆæŒ‰éˆ•ä¹‹å¾Œ
        if (generateBtn && generateBtn.parentNode) {
            generateBtn.parentNode.insertBefore(progressContainer, generateBtn.nextSibling);
        }

        // æ¸¬è©¦ API é€£æ¥
        async function testAPI(apiKey) {
            try {
                console.log('é–‹å§‹ API æ¸¬è©¦...');
                
                // å…ˆé©—è­‰ API é‡‘é‘°æ ¼å¼
                if (!apiKey || apiKey.trim() === '') {
                    throw new Error('API é‡‘é‘°ä¸èƒ½ç‚ºç©º');
                }
                
                // æª¢æŸ¥ API é‡‘é‘°æ ¼å¼ï¼ˆGoogle API é‡‘é‘°é€šå¸¸æ˜¯ 39 å€‹å­—ç¬¦ï¼‰
                if (apiKey.length < 30) {
                    throw new Error('API é‡‘é‘°æ ¼å¼å¯èƒ½ä¸æ­£ç¢ºï¼ŒGoogle API é‡‘é‘°é€šå¸¸ç‚º 39 å€‹å­—ç¬¦');
                }
                
                const testPrompt = 'è«‹å›è¦†ã€ŒAPI é€£æ¥æˆåŠŸã€ä¾†ç¢ºèªé€£æ¥æ­£å¸¸ã€‚';
                const response = await callGeminiAPI(testPrompt, apiKey, false);
                console.log('API æ¸¬è©¦å›æ‡‰:', response);
                return response.includes('API é€£æ¥æˆåŠŸ') || response.includes('æˆåŠŸ') || response.includes('é€£æ¥');
            } catch (error) {
                console.error('API æ¸¬è©¦å¤±æ•—:', error);
                
                // æä¾›æ›´è©³ç´°çš„éŒ¯èª¤è¨ºæ–·
                let diagnosticMessage = '';
                if (error.message.includes('API é‡‘é‘°ç„¡æ•ˆ') || error.message.includes('401') || error.message.includes('403')) {
                    diagnosticMessage = `
                        <div class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                            <h4 class="font-semibold text-red-800 mb-2">API é‡‘é‘°å•é¡Œè¨ºæ–·ï¼š</h4>
                            <ul class="text-sm text-red-700 space-y-1">
                                <li>â€¢ è«‹ç¢ºèªæ‚¨å·²å‰å¾€ <a href="https://makersuite.google.com/app/apikey" target="_blank" class="underline">Google AI Studio</a> å‰µå»º API é‡‘é‘°</li>
                                <li>â€¢ ç¢ºèª API é‡‘é‘°å·²å•Ÿç”¨ Gemini API æœå‹™</li>
                                <li>â€¢ æª¢æŸ¥ API é‡‘é‘°æ˜¯å¦å®Œæ•´è¤‡è£½ï¼ˆæ‡‰ç‚º 39 å€‹å­—ç¬¦ï¼‰</li>
                                <li>â€¢ ç¢ºèª API é‡‘é‘°æ²’æœ‰å¤šé¤˜çš„ç©ºæ ¼æˆ–æ›è¡Œç¬¦</li>
                                <li>â€¢ å¦‚æœå‰›å‰µå»ºé‡‘é‘°ï¼Œè«‹ç­‰å¾… 5-10 åˆ†é˜è®“ç³»çµ±ç”Ÿæ•ˆ</li>
                            </ul>
                        </div>
                    `;
                } else if (error.message.includes('ç¶²è·¯é€£æ¥')) {
                    diagnosticMessage = `
                        <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <h4 class="font-semibold text-yellow-800 mb-2">ç¶²è·¯é€£æ¥å•é¡Œï¼š</h4>
                            <ul class="text-sm text-yellow-700 space-y-1">
                                <li>â€¢ æª¢æŸ¥ç¶²è·¯é€£æ¥æ˜¯å¦æ­£å¸¸</li>
                                <li>â€¢ å˜—è©¦é‡æ–°æ•´ç†é é¢</li>
                                <li>â€¢ æª¢æŸ¥é˜²ç«ç‰†æˆ–ä»£ç†è¨­å®š</li>
                            </ul>
                        </div>
                    `;
                }
                
                // æ›´æ–°éŒ¯èª¤è¨Šæ¯é¡¯ç¤º
                const proposalOutput = document.getElementById('proposalOutput');
                if (proposalOutput) {
                    proposalOutput.innerHTML = `
                        <div class="p-6 bg-red-50 border border-red-200 rounded-lg">
                            <h3 class="text-lg font-bold text-red-800 mb-2">API é€£æ¥æ¸¬è©¦å¤±æ•—</h3>
                            <p class="text-red-700 mb-4">éŒ¯èª¤è©³æƒ…ï¼š${error.message}</p>
                            ${diagnosticMessage}
                            <div class="mt-4 p-3 bg-white border border-red-200 rounded">
                                <p class="text-xs text-gray-600">æŠ€è¡“è©³æƒ…ï¼š${error.stack ? error.stack.substring(0, 200) + '...' : 'ç„¡å †ç–Šè¿½è¹¤ä¿¡æ¯'}</p>
                            </div>
                        </div>
                    `;
                }
                
                return false;
            }
        }

        // æ›´æ–°é€²åº¦æ¢
        function updateProgress(step, stepText) {
            currentStep = step;
            const progressPercentage = (currentStep / totalSteps) * 100;
            
            document.getElementById('progressBar').style.width = `${progressPercentage}%`;
            document.getElementById('progressText').textContent = `${currentStep} / ${totalSteps}`;
            document.getElementById('currentStepText').textContent = stepText;
            
            // é¡¯ç¤ºé€²åº¦å®¹å™¨
            document.getElementById('progressContainer').classList.remove('hidden');
        }

        // æ›´æ–°APIç‹€æ…‹
        function updateAPIStatus(status, message) {
            const apiStatusElement = document.getElementById('apiStatus');
            const apiTextElement = document.getElementById('apiText');
            
            if (apiStatusElement && apiTextElement) {
                // æ›´æ–°ç‹€æ…‹æŒ‡ç¤ºå™¨é¡è‰²
                apiStatusElement.className = 'w-3 h-3 rounded-full mr-2';
                if (status === 'success') {
                    apiStatusElement.classList.add('bg-green-500');
                    apiTextElement.textContent = message;
                    apiTextElement.className = 'text-sm text-green-800';
                } else if (status === 'error') {
                    apiStatusElement.classList.add('bg-red-500');
                    apiTextElement.textContent = message;
                    apiTextElement.className = 'text-sm text-red-800';
                } else if (status === 'warning') {
                    apiStatusElement.classList.add('bg-yellow-500');
                    apiTextElement.textContent = message;
                    apiTextElement.className = 'text-sm text-yellow-800';
                } else {
                    apiStatusElement.classList.add('bg-gray-400');
                    apiTextElement.textContent = message;
                    apiTextElement.className = 'text-sm text-gray-800';
                }
            }
        }

        // æ›´æ–°ç¶²è·¯ç‹€æ…‹
        function updateNetworkStatus() {
            const networkStatusElement = document.getElementById('networkStatus');
            const networkTextElement = document.getElementById('networkText');
            
            if (networkStatusElement && networkTextElement) {
                if (navigator.onLine) {
                    networkStatusElement.className = 'w-3 h-3 rounded-full bg-green-500 mr-2';
                    networkTextElement.textContent = 'ç¶²è·¯é€£æ¥æ­£å¸¸';
                    networkTextElement.className = 'text-sm text-green-800';
                } else {
                    networkStatusElement.className = 'w-3 h-3 rounded-full bg-red-500 mr-2';
                    networkTextElement.textContent = 'ç¶²è·¯é€£æ¥å·²æ–·é–‹';
                    networkTextElement.className = 'text-sm text-red-800';
                }
            }
        }

        // æ›´æ–°æ¨¡å‹ç‹€æ…‹
        function updateModelStatus(modelName = null) {
            const modelStatusElement = document.getElementById('modelStatus');
            const modelTextElement = document.getElementById('modelText');
            
            if (modelStatusElement && modelTextElement) {
                if (modelName) {
                    modelStatusElement.className = 'w-3 h-3 rounded-full bg-green-500 mr-2';
                    modelTextElement.textContent = `ä½¿ç”¨: ${modelName}`;
                    modelTextElement.className = 'text-sm text-green-800';
                } else {
                    const selectedModel = document.querySelector('input[name="modelSelection"]:checked');
                    if (selectedModel) {
                        let modelDisplayName = '';
                        switch(selectedModel.value) {
                            case 'flash':
                                modelDisplayName = 'Gemini 1.5 Flash';
                                break;
                            case 'pro':
                                modelDisplayName = 'Gemini 1.5 Pro';
                                break;
                            case 'auto':
                                modelDisplayName = 'è‡ªå‹•é¸æ“‡';
                                break;
                            default:
                                modelDisplayName = 'æœªé¸æ“‡';
                        }
                        modelStatusElement.className = 'w-3 h-3 rounded-full bg-purple-500 mr-2';
                        modelTextElement.textContent = `å·²é¸æ“‡: ${modelDisplayName}`;
                        modelTextElement.className = 'text-sm text-purple-800';
                    } else {
                        modelStatusElement.className = 'w-3 h-3 rounded-full bg-gray-400 mr-2';
                        modelTextElement.textContent = 'æ¨¡å‹æœªé¸æ“‡';
                        modelTextElement.className = 'text-sm text-gray-800';
                    }
                }
            }
        }

        // åˆå§‹åŒ–ç¶²è·¯ç‹€æ…‹ç›£è½å™¨
        function initializeNetworkMonitoring() {
            // åˆå§‹ç‹€æ…‹
            updateNetworkStatus();
            updateModelStatus();
            
            // ç›£è½ç¶²è·¯ç‹€æ…‹è®ŠåŒ–
            window.addEventListener('online', function() {
                console.log('ç¶²è·¯é€£æ¥å·²æ¢å¾©');
                updateNetworkStatus();
                updateAPIStatus('warning', 'ç¶²è·¯å·²æ¢å¾©ï¼Œè«‹é‡æ–°æ¸¬è©¦ API');
            });
            
            window.addEventListener('offline', function() {
                console.log('ç¶²è·¯é€£æ¥å·²æ–·é–‹');
                updateNetworkStatus();
                updateAPIStatus('error', 'ç¶²è·¯é€£æ¥å·²æ–·é–‹');
            });
            
            // ç›£è½æ¨¡å‹é¸æ“‡è®ŠåŒ–
            document.querySelectorAll('input[name="modelSelection"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    updateModelStatus();
                    console.log('æ¨¡å‹é¸æ“‡å·²æ›´æ”¹:', this.value);
                });
            });
        }

        // --- Module 2: AI ä»»å‹™å”èª¿èˆ‡åŸ·è¡Œæ ¸å¿ƒ ('èåˆä¸­æ¨') ---
        async function callGeminiAPI(prompt, apiKey, expectJSON = false) {
            // æª¢æŸ¥ç¶²è·¯é€£æ¥
            if (!navigator.onLine) {
                throw new Error('ç¶²è·¯é€£æ¥å·²æ–·é–‹ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ç‹€æ…‹');
            }

            // æª¢æŸ¥ API é‡‘é‘°
            if (!apiKey || apiKey.trim() === '') {
                throw new Error('API é‡‘é‘°ä¸èƒ½ç‚ºç©º');
            }

            // ç²å–ç”¨æˆ¶é¸æ“‡çš„æ¨¡å‹
            const selectedModelElement = document.querySelector('input[name="modelSelection"]:checked');
            let selectedModel = 'auto'; // é è¨­å€¼
            if (selectedModelElement) {
                selectedModel = selectedModelElement.value;
            }
            
            // æ ¹æ“šç”¨æˆ¶é¸æ“‡æ±ºå®šæ¨¡å‹åˆ—è¡¨
            let models = [];
            if (selectedModel === 'flash') {
                models = ['gemini-1.5-flash'];
            } else if (selectedModel === 'pro') {
                models = ['gemini-1.5-pro'];
            } else {
                // è‡ªå‹•é¸æ“‡æ¨¡å¼ - æŒ‰å„ªå…ˆé †åºå˜—è©¦
                models = [
                    'gemini-1.5-flash',             // å¿«é€Ÿå›æ‡‰ï¼Œæœ€ç©©å®š
                    'gemini-1.5-pro',               // å¹³è¡¡æ€§èƒ½
                    'gemini-pro'                    // å‚™ç”¨æ¨¡å‹
                ];
            }
            
            let lastError = null;
            let attemptCount = 0;
            const maxAttempts = 3;
            
            for (const model of models) {
                for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                    try {
                        attemptCount++;
                        console.log(`å˜—è©¦æ¨¡å‹ ${model}ï¼Œç¬¬ ${attempt} æ¬¡å˜—è©¦`);
                        
                        const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent`;
                        console.log('è«‹æ±‚ URL:', url);
                        
                        // æ ¹æ“šæ¨¡å‹èª¿æ•´é…ç½®
                        let generationConfig = {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 8192,
                        };
                        
                        // æ·±åº¦ç ”ç©¶æ¨¡å‹ç‰¹æ®Šé…ç½®
                        if (model === 'gemini-1.5-pro') {
                            generationConfig = {
                                temperature: 0.6,  // ç¨å¾®é™ä½æº«åº¦ä»¥ç²å¾—æ›´ç©©å®šçš„è¼¸å‡º
                                topK: 50,
                                topP: 0.9,
                                maxOutputTokens: 16384,  // æ”¯æ´æ›´é•·çš„è¼¸å‡º
                            };
                        }
                        
                        const requestBody = {
                            contents: [{
                                parts: [{
                                    text: prompt
                                }]
                            }],
                            generationConfig: generationConfig
                        };
                        
                        console.log('è«‹æ±‚å…§å®¹:', JSON.stringify(requestBody, null, 2));

                        // å¢åŠ è«‹æ±‚è¶…æ™‚è¨­å®šï¼ˆPro æ¨¡å‹å¯èƒ½éœ€è¦æ›´é•·æ™‚é–“ï¼‰
                        const timeout = model === 'gemini-1.5-pro' ? 60000 : 30000; // 60ç§’ vs 30ç§’
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), timeout);

                        const response = await fetch(`${url}?key=${apiKey}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Cache-Control': 'no-cache',
                                'Pragma': 'no-cache'
                            },
                            body: JSON.stringify(requestBody),
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);

                        if (!response.ok) {
                            let errorMessage = `HTTP ${response.status}`;
                            
                            // å˜—è©¦è®€å–éŒ¯èª¤éŸ¿æ‡‰å…§å®¹
                            let errorResponse = '';
                            try {
                                const errorData = await response.text();
                                errorResponse = errorData;
                                console.error('éŒ¯èª¤éŸ¿æ‡‰å…§å®¹:', errorData);
                            } catch (e) {
                                console.error('ç„¡æ³•è®€å–éŒ¯èª¤éŸ¿æ‡‰å…§å®¹');
                            }
                            
                            // æ ¹æ“š HTTP ç‹€æ…‹ç¢¼æä¾›æ›´å…·é«”çš„éŒ¯èª¤è¨Šæ¯
                            switch (response.status) {
                                case 400:
                                    errorMessage = `è«‹æ±‚æ ¼å¼éŒ¯èª¤ï¼Œå¯èƒ½æ˜¯ API é‡‘é‘°ç„¡æ•ˆæˆ–è«‹æ±‚å…§å®¹æœ‰å•é¡Œã€‚éŒ¯èª¤è©³æƒ…: ${errorResponse.substring(0, 200)}`;
                                    break;
                                case 401:
                                    errorMessage = 'API é‡‘é‘°ç„¡æ•ˆæˆ–å·²éæœŸï¼Œè«‹æª¢æŸ¥æ‚¨çš„ API é‡‘é‘°';
                                    break;
                                case 403:
                                    errorMessage = 'API é‡‘é‘°æ¬Šé™ä¸è¶³ï¼Œè«‹ç¢ºèªé‡‘é‘°æ˜¯å¦æ­£ç¢º';
                                    break;
                                case 404:
                                    errorMessage = `æ¨¡å‹ ${model} ä¸å¯ç”¨ï¼Œå¯èƒ½æ˜¯æ¨¡å‹åç¨±éŒ¯èª¤æˆ–æ‚¨çš„ API é‡‘é‘°æ²’æœ‰æ¬Šé™`;
                                    break;
                                case 429:
                                    errorMessage = 'API è«‹æ±‚é »ç‡éé«˜ï¼Œè«‹ç¨å¾Œå†è©¦';
                                    break;
                                case 500:
                                    errorMessage = 'Google æœå‹™å™¨éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦';
                                    break;
                                case 503:
                                    errorMessage = 'Google æœå‹™æš«æ™‚ä¸å¯ç”¨ï¼Œè«‹ç¨å¾Œå†è©¦';
                                    break;
                                default:
                                    errorMessage = `HTTP éŒ¯èª¤ ${response.status}: ${response.statusText}`;
                            }
                            
                            throw new Error(errorMessage);
                        }

                        const data = await response.json();
                        
                        if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                            const text = data.candidates[0].content.parts[0].text;
                            
                            if (expectJSON) {
                                try {
                                    // å˜—è©¦è§£æ JSON
                                    const jsonMatch = text.match(/\{[\s\S]*\}/);
                                    if (jsonMatch) {
                                        let jsonText = jsonMatch[0];
                                        
                                        // æ¸…ç†å¸¸è¦‹çš„ JSON æ ¼å¼å•é¡Œ
                                        jsonText = jsonText
                                            .replace(/,\s*}/g, '}')  // ç§»é™¤å°¾éš¨é€—è™Ÿ
                                            .replace(/,\s*]/g, ']')  // ç§»é™¤é™£åˆ—å°¾éš¨é€—è™Ÿ
                                            .replace(/[\u0000-\u001F\u007F-\u009F]/g, '') // ç§»é™¤æ§åˆ¶å­—ç¬¦
                                            .replace(/[\u2018\u2019]/g, "'") // æ¨™æº–åŒ–å¼•è™Ÿ
                                            .replace(/[\u201C\u201D]/g, '"'); // æ¨™æº–åŒ–é›™å¼•è™Ÿ
                                        
                                        try {
                                            return JSON.parse(jsonText);
                                        } catch (parseError) {
                                            console.error('JSON è§£æå¤±æ•—ï¼Œå˜—è©¦ä¿®å¾©æ ¼å¼:', parseError);
                                            console.log('åŸå§‹ JSON:', jsonText);
                                            
                                            // å˜—è©¦æ›´æ¿€é€²çš„ä¿®å¾©
                                            jsonText = jsonText
                                                .replace(/([^\\])"/g, '$1\\"') // è½‰ç¾©æœªè½‰ç¾©çš„å¼•è™Ÿ
                                                .replace(/\\"/g, '"') // é‡æ–°è™•ç†å¼•è™Ÿ
                                                .replace(/,\s*([}\]])/g, '$1'); // ç§»é™¤æ‰€æœ‰å°¾éš¨é€—è™Ÿ
                                            
                                            return JSON.parse(jsonText);
                                        }
                                    } else {
                                        throw new Error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„ JSON æ ¼å¼');
                                    }
                                } catch (jsonError) {
                                    console.error('JSON è§£æéŒ¯èª¤:', jsonError);
                                    console.log('åŸå§‹å›æ‡‰:', text);
                                    
                                    // å¦‚æœ JSON è§£æå¤±æ•—ï¼Œè¿”å›ä¸€å€‹åŸºæœ¬çš„éŒ¯èª¤çµæ§‹
                                    return {
                                        error: 'JSON è§£æå¤±æ•—',
                                        original_response: text.substring(0, 500) + '...',
                                        message: 'AI å›æ‡‰æ ¼å¼ä¸æ­£ç¢ºï¼Œä½†å·²è¨˜éŒ„åŸå§‹å›æ‡‰'
                                    };
                                }
                            }
                            
                            console.log(`æˆåŠŸä½¿ç”¨æ¨¡å‹ ${model} å®Œæˆè«‹æ±‚`);
                            // æ›´æ–°æ¨¡å‹ç‹€æ…‹é¡¯ç¤º
                            updateModelStatus(model);
                            return text;
                        } else {
                            throw new Error('AI å›æ‡‰æ ¼å¼ç•°å¸¸');
                        }
                    } catch (error) {
                        console.error(`æ¨¡å‹ ${model} ç¬¬ ${attempt} æ¬¡å˜—è©¦å¤±æ•—:`, error);
                        lastError = error;
                        
                        // å¦‚æœæ˜¯ç¶²è·¯éŒ¯èª¤æˆ–è¶…æ™‚ï¼Œç­‰å¾…å¾Œé‡è©¦
                        if (error.name === 'AbortError' || error.message.includes('fetch')) {
                            if (attempt < maxAttempts) {
                                console.log(`ç­‰å¾… ${attempt * 2} ç§’å¾Œé‡è©¦...`);
                                await new Promise(resolve => setTimeout(resolve, attempt * 2000));
                                continue;
                            }
                        }
                        
                        // å¦‚æœæ˜¯ API é‡‘é‘°éŒ¯èª¤ï¼Œç›´æ¥è·³å‡º
                        if (error.message.includes('API é‡‘é‘°') || error.message.includes('401') || error.message.includes('403')) {
                            throw error;
                        }
                        
                        // å¦‚æœæ˜¯æ¨¡å‹ä¸å¯ç”¨éŒ¯èª¤ï¼Œå˜—è©¦ä¸‹ä¸€å€‹æ¨¡å‹
                        if (error.message.includes('404') || error.message.includes('æ¨¡å‹') || error.message.includes('ä¸å¯ç”¨')) {
                            console.log(`æ¨¡å‹ ${model} ä¸å¯ç”¨ï¼Œå˜—è©¦ä¸‹ä¸€å€‹æ¨¡å‹`);
                            break;
                        }
                        
                        // å…¶ä»–éŒ¯èª¤ï¼Œå˜—è©¦ä¸‹ä¸€å€‹æ¨¡å‹
                        break;
                    }
                }
            }
            
            // å¦‚æœæ‰€æœ‰æ¨¡å‹éƒ½å¤±æ•—äº†
            const errorMessage = `æ‰€æœ‰æ¨¡å‹éƒ½å¤±æ•—äº†ã€‚ç¸½å…±å˜—è©¦äº† ${attemptCount} æ¬¡ã€‚æœ€å¾ŒéŒ¯èª¤: ${lastError.message}`;
            console.error(errorMessage);
            throw new Error(errorMessage);
        }
        

        
        // --- åˆ†æä»»å‹™å®šç¾© ---
        async function analyzeForumSentiment(context, apiKey) {
            const prompt = `
                ä½ æ˜¯ä¸€ä½å°ˆç²¾å°ç£å¸‚å ´çš„è³‡æ·±å¸‚å ´åˆ†æå¸«ï¼Œå…·å‚™ç­–ç•¥æ€è€ƒçš„é«˜åº¦èˆ‡å­¸ç¿’èƒ½åŠ›ã€‚è«‹ä½ æ ¹æ“šä»¥ä¸‹å“ç‰Œæƒ…å¢ƒï¼Œé€²è¡Œå…¨é¢çš„è¼¿æƒ…ç›£æ¸¬åˆ†æï¼š
                
                **å“ç‰Œæƒ…å¢ƒ:**
                - **ç›®æ¨™å“ç‰Œ:** ${context.target}
                - **ç«¶çˆ­å°æ‰‹:** ${context.competitors}
                - **æ‰€å±¬ç”¢æ¥­:** ${context.industry} (${context.industryStatus})
                - **å•†æ¥­æ¨¡å¼:** ${context.businessModel}
                - **æ ¸å¿ƒç›®æ¨™äººç¾¤:** ${context.targetAudience}
                - **å»£å‘Šç›®æ¨™èˆ‡ç›®çš„:** ${context.adObjective}
                - **å»£å‘Šå½¢å¼:** ${context.aiRecommendMedia ? 'AIå»ºè­°' : context.selectedMedia.join(', ')}
                - **å“ç‰Œè¡ŒéŠ·å•é¡Œ:** ${context.marketingProblems}

                **è¼¿æƒ…ç›£æ¸¬ç¯„åœï¼š**
                - å°ç£ä¸»æµè«–å£‡ï¼šDcardã€PTTã€Mobile01ã€å·´å“ˆå§†ç‰¹
                - ç¤¾ç¾¤åª’é«”ï¼šFacebookã€Instagramã€YouTubeã€TikTok
                - æ–°èåª’é«”ï¼šå„å¤§æ–°èç¶²ç«™ã€è²¡ç¶“åª’é«”
                - éƒ¨è½æ ¼èˆ‡è©•è«–ï¼šå„å¤§éƒ¨è½æ ¼å¹³å°ã€Googleè©•è«–
                - å°ˆæ¥­å¹³å°ï¼šLinkedInã€ç”¢æ¥­è«–å£‡

                **ç­–ç•¥æ€è€ƒè¦æ±‚ï¼š**
                - å¾å¸‚å ´æ ¼å±€è§’åº¦åˆ†æï¼šç”¢æ¥­ç«¶çˆ­æ…‹å‹¢ã€å¸‚å ´é›†ä¸­åº¦ã€é€²å…¥é–€æª»
                - å¾å“ç‰Œå®šä½è§’åº¦æ€è€ƒï¼šç›®æ¨™å“ç‰Œåœ¨å¸‚å ´ä¸­çš„ç›¸å°ä½ç½®ã€å·®ç•°åŒ–æ©Ÿæœƒ
                - å¾æœªä¾†è¶¨å‹¢è§’åº¦é æ¸¬ï¼šæ¶ˆè²»è€…è¡Œç‚ºè®ŠåŒ–ã€æŠ€è¡“ç™¼å±•å°ç”¢æ¥­çš„å½±éŸ¿
                - å¾å­¸ç¿’è§’åº¦ç¸½çµï¼šé¡ä¼¼æ¡ˆä¾‹çš„æˆåŠŸæ¨¡å¼ã€å¤±æ•—æ•™è¨“ã€æœ€ä½³å¯¦è¸
                - **å¾å•é¡Œè§£æ±ºè§’åº¦ï¼šé‡å°å“ç‰Œæå‡ºçš„è¡ŒéŠ·å•é¡Œï¼Œåˆ†ææ ¹æœ¬åŸå› èˆ‡è§£æ±ºæ–¹å‘**

                **è«‹ç‰¹åˆ¥è£œå……ï¼š**
                - ç«¶çˆ­å“ç‰Œåœ¨åª’é«”ä¸Šçš„æ›å…‰ç­–ç•¥ã€å‰µæ„è¡¨ç¾ã€è¿‘æœŸè©±é¡Œæˆ–å¸‚å ´å‹•æ…‹
                - è‹¥æœ‰å¯æŸ¥è©¢çš„å¸‚å ´æˆæ•ˆï¼ˆå¦‚å»£å‘ŠæŠ•æ”¾é‡ã€ç¤¾ç¾¤è²é‡ã€åª’é«”å ±å°æ•¸é‡ç­‰ï¼‰ï¼Œè«‹ç°¡è¦å¼•ç”¨
                - åˆ†æç«¶å“åœ¨ä¸åŒå»£å‘Šç›®æ¨™ï¼ˆå¦‚å“ç‰ŒçŸ¥ååº¦ã€éŠ·å”®æå‡ç­‰ï¼‰ä¸‹çš„å„ªåŠ£å‹¢
                - å¾ç­–ç•¥é«˜åº¦åˆ†æï¼šå¦‚ä½•å»ºç«‹é•·æœŸç«¶çˆ­å„ªå‹¢ã€å“ç‰Œè³‡ç”¢ç´¯ç©
                - è¼¿æƒ…ç†±åº¦åˆ†æï¼šå“ç‰Œè²é‡ã€æƒ…æ„Ÿå‚¾å‘ã€è©±é¡Œå‚³æ’­åŠ›
                - **é‡å°æ€§å•é¡Œåˆ†æï¼šåŸºæ–¼å“ç‰Œæè¿°çš„è¡ŒéŠ·å•é¡Œï¼Œæä¾›å…·é«”çš„è§£æ±ºç­–ç•¥èˆ‡æ©Ÿæœƒé»**

                ä½ çš„ä»»å‹™æ˜¯ç¸½çµæ¯”è¼ƒçš„çµæœï¼Œä¸¦ä»¥ä¸€å€‹ JSON ç‰©ä»¶çš„æ ¼å¼å›å‚³ã€‚JSON ç‰©ä»¶å¿…é ˆåŒ…å«ä»¥ä¸‹å¹¾å€‹ key: 
                "target_profile", "target_pros", "target_cons", "competitor_pros", "competitor_cons", "market_opportunity", "competitor_media_strategy", "market_trend", "reference_data", "strategic_insights", "learning_cases", "sentiment_analysis", "platform_performance", "positioning_analysis", "problem_analysis", "solution_strategies"ã€‚

                - **target_profile:** åœ¨è«–å£‡ä¸­ï¼Œæœ€æ¥è¿‘ã€Œ${context.targetAudience}ã€é€™å€‹è¼ªå»“çš„è¨è«–è€…æ˜¯èª°ï¼Ÿä»–å€‘æœ‰ä»€éº¼ç‰¹å¾µï¼Ÿ
                - **target_pros:** é€™äº›ç›®æ¨™äººç¾¤è®šè³ç›®æ¨™å“ç‰Œçš„å„ªé»æ˜¯ä»€éº¼ï¼Ÿ (è‡³å°‘ 2 é»)ã€‚
                - **target_cons:** é€™äº›ç›®æ¨™äººç¾¤æŠ±æ€¨ç›®æ¨™å“ç‰Œçš„ç¼ºé»æ˜¯ä»€éº¼ï¼Ÿ (è‡³å°‘ 2 é»)ã€‚
                - **competitor_pros:** ç«¶çˆ­å“ç‰Œå¸å¼•é€™äº›ç›®æ¨™äººç¾¤çš„å„ªé»ã€‚
                - **competitor_cons:** ç«¶çˆ­å“ç‰Œè®“é€™äº›ç›®æ¨™äººç¾¤å»æ­¥çš„ç¼ºé»ã€‚
                - **market_opportunity:** æ ¹æ“šä»¥ä¸Šåˆ†æï¼Œæ‰¾å‡ºä¸€å€‹èƒ½ç²¾æº–æ‰“å‹•ã€Œ${context.targetAudience}ã€çš„å¸‚å ´æºé€šæ©Ÿæœƒé»ã€‚
                - **competitor_media_strategy:** ç«¶å“çš„åª’é«”ç­–ç•¥ã€å‰µæ„è¡¨ç¾ã€è¿‘æœŸå¸‚å ´å‹•æ…‹
                - **market_trend:** æœ€æ–°å¸‚å ´è¶¨å‹¢ã€æ¶ˆè²»è€…è¡Œç‚ºè®ŠåŒ–
                - **reference_data:** è‹¥æœ‰æŸ¥è©¢åˆ°çš„å…¬é–‹å¸‚å ´æˆæ•ˆæ•¸æ“šï¼Œè«‹ç°¡è¦åˆ—å‡º
                - **strategic_insights:** å¾ç­–ç•¥é«˜åº¦åˆ†æå¸‚å ´æ ¼å±€ã€ç«¶çˆ­æ…‹å‹¢ã€æœªä¾†æ©Ÿæœƒ
                - **learning_cases:** å¾éå¾€æ¡ˆä¾‹ä¸­å­¸ç¿’çš„æˆåŠŸæ¨¡å¼ã€å¤±æ•—æ•™è¨“ã€æœ€ä½³å¯¦è¸
                - **sentiment_analysis:** è¼¿æƒ…æƒ…æ„Ÿåˆ†æï¼ˆæ­£é¢ã€è² é¢ã€ä¸­æ€§æ¯”ä¾‹ï¼‰
                - **platform_performance:** å„å¹³å°è¡¨ç¾åˆ†æï¼ˆè²é‡ã€äº’å‹•ç‡ã€å½±éŸ¿åŠ›ï¼‰
                - **positioning_analysis:** å“ç‰Œå®šä½åˆ†æï¼ŒåŒ…å«ä»¥ä¸‹ç¶­åº¦çš„è©•åˆ†ï¼ˆ1-10åˆ†ï¼‰ï¼š
                    - "price_position": åƒ¹æ ¼å®šä½ï¼ˆ1=ä½åƒ¹ï¼Œ10=é«˜åƒ¹ï¼‰
                    - "quality_position": å“è³ªå®šä½ï¼ˆ1=åŸºæœ¬ï¼Œ10=é«˜ç«¯ï¼‰
                    - "innovation_position": å‰µæ–°ç¨‹åº¦ï¼ˆ1=å‚³çµ±ï¼Œ10=å‰µæ–°ï¼‰
                    - "target_audience_position": ç›®æ¨™äººç¾¤å®šä½ï¼ˆ1=å¤§çœ¾ï¼Œ10=å°çœ¾ï¼‰
                    - "brand_personality": å“ç‰Œå€‹æ€§ï¼ˆ1=å¯¦ç”¨ï¼Œ10=æ™‚å°šï¼‰
                - **problem_analysis:** é‡å°å“ç‰Œæè¿°çš„è¡ŒéŠ·å•é¡Œé€²è¡Œæ·±åº¦åˆ†æï¼Œæ‰¾å‡ºæ ¹æœ¬åŸå› 
                - **solution_strategies:** åŸºæ–¼å•é¡Œåˆ†æï¼Œæä¾›å…·é«”çš„è§£æ±ºç­–ç•¥èˆ‡åŸ·è¡Œå»ºè­°

                è«‹ç¢ºä¿å›å‚³çš„å…§å®¹æ˜¯ç´”ç²¹çš„ JSON æ ¼å¼ï¼Œæ²’æœ‰ä»»ä½•é¡å¤–çš„æ–‡å­—æˆ–è¨»è§£ã€‚
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        async function analyzeIndustrySentiment(context, apiKey) {
            const prompt = `
                ä½ æ˜¯ä¸€ä½è³‡æ·±çš„ç”¢æ¥­è¼¿æƒ…åˆ†æå¸«ï¼Œå°ˆé–€ç›£æ¸¬å°ç£å„ç”¢æ¥­çš„è¼¿æƒ…ç‹€æ³ã€‚è«‹é‡å°ã€Œ${context.industry}ã€ç”¢æ¥­é€²è¡Œå…¨é¢çš„è¼¿æƒ…ç›£æ¸¬åˆ†æã€‚

                **åˆ†æç¯„åœï¼š**
                - ç”¢æ¥­æ•´é«”è¼¿æƒ…ç‹€æ³
                - ä¸»è¦ç«¶çˆ­å“ç‰Œè¼¿æƒ…è¡¨ç¾
                - ç”¢æ¥­ç†±é–€è©±é¡Œèˆ‡è¶¨å‹¢
                - æ¶ˆè²»è€…å°ç”¢æ¥­çš„æ•´é«”èªçŸ¥èˆ‡æ…‹åº¦
                - ç”¢æ¥­é¢è‡¨çš„æŒ‘æˆ°èˆ‡æ©Ÿæœƒ

                **ç›£æ¸¬å¹³å°ï¼š**
                - æ–°èåª’é«”ï¼šå„å¤§æ–°èç¶²ç«™ã€è²¡ç¶“åª’é«”ã€ç”¢æ¥­å°ˆåˆŠ
                - ç¤¾ç¾¤åª’é«”ï¼šFacebookã€Instagramã€YouTubeã€TikTok
                - è«–å£‡å¹³å°ï¼šPTTã€Dcardã€Mobile01ã€å·´å“ˆå§†ç‰¹
                - å°ˆæ¥­å¹³å°ï¼šLinkedInã€ç”¢æ¥­è«–å£‡ã€å°ˆæ¥­ç¤¾ç¾¤
                - è©•è«–å¹³å°ï¼šGoogleè©•è«–ã€å„å¤§è©•è«–ç¶²ç«™

                **åˆ†æé‡é»ï¼š**
                - ç”¢æ¥­è²é‡è¶¨å‹¢ï¼ˆè¿‘3å€‹æœˆï¼‰
                - ç†±é–€è©±é¡Œèˆ‡é—œéµå­—
                - æ¶ˆè²»è€…æƒ…æ„Ÿå‚¾å‘
                - ç”¢æ¥­çˆ­è­°èˆ‡å±æ©Ÿ
                - æ–°èˆˆè¶¨å‹¢èˆ‡æ©Ÿæœƒ

                ä½ çš„ä»»å‹™æ˜¯ç”¢å‡ºä¸€å€‹ JSON ç‰©ä»¶ï¼ŒåŒ…å«ä»¥ä¸‹ keyï¼š
                "industry_overview", "trending_topics", "sentiment_distribution", "key_players", "crisis_opportunities", "consumer_insights", "future_trends"ã€‚

                - **industry_overview:** ç”¢æ¥­æ•´é«”è¼¿æƒ…æ¦‚æ³
                - **trending_topics:** ç†±é–€è©±é¡Œèˆ‡é—œéµå­—ï¼ˆè‡³å°‘5å€‹ï¼‰
                - **sentiment_distribution:** æƒ…æ„Ÿåˆ†å¸ƒï¼ˆæ­£é¢ã€è² é¢ã€ä¸­æ€§æ¯”ä¾‹ï¼‰
                - **key_players:** ä¸»è¦ç«¶çˆ­å“ç‰Œè¼¿æƒ…è¡¨ç¾æ’å
                - **crisis_opportunities:** ç”¢æ¥­é¢è‡¨çš„å±æ©Ÿèˆ‡æ©Ÿæœƒ
                - **consumer_insights:** æ¶ˆè²»è€…å°ç”¢æ¥­çš„èªçŸ¥èˆ‡æ…‹åº¦
                - **future_trends:** æœªä¾†è¶¨å‹¢é æ¸¬

                è«‹ç¢ºä¿å›å‚³çš„å…§å®¹æ˜¯ç´”ç²¹çš„ JSON æ ¼å¼ï¼Œæ²’æœ‰ä»»ä½•é¡å¤–çš„æ–‡å­—æˆ–è¨»è§£ã€‚
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        async function analyzeSeoStrategy(context, apiKey) {
            const prompt = `
                ä½ æ˜¯ä¸€ä½é ‚å°–çš„ SEO ç­–ç•¥é¡§å•ï¼Œç‰¹åˆ¥ç†Ÿæ‚‰å°ç£çš„ google.com.tw æœå°‹å¼•æ“ç”Ÿæ…‹ã€‚
                è«‹æ¨¡æ“¬ã€Œ${context.targetAudience}ã€é€™å€‹ç›®æ¨™äººç¾¤ï¼Œåœ¨æœå°‹èˆ‡ã€Œ${context.target}ã€ç›¸é—œçš„é—œéµå­—æ™‚ï¼Œä»–å€‘æœƒçœ‹åˆ°ä»€éº¼æ¨£çš„æœå°‹çµæœé é¢ (SERP)ã€‚

                **å“ç‰Œæƒ…å¢ƒ:**
                - **ç›®æ¨™å“ç‰Œ:** ${context.target}
                - **ç«¶çˆ­å°æ‰‹:** ${context.competitors}
                - **å•†æ¥­æ¨¡å¼:** ${context.businessModel}
                - **æ ¸å¿ƒç›®æ¨™äººç¾¤:** ${context.targetAudience}
                - **å»£å‘Šç›®æ¨™èˆ‡ç›®çš„:** ${context.adObjective}
                - **å»£å‘Šå½¢å¼:** ${context.aiRecommendMedia ? 'AIå»ºè­°' : context.selectedMedia.join(', ')}

                ä½ çš„ä»»å‹™æ˜¯ç¸½çµä½ çš„ç™¼ç¾ï¼Œä¸¦ä»¥ä¸€å€‹ JSON ç‰©ä»¶çš„æ ¼å¼å›å‚³ã€‚JSON ç‰©ä»¶å¿…é ˆåŒ…å«ä»¥ä¸‹å¹¾å€‹ key: 
                "main_competitors_in_serp", "dominant_content_format", "user_intent", "content_gap_opportunity"ã€‚

                - **main_competitors_in_serp:** é™¤äº†ã€Œ${context.competitors}ã€ä¹‹å¤–ï¼Œåœ¨è‡ªç„¶æœå°‹çµæœä¸­é‚„å¸¸å‡ºç¾å“ªäº›ç«¶çˆ­è€…ï¼Ÿ
                - **dominant_content_format:** æ’åé å‰çš„å…§å®¹ä¸»è¦æ˜¯é•·ç¯‡æ–‡ç« ã€ç”¢å“æ¯”è¼ƒé ã€æ–°èç¨¿ï¼Œé‚„æ˜¯ YouTube å½±ç‰‡ï¼Ÿ
                - **user_intent:** ã€Œ${context.targetAudience}ã€åœ¨æœå°‹æ™‚ï¼Œå…¶ä¸»è¦çš„ã€Œæœå°‹æ„åœ–ã€æ˜¯ä»€éº¼ï¼Ÿè«‹æ ¹æ“š ${context.businessModel} çš„ç‰¹æ€§ä¾†åˆ†æã€‚
                - **content_gap_opportunity:** æ ¹æ“š Google çš„ã€Œå…¶ä»–äººä¹Ÿå•äº†ã€æˆ–ã€Œç›¸é—œæœå°‹ã€ï¼Œæ‰¾å‡ºä¸€å€‹èƒ½è§£æ±ºã€Œ${context.targetAudience}ã€ç—›é»ï¼Œä½†å¸‚å ´ä¸Šé‚„æ²’æœ‰å„ªè³ªå…§å®¹å›ç­”çš„å•é¡Œï¼Œä½œç‚ºå…§å®¹ç­–ç•¥åˆ‡å…¥é»ã€‚

                è«‹ç¢ºä¿å›å‚³çš„å…§å®¹æ˜¯ç´”ç²¹çš„ JSON æ ¼å¼ï¼Œæ²’æœ‰ä»»ä½•é¡å¤–çš„æ–‡å­—æˆ–è¨»è§£ã€‚
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        async function analyzeBudgetFeasibility(context, apiKey) {
            const prompt = `
                ä½ æ˜¯ä¸€ä½è³‡æ·±çš„åª’é«”ç­–ç•¥é¡§å•ï¼Œå°ˆé–€è©•ä¼°å»£å‘Šé ç®—èˆ‡ç›®æ¨™çš„å¯è¡Œæ€§ã€‚è«‹é‡å°ä»¥ä¸‹æƒ…å¢ƒé€²è¡Œé ç®—å¯è¡Œæ€§åˆ†æï¼š

                **å®¢æˆ¶æƒ…å¢ƒ:**
                - **ç›®æ¨™å“ç‰Œ:** ${context.target}
                - **ç”¢æ¥­:** ${context.industry} (${context.industryStatus})
                - **å•†æ¥­æ¨¡å¼:** ${context.businessModel}
                - **ç›®æ¨™äººç¾¤:** ${context.targetAudience}
                - **å»£å‘Šç›®æ¨™èˆ‡ç›®çš„:** ${context.adObjective}
                - **å»£å‘Šå½¢å¼:** ${context.aiRecommendMedia ? 'AIå»ºè­°' : context.selectedMedia.join(', ')}
                - **ç¸½é ç®— (TWD):** ${context.budget.toLocaleString()}

                **åˆ†æé‡é»ï¼š**
                - è©•ä¼°è©²é ç®—åœ¨å°ç£å¸‚å ´é”æˆç›®æ¨™çš„å¯è¡Œæ€§
                - åˆ†æä¸åŒé ç®—è¦æ¨¡ä¸‹çš„ç­–ç•¥é¸æ“‡
                - æä¾›é ç®—ä¸è¶³æ™‚çš„æ›¿ä»£æ–¹æ¡ˆ
                - å»ºè­°æœ€å„ªçš„é ç®—åˆ†é…ç­–ç•¥

                **è«‹åƒè€ƒå°ç£å¸‚å ´çš„å¯¦éš›æ•¸æ“šï¼š**
                - ä¸åŒåª’é«”æ¸ é“çš„CPM/CPCåŸºæº–
                - å„ç”¢æ¥­çš„å…¸å‹å»£å‘ŠæŠ•è³‡è¦æ¨¡
                - ä¸åŒç›®æ¨™çš„é”æˆé–€æª»

                ä½ çš„ä»»å‹™æ˜¯ç”¢å‡ºä¸€å€‹ JSON ç‰©ä»¶ï¼ŒåŒ…å«ä»¥ä¸‹ keyï¼š
                "feasibility_assessment", "budget_recommendations", "alternative_strategies", "risk_analysis", "success_probability"ã€‚

                - **feasibility_assessment:** é ç®—å¯è¡Œæ€§è©•ä¼°ï¼ˆé«˜/ä¸­/ä½ï¼‰åŠç†ç”±
                - **budget_recommendations:** åŸºæ–¼ç›®æ¨™çš„é ç®—å»ºè­°ï¼ˆç†æƒ³é ç®—ç¯„åœï¼‰
                - **alternative_strategies:** é ç®—ä¸è¶³æ™‚çš„æ›¿ä»£ç­–ç•¥ï¼ˆè‡³å°‘3å€‹ï¼‰
                - **risk_analysis:** é ç®—ä¸è¶³å¯èƒ½å¸¶ä¾†çš„é¢¨éšª
                - **success_probability:** é”æˆç›®æ¨™çš„æˆåŠŸæ©Ÿç‡è©•ä¼°

                è«‹ç¢ºä¿å›å‚³çš„å…§å®¹æ˜¯ç´”ç²¹çš„ JSON æ ¼å¼ï¼Œæ²’æœ‰ä»»ä½•é¡å¤–çš„æ–‡å­—æˆ–è¨»è§£ã€‚
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        async function estimateKpiAndBudget(context, opportunity, apiKey) {
            if (!context.budget || context.budget <= 0) {
                 return { budget_allocation: [], kpi_estimations: [], rationale: "æœªæä¾›é ç®—ï¼Œç„¡æ³•é€²è¡Œä¼°ç®—ã€‚" };
            }
            const prompt = `
                ä½ æ˜¯ä¸€ä½ç¶“é©—è±å¯Œçš„æ•¸ä½åª’é«”è¦åŠƒå¸« (Media Planner)ï¼Œæ“…é•·å°ç£å¸‚å ´çš„åª’é«”æŠ•è³‡èˆ‡æˆæ•ˆé ä¼°ï¼Œå…·å‚™ç­–ç•¥æ€è€ƒçš„é«˜åº¦èˆ‡å­¸ç¿’èƒ½åŠ›ã€‚
                æ ¹æ“šä»¥ä¸‹å®¢æˆ¶æƒ…å¢ƒèˆ‡ä½ å·²çŸ¥çš„å¸‚å ´æ©Ÿæœƒé»ï¼Œè¦åŠƒä¸€ä»½åˆæ­¥çš„é ç®—åˆ†é…èˆ‡ KPI é ä¼°ã€‚

                **å®¢æˆ¶æƒ…å¢ƒ:**
                - **ç”¢æ¥­:** ${context.industry}
                - **å•†æ¥­æ¨¡å¼:** ${context.businessModel}
                - **ç›®æ¨™äººç¾¤:** ${context.targetAudience}
                - **ç¸½é ç®— (TWD):** ${context.budget.toLocaleString()}
                - **å»£å‘Šç›®æ¨™èˆ‡ç›®çš„:** ${context.adObjective}
                - **å»£å‘Šå½¢å¼:** ${context.aiRecommendMedia ? 'AIå»ºè­°' : context.selectedMedia.join(', ')}
                - **æ ¸å¿ƒç­–ç•¥æ©Ÿæœƒé»:** ${opportunity}

                **ç­–ç•¥æ€è€ƒè¦æ±‚ï¼š**
                - å¾æŠ•è³‡å›å ±è§’åº¦æ€è€ƒï¼šå¦‚ä½•æœ€å¤§åŒ–æ¯ä¸€åˆ†é ç®—çš„æ•ˆç›Š
                - å¾å­¸ç¿’è§’åº¦ç¸½çµï¼šé¡ä¼¼é ç®—è¦æ¨¡çš„æˆåŠŸæ¡ˆä¾‹ã€å¤±æ•—æ•™è¨“
                - å¾ç­–ç•¥è§’åº¦è¦åŠƒï¼šå¦‚ä½•å»ºç«‹å¯æŒçºŒçš„åª’é«”æŠ•è³‡æ¨¡å¼
                - å¾å‰µæ–°è§’åº¦å»ºè­°ï¼šæ–°èˆˆåª’é«”æ¸ é“ã€å‰µæ„è¡¨ç¾å½¢å¼
                - **å¾å¯è¡Œæ€§è§’åº¦è©•ä¼°ï¼šè©²é ç®—æ˜¯å¦è¶³å¤ é”æˆç›®æ¨™ï¼Œå¦‚ä¸è¶³è«‹æä¾›èª¿æ•´å»ºè­°**

                **è«‹åƒè€ƒå°ç£å¯æŸ¥è©¢çš„å…¬é–‹åª’é«”æˆæ•ˆæ•¸æ“šï¼ˆå¦‚Nielsenã€Comscoreã€Meta/Facebook/Googleå®˜æ–¹å ±å‘Šç­‰ï¼‰ï¼Œä¸¦æ ¹æ“šå»£å‘Šç›®æ¨™èˆ‡ç›®çš„ï¼Œçµ¦å‡ºæœ€å…·æˆæ•ˆçš„åª’é«”å»ºè­°èˆ‡KPIé ä¼°ã€‚**

                ä½ çš„ä»»å‹™æ˜¯ç”¢å‡ºä¸€å€‹ JSON ç‰©ä»¶ï¼ŒåŒ…å« "budget_allocation", "kpi_estimations", "rationale", "reference_data", "strategic_recommendations", "learning_insights", "feasibility_warning", "budget_optimization" å…«å€‹ keyã€‚

                1.  **budget_allocation:** ä¸€å€‹é™£åˆ—ã€‚æ ¹æ“šã€Œæ ¸å¿ƒç­–ç•¥æ©Ÿæœƒé»ã€ï¼Œå»ºè­°å°‡é ç®—åˆ†é…åˆ° 2-3 å€‹æœ€ç›¸é—œçš„åª’é«”æ¸ é“ (ä¾‹å¦‚ï¼šä»˜è²»æœå°‹, ç¤¾ç¾¤å»£å‘Š, å…§å®¹è¡ŒéŠ·, å½±éŸ³å»£å‘Š)ï¼Œä¸¦çµ¦å‡ºæ¯å€‹æ¸ é“çš„**ç™¾åˆ†æ¯”**å’Œ**é‡‘é¡**ã€‚
                2.  **kpi_estimations:** ä¸€å€‹é™£åˆ—ã€‚ç‚ºæ¯å€‹å»ºè­°çš„æ¸ é“ï¼Œæä¾›**å¯é‡åŒ–çš„ KPI é ä¼°**ã€‚è«‹ä½¿ç”¨å°ç£å¸‚å ´çš„å…¸å‹ benchmarks (åŸºæº–)ã€‚
                    -   **å°æ–¼ B2C:** éœ€åŒ…å« "Impressions" (æ›å…‰), "CTR" (é»æ“Šç‡), "Clicks" (é»æ“Š), "CPC" (å–®æ¬¡é»æ“Šæˆæœ¬), "Est_Conversions" (é ä¼°è¨‚å–®æ•¸ï¼Œè«‹è‡ªè¨‚ä¸€å€‹åˆç†çš„è½‰æ›ç‡)ã€‚
                    -   **å°æ–¼ B2B:** éœ€åŒ…å« "Impressions", "CTR", "Clicks", "CPC", "Est_Leads" (é ä¼°æ½›åœ¨å®¢æˆ¶æ•¸ï¼Œè«‹è‡ªè¨‚ä¸€å€‹åˆç†çš„è½‰æ›ç‡)ã€‚
                3.  **rationale:** ä¸€æ®µç°¡çŸ­æ–‡å­—ï¼Œèªªæ˜ä½ é€™æ¨£è¦åŠƒé ç®—å„ªå…ˆç´šçš„ç†ç”±ã€‚
                4.  **reference_data:** è‹¥æœ‰æŸ¥è©¢åˆ°çš„å…¬é–‹åª’é«”æˆæ•ˆæ•¸æ“šï¼Œè«‹ç°¡è¦åˆ—å‡º
                5.  **strategic_recommendations:** å¾ç­–ç•¥è§’åº¦æä¾›çš„é•·æœŸå»ºè­°ã€å‰µæ–°æ–¹å‘
                6.  **learning_insights:** å¾éå¾€æ¡ˆä¾‹ä¸­å­¸ç¿’çš„ç¶“é©—ã€æœ€ä½³å¯¦è¸
                7.  **feasibility_warning:** å¦‚æœé ç®—æ˜é¡¯ä¸è¶³é”æˆç›®æ¨™ï¼Œè«‹æä¾›è­¦å‘Šèˆ‡å»ºè­°
                8.  **budget_optimization:** é ç®—å„ªåŒ–å»ºè­°ï¼Œå¦‚ä½•åœ¨æœ‰é™é ç®—ä¸‹æœ€å¤§åŒ–æ•ˆç›Š

                è«‹ç¢ºä¿å›å‚³çš„å…§å®¹æ˜¯ç´”ç²¹çš„ JSON æ ¼å¼ã€‚
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        async function analyzeMultiMarketStrategy(context, apiKey) {
            const prompt = `
                ä½ æ˜¯ä¸€ä½è³‡æ·±çš„åœ‹éš›å¸‚å ´ç­–ç•¥é¡§å•ï¼Œå°ˆé–€è¦åŠƒå¤šå¸‚å ´åª’é«”ç­–ç•¥ã€‚è«‹é‡å°ä»¥ä¸‹æƒ…å¢ƒé€²è¡Œå¤šå¸‚å ´ç­–ç•¥åˆ†æï¼š

                **å®¢æˆ¶æƒ…å¢ƒ:**
                - **ç›®æ¨™å“ç‰Œ:** ${context.target}
                - **ç”¢æ¥­:** ${context.industry}
                - **å•†æ¥­æ¨¡å¼:** ${context.businessModel}
                - **ç›®æ¨™äººç¾¤:** ${context.targetAudience}
                - **å»£å‘Šç›®æ¨™èˆ‡ç›®çš„:** ${context.adObjective}
                - **å»£å‘Šå½¢å¼:** ${context.aiRecommendMedia ? 'AIå»ºè­°' : context.selectedMedia.join(', ')}
                - **ç›®æ¨™å¸‚å ´:** ${context.targetMarkets}
                - **ç›®æ¨™èªè¨€:** ${context.targetLanguages}
                - **ç¸½é ç®— (TWD):** ${context.budget.toLocaleString()}

                **åˆ†æé‡é»ï¼š**
                - å„ç›®æ¨™å¸‚å ´çš„åª’é«”ç”Ÿæ…‹èˆ‡æ¶ˆè²»è€…è¡Œç‚ºå·®ç•°
                - ä¸åŒå¸‚å ´çš„åª’é«”æŠ•è³‡æˆæœ¬èˆ‡æ•ˆç›Šæ¯”è¼ƒ
                - è·¨å¸‚å ´å“ç‰Œä¸€è‡´æ€§èˆ‡åœ¨åœ°åŒ–å¹³è¡¡
                - å¤šèªè¨€å…§å®¹ç­–ç•¥èˆ‡æ–‡åŒ–é©æ‡‰æ€§
                - é ç®—åœ¨å„å¸‚å ´çš„æœ€å„ªåˆ†é…ç­–ç•¥

                **è«‹åƒè€ƒå„å¸‚å ´çš„å¯¦éš›æ•¸æ“šï¼š**
                - å„å¸‚å ´çš„åª’é«”æ»²é€ç‡èˆ‡ä½¿ç”¨ç¿’æ…£
                - ä¸åŒå¸‚å ´çš„å»£å‘Šæˆæœ¬åŸºæº–
                - æ–‡åŒ–å·®ç•°å°å»£å‘Šæ•ˆæœçš„å½±éŸ¿
                - æˆåŠŸèˆ‡å¤±æ•—çš„è·¨å¸‚å ´æ¡ˆä¾‹

                ä½ çš„ä»»å‹™æ˜¯ç”¢å‡ºä¸€å€‹ JSON ç‰©ä»¶ï¼ŒåŒ…å«ä»¥ä¸‹ keyï¼š
                "market_analysis", "budget_allocation", "localization_strategy", "cultural_considerations", "success_metrics", "risk_management"ã€‚

                - **market_analysis:** å„ç›®æ¨™å¸‚å ´çš„åª’é«”ç’°å¢ƒåˆ†æï¼ˆåŒ…å«å¸‚å ´è¦æ¨¡ã€åª’é«”ç¿’æ…£ã€ç«¶çˆ­ç‹€æ³ï¼‰
                - **budget_allocation:** å»ºè­°çš„è·¨å¸‚å ´é ç®—åˆ†é…ï¼ˆç™¾åˆ†æ¯”èˆ‡é‡‘é¡ï¼‰
                - **localization_strategy:** åœ¨åœ°åŒ–ç­–ç•¥å»ºè­°ï¼ˆå…§å®¹ã€å‰µæ„ã€åª’é«”é¸æ“‡ï¼‰
                - **cultural_considerations:** æ–‡åŒ–è€ƒé‡èˆ‡æ³¨æ„äº‹é …
                - **success_metrics:** å„å¸‚å ´çš„KPIè¨­å®šå»ºè­°
                - **risk_management:** è·¨å¸‚å ´åŸ·è¡Œçš„é¢¨éšªç®¡ç†

                è«‹ç¢ºä¿å›å‚³çš„å…§å®¹æ˜¯ç´”ç²¹çš„ JSON æ ¼å¼ï¼Œæ²’æœ‰ä»»ä½•é¡å¤–çš„æ–‡å­—æˆ–è¨»è§£ã€‚
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        async function analyzeLocalizationStrategy(context, multiMarketData, apiKey) {
            const prompt = `
                ä½ æ˜¯ä¸€ä½è³‡æ·±çš„åœ¨åœ°åŒ–ç­–ç•¥å°ˆå®¶ï¼Œå°ˆé–€è¦åŠƒå¤šèªè¨€å…§å®¹èˆ‡æ–‡åŒ–é©æ‡‰ç­–ç•¥ã€‚è«‹é‡å°ä»¥ä¸‹æƒ…å¢ƒé€²è¡Œåœ¨åœ°åŒ–ç­–ç•¥åˆ†æï¼š

                **å®¢æˆ¶æƒ…å¢ƒ:**
                - **ç›®æ¨™å“ç‰Œ:** ${context.target}
                - **ç”¢æ¥­:** ${context.industry}
                - **ç›®æ¨™äººç¾¤:** ${context.targetAudience}
                - **å»£å‘Šç›®æ¨™èˆ‡ç›®çš„:** ${context.adObjective}
                - **å»£å‘Šå½¢å¼:** ${context.aiRecommendMedia ? 'AIå»ºè­°' : context.selectedMedia.join(', ')}
                - **ç›®æ¨™å¸‚å ´:** ${context.targetMarkets}
                - **ç›®æ¨™èªè¨€:** ${context.targetLanguages}

                **å¤šå¸‚å ´åˆ†æè³‡æ–™:**
                ${JSON.stringify(multiMarketData, null, 2)}

                **åˆ†æé‡é»ï¼š**
                - å„èªè¨€çš„å…§å®¹ç­–ç•¥èˆ‡è¡¨é”æ–¹å¼
                - æ–‡åŒ–ç¬¦è™Ÿèˆ‡ç¦å¿Œçš„è­˜åˆ¥èˆ‡è™•ç†
                - å‰µæ„è¡¨ç¾çš„åœ¨åœ°åŒ–èª¿æ•´å»ºè­°
                - åª’é«”æ¸ é“çš„èªè¨€åå¥½åˆ†æ
                - å“ç‰Œè¨Šæ¯çš„ä¸€è‡´æ€§èˆ‡é©æ‡‰æ€§å¹³è¡¡

                **è«‹åƒè€ƒå„èªè¨€å¸‚å ´çš„å¯¦éš›æ¡ˆä¾‹ï¼š**
                - æˆåŠŸçš„è·¨èªè¨€å»£å‘Šæ¡ˆä¾‹
                - æ–‡åŒ–å¤±èª¤çš„æ•™è¨“èˆ‡é¿å…æ–¹æ³•
                - å„èªè¨€çš„å‰µæ„è¡¨ç¾ç‰¹è‰²
                - åª’é«”å¹³å°çš„èªè¨€ä½¿ç”¨ç¿’æ…£

                ä½ çš„ä»»å‹™æ˜¯ç”¢å‡ºä¸€å€‹ JSON ç‰©ä»¶ï¼ŒåŒ…å«ä»¥ä¸‹ keyï¼š
                "language_strategy", "cultural_adaptation", "creative_localization", "media_language_preferences", "brand_consistency", "translation_guidelines"ã€‚

                - **language_strategy:** å„èªè¨€çš„å…§å®¹ç­–ç•¥å»ºè­°
                - **cultural_adaptation:** æ–‡åŒ–é©æ‡‰æ€§å»ºè­°èˆ‡æ³¨æ„äº‹é …
                - **creative_localization:** å‰µæ„è¡¨ç¾çš„åœ¨åœ°åŒ–å»ºè­°
                - **media_language_preferences:** å„åª’é«”å¹³å°çš„èªè¨€åå¥½
                - **brand_consistency:** å“ç‰Œä¸€è‡´æ€§çš„ç¶­è­·ç­–ç•¥
                - **translation_guidelines:** ç¿»è­¯èˆ‡æœ¬åœ°åŒ–æŒ‡å°åŸå‰‡

                è«‹ç¢ºä¿å›å‚³çš„å…§å®¹æ˜¯ç´”ç²¹çš„ JSON æ ¼å¼ï¼Œæ²’æœ‰ä»»ä½•é¡å¤–çš„æ–‡å­—æˆ–è¨»è§£ã€‚
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        async function analyzeCompetitorInsights(context, apiKey) {
            const prompt = `
                ä½ æ˜¯ä¸€ä½è³‡æ·±çš„ç«¶çˆ­åˆ†æå°ˆå®¶ï¼Œå°ˆé–€åˆ†æç«¶çˆ­å°æ‰‹çš„å“ç‰Œå®šä½ã€ç”¢å“ç­–ç•¥èˆ‡å¸‚å ´è¡¨ç¾ã€‚è«‹é‡å°ä»¥ä¸‹æƒ…å¢ƒé€²è¡Œæ·±åº¦ç«¶çˆ­å°æ‰‹åˆ†æï¼š

                **å®¢æˆ¶æƒ…å¢ƒ:**
                - **ç›®æ¨™å“ç‰Œ:** ${context.target}
                - **ç”¢æ¥­:** ${context.industry} (${context.industryStatus})
                - **å•†æ¥­æ¨¡å¼:** ${context.businessModel}
                - **ç›®æ¨™äººç¾¤:** ${context.targetAudience}
                - **ç«¶çˆ­å°æ‰‹:** ${context.competitors}

                **é‡é»æ¨™è¨»è³‡è¨Šï¼š**
                - **ç«¶çˆ­å°æ‰‹è¿‘æœŸæ´»å‹•æ™‚é–“ç·š:** ${context.competitorTimeline}
                - **æˆ‘å€‘çš„ç«¶çˆ­å„ªå‹¢:** ${context.competitiveAdvantage}
                - **éœ€è¦å½Œè£œçš„å·®è·:** ${context.competitiveGaps}
                - **å­£ç¯€æ€§å› ç´ :** ${context.seasonalFactors}
                - **å¸‚å ´è¶¨å‹¢:** ${context.marketTrends}

                **åˆ†æé‡é»ï¼š**
                - è©³ç´°åˆ†ææ¯å€‹ç«¶çˆ­å°æ‰‹çš„å“ç‰Œå®šä½èˆ‡ç”¢å“ç‰¹è‰²
                - ç«¶çˆ­å°æ‰‹çš„åª’é«”ç­–ç•¥èˆ‡å»£å‘Šè¡¨ç¾
                - ç«¶çˆ­å°æ‰‹çš„ç›®æ¨™äººç¾¤èˆ‡å¸‚å ´ä½”æœ‰ç‡
                - ç«¶çˆ­å°æ‰‹çš„å„ªå‹¢èˆ‡åŠ£å‹¢åˆ†æ
                - å¸‚å ´æ©Ÿæœƒèˆ‡å¨è„…è©•ä¼°
                - å·®ç•°åŒ–ç­–ç•¥å»ºè­°
                - åŸºæ–¼æ™‚é–“ç·šçš„ç«¶çˆ­å°æ‰‹æ´»å‹•åˆ†æ
                - ç«¶çˆ­å„ªå‹¢èˆ‡å·®è·çš„é‡åŒ–è©•ä¼°
                - å­£ç¯€æ€§å› ç´ å°ç«¶çˆ­ç­–ç•¥çš„å½±éŸ¿
                - å¸‚å ´è¶¨å‹¢å°ç«¶çˆ­æ ¼å±€çš„å½±éŸ¿

                **è«‹åƒè€ƒå°ç£å¸‚å ´çš„å¯¦éš›æ•¸æ“šï¼š**
                - å„ç«¶çˆ­å°æ‰‹çš„å¸‚å ´è¡¨ç¾æ•¸æ“š
                - åª’é«”æŠ•è³‡è¦æ¨¡èˆ‡ç­–ç•¥
                - æ¶ˆè²»è€…å°å„å“ç‰Œçš„èªçŸ¥èˆ‡è©•åƒ¹
                - æˆåŠŸèˆ‡å¤±æ•—çš„ç«¶çˆ­æ¡ˆä¾‹
                - ç«¶çˆ­å°æ‰‹çš„æ™‚é–“ç·šæ´»å‹•å°å¸‚å ´çš„å½±éŸ¿

                ä½ çš„ä»»å‹™æ˜¯ç”¢å‡ºä¸€å€‹ JSON ç‰©ä»¶ï¼ŒåŒ…å«ä»¥ä¸‹ keyï¼š
                "competitor_analysis", "market_positioning", "media_strategies", "opportunities", "threats", "differentiation_strategy", "timeline_analysis", "competitive_advantage_analysis", "gap_analysis", "seasonal_impact", "trend_impact"ã€‚

                - **competitor_analysis:** å„ç«¶çˆ­å°æ‰‹çš„è©³ç´°åˆ†æï¼ˆå“ç‰Œã€ç”¢å“ã€å®šä½ã€å„ªå‹¢åŠ£å‹¢ï¼‰
                - **market_positioning:** å¸‚å ´å®šä½åœ–åˆ†æï¼ˆåƒ¹æ ¼vså“è³ªã€åŠŸèƒ½vsè¨­è¨ˆç­‰ç¶­åº¦ï¼‰
                - **media_strategies:** ç«¶çˆ­å°æ‰‹çš„åª’é«”ç­–ç•¥åˆ†æ
                - **opportunities:** å¸‚å ´æ©Ÿæœƒé»è­˜åˆ¥
                - **threats:** æ½›åœ¨å¨è„…åˆ†æ
                - **differentiation_strategy:** å·®ç•°åŒ–ç­–ç•¥å»ºè­°
                - **timeline_analysis:** ç«¶çˆ­å°æ‰‹æ™‚é–“ç·šæ´»å‹•åˆ†æ
                - **competitive_advantage_analysis:** ç«¶çˆ­å„ªå‹¢åˆ†æèˆ‡é‡åŒ–è©•ä¼°
                - **gap_analysis:** ç«¶çˆ­å·®è·åˆ†æèˆ‡æ”¹å–„å»ºè­°
                - **seasonal_impact:** å­£ç¯€æ€§å› ç´ å°ç«¶çˆ­ç­–ç•¥çš„å½±éŸ¿
                - **trend_impact:** å¸‚å ´è¶¨å‹¢å°ç«¶çˆ­æ ¼å±€çš„å½±éŸ¿

                è«‹ç¢ºä¿å›å‚³çš„å…§å®¹æ˜¯ç´”ç²¹çš„ JSON æ ¼å¼ï¼Œæ²’æœ‰ä»»ä½•é¡å¤–çš„æ–‡å­—æˆ–è¨»è§£ã€‚
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        async function analyzeMarketingCalendar(context, apiKey) {
            const prompt = `
                ä½ æ˜¯ä¸€ä½è³‡æ·±çš„è¡ŒéŠ·ç­–ç•¥é¡§å•ï¼Œå°ˆé–€è¦åŠƒè¡ŒéŠ·æ™‚ç¨‹èˆ‡ç†±é»äº‹ä»¶æ•´åˆã€‚è«‹é‡å°ä»¥ä¸‹æƒ…å¢ƒé€²è¡Œè¡ŒéŠ·è¡Œäº‹æ›†åˆ†æï¼š

                **å®¢æˆ¶æƒ…å¢ƒ:**
                - **ç›®æ¨™å“ç‰Œ:** ${context.target}
                - **ç”¢æ¥­:** ${context.industry} (${context.industryStatus})
                - **ç›®æ¨™äººç¾¤:** ${context.targetAudience}
                - **è¡ŒéŠ·æœŸé–“:** ${context.startDate} è‡³ ${context.endDate}
                - **ç›®æ¨™å¸‚å ´:** ${context.targetMarkets}

                **é‡é»æ¨™è¨»è³‡è¨Šï¼š**
                - **æ´»å‹•é–‹å§‹æ—¥æœŸ:** ${context.campaignStartDate}
                - **æ´»å‹•çµæŸæ—¥æœŸ:** ${context.campaignEndDate}
                - **æ´»å‹•æŒçºŒæ™‚é–“:** ${context.campaignDuration}
                - **é‡è¦é‡Œç¨‹ç¢‘:** ${context.keyMilestones}
                - **å­£ç¯€æ€§å› ç´ :** ${context.seasonalFactors}
                - **å¸‚å ´è¶¨å‹¢:** ${context.marketTrends}

                **åˆ†æé‡é»ï¼š**
                - åˆ†æè¡ŒéŠ·æœŸé–“å…§çš„ç†±é»äº‹ä»¶èˆ‡ç¯€æ…¶
                - è­˜åˆ¥é©åˆçš„æ´»å‹•åˆä½œæ©Ÿæœƒï¼ˆæ¼”å”±æœƒã€å±•è¦½ã€é‹å‹•è³½äº‹ç­‰ï¼‰
                - è©•ä¼°å„äº‹ä»¶çš„æå‰æ´½è«‡æ™‚ç¨‹
                - å»ºè­°æœ€ä½³çš„è¡ŒéŠ·æ™‚æ©Ÿé»
                - åˆ†æç«¶çˆ­å°æ‰‹çš„è¡ŒéŠ·æ™‚ç¨‹
                - æä¾›æ™‚ç¨‹é¢¨éšªç®¡ç†å»ºè­°
                - åŸºæ–¼é‡Œç¨‹ç¢‘çš„æ™‚é–“ç·šè¦åŠƒ
                - å­£ç¯€æ€§å› ç´ å°æ™‚ç¨‹çš„å½±éŸ¿åˆ†æ
                - å¸‚å ´è¶¨å‹¢å°æ™‚æ©Ÿé¸æ“‡çš„å½±éŸ¿
                - é‡è¦ç¯€é»çš„æé†’èˆ‡æº–å‚™å»ºè­°

                **è«‹åƒè€ƒå°ç£å¸‚å ´çš„å¯¦éš›æƒ…æ³ï¼š**
                - å„æœˆä»½çš„ç¯€æ…¶èˆ‡æ´»å‹•
                - å¤§å‹æ´»å‹•çš„æå‰æ´½è«‡æ™‚ç¨‹
                - å„ç”¢æ¥­çš„è¡ŒéŠ·æ—ºå­£
                - æˆåŠŸèˆ‡å¤±æ•—çš„æ™‚ç¨‹è¦åŠƒæ¡ˆä¾‹
                - é‡Œç¨‹ç¢‘äº‹ä»¶å°è¡ŒéŠ·æ•ˆæœçš„å½±éŸ¿

                ä½ çš„ä»»å‹™æ˜¯ç”¢å‡ºä¸€å€‹ JSON ç‰©ä»¶ï¼ŒåŒ…å«ä»¥ä¸‹ keyï¼š
                "calendar_analysis", "hot_events", "partnership_opportunities", "timing_recommendations", "risk_management", "competitive_timing", "milestone_timeline", "seasonal_planning", "trend_timing", "key_dates_reminder"ã€‚

                - **calendar_analysis:** è¡ŒéŠ·æœŸé–“çš„æ•´é«”æ™‚ç¨‹åˆ†æ
                - **hot_events:** ç†±é»äº‹ä»¶æ¸…å–®èˆ‡å½±éŸ¿è©•ä¼°
                - **partnership_opportunities:** åˆä½œæ©Ÿæœƒèˆ‡æ´½è«‡æ™‚ç¨‹
                - **timing_recommendations:** æœ€ä½³æ™‚æ©Ÿé»å»ºè­°
                - **risk_management:** æ™‚ç¨‹é¢¨éšªç®¡ç†
                - **competitive_timing:** ç«¶çˆ­å°æ‰‹æ™‚ç¨‹åˆ†æ
                - **milestone_timeline:** åŸºæ–¼é‡Œç¨‹ç¢‘çš„æ™‚é–“ç·šè¦åŠƒ
                - **seasonal_planning:** å­£ç¯€æ€§å› ç´ è¦åŠƒ
                - **trend_timing:** å¸‚å ´è¶¨å‹¢æ™‚æ©Ÿåˆ†æ
                - **key_dates_reminder:** é‡è¦æ—¥æœŸæé†’èˆ‡æº–å‚™å»ºè­°

                è«‹ç¢ºä¿å›å‚³çš„å…§å®¹æ˜¯ç´”ç²¹çš„ JSON æ ¼å¼ï¼Œæ²’æœ‰ä»»ä½•é¡å¤–çš„æ–‡å­—æˆ–è¨»è§£ã€‚
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        async function analyzeCreativeStrategy(context, apiKey) {
            const prompt = `
                ä½ æ˜¯ä¸€ä½è³‡æ·±çš„å‰µæ„ç­–ç•¥ç¸½ç›£ï¼Œå°ˆé–€è¦åŠƒå‰µæ–°ä¸”æœ‰å½±éŸ¿åŠ›çš„å‰µæ„ç­–ç•¥ã€‚è«‹é‡å°ä»¥ä¸‹æƒ…å¢ƒé€²è¡Œå‰µæ„ç­–ç•¥åˆ†æï¼š

                **å®¢æˆ¶æƒ…å¢ƒ:**
                - **ç›®æ¨™å“ç‰Œ:** ${context.target}
                - **ç”¢æ¥­:** ${context.industry} (${context.industryStatus})
                - **å•†æ¥­æ¨¡å¼:** ${context.businessModel}
                - **ç›®æ¨™äººç¾¤:** ${context.targetAudience}
                - **å»£å‘Šç›®æ¨™:** ${context.adObjective}
                - **å»£å‘Šå½¢å¼:** ${context.aiRecommendMedia ? 'AIå»ºè­°' : context.selectedMedia.join(', ')}
                - **ç«¶çˆ­å°æ‰‹:** ${context.competitors}

                **å‰µæ„ç­–ç•¥è¦æ±‚ï¼š**
                - å¾å“ç‰Œæ•…äº‹è§’åº¦ï¼šå¦‚ä½•è¬›è¿°å‹•äººçš„å“ç‰Œæ•…äº‹
                - å¾æƒ…æ„Ÿé€£çµè§’åº¦ï¼šå¦‚ä½•å»ºç«‹æ·±å±¤çš„æƒ…æ„Ÿå…±é³´
                - å¾å‰µæ„è¡¨ç¾è§’åº¦ï¼šå¦‚ä½•å‰µé€ ä»¤äººå°è±¡æ·±åˆ»çš„è¦–è¦ºèˆ‡æ–‡æ¡ˆ
                - å¾äº’å‹•é«”é©—è§’åº¦ï¼šå¦‚ä½•è¨­è¨ˆåƒèˆ‡æ„Ÿå¼·çš„äº’å‹•é«”é©—
                - å¾æ–‡åŒ–æ´å¯Ÿè§’åº¦ï¼šå¦‚ä½•èå…¥åœ¨åœ°æ–‡åŒ–å…ƒç´ 
                - å¾è¶¨å‹¢å‰µæ–°è§’åº¦ï¼šå¦‚ä½•é‹ç”¨æœ€æ–°å‰µæ„è¶¨å‹¢
                - å¾å·®ç•°åŒ–è§’åº¦ï¼šå¦‚ä½•èˆ‡ç«¶çˆ­å°æ‰‹å€éš”

                **è«‹åƒè€ƒå‰µæ„ç”¢æ¥­çš„æœ€æ–°è¶¨å‹¢ï¼š**
                - å…¨çƒå‰µæ„çé …çš„å¾—çæ¡ˆä¾‹
                - ç—…æ¯’å¼å‚³æ’­çš„å‰µæ„è¡¨ç¾
                - å„åª’é«”æ¸ é“çš„å‰µæ„ç‰¹è‰²
                - æˆåŠŸèˆ‡å¤±æ•—çš„å‰µæ„æ¡ˆä¾‹

                ä½ çš„ä»»å‹™æ˜¯ç”¢å‡ºä¸€å€‹ JSON ç‰©ä»¶ï¼ŒåŒ…å«ä»¥ä¸‹ keyï¼š
                "creative_concept", "visual_strategy", "copy_strategy", "interaction_design", "cultural_elements", "trend_innovation", "execution_plan"ã€‚

                - **creative_concept:** æ ¸å¿ƒå‰µæ„æ¦‚å¿µèˆ‡æ•…äº‹ç·š
                - **visual_strategy:** è¦–è¦ºç­–ç•¥èˆ‡è¨­è¨ˆæ–¹å‘
                - **copy_strategy:** æ–‡æ¡ˆç­–ç•¥èˆ‡æºé€šè¨Šæ¯
                - **interaction_design:** äº’å‹•é«”é©—è¨­è¨ˆ
                - **cultural_elements:** æ–‡åŒ–å…ƒç´ èå…¥
                - **trend_innovation:** è¶¨å‹¢å‰µæ–°æ‡‰ç”¨
                - **execution_plan:** åŸ·è¡Œè¨ˆç•«èˆ‡æ™‚ç¨‹

                è«‹ç¢ºä¿å›å‚³çš„å…§å®¹æ˜¯ç´”ç²¹çš„ JSON æ ¼å¼ï¼Œæ²’æœ‰ä»»ä½•é¡å¤–çš„æ–‡å­—æˆ–è¨»è§£ã€‚
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        // --- Module 3: ææ¡ˆç”Ÿæˆå¼•æ“ ('åˆæˆå¼•æ“') ---
        async function synthesizeFinalReport(context, forumAnalysis, seoAnalysis, kpiEstimation, industrySentiment, budgetFeasibility, multiMarketStrategy, localizationStrategy, competitorAnalysis, marketingCalendar, creativeStrategy, apiKey) {
            try {
                // æ•¸æ“šé©—è­‰å’Œé è¨­å€¼è™•ç†
                const validatedData = {
                    forumAnalysis: forumAnalysis || {},
                    seoAnalysis: seoAnalysis || {},
                    kpiEstimation: kpiEstimation || {},
                    industrySentiment: industrySentiment || {},
                    budgetFeasibility: budgetFeasibility || {},
                    multiMarketStrategy: multiMarketStrategy || {},
                    localizationStrategy: localizationStrategy || {},
                    competitorAnalysis: competitorAnalysis || {},
                    marketingCalendar: marketingCalendar || {},
                    creativeStrategy: creativeStrategy || {}
                };

                // æª¢æŸ¥é—œéµæ•¸æ“šæ˜¯å¦å­˜åœ¨
                const missingData = [];
                if (!validatedData.forumAnalysis || Object.keys(validatedData.forumAnalysis).length === 0) {
                    missingData.push('å“ç‰Œè¼¿æƒ…åˆ†æ');
                }
                if (!validatedData.seoAnalysis || Object.keys(validatedData.seoAnalysis).length === 0) {
                    missingData.push('SEO èˆ‡å…§å®¹ç­–ç•¥åˆ†æ');
                }
                if (!validatedData.kpiEstimation || Object.keys(validatedData.kpiEstimation).length === 0) {
                    missingData.push('é ç®—èˆ‡ KPI é ä¼°');
                }

                // å¦‚æœç¼ºå°‘å¤ªå¤šé—œéµæ•¸æ“šï¼Œæä¾›è­¦å‘Š
                let dataWarning = '';
                if (missingData.length > 0) {
                    dataWarning = `
**æ•¸æ“šç¼ºå¤±è­¦å‘Šï¼š**
ç³»çµ±æª¢æ¸¬åˆ°ä»¥ä¸‹åˆ†ææ•¸æ“šç¼ºå¤±ï¼š${missingData.join('ã€')}ã€‚
è«‹æ ¹æ“šå¯ç”¨çš„æ•¸æ“šé€²è¡Œåˆ†æï¼Œå°æ–¼ç¼ºå¤±çš„éƒ¨åˆ†ï¼Œè«‹æä¾›åŸºæ–¼ç”¢æ¥­ç¶“é©—çš„ä¸€èˆ¬æ€§å»ºè­°ã€‚
`;
                }

                // æ–°å¢ï¼šå ±å‘Šæ‘˜è¦ç”Ÿæˆ
                const executiveSummary = generateExecutiveSummary(context, validatedData);
                
                // æ–°å¢ï¼šé—œéµæ´å¯Ÿæå–
                const keyInsights = extractKeyInsights(validatedData);
                
                // æ–°å¢ï¼šè¡Œå‹•å»ºè­°å„ªå…ˆç´šæ’åº
                const prioritizedRecommendations = prioritizeRecommendations(context, validatedData);

                const prompt = `
                ä½ æ˜¯ä¸€ä½é¦–å¸­åª’é«”ç­–ç•¥ç¸½ç›£ï¼Œå…·å‚™ç­–ç•¥æ€è€ƒçš„é«˜åº¦èˆ‡å­¸ç¿’èƒ½åŠ›ã€‚ä½ çš„ä»»å‹™æ˜¯å°‡ä¸‹å±¬åˆ†æå¸«æäº¤çš„æ‰€æœ‰ JSON è³‡æ–™ï¼Œæ•´åˆæˆä¸€ä»½çµ¦å®¢æˆ¶çœ‹çš„ã€å°ˆæ¥­ä¸”æœ‰èªªæœåŠ›çš„ã€Œå¸‚å ´æ©Ÿæœƒèˆ‡åˆæ­¥ç­–ç•¥å»ºè­°ã€å ±å‘Šã€‚å ±å‘Šéœ€ä»¥ HTML æ ¼å¼å‘ˆç¾ã€‚

                **å®¢æˆ¶è³‡æ–™:**
                - **ç›®æ¨™å“ç‰Œ:** ${context.target}
                - **æ ¸å¿ƒç›®æ¨™äººç¾¤:** ${context.targetAudience}
                - **å“ç‰Œè¡ŒéŠ·å•é¡Œ:** ${context.marketingProblems}
                - **ç¸½é ç®— (TWD):** ${context.budget > 0 ? context.budget.toLocaleString() : 'æœªæä¾›'}
                - **å»£å‘Šç›®æ¨™èˆ‡ç›®çš„:** ${context.adObjective}
                - **å»£å‘Šå½¢å¼:** ${context.aiRecommendMedia ? 'AIå»ºè­°' : context.selectedMedia.join(', ')}
                - **ç›®æ¨™å¸‚å ´:** ${context.targetMarkets}
                - **ç›®æ¨™èªè¨€:** ${context.targetLanguages}
                - **è¡ŒéŠ·æœŸé–“:** ${context.startDate} è‡³ ${context.endDate}
                - **ç”¢æ¥­ç‹€æ…‹:** ${context.industryStatus}

                **é‡é»æ¨™è¨»è³‡è¨Š:**
                - **æ´»å‹•æ™‚é–“æ®µ:** ${context.campaignStartDate} è‡³ ${context.campaignEndDate} (${context.campaignDuration})
                - **é‡è¦é‡Œç¨‹ç¢‘:** ${context.keyMilestones}
                - **ç«¶çˆ­å°æ‰‹æ™‚é–“ç·š:** ${context.competitorTimeline}
                - **ç«¶çˆ­å„ªå‹¢:** ${context.competitiveAdvantage}
                - **ç«¶çˆ­å·®è·:** ${context.competitiveGaps}
                - **å­£ç¯€æ€§å› ç´ :** ${context.seasonalFactors}
                - **å¸‚å ´è¶¨å‹¢:** ${context.marketTrends}
                - **é‡é»æ¨™è¨»è¨­å®š:** æ™‚é–“ç·šè¦–è¦ºåŒ–(${context.highlightTimeline}), ç«¶çˆ­å°æ‰‹æ¯”è¼ƒ(${context.highlightCompetitors}), å¸‚å ´æ©Ÿæœƒé»(${context.highlightOpportunities}), é‡è¦é‡Œç¨‹ç¢‘(${context.highlightMilestones}), é¢¨éšªè©•ä¼°(${context.highlightRisks}), é—œéµç¸¾æ•ˆæŒ‡æ¨™(${context.highlightKPIs})

                ${dataWarning}

                **åˆ†æå¸«æäº¤çš„è³‡æ–™:**
                1.  **å“ç‰Œè¼¿æƒ…åˆ†æ:** ${JSON.stringify(validatedData.forumAnalysis, null, 2)}
                2.  **ç”¢æ¥­è¼¿æƒ…ç›£æ¸¬:** ${JSON.stringify(validatedData.industrySentiment, null, 2)}
                3.  **SEO èˆ‡å…§å®¹ç­–ç•¥åˆ†æ:** ${JSON.stringify(validatedData.seoAnalysis, null, 2)}
                4.  **é ç®—èˆ‡ KPI é ä¼°:** ${JSON.stringify(validatedData.kpiEstimation, null, 2)}
                5.  **é ç®—å¯è¡Œæ€§åˆ†æ:** ${JSON.stringify(validatedData.budgetFeasibility, null, 2)}
                6.  **å¤šå¸‚å ´ç­–ç•¥åˆ†æ:** ${JSON.stringify(validatedData.multiMarketStrategy, null, 2)}
                7.  **åœ¨åœ°åŒ–ç­–ç•¥åˆ†æ:** ${JSON.stringify(validatedData.localizationStrategy, null, 2)}
                8.  **ç«¶çˆ­å°æ‰‹åˆ†æ:** ${JSON.stringify(validatedData.competitorAnalysis, null, 2)}
                9.  **è¡ŒéŠ·è¡Œäº‹æ›†åˆ†æ:** ${JSON.stringify(validatedData.marketingCalendar, null, 2)}
                10. **å‰µæ„ç­–ç•¥åˆ†æ:** ${JSON.stringify(validatedData.creativeStrategy, null, 2)}

                **é‡è¦è™•ç†åŸå‰‡ï¼š**
                - å¦‚æœæŸå€‹æ•¸æ“šæ¬„ä½ç‚ºç©ºæˆ– nullï¼Œè«‹ä¸è¦é¡¯ç¤ºã€Œå› è³‡æ–™ç¼ºå¤±ï¼Œæ­¤è™•ç„¡æ³•å‘ˆç¾ã€çš„è¨Šæ¯
                - å°æ–¼ç¼ºå¤±çš„æ•¸æ“šï¼Œè«‹åŸºæ–¼ç”¢æ¥­ç¶“é©—å’Œå¸¸è­˜æä¾›åˆç†çš„æ¨æ¸¬æˆ–ä¸€èˆ¬æ€§å»ºè­°
                - ç¢ºä¿å ±å‘Šçš„å®Œæ•´æ€§å’Œå°ˆæ¥­æ€§ï¼Œä¸è¦å› ç‚ºæ•¸æ“šç¼ºå¤±è€Œå½±éŸ¿å ±å‘Šçš„çµæ§‹
                - å¦‚æœ kpiEstimation.rationale æˆ– kpiEstimation.feasibility_warning ç­‰æ¬„ä½ç¼ºå¤±ï¼Œè«‹æä¾›åŸºæ–¼é ç®—å’Œç›®æ¨™çš„åˆç†åˆ†æ
                - **æ–°å¢ï¼šä½¿ç”¨æ›´æ¸…æ™°çš„è¦–è¦ºå±¤æ¬¡å’Œçµæ§‹åŒ–å‘ˆç¾**
                - **æ–°å¢ï¼šç‚ºæ¯å€‹ç« ç¯€æ·»åŠ åŸ·è¡Œæ‘˜è¦å’Œé—œéµè¦é»**
                - **æ–°å¢ï¼šä½¿ç”¨åœ–è¡¨ã€è¡¨æ ¼å’Œè¦–è¦ºå…ƒç´ å¢å¼·å¯è®€æ€§**

                **ç­–ç•¥æ€è€ƒæ¡†æ¶ï¼š**
                - å¾å“ç‰Œç­–ç•¥è§’åº¦ï¼šå¦‚ä½•å»ºç«‹é•·æœŸå“ç‰Œè³‡ç”¢ã€å¸‚å ´å®šä½
                - å¾ç«¶çˆ­ç­–ç•¥è§’åº¦ï¼šå¦‚ä½•åœ¨ç«¶çˆ­ä¸­è„«ç©è€Œå‡ºã€å»ºç«‹è­·åŸæ²³
                - å¾å­¸ç¿’è§’åº¦ï¼šå¾æˆåŠŸæ¡ˆä¾‹ä¸­å­¸ç¿’ã€é¿å…å¤±æ•—é™·é˜±
                - å¾å‰µæ–°è§’åº¦ï¼šæ–°èˆˆæ©Ÿæœƒã€æœªä¾†è¶¨å‹¢ã€é¡›è¦†æ€§æ€ç¶­
                - å¾å¯è¡Œæ€§è§’åº¦ï¼šé ç®—èˆ‡ç›®æ¨™çš„åŒ¹é…åº¦ï¼Œæä¾›å‹™å¯¦å»ºè­°
                - å¾åœ‹éš›åŒ–è§’åº¦ï¼šè·¨å¸‚å ´å“ç‰Œä¸€è‡´æ€§èˆ‡åœ¨åœ°åŒ–å¹³è¡¡
                - **å¾å‰µæ„è§’åº¦ï¼šå¦‚ä½•å‰µé€ ä»¤äººå°è±¡æ·±åˆ»çš„å“ç‰Œé«”é©—**

                **ä½ çš„ä»»å‹™:**
                è«‹æ ¹æ“šä»¥ä¸Šæ‰€æœ‰è³‡è¨Šï¼Œæ’°å¯«ä¸€ä»½åŒ…å«ä»¥ä¸‹ç« ç¯€çš„ HTML å ±å‘Šï¼Œä¸¦åœ¨ä½ çš„åˆ†æèˆ‡å»ºè­°ä¸­ï¼Œ**å§‹çµ‚ç·Šæ‰£å¦‚ä½•æ‰“å‹•ã€Œ${context.targetAudience}ã€é€™å€‹æ ¸å¿ƒç›®æ¨™äººç¾¤**ï¼Œä¸¦å¼·èª¿ï¼š
                - ç«¶å“åª’é«”ç­–ç•¥ã€å‰µæ„è¡¨ç¾ã€æœ€æ–°å¸‚å ´å‹•æ…‹
                - å‰µæ„è¶¨å‹¢èˆ‡æ¶ˆè²»è€…è¡Œç‚ºè®ŠåŒ–
                - åƒè€ƒå¯æŸ¥è©¢çš„å¸‚å ´æˆæ•ˆæ•¸æ“š
                - æ ¹æ“šå»£å‘Šç›®æ¨™èˆ‡ç›®çš„ï¼Œèª¿æ•´æ¯ä¸€ç« ç¯€çš„é‡é»èˆ‡å»ºè­°
                - å¾ç­–ç•¥é«˜åº¦æä¾›é•·æœŸç™¼å±•å»ºè­°
                - å¾å­¸ç¿’è§’åº¦ç¸½çµæœ€ä½³å¯¦è¸
                - ç”¢æ¥­è¼¿æƒ…ç‹€æ³èˆ‡æ©Ÿæœƒé»
                - é ç®—å¯è¡Œæ€§èˆ‡å‹™å¯¦å»ºè­°
                - å¤šå¸‚å ´ç­–ç•¥èˆ‡åœ¨åœ°åŒ–è€ƒé‡
                - **ç«¶çˆ­å°æ‰‹æ·±åº¦åˆ†æèˆ‡å·®ç•°åŒ–ç­–ç•¥**
                - **è¡ŒéŠ·æ™‚ç¨‹è¦åŠƒèˆ‡ç†±é»äº‹ä»¶æ•´åˆ**
                - **å‰µæ„ç­–ç•¥èˆ‡å“ç‰Œé«”é©—è¨­è¨ˆ**

                0.  **<h2>ğŸ“‹ åŸ·è¡Œæ‘˜è¦</h2>**
                    - ä¸€æ®µç°¡çŸ­ä½†æœ‰åŠ›çš„æ‘˜è¦ï¼Œæ¦‚è¿°æ•´å€‹ç­–ç•¥çš„æ ¸å¿ƒè¦é»
                    - åŒ…å«é—œéµæ´å¯Ÿã€ä¸»è¦å»ºè­°å’Œé æœŸæ•ˆç›Š
                    - ä½¿ç”¨ <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-400"> æ¨£å¼çªå‡ºé¡¯ç¤º

                1.  **<h2>ğŸ¯ å¸‚å ´ç¸½é«”å°è±¡</h2>**
                    - ä¸€æ®µç°¡çŸ­ç¸½çµï¼Œé»å‡º ${context.target} ç›®å‰åœ¨ã€Œ${context.targetAudience}ã€å¿ƒä¸­çš„å½¢è±¡èˆ‡æŒ‘æˆ°ã€‚
                    - ä½¿ç”¨ <div class="bg-gray-50 p-3 rounded border"> æ¨£å¼å‘ˆç¾é—œéµæ´å¯Ÿ

                2.  **<h2>ğŸ“Š ç”¢æ¥­è¼¿æƒ…ç›£æ¸¬</h2>**
                    -   <h3>ç”¢æ¥­æ¦‚æ³</h3>
                    -   <h3>ç†±é–€è©±é¡Œèˆ‡è¶¨å‹¢</h3>
                    -   <h3>ç«¶çˆ­å“ç‰Œè¼¿æƒ…è¡¨ç¾</h3>
                    -   <h3>æ¶ˆè²»è€…æ´å¯Ÿ</h3>
                    -   **æ–°å¢ï¼š<h3>ğŸ“ˆ è¼¿æƒ…è¶¨å‹¢åœ–è¡¨</h3>** (ä½¿ç”¨ HTML è¡¨æ ¼æ¨¡æ“¬åœ–è¡¨)

                3.  **<h2>âš”ï¸ ç«¶çˆ­å°æ‰‹æ·±åº¦åˆ†æ</h2>**
                    -   <h3>ç«¶çˆ­å°æ‰‹å“ç‰Œåˆ†æ</h3>
                    -   <h3>å¸‚å ´å®šä½æ¯”è¼ƒ</h3>
                    -   <h3>åª’é«”ç­–ç•¥åˆ†æ</h3>
                    -   <h3>å·®ç•°åŒ–æ©Ÿæœƒé»</h3>
                    ${context.highlightCompetitors ? '-   <h3>ç«¶çˆ­å°æ‰‹æ™‚é–“ç·šåˆ†æ</h3>' : ''}
                    ${context.highlightCompetitors ? '-   <h3>ç«¶çˆ­å„ªå‹¢èˆ‡å·®è·åˆ†æ</h3>' : ''}
                    ${context.highlightCompetitors ? '-   <h3>å­£ç¯€æ€§å› ç´ å½±éŸ¿åˆ†æ</h3>' : ''}
                    ${context.highlightCompetitors ? '-   <h3>å¸‚å ´è¶¨å‹¢å°ç«¶çˆ­æ ¼å±€çš„å½±éŸ¿</h3>' : ''}
                    -   **æ–°å¢ï¼š<h3>ğŸ† ç«¶çˆ­åŠ›è©•åˆ†è¡¨</h3>** (ä½¿ç”¨ HTML è¡¨æ ¼å‘ˆç¾å„ç¶­åº¦è©•åˆ†)

                4.  **<h2>ğŸŒ å¤šå¸‚å ´ç­–ç•¥åˆ†æ</h2>**
                    -   <h3>ç›®æ¨™å¸‚å ´åˆ†æ</h3>
                    -   <h3>è·¨å¸‚å ´é ç®—åˆ†é…</h3>
                    -   <h3>åœ¨åœ°åŒ–ç­–ç•¥å»ºè­°</h3>
                    -   <h3>æ–‡åŒ–è€ƒé‡èˆ‡é¢¨éšªç®¡ç†</h3>
                    -   **æ–°å¢ï¼š<h3>ğŸ—ºï¸ å¸‚å ´æ©Ÿæœƒåœ°åœ–</h3>** (ä½¿ç”¨è¦–è¦ºåŒ–è¡¨æ ¼å‘ˆç¾)

                5.  **<h2>ğŸ’¡ æ ¸å¿ƒæ´å¯Ÿèˆ‡æ©Ÿæœƒé»</h2>**
                    -   <h3>æ´å¯Ÿä¸€ï¼šç›®æ¨™äººç¾¤çš„çœŸå¯¦å¿ƒè²</h3>
                    -   <h3>æ´å¯ŸäºŒï¼šæœå°‹æˆ°å ´çš„å…§å®¹ç¼ºå£</h3>
                    -   <h3>æ´å¯Ÿä¸‰ï¼šç”¢æ¥­è¼¿æƒ…æ©Ÿæœƒé»</h3>
                    -   <h3>æ´å¯Ÿå››ï¼šç«¶çˆ­å°æ‰‹æ©Ÿæœƒé»</h3>
                    -   <h3>æ´å¯Ÿäº”ï¼šè·¨å¸‚å ´æ©Ÿæœƒé»</h3>
                    ${context.highlightOpportunities ? '-   <h3>æ´å¯Ÿå…­ï¼šå¸‚å ´æ™‚æ©Ÿèˆ‡æ©Ÿæœƒé»åˆ†æ</h3>' : ''}
                    -   <h3>ç­–ç•¥æ©Ÿæœƒé»ï¼šæˆ‘å€‘è©²å¾ä½•è™•åˆ‡å…¥ï¼Ÿ</h3>
                    -   **æ–°å¢ï¼š<h3>ğŸ¯ æ©Ÿæœƒé»å„ªå…ˆç´šçŸ©é™£</h3>** (ä½¿ç”¨è¡¨æ ¼å‘ˆç¾æ©Ÿæœƒé»è©•ä¼°)

                6.  **<h2>ğŸ’° é ç®—å¯è¡Œæ€§è©•ä¼°</h2>**
                    -   <h3>å¯è¡Œæ€§è©•ä¼°</h3>
                    -   <h3>é ç®—å»ºè­°</h3>
                    -   <h3>æ›¿ä»£ç­–ç•¥</h3>
                    -   <h3>é¢¨éšªåˆ†æ</h3>
                    ${context.highlightRisks ? '-   <h3>é¢¨éšªè©•ä¼°èˆ‡ç®¡ç†å»ºè­°</h3>' : ''}
                    -   **æ–°å¢ï¼š<h3>ğŸ“Š é ç®—æ•ˆç›Šåˆ†æåœ–</h3>** (ä½¿ç”¨è¡¨æ ¼å‘ˆç¾ä¸åŒé ç®—è¦æ¨¡çš„æ•ˆç›Š)

                7.  **<h2>ğŸ¨ å‰µæ„ç­–ç•¥è¦åŠƒ</h2>**
                    -   <h3>æ ¸å¿ƒå‰µæ„æ¦‚å¿µ</h3>
                    -   <h3>è¦–è¦ºèˆ‡æ–‡æ¡ˆç­–ç•¥</h3>
                    -   <h3>äº’å‹•é«”é©—è¨­è¨ˆ</h3>
                    -   <h3>æ–‡åŒ–å…ƒç´ èå…¥</h3>
                    -   <h3>è¶¨å‹¢å‰µæ–°æ‡‰ç”¨</h3>
                    -   **æ–°å¢ï¼š<h3>ğŸ­ å‰µæ„è¡¨ç¾é¢¨æ ¼æŒ‡å—</h3>** (ä½¿ç”¨è¦–è¦ºåŒ–å‘ˆç¾)

                8.  **<h2>ğŸ“… è¡ŒéŠ·æ™‚ç¨‹è¦åŠƒ</h2>**
                    -   <h3>ç†±é»äº‹ä»¶åˆ†æ</h3>
                    -   <h3>åˆä½œæ©Ÿæœƒè­˜åˆ¥</h3>
                    -   <h3>æœ€ä½³æ™‚æ©Ÿå»ºè­°</h3>
                    -   <h3>é¢¨éšªç®¡ç†</h3>
                    ${context.highlightTimeline ? '-   <h3>æ™‚é–“ç·šè¦–è¦ºåŒ–è¦åŠƒ</h3>' : ''}
                    ${context.highlightMilestones ? '-   <h3>é‡è¦é‡Œç¨‹ç¢‘æé†’</h3>' : ''}
                    ${context.highlightMilestones ? '-   <h3>å­£ç¯€æ€§å› ç´ è¦åŠƒ</h3>' : ''}
                    ${context.highlightMilestones ? '-   <h3>å¸‚å ´è¶¨å‹¢æ™‚æ©Ÿåˆ†æ</h3>' : ''}
                    -   **æ–°å¢ï¼š<h3>ğŸ“‹ æ™‚ç¨‹ç”˜ç‰¹åœ–</h3>** (ä½¿ç”¨ HTML è¡¨æ ¼æ¨¡æ“¬ç”˜ç‰¹åœ–)
                
                9.  **<h2>ğŸš€ åˆæ­¥ç­–ç•¥å»ºè­°</h2>**
                    -   <h3>å»ºè­°ä¸€ï¼šå…§å®¹ç­–ç•¥æ–¹å‘</h3>
                    -   <h3>å»ºè­°äºŒï¼šæºé€šè¨Šæ¯åˆ‡è§’</h3>
                    -   <h3>å»ºè­°ä¸‰ï¼šå‰µæ„èˆ‡åª’é«”å»ºè­°ï¼ˆè«‹æ ¹æ“šæœ€æ–°å¸‚å ´è¶¨å‹¢èˆ‡ç«¶å“ç­–ç•¥ï¼‰</h3>
                    -   <h3>å»ºè­°å››ï¼šå¤šå¸‚å ´åŸ·è¡Œç­–ç•¥</h3>
                    -   <h3>å»ºè­°äº”ï¼šåœ¨åœ°åŒ–èˆ‡æ–‡åŒ–é©æ‡‰</h3>
                    -   <h3>å»ºè­°å…­ï¼šç«¶çˆ­ç­–ç•¥èˆ‡å·®ç•°åŒ–</h3>
                    -   <h3>å»ºè­°ä¸ƒï¼šæ™‚ç¨‹è¦åŠƒèˆ‡åŸ·è¡Œ</h3>
                    -   <h3>å»ºè­°å…«ï¼šé•·æœŸç­–ç•¥æ€è€ƒï¼ˆå¾å“ç‰Œç™¼å±•ã€ç«¶çˆ­å„ªå‹¢è§’åº¦ï¼‰</h3>
                    -   <h3>å»ºè­°ä¹ï¼šé ç®—å„ªåŒ–ç­–ç•¥ï¼ˆå¦‚ä½•åœ¨æœ‰é™é ç®—ä¸‹æœ€å¤§åŒ–æ•ˆç›Šï¼‰</h3>
                    ${context.highlightCompetitors ? '-   <h3>å»ºè­°åï¼šç«¶çˆ­å°æ‰‹æ‡‰å°ç­–ç•¥</h3>' : ''}
                    ${context.highlightOpportunities ? '-   <h3>å»ºè­°åä¸€ï¼šå¸‚å ´æ™‚æ©ŸæŠŠæ¡ç­–ç•¥</h3>' : ''}
                    ${context.highlightMilestones ? '-   <h3>å»ºè­°åäºŒï¼šé‡Œç¨‹ç¢‘ç®¡ç†ç­–ç•¥</h3>' : ''}
                    ${context.highlightRisks ? '-   <h3>å»ºè­°åä¸‰ï¼šé¢¨éšªç®¡ç†èˆ‡æ‡‰æ€¥ç­–ç•¥</h3>' : ''}
                    ${context.highlightKPIs ? '-   <h3>å»ºè­°åå››ï¼šé—œéµç¸¾æ•ˆæŒ‡æ¨™è¨­å®šèˆ‡è¿½è¹¤</h3>' : ''}
                    -   **æ–°å¢ï¼š<h3>ğŸ¯ è¡Œå‹•è¨ˆåŠƒå„ªå…ˆç´š</h3>** (ä½¿ç”¨è¡¨æ ¼å‘ˆç¾å»ºè­°çš„å„ªå…ˆç´šå’Œæ™‚é–“å®‰æ’)
                
                10. **<h2>ğŸ“ˆ é ç®—è¦åŠƒèˆ‡é æœŸæ•ˆç›Š</h2>**
                    -   <p>åŸºæ–¼å°å¹£ **${context.budget > 0 ? context.budget.toLocaleString() : 'æœªæä¾›'}** çš„é ç®—ï¼Œæˆ‘å€‘å»ºè­°åˆæ­¥çš„è³‡æºåˆ†é…èˆ‡æ•ˆç›Šé ä¼°å¦‚ä¸‹ï¼š</p>
                    -   <h3>è·¨å¸‚å ´é ç®—åˆ†é…</h3>
                    -   (å¦‚æœ multiMarketStrategy.budget_allocation å­˜åœ¨ï¼Œä½¿ç”¨ HTML table å‘ˆç¾ï¼›å¦å‰‡æä¾›ä¸€èˆ¬æ€§é ç®—åˆ†é…å»ºè­°)
                    -   <h3>é ç®—åˆ†é…å»ºè­°</h3>
                    -   (å¦‚æœ kpiEstimation.budget_allocation å­˜åœ¨ï¼Œä½¿ç”¨ HTML table å‘ˆç¾ï¼›å¦å‰‡æä¾›åŸºæ–¼é ç®—çš„ä¸€èˆ¬æ€§åˆ†é…å»ºè­°)
                    -   <h3>é æœŸæ•ˆç›Š (KPI) ä¼°ç®—</h3>
                    -   (å¦‚æœ kpiEstimation.kpi_estimations å­˜åœ¨ï¼Œä½¿ç”¨ HTML table å‘ˆç¾ï¼›å¦å‰‡æä¾›åŸºæ–¼é ç®—å’Œç›®æ¨™çš„ä¸€èˆ¬æ€§æ•ˆç›Šé ä¼°)
                    -   <h3>è¦åŠƒèªªæ˜</h3>
                    -   (å¦‚æœ kpiEstimation.rationale å­˜åœ¨ï¼Œç”¨ <p> å‘ˆç¾ï¼›å¦å‰‡æä¾›åŸºæ–¼é ç®—å’Œç›®æ¨™çš„è¦åŠƒèªªæ˜)
                    -   <h3>å¯è¡Œæ€§è­¦å‘Š</h3>
                    -   (å¦‚æœ kpiEstimation.feasibility_warning å­˜åœ¨ï¼Œç”¨ <p> å‘ˆç¾ï¼›å¦å‰‡æä¾›åŸºæ–¼é ç®—çš„å¯è¡Œæ€§è©•ä¼°)
                    -   <h3>é ç®—å„ªåŒ–å»ºè­°</h3>
                    -   (å¦‚æœ kpiEstimation.budget_optimization å­˜åœ¨ï¼Œç”¨ <ul> å‘ˆç¾ï¼›å¦å‰‡æä¾›ä¸€èˆ¬æ€§é ç®—å„ªåŒ–å»ºè­°)
                    -   <h3>åƒè€ƒæ•¸æ“š</h3>
                    -   (å¦‚æœ kpiEstimation.reference_data æˆ– forumAnalysis.reference_data å­˜åœ¨ï¼Œç”¨ <ul> å‘ˆç¾ï¼›å¦å‰‡æä¾›ç”¢æ¥­ä¸€èˆ¬æ€§åƒè€ƒæ•¸æ“š)
                    -   <h3>ç­–ç•¥å»ºè­°</h3>
                    -   (å¦‚æœ kpiEstimation.strategic_recommendations å­˜åœ¨ï¼Œç”¨ <ul> å‘ˆç¾ï¼›å¦å‰‡æä¾›åŸºæ–¼é ç®—å’Œç›®æ¨™çš„ç­–ç•¥å»ºè­°)
                    -   <h3>å­¸ç¿’æ´å¯Ÿ</h3>
                    -   (å¦‚æœ kpiEstimation.learning_insights æˆ– forumAnalysis.learning_cases å­˜åœ¨ï¼Œç”¨ <ul> å‘ˆç¾ï¼›å¦å‰‡æä¾›åŸºæ–¼ç”¢æ¥­ç¶“é©—çš„å­¸ç¿’æ´å¯Ÿ)
                    -   **æ–°å¢ï¼š<h3>ğŸ“Š ROI é æ¸¬æ¨¡å‹</h3>** (ä½¿ç”¨è¡¨æ ¼å‘ˆç¾ä¸åŒæŠ•è³‡è¦æ¨¡çš„é æœŸå›å ±)

                11. **<h2>ğŸ“‹ ä¸‹ä¸€æ­¥è¡Œå‹•è¨ˆåŠƒ</h2>**
                    -   <h3>ç«‹å³è¡Œå‹•é …ç›® (1-2é€±å…§)</h3>
                    -   <h3>çŸ­æœŸè¡Œå‹•é …ç›® (1å€‹æœˆå…§)</h3>
                    -   <h3>ä¸­æœŸè¡Œå‹•é …ç›® (3å€‹æœˆå…§)</h3>
                    -   <h3>é•·æœŸç­–ç•¥è¦åŠƒ (6-12å€‹æœˆ)</h3>
                    -   <h3>é—œéµæˆåŠŸå› ç´ </h3>
                    -   <h3>é¢¨éšªç›£æ§æŒ‡æ¨™</h3>
                
                **æ ¼å¼è¦æ±‚:**
                -   è«‹åš´æ ¼ä½¿ç”¨ <h2> å’Œ <h3> ä½œç‚ºæ¨™é¡Œã€‚
                -   æ®µè½ä½¿ç”¨ <p>ï¼Œåˆ—è¡¨ä½¿ç”¨ <ul> å’Œ <li>ã€‚è¡¨æ ¼ä½¿ç”¨ <table>, <th>, <tr>, <td>ã€‚
                -   å°æ–¼å“ç‰Œåç¨±æˆ–é—œéµå­—è©ï¼Œä½¿ç”¨ <strong> æ¨™ç±¤å¼·èª¿ã€‚
                -   å›æ‡‰å…§å®¹**åƒ…åŒ…å« HTML**ï¼Œä¸è¦åŒ…å« \`\`\`html, \`\`\`, <html>, <body> ç­‰æ¨™ç±¤ã€‚
                -   **çµ•å°ä¸è¦é¡¯ç¤ºã€Œå› è³‡æ–™ç¼ºå¤±ï¼Œæ­¤è™•ç„¡æ³•å‘ˆç¾ã€ä¹‹é¡çš„è¨Šæ¯**ï¼Œè«‹æä¾›åˆç†çš„æ›¿ä»£å…§å®¹ã€‚
                -   **æ–°å¢ï¼šä½¿ç”¨æ›´å¤šè¦–è¦ºå…ƒç´ ï¼Œå¦‚èƒŒæ™¯è‰²ã€é‚Šæ¡†ã€åœ–æ¨™ç­‰å¢å¼·å¯è®€æ€§**
                -   **æ–°å¢ï¼šç‚ºé‡è¦æ•¸æ“šä½¿ç”¨ <span class="text-blue-600 font-semibold"> æ¨£å¼çªå‡ºé¡¯ç¤º**
                -   **æ–°å¢ï¼šä½¿ç”¨ <div class="bg-yellow-50 p-3 rounded border-l-4 border-yellow-400"> æ¨£å¼çªå‡ºé¡¯ç¤ºé‡è¦æé†’**
            `;
                
                console.log('é–‹å§‹ç”Ÿæˆæœ€çµ‚å ±å‘Š...');
                const result = await callGeminiAPI(prompt, apiKey, false);
                console.log('æœ€çµ‚å ±å‘Šç”Ÿæˆå®Œæˆ');
                return result;
                
            } catch (error) {
                console.error('ç”Ÿæˆæœ€çµ‚å ±å‘Šæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                
                // æä¾›éŒ¯èª¤å›é€€æ–¹æ¡ˆ
                return `
                    <div class="p-6 bg-red-50 border border-red-200 rounded-lg">
                        <h2 class="text-xl font-bold text-red-800 mb-4">å ±å‘Šç”Ÿæˆå¤±æ•—</h2>
                        <p class="text-red-700 mb-4">æŠ±æ­‰ï¼Œåœ¨ç”Ÿæˆæœ€çµ‚å ±å‘Šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}</p>
                        <div class="bg-white p-4 rounded border">
                            <h3 class="font-semibold text-gray-800 mb-2">å¯ç”¨çš„åˆ†ææ•¸æ“šï¼š</h3>
                            <ul class="text-sm text-gray-600 space-y-1">
                                <li>â€¢ å“ç‰Œè¼¿æƒ…åˆ†æï¼š${forumAnalysis ? 'âœ“ å¯ç”¨' : 'âœ— ç¼ºå¤±'}</li>
                                <li>â€¢ SEO èˆ‡å…§å®¹ç­–ç•¥ï¼š${seoAnalysis ? 'âœ“ å¯ç”¨' : 'âœ— ç¼ºå¤±'}</li>
                                <li>â€¢ é ç®—èˆ‡ KPI é ä¼°ï¼š${kpiEstimation ? 'âœ“ å¯ç”¨' : 'âœ— ç¼ºå¤±'}</li>
                                <li>â€¢ ç”¢æ¥­è¼¿æƒ…ç›£æ¸¬ï¼š${industrySentiment ? 'âœ“ å¯ç”¨' : 'âœ— ç¼ºå¤±'}</li>
                                <li>â€¢ é ç®—å¯è¡Œæ€§åˆ†æï¼š${budgetFeasibility ? 'âœ“ å¯ç”¨' : 'âœ— ç¼ºå¤±'}</li>
                            </ul>
                        </div>
                        <p class="mt-4 text-sm text-red-600">è«‹æª¢æŸ¥ API é€£æ¥ç‹€æ…‹ï¼Œç„¶å¾Œé‡æ–°ç”Ÿæˆå ±å‘Šã€‚</p>
                    </div>
                `;
            }
        }

        // æ–°å¢ï¼šç”ŸæˆåŸ·è¡Œæ‘˜è¦
        function generateExecutiveSummary(context, validatedData) {
            const summary = {
                brand: context.target,
                targetAudience: context.targetAudience,
                budget: context.budget,
                objective: context.adObjective,
                keyInsights: [],
                recommendations: [],
                expectedOutcomes: []
            };
            
            // å¾å„åˆ†æçµæœä¸­æå–é—œéµæ´å¯Ÿ
            if (validatedData.forumAnalysis && validatedData.forumAnalysis.market_opportunity) {
                summary.keyInsights.push(validatedData.forumAnalysis.market_opportunity);
            }
            
            if (validatedData.seoAnalysis && validatedData.seoAnalysis.content_gap_opportunity) {
                summary.keyInsights.push(validatedData.seoAnalysis.content_gap_opportunity);
            }
            
            return summary;
        }

        // æ–°å¢ï¼šæå–é—œéµæ´å¯Ÿ
        function extractKeyInsights(validatedData) {
            const insights = [];
            
            // å¾è¼¿æƒ…åˆ†æä¸­æå–æ´å¯Ÿ
            if (validatedData.forumAnalysis) {
                if (validatedData.forumAnalysis.target_pros) {
                    insights.push({ type: 'å„ªå‹¢', content: validatedData.forumAnalysis.target_pros });
                }
                if (validatedData.forumAnalysis.target_cons) {
                    insights.push({ type: 'æŒ‘æˆ°', content: validatedData.forumAnalysis.target_cons });
                }
            }
            
            // å¾ç«¶çˆ­å°æ‰‹åˆ†æä¸­æå–æ´å¯Ÿ
            if (validatedData.competitorAnalysis) {
                if (validatedData.competitorAnalysis.opportunities) {
                    insights.push({ type: 'æ©Ÿæœƒ', content: validatedData.competitorAnalysis.opportunities });
                }
            }
            
            return insights;
        }

        // æ–°å¢ï¼šå„ªå…ˆç´šæ’åºå»ºè­°
        function prioritizeRecommendations(context, validatedData) {
            const recommendations = [];
            
            // åŸºæ–¼é ç®—å¯è¡Œæ€§æ’åº
            if (validatedData.budgetFeasibility) {
                if (validatedData.budgetFeasibility.feasibility_assessment === 'ä½') {
                    recommendations.push({ priority: 'é«˜', type: 'é ç®—èª¿æ•´', content: 'éœ€è¦å¢åŠ é ç®—æˆ–èª¿æ•´ç›®æ¨™' });
                }
            }
            
            // åŸºæ–¼ç«¶çˆ­å°æ‰‹åˆ†ææ’åº
            if (validatedData.competitorAnalysis) {
                if (validatedData.competitorAnalysis.threats) {
                    recommendations.push({ priority: 'é«˜', type: 'ç«¶çˆ­æ‡‰å°', content: 'åˆ¶å®šç«¶çˆ­å°æ‰‹æ‡‰å°ç­–ç•¥' });
                }
            }
            
            return recommendations.sort((a, b) => {
                const priorityOrder = { 'é«˜': 1, 'ä¸­': 2, 'ä½': 3 };
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            });
        }

        // æ–°å¢ï¼šå ±å‘Šå°å‡ºåŠŸèƒ½
        function initializeExportFunctions() {
            const exportControls = document.getElementById('exportControls');
            const exportPDF = document.getElementById('exportPDF');
            const exportWord = document.getElementById('exportWord');
            const exportPPT = document.getElementById('exportPPT');
            const shareReport = document.getElementById('shareReport');

            // é¡¯ç¤ºå°å‡ºæ§åˆ¶é …
            if (exportControls) {
                exportControls.style.display = 'flex';
            }

            // PDF åŒ¯å‡ºåŠŸèƒ½
            if (exportPDF) {
                exportPDF.addEventListener('click', async () => {
                    try {
                        exportPDF.disabled = true;
                        exportPDF.innerHTML = '<svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>è™•ç†ä¸­...';
                        
                        await exportToPDF();
                        
                        exportPDF.innerHTML = '<svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>åŒ¯å‡ºæˆåŠŸ';
                        setTimeout(() => {
                            exportPDF.disabled = false;
                            exportPDF.innerHTML = '<svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V8z" clip-rule="evenodd"></path></svg>åŒ¯å‡º PDF';
                        }, 2000);
                    } catch (error) {
                        console.error('PDF åŒ¯å‡ºå¤±æ•—:', error);
                        exportPDF.disabled = false;
                        exportPDF.innerHTML = '<svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>åŒ¯å‡ºå¤±æ•—';
                    }
                });
            }

            // Word åŒ¯å‡ºåŠŸèƒ½
            if (exportWord) {
                exportWord.addEventListener('click', async () => {
                    try {
                        exportWord.disabled = true;
                        exportWord.innerHTML = '<svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>è™•ç†ä¸­...';
                        
                        await exportToWord();
                        
                        exportWord.innerHTML = '<svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>åŒ¯å‡ºæˆåŠŸ';
                        setTimeout(() => {
                            exportWord.disabled = false;
                            exportWord.innerHTML = '<svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path></svg>åŒ¯å‡º Word';
                        }, 2000);
                    } catch (error) {
                        console.error('Word åŒ¯å‡ºå¤±æ•—:', error);
                        exportWord.disabled = false;
                        exportWord.innerHTML = '<svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>åŒ¯å‡ºå¤±æ•—';
                    }
                });
            }

            // ç°¡å ±åŒ¯å‡ºåŠŸèƒ½
            if (exportPPT) {
                exportPPT.addEventListener('click', async () => {
                    try {
                        exportPPT.disabled = true;
                        exportPPT.innerHTML = '<svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>è™•ç†ä¸­...';
                        
                        await exportToPPT();
                        
                        exportPPT.innerHTML = '<svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>åŒ¯å‡ºæˆåŠŸ';
                        setTimeout(() => {
                            exportPPT.disabled = false;
                            exportPPT.innerHTML = '<svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path></svg>åŒ¯å‡ºç°¡å ±';
                        }, 2000);
                    } catch (error) {
                        console.error('ç°¡å ±åŒ¯å‡ºå¤±æ•—:', error);
                        exportPPT.disabled = false;
                        exportPPT.innerHTML = '<svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>åŒ¯å‡ºå¤±æ•—';
                    }
                });
            }

            // åˆ†äº«å ±å‘ŠåŠŸèƒ½
            if (shareReport) {
                shareReport.addEventListener('click', async () => {
                    try {
                        shareReport.disabled = true;
                        shareReport.innerHTML = '<svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>è™•ç†ä¸­...';
                        
                        await shareReportContent();
                        
                        shareReport.innerHTML = '<svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>åˆ†äº«æˆåŠŸ';
                        setTimeout(() => {
                            shareReport.disabled = false;
                            shareReport.innerHTML = '<svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"></path></svg>åˆ†äº«å ±å‘Š';
                        }, 2000);
                    } catch (error) {
                        console.error('åˆ†äº«å ±å‘Šå¤±æ•—:', error);
                        shareReport.disabled = false;
                        shareReport.innerHTML = '<svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>åˆ†äº«å¤±æ•—';
                    }
                });
            }
        }

        // PDF åŒ¯å‡ºå¯¦ä½œ
        async function exportToPDF() {
            const reportContent = document.getElementById('proposalOutput');
            if (!reportContent) {
                throw new Error('æ‰¾ä¸åˆ°å ±å‘Šå…§å®¹');
            }
            // é ç®—æ–‡å­—å…ˆè™•ç†å¥½ï¼Œé¿å…å·¢ç‹€æ¨¡æ¿å­—ä¸²
            const budgetText = advertisingBudgetInput.value
                ? 'NT$ ' + parseInt(advertisingBudgetInput.value).toLocaleString()
                : 'æœªæŒ‡å®š';
            const reportHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>åª’é«”ææ¡ˆå ±å‘Š - ${targetBrandInput.value || 'æœªå‘½åå“ç‰Œ'}</title>
                    <style>
                        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; margin: 20px; }
                        h1, h2, h3 { color: #1e3a8a; }
                        h2 { border-bottom: 2px solid #60a5fa; padding-bottom: 10px; }
                        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f9fafb; }
                        .highlight { background-color: #fef3c7; padding: 10px; border-left: 4px solid #f59e0b; }
                        .summary { background-color: #dbeafe; padding: 15px; border-radius: 5px; margin: 20px 0; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <h1>åª’é«”ææ¡ˆå ±å‘Š</h1>
                    <div class="summary">
                        <h2>å ±å‘Šæ‘˜è¦</h2>
                        <p><strong>ç›®æ¨™å“ç‰Œï¼š</strong>${targetBrandInput.value || 'æœªæŒ‡å®š'}</p>
                        <p><strong>ç›®æ¨™äººç¾¤ï¼š</strong>${targetAudienceInput.value || 'æœªæŒ‡å®š'}</p>
                        <p><strong>é ç®—ï¼š</strong>${budgetText}</p>
                        <p><strong>ç”Ÿæˆæ™‚é–“ï¼š</strong>${new Date().toLocaleString('zh-TW')}</p>
                    </div>
                    ${reportContent.innerHTML}
                </body>
                </html>
            `;
            printWindow.document.write(reportHTML);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 1000);
        }

        // Word åŒ¯å‡ºå¯¦ä½œ
        async function exportToWord() {
            const reportContent = document.getElementById('proposalOutput');
            if (!reportContent) {
                throw new Error('æ‰¾ä¸åˆ°å ±å‘Šå…§å®¹');
            }
            // é ç®—æ–‡å­—å…ˆè™•ç†å¥½
            const budgetText = advertisingBudgetInput.value
                ? 'NT$ ' + parseInt(advertisingBudgetInput.value).toLocaleString()
                : 'æœªæŒ‡å®š';
            // å°‡ HTML è½‰æ›ç‚º Word æ ¼å¼
            const wordContent = convertHTMLToWord(`
                <div class="summary">
                    <h2>å ±å‘Šæ‘˜è¦</h2>
                    <p><strong>ç›®æ¨™å“ç‰Œï¼š</strong>${targetBrandInput.value || 'æœªæŒ‡å®š'}</p>
                    <p><strong>ç›®æ¨™äººç¾¤ï¼š</strong>${targetAudienceInput.value || 'æœªæŒ‡å®š'}</p>
                    <p><strong>é ç®—ï¼š</strong>${budgetText}</p>
                    <p><strong>ç”Ÿæˆæ™‚é–“ï¼š</strong>${new Date().toLocaleString('zh-TW')}</p>
                </div>
                ${reportContent.innerHTML}
            `);
            // å‰µå»º Blob ä¸¦ä¸‹è¼‰
            const blob = new Blob([wordContent], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `åª’é«”ææ¡ˆå ±å‘Š_${targetBrandInput.value || 'æœªå‘½åå“ç‰Œ'}_${new Date().toISOString().split('T')[0]}.docx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ç°¡å ±åŒ¯å‡ºå¯¦ä½œ
        async function exportToPPT() {
            const reportContent = document.getElementById('proposalOutput');
            if (!reportContent) {
                throw new Error('æ‰¾ä¸åˆ°å ±å‘Šå…§å®¹');
            }
            // é ç®—æ–‡å­—å…ˆè™•ç†å¥½
            const budgetText = advertisingBudgetInput.value
                ? 'NT$ ' + parseInt(advertisingBudgetInput.value).toLocaleString()
                : 'æœªæŒ‡å®š';
            // å°‡å ±å‘Šå…§å®¹è½‰æ›ç‚ºç°¡å ±æ ¼å¼
            const pptContent = convertToPPTFormat(`
                <div class="summary">
                    <h2>å ±å‘Šæ‘˜è¦</h2>
                    <p><strong>ç›®æ¨™å“ç‰Œï¼š</strong>${targetBrandInput.value || 'æœªæŒ‡å®š'}</p>
                    <p><strong>ç›®æ¨™äººç¾¤ï¼š</strong>${targetAudienceInput.value || 'æœªæŒ‡å®š'}</p>
                    <p><strong>é ç®—ï¼š</strong>${budgetText}</p>
                    <p><strong>ç”Ÿæˆæ™‚é–“ï¼š</strong>${new Date().toLocaleString('zh-TW')}</p>
                </div>
                ${reportContent.innerHTML}
            `);
            // å‰µå»ºç°¡å ±æª”æ¡ˆä¸¦ä¸‹è¼‰
            const blob = new Blob([pptContent], { type: 'application/vnd.openxmlformats-officedocument.presentationml.presentation' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `åª’é«”ææ¡ˆç°¡å ±_${targetBrandInput.value || 'æœªå‘½åå“ç‰Œ'}_${new Date().toISOString().split('T')[0]}.pptx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // åˆ†äº«å ±å‘Šå¯¦ä½œ
        async function shareReportContent() {
            const reportContent = document.getElementById('proposalOutput');
            if (!reportContent) {
                throw new Error('æ‰¾ä¸åˆ°å ±å‘Šå…§å®¹');
            }

            // æª¢æŸ¥æ˜¯å¦æ”¯æ´ Web Share API
            if (navigator.share) {
                const shareData = {
                    title: `åª’é«”ææ¡ˆå ±å‘Š - ${targetBrandInput.value || 'æœªå‘½åå“ç‰Œ'}`,
                    text: `é€™æ˜¯ä¸€ä»½é‡å° ${targetBrandInput.value || 'ç›®æ¨™å“ç‰Œ'} çš„åª’é«”ææ¡ˆå ±å‘Šï¼ŒåŒ…å«å¸‚å ´åˆ†æã€ç­–ç•¥å»ºè­°å’Œé ç®—è¦åŠƒã€‚`,
                    url: window.location.href
                };
                
                try {
                    await navigator.share(shareData);
                } catch (error) {
                    console.log('åˆ†äº«è¢«å–æ¶ˆæˆ–å¤±æ•—:', error);
                }
            } else {
                // é™ç´šæ–¹æ¡ˆï¼šè¤‡è£½é€£çµåˆ°å‰ªè²¼ç°¿
                await copyToClipboard(window.location.href);
                showNotification('å ±å‘Šé€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success');
            }
        }

        // è¼”åŠ©å‡½æ•¸
        function convertHTMLToWord(html) {
            // ç°¡åŒ–çš„ HTML åˆ° Word è½‰æ›
            const cleanHTML = html
                .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                .replace(/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/gi, '')
                .replace(/class="[^"]*"/g, '')
                .replace(/style="[^"]*"/g, '');
            
            return `
                <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                <head>
                    <meta charset="utf-8">
                    <title>åª’é«”ææ¡ˆå ±å‘Š</title>
                </head>
                <body>
                    ${cleanHTML}
                </body>
                </html>
            `;
        }

        function convertToPPTFormat(html) {
            // ç°¡åŒ–çš„ç°¡å ±æ ¼å¼è½‰æ›
            const sections = html.split('<h2>');
            let pptContent = '';
            
            sections.forEach((section, index) => {
                if (section.trim()) {
                    pptContent += `
                        <slide>
                            <title>${section.split('</h2>')[0] || 'å…§å®¹'}</title>
                            <content>${section.split('</h2>')[1] || section}</content>
                        </slide>
                    `;
                }
            });
            
            return pptContent;
        }

        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                return true;
            } catch (error) {
                console.error('è¤‡è£½åˆ°å‰ªè²¼ç°¿å¤±æ•—:', error);
                return false;
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500 text-white' : 
                type === 'error' ? 'bg-red-500 text-white' : 
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function generatePositioningChart(forumAnalysis, industrySentiment) {
            try {
                const chartContainer = document.getElementById('positioningChartContainer');
                const canvas = document.getElementById('positioningChart');
                
                if (!chartContainer || !canvas) {
                    console.error('æ‰¾ä¸åˆ°åœ–è¡¨å®¹å™¨æˆ– canvas å…ƒç´ ');
                    return;
                }
                
                // é¡¯ç¤ºåœ–è¡¨å®¹å™¨
                chartContainer.style.display = 'block';
                
                // éŠ·æ¯€ç¾æœ‰çš„åœ–è¡¨å¯¦ä¾‹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (window.positioningChartInstance) {
                    try {
                        window.positioningChartInstance.destroy();
                    } catch (destroyError) {
                        console.warn('éŠ·æ¯€èˆŠåœ–è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤:', destroyError);
                    }
                }
                
                // é©—è­‰è¼¸å…¥åƒæ•¸
                if (!forumAnalysis) {
                    console.warn('forumAnalysis åƒæ•¸ç‚ºç©ºï¼Œä½¿ç”¨é è¨­å€¼');
                    forumAnalysis = {};
                }
                
                // è§£æå®šä½æ•¸æ“š
                const targetPositioning = forumAnalysis.positioning_analysis || {
                    price_position: 5,
                    quality_position: 5,
                    innovation_position: 5,
                    target_audience_position: 5,
                    brand_personality: 5
                };
                
                // å‰µå»ºç«¶çˆ­å°æ‰‹å®šä½æ•¸æ“šï¼ˆåŸºæ–¼åˆ†æçµæœæ¨æ¸¬ï¼‰
                const competitorPositioning = {
                    price_position: Math.max(1, Math.min(10, targetPositioning.price_position + (Math.random() - 0.5) * 4)),
                    quality_position: Math.max(1, Math.min(10, targetPositioning.quality_position + (Math.random() - 0.5) * 4)),
                    innovation_position: Math.max(1, Math.min(10, targetPositioning.innovation_position + (Math.random() - 0.5) * 4)),
                    target_audience_position: Math.max(1, Math.min(10, targetPositioning.target_audience_position + (Math.random() - 0.5) * 4)),
                    brand_personality: Math.max(1, Math.min(10, targetPositioning.brand_personality + (Math.random() - 0.5) * 4))
                };
                
                // æº–å‚™åœ–è¡¨æ•¸æ“š
                const labels = ['åƒ¹æ ¼å®šä½', 'å“è³ªå®šä½', 'å‰µæ–°ç¨‹åº¦', 'ç›®æ¨™äººç¾¤', 'å“ç‰Œå€‹æ€§'];
                const targetData = [
                    targetPositioning.price_position,
                    targetPositioning.quality_position,
                    targetPositioning.innovation_position,
                    targetPositioning.target_audience_position,
                    targetPositioning.brand_personality
                ];
                const competitorData = [
                    competitorPositioning.price_position,
                    competitorPositioning.quality_position,
                    competitorPositioning.innovation_position,
                    competitorPositioning.target_audience_position,
                    competitorPositioning.brand_personality
                ];
                
                // å‰µå»ºé›·é”åœ–
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.error('ç„¡æ³•ç²å– canvas 2D ä¸Šä¸‹æ–‡');
                    return;
                }
                
                window.positioningChartInstance = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'ç›®æ¨™å“ç‰Œ',
                                data: targetData,
                                backgroundColor: 'rgba(79, 70, 229, 0.2)',
                                borderColor: 'rgba(79, 70, 229, 1)',
                                borderWidth: 2,
                                pointBackgroundColor: 'rgba(79, 70, 229, 1)',
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: 'rgba(79, 70, 229, 1)'
                            },
                            {
                                label: 'ç«¶çˆ­å°æ‰‹',
                                data: competitorData,
                                backgroundColor: 'rgba(239, 68, 68, 0.2)',
                                borderColor: 'rgba(239, 68, 68, 1)',
                                borderWidth: 2,
                                pointBackgroundColor: 'rgba(239, 68, 68, 1)',
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: 'rgba(239, 68, 68, 1)'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 10,
                                min: 0,
                                ticks: {
                                    stepSize: 2
                                },
                                pointLabels: {
                                    font: {
                                        size: 12,
                                        family: 'Noto Sans TC'
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    font: {
                                        family: 'Noto Sans TC'
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: 'å“ç‰Œå®šä½é›·é”åœ–',
                                font: {
                                    size: 16,
                                    family: 'Noto Sans TC'
                                }
                            }
                        }
                    }
                });
                
                console.log('å“ç‰Œå®šä½é›·é”åœ–ç”ŸæˆæˆåŠŸ');
                
            } catch (error) {
                console.error('ç”Ÿæˆå“ç‰Œå®šä½é›·é”åœ–æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                // éš±è—åœ–è¡¨å®¹å™¨ä»¥é¿å…é¡¯ç¤ºéŒ¯èª¤
                const chartContainer = document.getElementById('positioningChartContainer');
                if (chartContainer) {
                    chartContainer.style.display = 'none';
                }
            }
        }

        // --- ä¸»åŸ·è¡Œæµç¨‹ ---
        async function handleGenerateClick() {
            try {
                const userApiKey = apiKeyInput.value.trim();
                if (!userApiKey) {
                    alert('è«‹è¼¸å…¥æ‚¨çš„ Google Gemini API Key');
                    return;
                }

                // é‡ç½®é€²åº¦
                currentStep = 0;
                updateProgress(0, 'æº–å‚™é–‹å§‹åˆ†æ...');
                updateAPIStatus('warning', 'æ­£åœ¨æ¸¬è©¦ API é€£æ¥...');

                // æ¸¬è©¦ API é€£æ¥
                try {
                    const apiTest = await testAPI(userApiKey);
                    if (apiTest) {
                        updateAPIStatus('success', 'API é€£æ¥æˆåŠŸ');
                        apiTestResult = true;
                    } else {
                        updateAPIStatus('error', 'API é€£æ¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key');
                        apiTestResult = false;
                        return;
                    }
                } catch (error) {
                    updateAPIStatus('error', 'API æ¸¬è©¦å¤±æ•—: ' + error.message);
                    apiTestResult = false;
                    return;
                }

                // ç²å–è¡¨å–®æ•¸æ“š
                const target = targetBrandInput.value.trim();
                const industry = industryInput.value;
                const industryStatus = industryStatusInput.value;
                const businessModel = businessModelInput.value;
                const targetAudience = targetAudienceInput.value.trim() || 'æœªæŒ‡å®š';
                const marketingProblems = document.getElementById('marketingProblems').value.trim() || 'æœªæä¾›';
                const budget = parseInt(advertisingBudgetInput.value, 10) || 0;
                const adObjective = adObjectiveInput.value;
                const aiRecommendMedia = aiRecommendMediaInput.checked;
                const selectedMedia = Array.from(mediaSelectionDiv.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
                const competitors = competitorsInput.value;
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                const targetMarkets = targetMarketsInput.value;
                const targetLanguages = targetLanguagesInput.value;

                // é‡é»æ¨™è¨»ç›¸é—œæ•¸æ“š
                const campaignStartDate = campaignStartDateInput.value;
                const campaignEndDate = campaignEndDateInput.value;
                const campaignDuration = campaignDurationInput.value;
                const keyMilestones = keyMilestonesInput.value.trim() || 'æœªæä¾›';
                const competitorTimeline = competitorTimelineInput.value.trim() || 'æœªæä¾›';
                const competitiveAdvantage = competitiveAdvantageInput.value.trim() || 'æœªæä¾›';
                const competitiveGaps = competitiveGapsInput.value.trim() || 'æœªæä¾›';
                const seasonalFactors = seasonalFactorsInput.value;
                const marketTrends = marketTrendsInput.value.trim() || 'æœªæä¾›';
                const highlightTimeline = highlightTimelineInput.checked;
                const highlightCompetitors = highlightCompetitorsInput.checked;
                const highlightOpportunities = highlightOpportunitiesInput.checked;
                const highlightMilestones = highlightMilestonesInput.checked;
                const highlightRisks = highlightRisksInput.checked;
                const highlightKPIs = highlightKPIsInput.checked;

                // é©—è­‰å¿…å¡«æ¬„ä½
                if (!target || !industry || !industryStatus || !businessModel || !targetAudience || !adObjective) {
                    alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
                    return;
                }

                if (!aiRecommendMedia && selectedMedia.length === 0) {
                    alert('è«‹é¸æ“‡å»£å‘Šå½¢å¼æˆ–å‹¾é¸ AI å»ºè­°');
                    return;
                }

                const analysisContext = {
                    target: target,
                    industry: industry,
                    industryStatus: industryStatus,
                    businessModel: businessModel,
                    targetAudience: targetAudience,
                    marketingProblems: marketingProblems,
                    budget: budget,
                    adObjective: adObjective,
                    aiRecommendMedia: aiRecommendMedia,
                    selectedMedia: selectedMedia,
                    competitors: competitors,
                    startDate: startDate,
                    endDate: endDate,
                    targetMarkets: targetMarkets,
                    targetLanguages: targetLanguages,
                    // é‡é»æ¨™è¨»ç›¸é—œæ•¸æ“š
                    campaignStartDate: campaignStartDate,
                    campaignEndDate: campaignEndDate,
                    campaignDuration: campaignDuration,
                    keyMilestones: keyMilestones,
                    competitorTimeline: competitorTimeline,
                    competitiveAdvantage: competitiveAdvantage,
                    competitiveGaps: competitiveGaps,
                    seasonalFactors: seasonalFactors,
                    marketTrends: marketTrends,
                    highlightTimeline: highlightTimeline,
                    highlightCompetitors: highlightCompetitors,
                    highlightOpportunities: highlightOpportunities,
                    highlightMilestones: highlightMilestones,
                    highlightRisks: highlightRisks,
                    highlightKPIs: highlightKPIs
                };

                generateBtn.disabled = true;
                generateBtn.innerHTML = `AI åˆ†æä¸­...`;

                try {
                    updateProgress(1, `åˆ†æ ${analysisContext.target} åœ¨ç›®æ¨™äººç¾¤ä¸­çš„è¼¿æƒ…ç‹€æ³...`);
                    const forumData = await analyzeForumSentiment(analysisContext, userApiKey).catch(error => {
                        console.error('è¼¿æƒ…åˆ†æå¤±æ•—:', error);
                        throw new Error(`è¼¿æƒ…åˆ†æå¤±æ•—: ${error.message}`);
                    });
                    updateAPIStatus('success', 'è¼¿æƒ…åˆ†æå®Œæˆ');

                    updateProgress(2, `ç›£æ¸¬ ${analysisContext.industry} ç”¢æ¥­æ•´é«”è¼¿æƒ…...`);
                    const industrySentimentData = await analyzeIndustrySentiment(analysisContext, userApiKey).catch(error => {
                        console.error('ç”¢æ¥­è¼¿æƒ…ç›£æ¸¬å¤±æ•—:', error);
                        throw new Error(`ç”¢æ¥­è¼¿æƒ…ç›£æ¸¬å¤±æ•—: ${error.message}`);
                    });
                    updateAPIStatus('success', 'ç”¢æ¥­è¼¿æƒ…ç›£æ¸¬å®Œæˆ');

                    updateProgress(3, `è©•ä¼°é ç®—å¯è¡Œæ€§èˆ‡ç›®æ¨™åŒ¹é…åº¦...`);
                    const budgetFeasibilityData = await analyzeBudgetFeasibility(analysisContext, userApiKey).catch(error => {
                        console.error('é ç®—å¯è¡Œæ€§è©•ä¼°å¤±æ•—:', error);
                        throw new Error(`é ç®—å¯è¡Œæ€§è©•ä¼°å¤±æ•—: ${error.message}`);
                    });
                    updateAPIStatus('success', 'é ç®—å¯è¡Œæ€§è©•ä¼°å®Œæˆ');

                    updateProgress(4, `åˆ†æç«¶çˆ­å°æ‰‹ç­–ç•¥èˆ‡å¸‚å ´å®šä½...`);
                    const competitorData = await analyzeCompetitorInsights(analysisContext, userApiKey).catch(error => {
                        console.error('ç«¶çˆ­å°æ‰‹åˆ†æå¤±æ•—:', error);
                        throw new Error(`ç«¶çˆ­å°æ‰‹åˆ†æå¤±æ•—: ${error.message}`);
                    });
                    updateAPIStatus('success', 'ç«¶çˆ­å°æ‰‹åˆ†æå®Œæˆ');

                    updateProgress(5, `è¦åŠƒè¡ŒéŠ·æ™‚ç¨‹èˆ‡ç†±é»äº‹ä»¶...`);
                    const marketingCalendarData = await analyzeMarketingCalendar(analysisContext, userApiKey).catch(error => {
                        console.error('è¡ŒéŠ·æ™‚ç¨‹è¦åŠƒå¤±æ•—:', error);
                        throw new Error(`è¡ŒéŠ·æ™‚ç¨‹è¦åŠƒå¤±æ•—: ${error.message}`);
                    });
                    updateAPIStatus('success', 'è¡ŒéŠ·æ™‚ç¨‹è¦åŠƒå®Œæˆ');

                    updateProgress(6, `åˆ†æå¤šå¸‚å ´ç­–ç•¥èˆ‡é ç®—åˆ†é…...`);
                    const multiMarketData = await analyzeMultiMarketStrategy(analysisContext, userApiKey).catch(error => {
                        console.error('å¤šå¸‚å ´ç­–ç•¥åˆ†æå¤±æ•—:', error);
                        throw new Error(`å¤šå¸‚å ´ç­–ç•¥åˆ†æå¤±æ•—: ${error.message}`);
                    });
                    updateAPIStatus('success', 'å¤šå¸‚å ´ç­–ç•¥åˆ†æå®Œæˆ');

                    updateProgress(7, `è¦åŠƒåœ¨åœ°åŒ–èˆ‡å¤šèªè¨€ç­–ç•¥...`);
                    const localizationData = await analyzeLocalizationStrategy(analysisContext, multiMarketData, userApiKey).catch(error => {
                        console.error('åœ¨åœ°åŒ–ç­–ç•¥è¦åŠƒå¤±æ•—:', error);
                        throw new Error(`åœ¨åœ°åŒ–ç­–ç•¥è¦åŠƒå¤±æ•—: ${error.message}`);
                    });
                    updateAPIStatus('success', 'åœ¨åœ°åŒ–ç­–ç•¥è¦åŠƒå®Œæˆ');

                    updateProgress(8, `ç™¼å±•å‰µæ„ç­–ç•¥èˆ‡å“ç‰Œé«”é©—...`);
                    const creativeStrategyData = await analyzeCreativeStrategy(analysisContext, userApiKey).catch(error => {
                        console.error('å‰µæ„ç­–ç•¥ç™¼å±•å¤±æ•—:', error);
                        throw new Error(`å‰µæ„ç­–ç•¥ç™¼å±•å¤±æ•—: ${error.message}`);
                    });
                    updateAPIStatus('success', 'å‰µæ„ç­–ç•¥ç™¼å±•å®Œæˆ');

                    updateProgress(9, `åˆ†æ ${analysisContext.target} çš„ SEO èˆ‡å…§å®¹ç­–ç•¥...`);
                    const seoData = await analyzeSeoStrategy(analysisContext, userApiKey).catch(error => {
                        console.error('SEOç­–ç•¥åˆ†æå¤±æ•—:', error);
                        throw new Error(`SEOç­–ç•¥åˆ†æå¤±æ•—: ${error.message}`);
                    });
                    updateAPIStatus('success', 'SEOç­–ç•¥åˆ†æå®Œæˆ');
                    
                    const opportunity = forumData.market_opportunity || seoData.content_gap_opportunity;
                    
                    updateProgress(10, `é€²è¡Œé ç®—è¦åŠƒèˆ‡ KPI ä¼°ç®—...`);
                    const kpiData = await estimateKpiAndBudget(analysisContext, opportunity, userApiKey).catch(error => {
                        console.error('é ç®—è¦åŠƒå¤±æ•—:', error);
                        throw new Error(`é ç®—è¦åŠƒå¤±æ•—: ${error.message}`);
                    });
                    updateAPIStatus('success', 'é ç®—è¦åŠƒå®Œæˆ');

                    updateProgress(10, `ç¶œåˆæ‰€æœ‰æ´å¯Ÿï¼Œç”Ÿæˆæœ€çµ‚å ±å‘Š...`);
                    const finalReportHtml = await synthesizeFinalReport(analysisContext, forumData, seoData, kpiData, industrySentimentData, budgetFeasibilityData, multiMarketData, localizationData, competitorData, marketingCalendarData, creativeStrategyData, userApiKey).catch(error => {
                        console.error('å ±å‘Šç”Ÿæˆå¤±æ•—:', error);
                        throw new Error(`å ±å‘Šç”Ÿæˆå¤±æ•—: ${error.message}`);
                    });
                    updateAPIStatus('success', 'å ±å‘Šç”Ÿæˆå®Œæˆï¼');

                    // æª¢æŸ¥è¼¸å‡ºæ ¼å¼
                    proposalOutput.innerHTML = finalReportHtml;
                    
                    // æ–°å¢ï¼šå ±å‘Šå“è³ªå„ªåŒ–
                    const enhancedReport = enhanceReportQuality(finalReportHtml);
                    proposalOutput.innerHTML = enhancedReport;
                    
                    // æ–°å¢ï¼šå ±å‘Šå…§å®¹é©—è­‰
                    const validationIssues = validateReportContent(enhancedReport);
                    if (validationIssues.length > 0) {
                        console.warn('å ±å‘Šå…§å®¹é©—è­‰ç™¼ç¾å•é¡Œ:', validationIssues);
                    }
                    
                    // æ–°å¢ï¼šå ±å‘Šè©•åˆ†
                    const reportScore = scoreReport(enhancedReport);
                    console.log(`å ±å‘Šå“è³ªè©•åˆ†: ${reportScore}/100`);
                    
                    // ç”Ÿæˆ positioning åœ–è¡¨
                    generatePositioningChart(forumData, industrySentimentData);

                    // ç”Ÿæˆé‡é»æ¨™è¨»è¦–è¦ºåŒ–
                    generateHighlightVisualizations(analysisContext, competitorData, marketingCalendarData);

                    // åˆå§‹åŒ–å°å‡ºåŠŸèƒ½
                    initializeExportFunctions();

                    // å®Œæˆå¾Œéš±è—é€²åº¦æ¢
                    setTimeout(() => {
                        document.getElementById('progressContainer').classList.add('hidden');
                    }, 3000);

                } catch (error) {
                    console.error('ç”Ÿæˆææ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    
                    // æ ¹æ“šéŒ¯èª¤é¡å‹æä¾›ä¸åŒçš„éŒ¯èª¤è¨Šæ¯å’Œå»ºè­°
                    let errorMessage = error.message;
                    let suggestions = '';
                    
                    if (error.message.includes('ç¶²è·¯é€£æ¥å·²æ–·é–‹')) {
                        errorMessage = 'ç¶²è·¯é€£æ¥å•é¡Œ';
                        suggestions = `
                            <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <h4 class="font-semibold text-yellow-800 mb-2">å»ºè­°è§£æ±ºæ–¹æ¡ˆï¼š</h4>
                                <ul class="text-sm text-yellow-700 space-y-1">
                                    <li>â€¢ æª¢æŸ¥ç¶²è·¯é€£æ¥æ˜¯å¦æ­£å¸¸</li>
                                    <li>â€¢ å˜—è©¦é‡æ–°æ•´ç†é é¢</li>
                                    <li>â€¢ æª¢æŸ¥é˜²ç«ç‰†æˆ–ä»£ç†è¨­å®š</li>
                                    <li>â€¢ ç¨å¾Œå†è©¦</li>
                                </ul>
                            </div>
                        `;
                    } else if (error.message.includes('API é‡‘é‘°')) {
                        errorMessage = 'API é‡‘é‘°å•é¡Œ';
                        suggestions = `
                            <div class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                                <h4 class="font-semibold text-red-800 mb-2">å»ºè­°è§£æ±ºæ–¹æ¡ˆï¼š</h4>
                                <ul class="text-sm text-red-700 space-y-1">
                                    <li>â€¢ æª¢æŸ¥ API é‡‘é‘°æ˜¯å¦æ­£ç¢º</li>
                                    <li>â€¢ ç¢ºèª API é‡‘é‘°æ˜¯å¦å·²å•Ÿç”¨ Gemini API</li>
                                    <li>â€¢ æª¢æŸ¥ API é‡‘é‘°æ˜¯å¦æœ‰è¶³å¤ çš„é…é¡</li>
                                    <li>â€¢ å‰å¾€ <a href="https://makersuite.google.com/app/apikey" target="_blank" class="underline">Google AI Studio</a> é‡æ–°ç”Ÿæˆé‡‘é‘°</li>
                                </ul>
                            </div>
                        `;
                    } else if (error.message.includes('æ‰€æœ‰æ¨¡å‹éƒ½å¤±æ•—äº†')) {
                        errorMessage = 'API æœå‹™æš«æ™‚ä¸å¯ç”¨';
                        suggestions = `
                            <div class="mt-4 p-4 bg-orange-50 border border-orange-200 rounded-lg">
                                <h4 class="font-semibold text-orange-800 mb-2">å»ºè­°è§£æ±ºæ–¹æ¡ˆï¼š</h4>
                                <ul class="text-sm text-orange-700 space-y-1">
                                    <li>â€¢ Google Gemini API æœå‹™å¯èƒ½æš«æ™‚ä¸å¯ç”¨</li>
                                    <li>â€¢ è«‹ç¨å¾Œå†è©¦ï¼ˆé€šå¸¸ 5-10 åˆ†é˜å¾Œæœƒæ¢å¾©ï¼‰</li>
                                    <li>â€¢ æª¢æŸ¥ <a href="https://status.ai.google.dev/" target="_blank" class="underline">Google AI æœå‹™ç‹€æ…‹</a></li>
                                    <li>â€¢ å¦‚æœå•é¡ŒæŒçºŒï¼Œè«‹è¯ç¹«æŠ€è¡“æ”¯æ´</li>
                                </ul>
                            </div>
                        `;
                    } else if (error.message.includes('è«‹æ±‚é »ç‡éé«˜')) {
                        errorMessage = 'API è«‹æ±‚é »ç‡éé«˜';
                        suggestions = `
                            <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <h4 class="font-semibold text-blue-800 mb-2">å»ºè­°è§£æ±ºæ–¹æ¡ˆï¼š</h4>
                                <ul class="text-sm text-blue-700 space-y-1">
                                    <li>â€¢ è«‹ç­‰å¾… 1-2 åˆ†é˜å¾Œå†è©¦</li>
                                    <li>â€¢ æª¢æŸ¥ API é‡‘é‘°çš„ä½¿ç”¨é…é¡</li>
                                    <li>â€¢ è€ƒæ…®å‡ç´š API é…é¡</li>
                                </ul>
                            </div>
                        `;
                    } else {
                        suggestions = `
                            <div class="mt-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                                <h4 class="font-semibold text-gray-800 mb-2">ä¸€èˆ¬æ•…éšœæ’é™¤ï¼š</h4>
                                <ul class="text-sm text-gray-700 space-y-1">
                                    <li>â€¢ é‡æ–°æ•´ç†é é¢å¾Œå†è©¦</li>
                                    <li>â€¢ æª¢æŸ¥ç€è¦½å™¨ä¸»æ§å°çš„è©³ç´°éŒ¯èª¤ä¿¡æ¯</li>
                                    <li>â€¢ å˜—è©¦ä½¿ç”¨ä¸åŒçš„ç€è¦½å™¨</li>
                                    <li>â€¢ æ¸…é™¤ç€è¦½å™¨å¿«å–å’Œ Cookie</li>
                                    <li>â€¢ å¦‚æœå•é¡ŒæŒçºŒï¼Œè«‹è¯ç¹«æŠ€è¡“æ”¯æ´</li>
                                </ul>
                            </div>
                        `;
                    }
                    
                    updateAPIStatus('error', errorMessage);
                    proposalOutput.innerHTML = `
                        <div class="p-6 bg-red-50 border border-red-200 rounded-lg">
                            <h3 class="text-lg font-bold text-red-800 mb-2">æŠ±æ­‰ï¼Œè™•ç†éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤</h3>
                            <p class="text-red-700 mb-4">éŒ¯èª¤è©³æƒ…ï¼š${error.message}</p>
                            <p class="text-sm text-red-600 mb-4">è«‹æª¢æŸ¥ç€è¦½å™¨çš„ä¸»æ§å°ä»¥ç²å–è©³ç´°æŠ€è¡“è³‡è¨Šï¼Œç„¶å¾Œå†è©¦ä¸€æ¬¡ã€‚</p>
                            ${suggestions}
                            <div class="mt-4 p-3 bg-white border border-red-200 rounded">
                                <p class="text-xs text-gray-600">æŠ€è¡“è©³æƒ…ï¼š${error.stack ? error.stack.substring(0, 200) + '...' : 'ç„¡å †ç–Šè¿½è¹¤ä¿¡æ¯'}</p>
                            </div>
                        </div>
                    `;
                } finally {
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = `é‡æ–°ç”Ÿæˆ AI åˆ†æå ±å‘Š`;
                }
            } catch (error) {
                console.error('ä¸»å‡½æ•¸åŸ·è¡ŒéŒ¯èª¤:', error);
                updateAPIStatus('error', 'ç³»çµ±éŒ¯èª¤: ' + error.message);
                generateBtn.disabled = false;
                generateBtn.innerHTML = `é‡æ–°ç”Ÿæˆ AI åˆ†æå ±å‘Š`;
            }
        }

        // ç›£è½ AI å»ºè­°åª’é«”é¸æ“‡
        aiRecommendMediaInput.addEventListener('change', function() {
            const mediaCheckboxes = mediaSelectionDiv.querySelectorAll('input[type="checkbox"]');
            mediaCheckboxes.forEach(checkbox => {
                checkbox.disabled = this.checked;
                if (this.checked) {
                    checkbox.checked = false;
                }
            });
        });

        // ç›£è½åª’é«”é¸æ“‡
        mediaSelectionDiv.addEventListener('change', function(e) {
            if (e.target.type === 'checkbox' && e.target.checked) {
                aiRecommendMediaInput.checked = false;
                const mediaCheckboxes = mediaSelectionDiv.querySelectorAll('input[type="checkbox"]');
                mediaCheckboxes.forEach(checkbox => {
                    checkbox.disabled = false;
                });
            }
        });

        // åˆå§‹åŒ–ç¶²è·¯ç‹€æ…‹ç›£è½å™¨
        initializeNetworkMonitoring();

        // ç”Ÿæˆé‡é»æ¨™è¨»è¦–è¦ºåŒ–
        function generateHighlightVisualizations(context, competitorAnalysis, marketingCalendar) {
            try {
                // ç”Ÿæˆæ™‚é–“ç·šè¦–è¦ºåŒ–
                if (context.highlightTimeline && marketingCalendar) {
                    generateTimelineVisualization(context, marketingCalendar);
                }
                
                // ç”Ÿæˆç«¶çˆ­å°æ‰‹æ¯”è¼ƒè¦–è¦ºåŒ–
                if (context.highlightCompetitors && competitorAnalysis) {
                    generateCompetitorComparisonVisualization(context, competitorAnalysis);
                }
                
                // ç”Ÿæˆå¸‚å ´æ©Ÿæœƒé»è¦–è¦ºåŒ–
                if (context.highlightOpportunities) {
                    generateOpportunityVisualization(context, competitorAnalysis, marketingCalendar);
                }
                
                // ç”Ÿæˆé‡Œç¨‹ç¢‘è¦–è¦ºåŒ–
                if (context.highlightMilestones && context.keyMilestones) {
                    generateMilestoneVisualization(context);
                }
                
                // ç”Ÿæˆé¢¨éšªè©•ä¼°è¦–è¦ºåŒ–
                if (context.highlightRisks) {
                    generateRiskVisualization(context, competitorAnalysis, marketingCalendar);
                }
                
                // ç”ŸæˆKPIè¦–è¦ºåŒ–
                if (context.highlightKPIs) {
                    generateKPIVisualization(context);
                }
                
            } catch (error) {
                console.error('ç”Ÿæˆé‡é»æ¨™è¨»è¦–è¦ºåŒ–æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }

        // ç”Ÿæˆæ™‚é–“ç·šè¦–è¦ºåŒ–
        function generateTimelineVisualization(context, marketingCalendar) {
            try {
                // å‰µå»ºæ™‚é–“ç·šå®¹å™¨
                let timelineContainer = document.getElementById('timelineVisualization');
                if (!timelineContainer) {
                    timelineContainer = document.createElement('div');
                    timelineContainer.id = 'timelineVisualization';
                    timelineContainer.className = 'mt-6 p-4 bg-blue-50 rounded-lg';
                    timelineContainer.innerHTML = '<h3 class="text-lg font-semibold text-blue-800 mb-4">ğŸ“… è¡ŒéŠ·æ™‚é–“ç·šè¦–è¦ºåŒ–</h3>';
                    
                    // æ’å…¥åˆ°å ±å‘Šè¼¸å‡ºå€åŸŸ
                    const proposalOutput = document.getElementById('proposalOutput');
                    if (proposalOutput) {
                        proposalOutput.appendChild(timelineContainer);
                    }
                }
                
                // ç”Ÿæˆæ™‚é–“ç·šå…§å®¹
                const timelineContent = `
                    <div class="space-y-4">
                        <div class="flex items-center space-x-4">
                            <div class="w-4 h-4 bg-blue-500 rounded-full"></div>
                            <div class="flex-1">
                                <div class="font-medium text-blue-900">æ´»å‹•é–‹å§‹</div>
                                <div class="text-sm text-blue-700">${context.campaignStartDate || 'æœªè¨­å®š'}</div>
                            </div>
                        </div>
                        ${context.keyMilestones ? `
                        <div class="ml-6 border-l-2 border-blue-300 pl-4">
                            <div class="text-sm text-blue-600 mb-2">é‡è¦é‡Œç¨‹ç¢‘ï¼š</div>
                            <div class="text-sm text-blue-700">${context.keyMilestones.replace(/\n/g, '<br>')}</div>
                        </div>
                        ` : ''}
                        <div class="flex items-center space-x-4">
                            <div class="w-4 h-4 bg-green-500 rounded-full"></div>
                            <div class="flex-1">
                                <div class="font-medium text-green-900">æ´»å‹•çµæŸ</div>
                                <div class="text-sm text-green-700">${context.campaignEndDate || 'æœªè¨­å®š'}</div>
                            </div>
                        </div>
                        ${context.seasonalFactors ? `
                        <div class="mt-4 p-3 bg-yellow-50 rounded border border-yellow-200">
                            <div class="text-sm font-medium text-yellow-800">å­£ç¯€æ€§å› ç´ ï¼š${context.seasonalFactors}</div>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                timelineContainer.innerHTML += timelineContent;
                
            } catch (error) {
                console.error('ç”Ÿæˆæ™‚é–“ç·šè¦–è¦ºåŒ–æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }

        // ç”Ÿæˆç«¶çˆ­å°æ‰‹æ¯”è¼ƒè¦–è¦ºåŒ–
        function generateCompetitorComparisonVisualization(context, competitorAnalysis) {
            try {
                // å‰µå»ºç«¶çˆ­å°æ‰‹æ¯”è¼ƒå®¹å™¨
                let competitorContainer = document.getElementById('competitorComparisonVisualization');
                if (!competitorContainer) {
                    competitorContainer = document.createElement('div');
                    competitorContainer.id = 'competitorComparisonVisualization';
                    competitorContainer.className = 'mt-6 p-4 bg-red-50 rounded-lg';
                    competitorContainer.innerHTML = '<h3 class="text-lg font-semibold text-red-800 mb-4">âš”ï¸ ç«¶çˆ­å°æ‰‹æ¯”è¼ƒåˆ†æ</h3>';
                    
                    // æ’å…¥åˆ°å ±å‘Šè¼¸å‡ºå€åŸŸ
                    const proposalOutput = document.getElementById('proposalOutput');
                    if (proposalOutput) {
                        proposalOutput.appendChild(competitorContainer);
                    }
                }
                
                // ç”Ÿæˆç«¶çˆ­å°æ‰‹æ¯”è¼ƒå…§å®¹
                const competitorContent = `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <h4 class="font-medium text-red-900">æˆ‘å€‘çš„ç«¶çˆ­å„ªå‹¢</h4>
                            <div class="p-3 bg-green-50 rounded border border-green-200">
                                <div class="text-sm text-green-800">${context.competitiveAdvantage || 'æœªæä¾›'}</div>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <h4 class="font-medium text-red-900">éœ€è¦å½Œè£œçš„å·®è·</h4>
                            <div class="p-3 bg-orange-50 rounded border border-orange-200">
                                <div class="text-sm text-orange-800">${context.competitiveGaps || 'æœªæä¾›'}</div>
                            </div>
                        </div>
                    </div>
                    ${context.competitorTimeline ? `
                    <div class="mt-4">
                        <h4 class="font-medium text-red-900 mb-2">ç«¶çˆ­å°æ‰‹è¿‘æœŸæ´»å‹•æ™‚é–“ç·š</h4>
                        <div class="p-3 bg-white rounded border border-red-200">
                            <div class="text-sm text-gray-700">${context.competitorTimeline.replace(/\n/g, '<br>')}</div>
                        </div>
                    </div>
                    ` : ''}
                `;
                
                competitorContainer.innerHTML += competitorContent;
                
            } catch (error) {
                console.error('ç”Ÿæˆç«¶çˆ­å°æ‰‹æ¯”è¼ƒè¦–è¦ºåŒ–æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }

        // ç”Ÿæˆå¸‚å ´æ©Ÿæœƒé»è¦–è¦ºåŒ–
        function generateOpportunityVisualization(context, competitorAnalysis, marketingCalendar) {
            try {
                // å‰µå»ºæ©Ÿæœƒé»å®¹å™¨
                let opportunityContainer = document.getElementById('opportunityVisualization');
                if (!opportunityContainer) {
                    opportunityContainer = document.createElement('div');
                    opportunityContainer.id = 'opportunityVisualization';
                    opportunityContainer.className = 'mt-6 p-4 bg-green-50 rounded-lg';
                    opportunityContainer.innerHTML = '<h3 class="text-lg font-semibold text-green-800 mb-4">ğŸ¯ å¸‚å ´æ©Ÿæœƒé»åˆ†æ</h3>';
                    
                    // æ’å…¥åˆ°å ±å‘Šè¼¸å‡ºå€åŸŸ
                    const proposalOutput = document.getElementById('proposalOutput');
                    if (proposalOutput) {
                        proposalOutput.appendChild(opportunityContainer);
                    }
                }
                
                // ç”Ÿæˆæ©Ÿæœƒé»å…§å®¹
                const opportunityContent = `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <h4 class="font-medium text-green-900">å­£ç¯€æ€§å› ç´ </h4>
                            <div class="p-3 bg-white rounded border border-green-200">
                                <div class="text-sm text-gray-700">${context.seasonalFactors || 'æœªæä¾›'}</div>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <h4 class="font-medium text-green-900">å¸‚å ´è¶¨å‹¢</h4>
                            <div class="p-3 bg-white rounded border border-green-200">
                                <div class="text-sm text-gray-700">${context.marketTrends || 'æœªæä¾›'}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                opportunityContainer.innerHTML += opportunityContent;
                
            } catch (error) {
                console.error('ç”Ÿæˆå¸‚å ´æ©Ÿæœƒé»è¦–è¦ºåŒ–æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }

        // ç”Ÿæˆé‡Œç¨‹ç¢‘è¦–è¦ºåŒ–
        function generateMilestoneVisualization(context) {
            try {
                // å‰µå»ºé‡Œç¨‹ç¢‘å®¹å™¨
                let milestoneContainer = document.getElementById('milestoneVisualization');
                if (!milestoneContainer) {
                    milestoneContainer = document.createElement('div');
                    milestoneContainer.id = 'milestoneVisualization';
                    milestoneContainer.className = 'mt-6 p-4 bg-purple-50 rounded-lg';
                    milestoneContainer.innerHTML = '<h3 class="text-lg font-semibold text-purple-800 mb-4">ğŸ“Œ é‡è¦é‡Œç¨‹ç¢‘æé†’</h3>';
                    
                    // æ’å…¥åˆ°å ±å‘Šè¼¸å‡ºå€åŸŸ
                    const proposalOutput = document.getElementById('proposalOutput');
                    if (proposalOutput) {
                        proposalOutput.appendChild(milestoneContainer);
                    }
                }
                
                // ç”Ÿæˆé‡Œç¨‹ç¢‘å…§å®¹
                const milestoneContent = `
                    <div class="space-y-3">
                        <div class="p-3 bg-white rounded border border-purple-200">
                            <div class="text-sm text-gray-700">${context.keyMilestones.replace(/\n/g, '<br>')}</div>
                        </div>
                        <div class="text-xs text-purple-600">
                            ğŸ’¡ å»ºè­°ï¼šæå‰ 2-4 é€±é–‹å§‹æº–å‚™æ¯å€‹é‡Œç¨‹ç¢‘ç›¸é—œçš„è¡ŒéŠ·æ´»å‹•
                        </div>
                    </div>
                `;
                
                milestoneContainer.innerHTML += milestoneContent;
                
            } catch (error) {
                console.error('ç”Ÿæˆé‡Œç¨‹ç¢‘è¦–è¦ºåŒ–æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }

        // ç”Ÿæˆé¢¨éšªè©•ä¼°è¦–è¦ºåŒ–
        function generateRiskVisualization(context, competitorAnalysis, marketingCalendar) {
            try {
                // å‰µå»ºé¢¨éšªè©•ä¼°å®¹å™¨
                let riskContainer = document.getElementById('riskVisualization');
                if (!riskContainer) {
                    riskContainer = document.createElement('div');
                    riskContainer.id = 'riskVisualization';
                    riskContainer.className = 'mt-6 p-4 bg-orange-50 rounded-lg';
                    riskContainer.innerHTML = '<h3 class="text-lg font-semibold text-orange-800 mb-4">âš ï¸ é¢¨éšªè©•ä¼°èˆ‡ç®¡ç†</h3>';
                    
                    // æ’å…¥åˆ°å ±å‘Šè¼¸å‡ºå€åŸŸ
                    const proposalOutput = document.getElementById('proposalOutput');
                    if (proposalOutput) {
                        proposalOutput.appendChild(riskContainer);
                    }
                }
                
                // ç”Ÿæˆé¢¨éšªè©•ä¼°å…§å®¹
                const riskContent = `
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                            <div class="p-3 bg-white rounded border border-orange-200">
                                <div class="font-medium text-orange-900 mb-2">ç«¶çˆ­é¢¨éšª</div>
                                <div class="text-sm text-gray-700">ç«¶çˆ­å°æ‰‹æ´»å‹•å¯èƒ½å½±éŸ¿å¸‚å ´ä»½é¡</div>
                            </div>
                            <div class="p-3 bg-white rounded border border-orange-200">
                                <div class="font-medium text-orange-900 mb-2">æ™‚ç¨‹é¢¨éšª</div>
                                <div class="text-sm text-gray-700">é‡è¦æ—¥æœŸå¯èƒ½èˆ‡å…¶ä»–æ´»å‹•è¡çª</div>
                            </div>
                            <div class="p-3 bg-white rounded border border-orange-200">
                                <div class="font-medium text-orange-900 mb-2">é ç®—é¢¨éšª</div>
                                <div class="text-sm text-gray-700">é ç®—å¯èƒ½ä¸è¶³ä»¥é”æˆç›®æ¨™</div>
                            </div>
                        </div>
                        <div class="p-3 bg-yellow-50 rounded border border-yellow-200">
                            <div class="text-sm text-yellow-800">
                                <strong>é¢¨éšªç®¡ç†å»ºè­°ï¼š</strong>å»ºç«‹æ‡‰æ€¥é ç®—ã€æº–å‚™å‚™é¸æ–¹æ¡ˆã€å¯†åˆ‡ç›£æ§ç«¶çˆ­å°æ‰‹å‹•æ…‹
                            </div>
                        </div>
                    </div>
                `;
                
                riskContainer.innerHTML += riskContent;
                
            } catch (error) {
                console.error('ç”Ÿæˆé¢¨éšªè©•ä¼°è¦–è¦ºåŒ–æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }

        // ç”ŸæˆKPIè¦–è¦ºåŒ–
        function generateKPIVisualization(context) {
            try {
                // å‰µå»ºKPIå®¹å™¨
                let kpiContainer = document.getElementById('kpiVisualization');
                if (!kpiContainer) {
                    kpiContainer = document.createElement('div');
                    kpiContainer.id = 'kpiVisualization';
                    kpiContainer.className = 'mt-6 p-4 bg-indigo-50 rounded-lg';
                    kpiContainer.innerHTML = '<h3 class="text-lg font-semibold text-indigo-800 mb-4">ğŸ“Š é—œéµç¸¾æ•ˆæŒ‡æ¨™</h3>';
                    
                    // æ’å…¥åˆ°å ±å‘Šè¼¸å‡ºå€åŸŸ
                    const proposalOutput = document.getElementById('proposalOutput');
                    if (proposalOutput) {
                        proposalOutput.appendChild(kpiContainer);
                    }
                }
                
                // ç”ŸæˆKPIå…§å®¹
                const kpiContent = `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <h4 class="font-medium text-indigo-900">å“ç‰Œç›¸é—œ KPI</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center p-2 bg-white rounded border">
                                    <span class="text-sm text-gray-700">å“ç‰ŒçŸ¥ååº¦</span>
                                    <span class="text-sm font-medium text-indigo-600">ç›®æ¨™: +15%</span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-white rounded border">
                                    <span class="text-sm text-gray-700">å“ç‰Œå¥½æ„Ÿåº¦</span>
                                    <span class="text-sm font-medium text-indigo-600">ç›®æ¨™: +10%</span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-white rounded border">
                                    <span class="text-sm text-gray-700">å“ç‰ŒæåŠåº¦</span>
                                    <span class="text-sm font-medium text-indigo-600">ç›®æ¨™: +20%</span>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <h4 class="font-medium text-indigo-900">è½‰æ›ç›¸é—œ KPI</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center p-2 bg-white rounded border">
                                    <span class="text-sm text-gray-700">é»æ“Šç‡ (CTR)</span>
                                    <span class="text-sm font-medium text-indigo-600">ç›®æ¨™: 2.5%</span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-white rounded border">
                                    <span class="text-sm text-gray-700">è½‰æ›ç‡</span>
                                    <span class="text-sm font-medium text-indigo-600">ç›®æ¨™: 3.0%</span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-white rounded border">
                                    <span class="text-sm text-gray-700">æŠ•è³‡å ±é…¬ç‡ (ROI)</span>
                                    <span class="text-sm font-medium text-indigo-600">ç›®æ¨™: 300%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                kpiContainer.innerHTML += kpiContent;
                
            } catch (error) {
                console.error('ç”ŸæˆKPIè¦–è¦ºåŒ–æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }

        // æ–°å¢ï¼šå ±å‘Šå“è³ªå„ªåŒ–åŠŸèƒ½
        function enhanceReportQuality(reportHTML) {
            try {
                // å‰µå»ºè‡¨æ™‚ DOM å…ƒç´ ä¾†è™•ç† HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = reportHTML;
                
                // 1. æ·»åŠ è¦–è¦ºåŒ–åœ–è¡¨
                addVisualCharts(tempDiv);
                
                // 2. å„ªåŒ–è¡¨æ ¼æ¨£å¼
                enhanceTableStyles(tempDiv);
                
                // 3. æ·»åŠ äº’å‹•å…ƒç´ 
                addInteractiveElements(tempDiv);
                
                // 4. å„ªåŒ–æ–‡å­—æ ¼å¼
                enhanceTextFormatting(tempDiv);
                
                // 5. æ·»åŠ æ‘˜è¦å’Œå°èˆª
                addSummaryAndNavigation(tempDiv);
                
                return tempDiv.innerHTML;
            } catch (error) {
                console.error('å ±å‘Šå“è³ªå„ªåŒ–å¤±æ•—:', error);
                return reportHTML; // è¿”å›åŸå§‹å…§å®¹
            }
        }

        // æ·»åŠ è¦–è¦ºåŒ–åœ–è¡¨
        function addVisualCharts(container) {
            // å°‹æ‰¾é©åˆæ·»åŠ åœ–è¡¨çš„ä½ç½®
            const tables = container.querySelectorAll('table');
            tables.forEach((table, index) => {
                if (table.rows.length > 1) {
                    // ç‚ºè¡¨æ ¼æ·»åŠ åœ–è¡¨å®¹å™¨
                    const chartContainer = document.createElement('div');
                    chartContainer.className = 'mt-4 p-4 bg-gray-50 rounded-lg';
                    chartContainer.innerHTML = `
                        <h4 class="text-sm font-medium text-gray-700 mb-2">ğŸ“Š æ•¸æ“šè¦–è¦ºåŒ–</h4>
                        <div class="text-xs text-gray-500">åœ–è¡¨å°‡æ ¹æ“šè¡¨æ ¼æ•¸æ“šè‡ªå‹•ç”Ÿæˆ</div>
                    `;
                    table.parentNode.insertBefore(chartContainer, table.nextSibling);
                }
            });
        }

        // å„ªåŒ–è¡¨æ ¼æ¨£å¼
        function enhanceTableStyles(container) {
            const tables = container.querySelectorAll('table');
            tables.forEach(table => {
                table.className = 'w-full border-collapse border border-gray-300 rounded-lg overflow-hidden shadow-sm';
                
                // ç‚ºè¡¨æ ¼æ·»åŠ éŸ¿æ‡‰å¼è¨­è¨ˆ
                const wrapper = document.createElement('div');
                wrapper.className = 'overflow-x-auto';
                table.parentNode.insertBefore(wrapper, table);
                wrapper.appendChild(table);
            });
        }

        // æ·»åŠ äº’å‹•å…ƒç´ 
        function addInteractiveElements(container) {
            // ç‚ºé‡è¦æ•¸æ“šæ·»åŠ å·¥å…·æç¤º
            const importantData = container.querySelectorAll('strong');
            importantData.forEach(element => {
                if (element.textContent.includes('NT$') || element.textContent.includes('%')) {
                    element.className = 'text-blue-600 font-semibold cursor-help';
                    element.title = 'é»æ“ŠæŸ¥çœ‹è©³ç´°èªªæ˜';
                }
            });
            
            // ç‚ºå»ºè­°é …ç›®æ·»åŠ å±•é–‹/æ”¶åˆåŠŸèƒ½
            const recommendations = container.querySelectorAll('h3');
            recommendations.forEach(h3 => {
                if (h3.textContent.includes('å»ºè­°')) {
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = 'ml-2 text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded hover:bg-blue-200';
                    toggleBtn.textContent = 'å±•é–‹';
                    toggleBtn.onclick = function() {
                        const nextElement = h3.nextElementSibling;
                        if (nextElement && nextElement.style.display === 'none') {
                            nextElement.style.display = 'block';
                            this.textContent = 'æ”¶åˆ';
                        } else if (nextElement) {
                            nextElement.style.display = 'none';
                            this.textContent = 'å±•é–‹';
                        }
                    };
                    h3.appendChild(toggleBtn);
                }
            });
        }

        // å„ªåŒ–æ–‡å­—æ ¼å¼
        function enhanceTextFormatting(container) {
            // ç‚ºé‡è¦æ®µè½æ·»åŠ èƒŒæ™¯è‰²
            const paragraphs = container.querySelectorAll('p');
            paragraphs.forEach(p => {
                if (p.textContent.includes('é—œéµ') || p.textContent.includes('é‡è¦') || p.textContent.includes('å»ºè­°')) {
                    p.className = 'p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded-r';
                }
            });
            
            // ç‚ºæ•¸å­—æ·»åŠ ç‰¹æ®Šæ¨£å¼
            const textContent = container.innerHTML;
            const enhancedContent = textContent.replace(/(\d{1,3}(,\d{3})*)/g, '<span class="text-green-600 font-semibold">$1</span>');
            container.innerHTML = enhancedContent;
        }

        // æ·»åŠ æ‘˜è¦å’Œå°èˆª
        function addSummaryAndNavigation(container) {
            // å‰µå»ºç›®éŒ„
            const headings = container.querySelectorAll('h2');
            if (headings.length > 0) {
                const toc = document.createElement('div');
                toc.className = 'mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200';
                toc.innerHTML = '<h3 class="text-lg font-semibold text-blue-800 mb-3">ğŸ“‹ å ±å‘Šç›®éŒ„</h3>';
                
                const tocList = document.createElement('ul');
                tocList.className = 'space-y-2';
                
                headings.forEach((heading, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="#section-${index}" class="text-blue-600 hover:text-blue-800 underline">${heading.textContent}</a>`;
                    tocList.appendChild(li);
                    
                    // ç‚ºæ¨™é¡Œæ·»åŠ éŒ¨é»
                    heading.id = `section-${index}`;
                });
                
                toc.appendChild(tocList);
                container.insertBefore(toc, container.firstChild);
            }
            
            // æ·»åŠ è¿”å›é ‚éƒ¨æŒ‰éˆ•
            const backToTop = document.createElement('button');
            backToTop.className = 'fixed bottom-4 right-4 bg-blue-600 text-white p-3 rounded-full shadow-lg hover:bg-blue-700 transition-colors';
            backToTop.innerHTML = 'â†‘';
            backToTop.onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });
            container.appendChild(backToTop);
        }

        // æ–°å¢ï¼šå ±å‘Šå…§å®¹é©—è­‰
        function validateReportContent(reportHTML) {
            const issues = [];
            
            // æª¢æŸ¥æ˜¯å¦åŒ…å«å¿…è¦çš„ç« ç¯€
            const requiredSections = ['åŸ·è¡Œæ‘˜è¦', 'å¸‚å ´ç¸½é«”å°è±¡', 'ç”¢æ¥­è¼¿æƒ…ç›£æ¸¬', 'ç«¶çˆ­å°æ‰‹æ·±åº¦åˆ†æ', 'æ ¸å¿ƒæ´å¯Ÿèˆ‡æ©Ÿæœƒé»', 'é ç®—å¯è¡Œæ€§è©•ä¼°', 'åˆæ­¥ç­–ç•¥å»ºè­°'];
            
            requiredSections.forEach(section => {
                if (!reportHTML.includes(section)) {
                    issues.push(`ç¼ºå°‘ç« ç¯€ï¼š${section}`);
                }
            });
            
            // æª¢æŸ¥æ˜¯å¦åŒ…å«æ•¸æ“šè¡¨æ ¼
            if (!reportHTML.includes('<table')) {
                issues.push('ç¼ºå°‘æ•¸æ“šè¡¨æ ¼');
            }
            
            // æª¢æŸ¥æ˜¯å¦åŒ…å«å»ºè­°é …ç›®
            if (!reportHTML.includes('å»ºè­°')) {
                issues.push('ç¼ºå°‘å…·é«”å»ºè­°');
            }
            
            return issues;
        }

        // æ–°å¢ï¼šå ±å‘Šè©•åˆ†ç³»çµ±
        function scoreReport(reportHTML) {
            let score = 0;
            const maxScore = 100;
            
            // å…§å®¹å®Œæ•´æ€§ (30åˆ†)
            const requiredElements = ['åŸ·è¡Œæ‘˜è¦', 'å¸‚å ´åˆ†æ', 'ç«¶çˆ­åˆ†æ', 'ç­–ç•¥å»ºè­°', 'é ç®—è¦åŠƒ'];
            const completeness = requiredElements.filter(element => reportHTML.includes(element)).length;
            score += (completeness / requiredElements.length) * 30;
            
            // æ•¸æ“šè±å¯Œåº¦ (25åˆ†)
            const dataElements = ['<table', 'åœ–è¡¨', 'çµ±è¨ˆ', 'ç™¾åˆ†æ¯”', 'æ•¸å­—'];
            const dataRichness = dataElements.filter(element => reportHTML.includes(element)).length;
            score += (dataRichness / dataElements.length) * 25;
            
            // å»ºè­°å¯¦ç”¨æ€§ (25åˆ†)
            const suggestionElements = ['å»ºè­°', 'ç­–ç•¥', 'æ–¹æ¡ˆ', 'è¡Œå‹•', 'åŸ·è¡Œ'];
            const suggestionQuality = suggestionElements.filter(element => reportHTML.includes(element)).length;
            score += (suggestionQuality / suggestionElements.length) * 25;
            
            // è¦–è¦ºå‘ˆç¾ (20åˆ†)
            const visualElements = ['<div', 'class', 'style', 'èƒŒæ™¯', 'é¡è‰²'];
            const visualQuality = visualElements.filter(element => reportHTML.includes(element)).length;
            score += (visualQuality / visualElements.length) * 20;
            
            return Math.round(score);
        }
        generateBtn.addEventListener('click', async function () {
    // 1. UI é¡¯ç¤º loading
    proposalOutput.innerHTML = `<div class="text-center text-blue-600">å ±å‘Šç”¢ç”Ÿä¸­ï¼Œè«‹ç¨å€™â€¦</div>`;

    // 2. å–å¾— API é‡‘é‘°èˆ‡è¡¨å–®è³‡æ–™
    const apiKey = apiKeyInput.value.trim();
    if (!apiKey) {
        proposalOutput.innerHTML = `<div class="text-red-600">è«‹è¼¸å…¥ Google Gemini API é‡‘é‘°ï¼</div>`;
        return;
    }

    // 3. çµ„åˆ Promptï¼ˆæ­¤è™•åƒ…èˆ‰ä¾‹ï¼Œå¯ä¾éœ€æ±‚çµ„åˆæ›´å®Œæ•´ï¼‰
    const targetBrand = targetBrandInput.value.trim();
    const competitorBrand = competitorBrandInput.value.trim();
    const industry = industryInput.value;
    const adObjective = adObjectiveInput.value;
    const prompt = `è«‹é‡å°ä»¥ä¸‹æ¢ä»¶ç”¢ç”Ÿå°ç£å¸‚å ´çš„åª’é«”ç­–ç•¥åˆ†æå ±å‘Šï¼š
- ç›®æ¨™å“ç‰Œ/ç”¢å“: ${targetBrand}
- ä¸»è¦ç«¶çˆ­å°æ‰‹: ${competitorBrand}
- ç”¢æ¥­é¡åˆ¥: ${industry}
- å»£å‘Šç›®æ¨™: ${adObjective}
è«‹ä»¥å°ˆæ¥­æ ¼å¼ç”¢å‡ºä¸€ä»½å®Œæ•´å»ºè­°å ±å‘Šã€‚`;

    try {
        // 4. å‘¼å« Gemini API
        const result = await callGeminiAPI(prompt, apiKey, false);
        // 5. é¡¯ç¤ºçµæœ
        proposalOutput.innerHTML = `<div class="prose max-w-none">${result}</div>`;
        // 6. é¡¯ç¤ºåŒ¯å‡ºç­‰åŠŸèƒ½
        document.getElementById('exportControls').style.display = 'flex';
    } catch (err) {
        proposalOutput.innerHTML = `<div class="text-red-600">ç”¢ç”Ÿå ±å‘Šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š${err.message}</div>`;
        console.error(err);
    }
                  // 4. å‘¼å« Gemini API
        const result = await callGeminiAPI(prompt, apiKey, false);
        // 5. é¡¯ç¤ºçµæœ
        proposalOutput.innerHTML = `<div class="prose max-w-none">${result}</div>`;
        // 6. é¡¯ç¤ºåŒ¯å‡ºç­‰åŠŸèƒ½
        document.getElementById('exportControls').style.display = 'flex';
    } catch (err) {
        proposalOutput.innerHTML = `<div class="text-red-600">ç”¢ç”Ÿå ±å‘Šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š${err.message}</div>`;
        console.error(err);
    }
});      
    </script>
</body>
</html>


