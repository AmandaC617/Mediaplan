<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自動化媒體提案引擎 (台灣市場特化版 MVP)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%);
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #818cf8 100%);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(0,0,0,0.1);
        }
        .btn-primary:disabled {
            background: #a5b4fc;
            cursor: not-allowed;
            transform: translateY(0);
            box-shadow: none;
        }
        #proposalOutput h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e3a8a;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #60a5fa;
            padding-bottom: 0.5rem;
        }
        #proposalOutput h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1d4ed8;
            margin-top: 1.25rem;
            margin-bottom: 0.75rem;
        }
        #proposalOutput p, #proposalOutput li, #proposalOutput td, #proposalOutput th {
            color: #374151;
            line-height: 1.7;
        }
        #proposalOutput p, #proposalOutput ul {
             margin-bottom: 1rem;
        }
        #proposalOutput ul {
            list-style-type: disc;
            padding-left: 1.5rem;
        }
        #proposalOutput strong {
            color: #1e40af;
            font-weight: 600;
        }
        .status-update {
            transition: all 0.5s ease;
            overflow: hidden;
            max-height: 0;
            opacity: 0;
        }
        .status-update.active {
            max-height: 100px; /* or a suitable max-height */
            opacity: 1;
            margin-top: 1rem;
        }
        .input-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 1.5rem;
        }
        @media (min-width: 1024px) {
            .input-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        #proposalOutput table {
            width: 100%;
            margin-top: 1rem;
            margin-bottom: 1rem;
            border-collapse: collapse;
        }
        #proposalOutput th, #proposalOutput td {
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            text-align: left;
        }
        #proposalOutput th {
            background-color: #f9fafb;
            font-weight: 600;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-6xl mx-auto">
        <div class="card p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">自動化媒體提案引擎</h1>
                <p class="mt-2 text-gray-600">v2.8 Gemini 2.0 優化版 (MVP)</p>
            </div>

            <!-- Module 1: 使用者與配置介面 ('駕駛艙') -->
            <div class="space-y-6">
                 <!-- API 金鑰輸入 -->
                <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <label for="apiKeyInput" class="block text-sm font-medium text-yellow-800 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 8a6 6 0 11-12 0 6 6 0 0112 0zM7 8a1 1 0 11-2 0 1 1 0 012 0zm5 0a1 1 0 11-2 0 1 1 0 012 0zm5 0a1 1 0 11-2 0 1 1 0 012 0z" clip-rule="evenodd"></path></svg>
                        Google Gemini API 金鑰 <span class="text-red-500 ml-1">*</span>
                    </label>
                    <input type="password" id="apiKeyInput" class="mt-1 block w-full px-3 py-2 border border-yellow-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="請在此貼上您的 API 金鑰">
                    <p class="mt-2 text-xs text-yellow-700">此金鑰僅存於您目前的瀏覽器分頁，關閉後即消失，不會被儲存。</p>
                </div>

                <!-- AI 模型選擇 -->
                <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                    <label for="modelSelection" class="block text-sm font-medium text-green-800 flex items-center mb-2">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
                        AI 模型選擇
                    </label>
                    <div class="space-y-3">
                        <div class="flex items-center">
                            <input type="radio" id="modelAuto" name="modelSelection" value="auto" class="mr-2" checked>
                            <label for="modelAuto" class="text-sm text-green-700">
                                <span class="font-medium">自動選擇</span> - 系統自動選擇最佳模型（推薦）
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="modelPro" name="modelSelection" value="pro" class="mr-2">
                            <label for="modelPro" class="text-sm text-green-700">
                                <span class="font-medium">Gemini 1.5 Pro</span> - 深度分析模型，適合複雜策略規劃
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="modelFlash" name="modelSelection" value="flash" class="mr-2">
                            <label for="modelFlash" class="text-sm text-green-700">
                                <span class="font-medium">Gemini 2.0 Flash</span> - 最新版本，最快最穩定（推薦）
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="modelPro" name="modelSelection" value="pro" class="mr-2">
                            <label for="modelPro" class="text-sm text-green-700">
                                <span class="font-medium">Gemini 1.5 Pro</span> - 深度分析模型，適合複雜策略規劃
                            </label>
                        </div>
                    </div>
                    <p class="mt-2 text-xs text-green-600">
                        <strong>Gemini 2.0 Flash 特色：</strong>最新版本，速度提升 30%，更穩定的回應品質
                        <br><strong>Pro 模型特色：</strong>支援更長的上下文、更深入的推理能力、更好的多語言理解
                    </p>
                </div>

                <!-- 系統狀態指示器 -->
                <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <!-- 網路狀態 -->
                            <div class="flex items-center">
                                <div id="networkStatus" class="w-3 h-3 rounded-full bg-green-500 mr-2"></div>
                                <span id="networkText" class="text-sm text-blue-800">網路連接正常</span>
                            </div>
                            <!-- API 狀態 -->
                            <div class="flex items-center">
                                <div id="apiStatus" class="w-3 h-3 rounded-full bg-gray-400 mr-2"></div>
                                <span id="apiText" class="text-sm text-blue-800">API 未測試</span>
                            </div>
                            <!-- 當前模型 -->
                            <div class="flex items-center">
                                <div id="modelStatus" class="w-3 h-3 rounded-full bg-purple-500 mr-2"></div>
                                <span id="modelText" class="text-sm text-blue-800">模型未選擇</span>
                            </div>
                        </div>
                        <!-- 系統版本 -->
                        <div class="text-xs text-blue-600">
                            系統版本: v2.8 | 最後更新: 2024-12-19
                        </div>
                    </div>
                </div>
                
                <div class="border-t border-gray-200 pt-6">
                    <div class="input-grid">
                        <div>
                            <label for="targetBrand" class="block text-sm font-medium text-gray-700">目標品牌 / 產品 <span class="text-red-500">*</span></label>
                            <input type="text" id="targetBrand" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="例如：gogoro, 星宇航空">
                        </div>
                        <div>
                            <label for="competitorBrand" class="block text-sm font-medium text-gray-700">主要競爭對手 <span class="text-red-500">*</span></label>
                            <input type="text" id="competitorBrand" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="例如：光陽, 長榮航空">
                        </div>
                         <div>
                            <label for="industry" class="block text-sm font-medium text-gray-700 mb-2">產業類別 <span class="text-red-500">*</span></label>
                            <select id="industry" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">請選擇產業類別</option>
                                <optgroup label="科技產業">
                                    <option value="軟體開發">軟體開發</option>
                                    <option value="電子商務">電子商務</option>
                                    <option value="人工智慧">人工智慧</option>
                                    <option value="物聯網">物聯網</option>
                                    <option value="區塊鏈">區塊鏈</option>
                                    <option value="雲端服務">雲端服務</option>
                                    <option value="數位行銷">數位行銷</option>
                                    <option value="遊戲產業">遊戲產業</option>
                                    <option value="硬體製造">硬體製造</option>
                                    <option value="網路服務">網路服務</option>
                                </optgroup>
                                <optgroup label="消費品產業">
                                    <option value="美妝保養">美妝保養</option>
                                    <option value="服飾時尚">服飾時尚</option>
                                    <option value="食品飲料">食品飲料</option>
                                    <option value="家居用品">家居用品</option>
                                    <option value="運動用品">運動用品</option>
                                    <option value="母嬰用品">母嬰用品</option>
                                    <option value="寵物用品">寵物用品</option>
                                    <option value="個人護理">個人護理</option>
                                </optgroup>
                                <optgroup label="金融服務">
                                    <option value="銀行業">銀行業</option>
                                    <option value="保險業">保險業</option>
                                    <option value="投資理財">投資理財</option>
                                    <option value="支付服務">支付服務</option>
                                    <option value="FinTech">FinTech</option>
                                    <option value="房地產">房地產</option>
                                </optgroup>
                                <optgroup label="教育與培訓">
                                    <option value="線上教育">線上教育</option>
                                    <option value="語言學習">語言學習</option>
                                    <option value="職業培訓">職業培訓</option>
                                    <option value="兒童教育">兒童教育</option>
                                    <option value="高等教育">高等教育</option>
                                    <option value="技能培訓">技能培訓</option>
                                </optgroup>
                                <optgroup label="健康醫療">
                                    <option value="醫療服務">醫療服務</option>
                                    <option value="健康管理">健康管理</option>
                                    <option value="健身運動">健身運動</option>
                                    <option value="營養保健">營養保健</option>
                                    <option value="心理健康">心理健康</option>
                                    <option value="醫美整形">醫美整形</option>
                                </optgroup>
                                <optgroup label="交通運輸">
                                    <option value="共享交通">共享交通</option>
                                    <option value="物流配送">物流配送</option>
                                    <option value="旅遊服務">旅遊服務</option>
                                    <option value="航空運輸">航空運輸</option>
                                    <option value="汽車產業">汽車產業</option>
                                    <option value="大眾運輸">大眾運輸</option>
                                </optgroup>
                                <optgroup label="娛樂媒體">
                                    <option value="影視製作">影視製作</option>
                                    <option value="音樂產業">音樂產業</option>
                                    <option value="出版業">出版業</option>
                                    <option value="直播平台">直播平台</option>
                                    <option value="短影片">短影片</option>
                                    <option value="Podcast">Podcast</option>
                                </optgroup>
                                <optgroup label="其他產業">
                                    <option value="政府機關">政府機關</option>
                                    <option value="非營利組織">非營利組織</option>
                                    <option value="製造業">製造業</option>
                                    <option value="能源產業">能源產業</option>
                                    <option value="環保產業">環保產業</option>
                                    <option value="農業科技">農業科技</option>
                                </optgroup>
                            </select>
                        </div>
                        <div>
                            <label for="industryStatus" class="block text-sm font-medium text-gray-700 mb-2">產業狀態 <span class="text-red-500">*</span></label>
                            <select id="industryStatus" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">請選擇產業狀態</option>
                                <option value="新創期">新創期 - 市場剛起步，競爭較少</option>
                                <option value="成長期">成長期 - 市場快速擴張，競爭加劇</option>
                                <option value="成熟期">成熟期 - 市場穩定，競爭激烈</option>
                                <option value="衰退期">衰退期 - 市場萎縮，需要轉型</option>
                                <option value="轉型期">轉型期 - 產業結構調整，新機會出現</option>
                                <option value="復甦期">復甦期 - 市場重新活絡</option>
                                <option value="創新期">創新期 - 技術突破帶來新機會</option>
                                <option value="整合期">整合期 - 產業併購整合階段</option>
                            </select>
                        </div>
                         <div>
                            <label for="businessModel" class="block text-sm font-medium text-gray-700">商業模式 <span class="text-red-500">*</span></label>
                             <select id="businessModel" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="B2C">B2C (企業對消費者)</option>
                                <option value="B2B">B2B (企業對企業)</option>
                            </select>
                        </div>
                         <div>
                            <label for="salesChannels" class="block text-sm font-medium text-gray-700">主要銷售通路</label>
                            <input type="text" id="salesChannels" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="例如：線上官網、MOMO、實體門市">
                        </div>
                        <div>
                            <label for="targetAudience" class="block text-sm font-medium text-gray-700">目標人群描述</label>
                            <input type="text" id="targetAudience" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="例如：25-35歲都會女性、科技業採購主管">
                        </div>
                        <div class="md:col-span-2">
                            <label for="marketingProblems" class="block text-sm font-medium text-gray-700">品牌行銷問題描述 <span class="text-blue-500">💡</span></label>
                            <textarea id="marketingProblems" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="請描述您目前遇到的行銷問題或挑戰，例如：&#10;• 品牌知名度不足，消費者對我們不熟悉&#10;• 競爭對手廣告投放量大，我們難以突圍&#10;• 目標人群對我們的產品價值認知不清&#10;• 轉換率偏低，廣告點擊多但購買少&#10;• 預算有限，不知道如何最大化效益"></textarea>
                            <p class="mt-1 text-xs text-gray-500">詳細描述問題將幫助 AI 提供更精準的策略建議</p>
                        </div>
                         <div class="md:col-span-3">
                            <label for="advertisingBudget" class="block text-sm font-medium text-gray-700">預計廣告預算 (台幣)</label>
                            <input type="number" id="advertisingBudget" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="例如：300000">
                        </div>
                        <div>
                            <label for="adObjective" class="block text-sm font-medium text-gray-700">廣告目標與目的 <span class="text-red-500">*</span></label>
                            <select id="adObjective" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="品牌知名度">品牌知名度</option>
                                <option value="銷售提升">銷售提升</option>
                                <option value="會員招募">會員招募</option>
                                <option value="活動推廣">活動推廣</option>
                                <option value="APP下載">APP下載</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div>
                            <label for="adFormat" class="block text-sm font-medium text-gray-700 mb-2">廣告形式</label>
                            <div class="space-y-3">
                                <div class="flex items-center">
                                    <input type="checkbox" id="aiRecommendMedia" class="mr-2">
                                    <label for="aiRecommendMedia" class="text-sm text-gray-700">請 AI 建議最適合的媒體組合</label>
                                </div>
                                <div id="mediaSelection" class="space-y-2">
                                    <div class="grid grid-cols-2 gap-3">
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="數位廣告" class="mr-2">
                                            <span class="text-sm">數位廣告</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="社群媒體廣告" class="mr-2">
                                            <span class="text-sm">社群媒體廣告</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="搜尋引擎廣告" class="mr-2">
                                            <span class="text-sm">搜尋引擎廣告</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="影音廣告" class="mr-2">
                                            <span class="text-sm">影音廣告</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="展示廣告" class="mr-2">
                                            <span class="text-sm">展示廣告</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="原生廣告" class="mr-2">
                                            <span class="text-sm">原生廣告</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="影響者行銷" class="mr-2">
                                            <span class="text-sm">影響者行銷</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="內容行銷" class="mr-2">
                                            <span class="text-sm">內容行銷</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="整合行銷" class="mr-2">
                                            <span class="text-sm">整合行銷</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="戶外廣告" class="mr-2">
                                            <span class="text-sm">戶外廣告</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="電視廣告" class="mr-2">
                                            <span class="text-sm">電視廣告</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="廣播廣告" class="mr-2">
                                            <span class="text-sm">廣播廣告</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="雜誌廣告" class="mr-2">
                                            <span class="text-sm">雜誌廣告</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="報紙廣告" class="mr-2">
                                            <span class="text-sm">報紙廣告</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="活動行銷" class="mr-2">
                                            <span class="text-sm">活動行銷</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="competitors" class="block text-sm font-medium text-gray-700 mb-2">主要競爭對手</label>
                    <textarea id="competitors" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="請列出主要競爭對手的品牌名稱與產品名稱，例如：&#10;Apple iPhone 15&#10;Samsung Galaxy S24&#10;Google Pixel 8"></textarea>
                </div>

                <!-- 重點標註區塊 -->
                <div class="border-t border-gray-200 pt-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        重點標註與時間規劃
                    </h3>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- 行銷時間段 -->
                        <div class="space-y-4">
                            <div>
                                <label for="marketingTimeline" class="block text-sm font-medium text-gray-700 mb-2">行銷時間段規劃 <span class="text-blue-500">📅</span></label>
                                <div class="space-y-3">
                                    <div class="flex items-center space-x-4">
                                        <div class="flex-1">
                                            <label class="block text-xs text-gray-600 mb-1">開始日期</label>
                                            <input type="date" id="campaignStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        </div>
                                        <div class="flex-1">
                                            <label class="block text-xs text-gray-600 mb-1">結束日期</label>
                                            <input type="date" id="campaignEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        </div>
                                    </div>
                                    <div>
                                        <label for="campaignDuration" class="block text-xs text-gray-600 mb-1">活動持續時間</label>
                                        <select id="campaignDuration" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="">請選擇活動持續時間</option>
                                            <option value="短期(1-2週)">短期(1-2週)</option>
                                            <option value="中期(1-3個月)">中期(1-3個月)</option>
                                            <option value="長期(3-6個月)">長期(3-6個月)</option>
                                            <option value="年度計畫(6-12個月)">年度計畫(6-12個月)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="keyMilestones" class="block text-xs text-gray-600 mb-1">重要里程碑</label>
                                        <textarea id="keyMilestones" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="請列出重要的行銷里程碑，例如：&#10;• 產品上市日期&#10;• 重要節慶活動&#10;• 競品新品發表時間&#10;• 產業展覽會期"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 競爭對手分析比較 -->
                        <div class="space-y-4">
                            <div>
                                <label for="competitorAnalysis" class="block text-sm font-medium text-gray-700 mb-2">競爭對手分析比較 <span class="text-red-500">⚔️</span></label>
                                <div class="space-y-3">
                                    <div>
                                        <label for="competitorTimeline" class="block text-xs text-gray-600 mb-1">競爭對手近期活動時間線</label>
                                        <textarea id="competitorTimeline" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="請描述競爭對手近期的行銷活動，例如：&#10;• 2024年3月：Apple發表iPhone 15系列&#10;• 2024年4月：Samsung推出Galaxy S24廣告&#10;• 2024年5月：Google Pixel 8促銷活動"></textarea>
                                    </div>
                                    <div>
                                        <label for="competitiveAdvantage" class="block text-xs text-gray-600 mb-1">我們的競爭優勢</label>
                                        <textarea id="competitiveAdvantage" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="請描述相對於競爭對手的優勢，例如：&#10;• 價格優勢：比競品便宜20%&#10;• 技術優勢：獨家專利技術&#10;• 服務優勢：24小時客服支援&#10;• 品牌優勢：在地化品牌形象"></textarea>
                                    </div>
                                    <div>
                                        <label for="competitiveGaps" class="block text-xs text-gray-600 mb-1">需要彌補的差距</label>
                                        <textarea id="competitiveGaps" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="請描述需要彌補的競爭差距，例如：&#10;• 品牌知名度不如競品&#10;• 通路覆蓋率較低&#10;• 產品功能需要強化&#10;• 客戶服務需要改善"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 市場時機與機會點 -->
                    <div class="mt-6">
                        <label for="marketOpportunities" class="block text-sm font-medium text-gray-700 mb-2">市場時機與機會點 <span class="text-green-500">🎯</span></label>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <div>
                                <label for="seasonalFactors" class="block text-xs text-gray-600 mb-1">季節性因素</label>
                                <select id="seasonalFactors" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">請選擇季節性因素</option>
                                    <option value="春節期間">春節期間</option>
                                    <option value="暑假旺季">暑假旺季</option>
                                    <option value="開學季">開學季</option>
                                    <option value="聖誕節">聖誕節</option>
                                    <option value="雙11購物節">雙11購物節</option>
                                    <option value="年終促銷">年終促銷</option>
                                    <option value="無明顯季節性">無明顯季節性</option>
                                    <option value="其他">其他</option>
                                </select>
                            </div>
                            <div>
                                <label for="marketTrends" class="block text-xs text-gray-600 mb-1">市場趨勢</label>
                                <textarea id="marketTrends" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="請描述當前市場趨勢，例如：&#10;• 消費者偏好環保產品&#10;• 線上購物需求增加&#10;• 健康意識提升"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- 市場變化因素分析 -->
                    <div class="mt-6 p-4 bg-orange-50 border border-orange-200 rounded-lg">
                        <h4 class="text-md font-semibold text-orange-800 mb-4 flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.71-4.733-.47A7.993 7.993 0 0112 4a7.993 7.993 0 01-.605 2.553z" clip-rule="evenodd"></path>
                            </svg>
                            市場變化因素分析 <span class="text-orange-600">📊</span>
                        </h4>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- 宏觀經濟因素 -->
                            <div class="space-y-4">
                                <h5 class="text-sm font-medium text-orange-700">宏觀經濟因素</h5>
                                <div class="space-y-3">
                                    <div>
                                        <label for="economicTrend" class="block text-xs text-gray-600 mb-1">經濟趨勢影響</label>
                                        <select id="economicTrend" class="w-full px-3 py-2 border border-orange-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                                            <option value="">請選擇經濟趨勢</option>
                                            <option value="經濟成長期">經濟成長期 - 消費力強，市場活絡</option>
                                            <option value="經濟穩定期">經濟穩定期 - 市場平穩發展</option>
                                            <option value="經濟調整期">經濟調整期 - 消費趨於保守</option>
                                            <option value="通貨膨脹期">通貨膨脹期 - 成本上升，價格敏感</option>
                                            <option value="經濟衰退期">經濟衰退期 - 消費緊縮，需求下降</option>
                                            <option value="復甦期">復甦期 - 市場重新活絡</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="interestRate" class="block text-xs text-gray-600 mb-1">利率環境</label>
                                        <select id="interestRate" class="w-full px-3 py-2 border border-orange-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                                            <option value="">請選擇利率環境</option>
                                            <option value="低利率環境">低利率環境 - 借貸成本低，投資活絡</option>
                                            <option value="升息環境">升息環境 - 借貸成本上升，消費趨於保守</option>
                                            <option value="降息環境">降息環境 - 刺激經濟，消費意願提升</option>
                                            <option value="利率穩定">利率穩定 - 市場預期穩定</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="currencyTrend" class="block text-xs text-gray-600 mb-1">匯率趨勢</label>
                                        <select id="currencyTrend" class="w-full px-3 py-2 border border-orange-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                                            <option value="">請選擇匯率趨勢</option>
                                            <option value="台幣升值">台幣升值 - 進口成本降低</option>
                                            <option value="台幣貶值">台幣貶值 - 出口競爭力提升</option>
                                            <option value="匯率穩定">匯率穩定 - 市場預期穩定</option>
                                            <option value="匯率波動">匯率波動 - 不確定性增加</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- 產業變化因素 -->
                            <div class="space-y-4">
                                <h5 class="text-sm font-medium text-orange-700">產業變化因素</h5>
                                <div class="space-y-3">
                                    <div>
                                        <label for="technologyDisruption" class="block text-xs text-gray-600 mb-1">技術顛覆</label>
                                        <select id="technologyDisruption" class="w-full px-3 py-2 border border-orange-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                                            <option value="">請選擇技術顛覆程度</option>
                                            <option value="高度顛覆">高度顛覆 - AI、自動化等新技術快速發展</option>
                                            <option value="中度顛覆">中度顛覆 - 技術逐步演進</option>
                                            <option value="低度顛覆">低度顛覆 - 技術相對穩定</option>
                                            <option value="無明顯顛覆">無明顯顛覆 - 傳統技術為主</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="regulatoryChanges" class="block text-xs text-gray-600 mb-1">法規變化</label>
                                        <select id="regulatoryChanges" class="w-full px-3 py-2 border border-orange-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                                            <option value="">請選擇法規變化</option>
                                            <option value="法規趨嚴">法規趨嚴 - 合規成本上升</option>
                                            <option value="法規放寬">法規放寬 - 市場進入門檻降低</option>
                                            <option value="法規穩定">法規穩定 - 政策環境穩定</option>
                                            <option value="法規不確定">法規不確定 - 政策方向不明</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="supplyChainIssues" class="block text-xs text-gray-600 mb-1">供應鏈狀況</label>
                                        <select id="supplyChainIssues" class="w-full px-3 py-2 border border-orange-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                                            <option value="">請選擇供應鏈狀況</option>
                                            <option value="供應鏈穩定">供應鏈穩定 - 正常運作</option>
                                            <option value="供應鏈緊張">供應鏈緊張 - 交期延長，成本上升</option>
                                            <option value="供應鏈重組">供應鏈重組 - 重新布局中</option>
                                            <option value="供應鏈多元化">供應鏈多元化 - 分散風險</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 消費者行為變化 -->
                        <div class="mt-6">
                            <h5 class="text-sm font-medium text-orange-700 mb-3">消費者行為變化</h5>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                <div>
                                    <label for="consumerConfidence" class="block text-xs text-gray-600 mb-1">消費者信心指數</label>
                                    <select id="consumerConfidence" class="w-full px-3 py-2 border border-orange-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                                        <option value="">請選擇消費者信心</option>
                                        <option value="高度樂觀">高度樂觀 - 消費意願強烈</option>
                                        <option value="適度樂觀">適度樂觀 - 正常消費行為</option>
                                        <option value="保守觀望">保守觀望 - 消費趨於謹慎</option>
                                        <option value="悲觀緊縮">悲觀緊縮 - 消費大幅減少</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="digitalAdoption" class="block text-xs text-gray-600 mb-1">數位化程度</label>
                                    <select id="digitalAdoption" class="w-full px-3 py-2 border border-orange-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                                        <option value="">請選擇數位化程度</option>
                                        <option value="高度數位化">高度數位化 - 線上消費為主</option>
                                        <option value="中度數位化">中度數位化 - 線上線下並重</option>
                                        <option value="低度數位化">低度數位化 - 實體消費為主</option>
                                        <option value="快速轉型中">快速轉型中 - 數位化加速</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label for="consumerBehaviorChanges" class="block text-xs text-gray-600 mb-1">具體行為變化描述</label>
                                <textarea id="consumerBehaviorChanges" rows="3" class="w-full px-3 py-2 border border-orange-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="請描述目標消費者的具體行為變化，例如：&#10;• 更注重性價比，價格敏感度提升&#10;• 偏好環保、永續的產品&#10;• 線上購物頻率增加&#10;• 更重視品牌價值和社會責任&#10;• 健康意識提升，相關產品需求增加"></textarea>
                            </div>
                        </div>

                        <!-- 競爭環境變化 -->
                        <div class="mt-6">
                            <h5 class="text-sm font-medium text-orange-700 mb-3">競爭環境變化</h5>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                <div>
                                    <label for="newEntrants" class="block text-xs text-gray-600 mb-1">新進入者威脅</label>
                                    <select id="newEntrants" class="w-full px-3 py-2 border border-orange-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                                        <option value="">請選擇新進入者威脅</option>
                                        <option value="高度威脅">高度威脅 - 大量新競爭者進入</option>
                                        <option value="中度威脅">中度威脅 - 部分新競爭者進入</option>
                                        <option value="低度威脅">低度威脅 - 進入門檻高</option>
                                        <option value="無明顯威脅">無明顯威脅 - 市場相對穩定</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="marketConsolidation" class="block text-xs text-gray-600 mb-1">市場整合程度</label>
                                    <select id="marketConsolidation" class="w-full px-3 py-2 border border-orange-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                                        <option value="">請選擇市場整合程度</option>
                                        <option value="高度整合">高度整合 - 併購頻繁，大者恆大</option>
                                        <option value="中度整合">中度整合 - 部分整合活動</option>
                                        <option value="低度整合">低度整合 - 市場分散</option>
                                        <option value="無明顯整合">無明顯整合 - 市場結構穩定</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label for="competitiveDynamics" class="block text-xs text-gray-600 mb-1">競爭動態變化</label>
                                <textarea id="competitiveDynamics" rows="3" class="w-full px-3 py-2 border border-orange-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="請描述競爭環境的具體變化，例如：&#10;• 主要競爭對手推出新產品或服務&#10;• 價格戰加劇，利潤率下降&#10;• 新技術或商業模式顛覆市場&#10;• 國際品牌進入台灣市場&#10;• 本土品牌國際化擴張"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- 重點標註設定 -->
                    <div class="mt-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">重點標註設定 <span class="text-purple-500">📌</span></label>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                            <div class="flex items-center space-x-3 p-3 border rounded-lg">
                                <input type="checkbox" id="highlightTimeline" class="w-4 h-4 text-blue-600">
                                <label for="highlightTimeline" class="text-sm text-gray-700">生成時間線視覺化</label>
                            </div>
                            <div class="flex items-center space-x-3 p-3 border rounded-lg">
                                <input type="checkbox" id="highlightCompetitors" class="w-4 h-4 text-blue-600">
                                <label for="highlightCompetitors" class="text-sm text-gray-700">競爭對手比較分析</label>
                            </div>
                            <div class="flex items-center space-x-3 p-3 border rounded-lg">
                                <input type="checkbox" id="highlightOpportunities" class="w-4 h-4 text-blue-600">
                                <label for="highlightOpportunities" class="text-sm text-gray-700">市場機會點分析</label>
                            </div>
                            <div class="flex items-center space-x-3 p-3 border rounded-lg">
                                <input type="checkbox" id="highlightMilestones" class="w-4 h-4 text-blue-600">
                                <label for="highlightMilestones" class="text-sm text-gray-700">重要里程碑提醒</label>
                            </div>
                            <div class="flex items-center space-x-3 p-3 border rounded-lg">
                                <input type="checkbox" id="highlightRisks" class="w-4 h-4 text-blue-600">
                                <label for="highlightRisks" class="text-sm text-gray-700">風險評估與建議</label>
                            </div>
                            <div class="flex items-center space-x-3 p-3 border rounded-lg">
                                <input type="checkbox" id="highlightKPIs" class="w-4 h-4 text-blue-600">
                                <label for="highlightKPIs" class="text-sm text-gray-700">關鍵績效指標</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="targetMarkets" class="block text-sm font-medium text-gray-700 mb-2">目標市場</label>
                    <select id="targetMarkets" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="台灣">台灣</option>
                        <option value="台灣,香港">台灣 + 香港</option>
                        <option value="台灣,新加坡">台灣 + 新加坡</option>
                        <option value="台灣,馬來西亞">台灣 + 馬來西亞</option>
                        <option value="台灣,泰國">台灣 + 泰國</option>
                        <option value="台灣,越南">台灣 + 越南</option>
                        <option value="台灣,菲律賓">台灣 + 菲律賓</option>
                        <option value="台灣,印尼">台灣 + 印尼</option>
                        <option value="台灣,日本">台灣 + 日本</option>
                        <option value="台灣,韓國">台灣 + 韓國</option>
                        <option value="台灣,中國">台灣 + 中國</option>
                        <option value="台灣,美國">台灣 + 美國</option>
                        <option value="台灣,加拿大">台灣 + 加拿大</option>
                        <option value="台灣,澳洲">台灣 + 澳洲</option>
                        <option value="台灣,英國">台灣 + 英國</option>
                        <option value="台灣,德國">台灣 + 德國</option>
                        <option value="台灣,法國">台灣 + 法國</option>
                        <option value="全球">全球策略</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label for="targetLanguages" class="block text-sm font-medium text-gray-700 mb-2">目標語言</label>
                    <select id="targetLanguages" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="繁體中文">繁體中文</option>
                        <option value="繁體中文,簡體中文">繁體中文 + 簡體中文</option>
                        <option value="繁體中文,英文">繁體中文 + 英文</option>
                        <option value="繁體中文,日文">繁體中文 + 日文</option>
                        <option value="繁體中文,韓文">繁體中文 + 韓文</option>
                        <option value="繁體中文,泰文">繁體中文 + 泰文</option>
                        <option value="繁體中文,越南文">繁體中文 + 越南文</option>
                        <option value="繁體中文,印尼文">繁體中文 + 印尼文</option>
                        <option value="繁體中文,馬來文">繁體中文 + 馬來文</option>
                        <option value="繁體中文,菲律賓文">繁體中文 + 菲律賓文</option>
                        <option value="繁體中文,德文">繁體中文 + 德文</option>
                        <option value="繁體中文,法文">繁體中文 + 法文</option>
                        <option value="繁體中文,西班牙文">繁體中文 + 西班牙文</option>
                        <option value="多語言">多語言策略</option>
                    </select>
                </div>


                <button id="generateBtn" class="btn-primary px-8 py-3 rounded-lg text-lg font-semibold w-full">
                    生成 AI 分析報告
                </button>
            </div>

            <!-- 動態狀態更新區域 -->

            <!-- Module 4: 輸出與交付模組 ('渲染層') -->
            <div id="proposalOutput" class="mt-8 p-6 bg-white rounded-lg shadow-lg">
                <div class="text-center text-gray-500">
                    <svg class="mx-auto h-12 w-12 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <p>AI 分析報告將在此處顯示</p>
                </div>
                
                <!-- 新增：報告導出功能 -->
                <div id="exportControls" class="mt-4 flex flex-wrap gap-3 justify-center" style="display: none;">
                    <button id="exportPDF" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V8z" clip-rule="evenodd"></path>
                        </svg>
                        匯出 PDF
                    </button>
                    <button id="exportWord" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                        </svg>
                        匯出 Word
                    </button>
                    <button id="exportPPT" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
                        </svg>
                        匯出簡報
                    </button>
                    <button id="shareReport" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"></path>
                        </svg>
                        分享報告
                    </button>
                </div>
            </div>
            
            <!-- Positioning 圖表區域 -->
            <div id="positioningChartContainer" class="mt-8 border-t-2 border-gray-200 pt-6" style="display: none;">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">品牌定位分析圖表</h2>
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <canvas id="positioningChart" width="400" height="400"></canvas>
                </div>
            </div>
        </div>
        <footer class="text-center mt-4 text-sm text-gray-500">
            <p>本原型由 Google Gemini 驅動，所有分析皆為即時生成。</p>
        </footer>
    </div>

    <script type="module">
        // --- Module 1: 介面控制與資料收集 ('控制層') ---
        const apiKeyInput = document.getElementById('apiKeyInput');
        const targetBrandInput = document.getElementById('targetBrand');
        const competitorBrandInput = document.getElementById('competitorBrand');
        const industryInput = document.getElementById('industry');
        const industryStatusInput = document.getElementById('industryStatus');
        const businessModelInput = document.getElementById('businessModel');
        const salesChannelsInput = document.getElementById('salesChannels');
        const targetAudienceInput = document.getElementById('targetAudience');
        const advertisingBudgetInput = document.getElementById('advertisingBudget');
        const proposalOutput = document.getElementById('proposalOutput');
        const adObjectiveInput = document.getElementById('adObjective');
        const aiRecommendMediaInput = document.getElementById('aiRecommendMedia');
        const mediaSelectionDiv = document.getElementById('mediaSelection');
        const competitorsInput = document.getElementById('competitors');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const targetMarketsInput = document.getElementById('targetMarkets');
        const targetLanguagesInput = document.getElementById('targetLanguages');
        const generateBtn = document.getElementById('generateBtn');

        // 重點標註相關元素
        const campaignStartDateInput = document.getElementById('campaignStartDate');
        const campaignEndDateInput = document.getElementById('campaignEndDate');
        const campaignDurationInput = document.getElementById('campaignDuration');
        const keyMilestonesInput = document.getElementById('keyMilestones');
        const competitorTimelineInput = document.getElementById('competitorTimeline');
        const competitiveAdvantageInput = document.getElementById('competitiveAdvantage');
        const competitiveGapsInput = document.getElementById('competitiveGaps');
        const seasonalFactorsInput = document.getElementById('seasonalFactors');
        const marketTrendsInput = document.getElementById('marketTrends');
        const highlightTimelineInput = document.getElementById('highlightTimeline');
        const highlightCompetitorsInput = document.getElementById('highlightCompetitors');
        const highlightOpportunitiesInput = document.getElementById('highlightOpportunities');
        const highlightMilestonesInput = document.getElementById('highlightMilestones');
        const highlightRisksInput = document.getElementById('highlightRisks');
        const highlightKPIsInput = document.getElementById('highlightKPIs');

        // 新增進度追蹤變數
        let currentStep = 0;
        let totalSteps = 11;
        let apiTestResult = null;

        // 新增進度條元素
        const progressContainer = document.createElement('div');
        progressContainer.id = 'progressContainer';
        progressContainer.className = 'mt-4 p-4 bg-blue-50 rounded-lg hidden';
        progressContainer.innerHTML = `
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-blue-800">AI 分析進度</span>
                <span id="progressText" class="text-sm text-blue-600">0 / ${totalSteps}</span>
            </div>
            <div class="w-full bg-blue-200 rounded-full h-2">
                <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <div id="currentStepText" class="mt-2 text-sm text-blue-700"></div>
            <div id="apiStatus" class="mt-2 text-sm"></div>
        `;
        
        // 將進度容器添加到生成按鈕之後
        if (generateBtn && generateBtn.parentNode) {
            generateBtn.parentNode.insertBefore(progressContainer, generateBtn.nextSibling);
        }

        // 測試 API 連接
        async function testAPI(apiKey) {
            try {
                console.log('開始 API 測試...');
                
                // 先驗證 API 金鑰格式
                if (!apiKey || apiKey.trim() === '') {
                    throw new Error('API 金鑰不能為空');
                }
                
                // 檢查 API 金鑰格式（Google API 金鑰通常是 39 個字符）
                if (apiKey.length < 30) {
                    throw new Error('API 金鑰格式可能不正確，Google API 金鑰通常為 39 個字符');
                }
                
                const testPrompt = '請回覆「API 連接成功」來確認連接正常。';
                const response = await callGeminiAPI(testPrompt, apiKey, false);
                console.log('API 測試回應:', response);
                return response.includes('API 連接成功') || response.includes('成功') || response.includes('連接');
            } catch (error) {
                console.error('API 測試失敗:', error);
                
                // 提供更詳細的錯誤診斷
                let diagnosticMessage = '';
                if (error.message.includes('API 金鑰無效') || error.message.includes('401') || error.message.includes('403')) {
                    diagnosticMessage = `
                        <div class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                            <h4 class="font-semibold text-red-800 mb-2">API 金鑰問題診斷：</h4>
                            <ul class="text-sm text-red-700 space-y-1">
                                <li>• 請確認您已前往 <a href="https://makersuite.google.com/app/apikey" target="_blank" class="underline">Google AI Studio</a> 創建 API 金鑰</li>
                                <li>• 確認 API 金鑰已啟用 Gemini API 服務</li>
                                <li>• 檢查 API 金鑰是否完整複製（應為 39 個字符）</li>
                                <li>• 確認 API 金鑰沒有多餘的空格或換行符</li>
                                <li>• 如果剛創建金鑰，請等待 5-10 分鐘讓系統生效</li>
                            </ul>
                        </div>
                    `;
                } else if (error.message.includes('網路連接')) {
                    diagnosticMessage = `
                        <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <h4 class="font-semibold text-yellow-800 mb-2">網路連接問題：</h4>
                            <ul class="text-sm text-yellow-700 space-y-1">
                                <li>• 檢查網路連接是否正常</li>
                                <li>• 嘗試重新整理頁面</li>
                                <li>• 檢查防火牆或代理設定</li>
                            </ul>
                        </div>
                    `;
                }
                
                // 更新錯誤訊息顯示
                const proposalOutput = document.getElementById('proposalOutput');
                if (proposalOutput) {
                    proposalOutput.innerHTML = `
                        <div class="p-6 bg-red-50 border border-red-200 rounded-lg">
                            <h3 class="text-lg font-bold text-red-800 mb-2">API 連接測試失敗</h3>
                            <p class="text-red-700 mb-4">錯誤詳情：${error.message}</p>
                            ${diagnosticMessage}
                            <div class="mt-4 p-3 bg-white border border-red-200 rounded">
                                <p class="text-xs text-gray-600">技術詳情：${error.stack ? error.stack.substring(0, 200) + '...' : '無堆疊追蹤信息'}</p>
                            </div>
                        </div>
                    `;
                }
                
                return false;
            }
        }

        // 更新進度條
        function updateProgress(step, stepText) {
            currentStep = step;
            const progressPercentage = (currentStep / totalSteps) * 100;
            
            document.getElementById('progressBar').style.width = `${progressPercentage}%`;
            document.getElementById('progressText').textContent = `${currentStep} / ${totalSteps}`;
            document.getElementById('currentStepText').textContent = stepText;
            
            // 顯示進度容器
            document.getElementById('progressContainer').classList.remove('hidden');
        }

        // 更新API狀態
        function updateAPIStatus(status, message) {
            const apiStatusElement = document.getElementById('apiStatus');
            const apiTextElement = document.getElementById('apiText');
            
            if (apiStatusElement && apiTextElement) {
                // 更新狀態指示器顏色
                apiStatusElement.className = 'w-3 h-3 rounded-full mr-2';
                if (status === 'success') {
                    apiStatusElement.classList.add('bg-green-500');
                    apiTextElement.textContent = message;
                    apiTextElement.className = 'text-sm text-green-800';
                } else if (status === 'error') {
                    apiStatusElement.classList.add('bg-red-500');
                    apiTextElement.textContent = message;
                    apiTextElement.className = 'text-sm text-red-800';
                } else if (status === 'warning') {
                    apiStatusElement.classList.add('bg-yellow-500');
                    apiTextElement.textContent = message;
                    apiTextElement.className = 'text-sm text-yellow-800';
                } else {
                    apiStatusElement.classList.add('bg-gray-400');
                    apiTextElement.textContent = message;
                    apiTextElement.className = 'text-sm text-gray-800';
                }
            }
        }

        // 更新網路狀態
        function updateNetworkStatus() {
            const networkStatusElement = document.getElementById('networkStatus');
            const networkTextElement = document.getElementById('networkText');
            
            if (networkStatusElement && networkTextElement) {
                if (navigator.onLine) {
                    networkStatusElement.className = 'w-3 h-3 rounded-full bg-green-500 mr-2';
                    networkTextElement.textContent = '網路連接正常';
                    networkTextElement.className = 'text-sm text-green-800';
                } else {
                    networkStatusElement.className = 'w-3 h-3 rounded-full bg-red-500 mr-2';
                    networkTextElement.textContent = '網路連接已斷開';
                    networkTextElement.className = 'text-sm text-red-800';
                }
            }
        }

        // 更新模型狀態
        function updateModelStatus(modelName = null) {
            const modelStatusElement = document.getElementById('modelStatus');
            const modelTextElement = document.getElementById('modelText');
            
            if (modelStatusElement && modelTextElement) {
                if (modelName) {
                    modelStatusElement.className = 'w-3 h-3 rounded-full bg-green-500 mr-2';
                    modelTextElement.textContent = `使用: ${modelName}`;
                    modelTextElement.className = 'text-sm text-green-800';
                } else {
                    const selectedModel = document.querySelector('input[name="modelSelection"]:checked');
                    if (selectedModel) {
                        let modelDisplayName = '';
                        switch(selectedModel.value) {
                            case 'flash':
                                modelDisplayName = 'Gemini 1.5 Flash';
                                break;
                            case 'pro':
                                modelDisplayName = 'Gemini 1.5 Pro';
                                break;
                            case 'auto':
                                modelDisplayName = '自動選擇';
                                break;
                            default:
                                modelDisplayName = '未選擇';
                        }
                        modelStatusElement.className = 'w-3 h-3 rounded-full bg-purple-500 mr-2';
                        modelTextElement.textContent = `已選擇: ${modelDisplayName}`;
                        modelTextElement.className = 'text-sm text-purple-800';
                    } else {
                        modelStatusElement.className = 'w-3 h-3 rounded-full bg-gray-400 mr-2';
                        modelTextElement.textContent = '模型未選擇';
                        modelTextElement.className = 'text-sm text-gray-800';
                    }
                }
            }
        }

        // 初始化網路狀態監聽器
        function initializeNetworkMonitoring() {
            // 初始狀態
            updateNetworkStatus();
            updateModelStatus();
            
            // 監聽網路狀態變化
            window.addEventListener('online', function() {
                console.log('網路連接已恢復');
                updateNetworkStatus();
                updateAPIStatus('warning', '網路已恢復，請重新測試 API');
            });
            
            window.addEventListener('offline', function() {
                console.log('網路連接已斷開');
                updateNetworkStatus();
                updateAPIStatus('error', '網路連接已斷開');
            });
            
            // 監聽模型選擇變化
            document.querySelectorAll('input[name="modelSelection"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    updateModelStatus();
                    console.log('模型選擇已更改:', this.value);
                });
            });
        }

        // --- Module 2: AI 任務協調與執行核心 ('融合中樞') ---
        async function callGeminiAPI(prompt, apiKey, expectJSON = false) {
            // 檢查網路連接
            if (!navigator.onLine) {
                throw new Error('網路連接已斷開，請檢查網路狀態');
            }

            // 檢查 API 金鑰
            if (!apiKey || apiKey.trim() === '') {
                throw new Error('API 金鑰不能為空');
            }

            // 獲取用戶選擇的模型
            const selectedModelElement = document.querySelector('input[name="modelSelection"]:checked');
            let selectedModel = 'auto'; // 預設值
            if (selectedModelElement) {
                selectedModel = selectedModelElement.value;
            }
            
            // 根據用戶選擇決定模型列表
            let models = [];
            if (selectedModel === 'flash') {
                models = ['gemini-2.0-flash', 'gemini-1.5-flash']; // 優先使用 2.0 版本
            } else if (selectedModel === 'pro') {
                models = ['gemini-1.5-pro', 'gemini-pro']; // Pro 模型
            } else {
                // 自動選擇模式 - 按優先順序嘗試（最新版本優先）
                models = [
                    'gemini-2.0-flash',             // 最新版本，最快最穩定
                    'gemini-1.5-flash',             // 快速回應
                    'gemini-1.5-pro',               // 平衡性能
                    'gemini-pro'                    // 備用模型
                ];
            }
            
            let lastError = null;
            let attemptCount = 0;
            const maxAttempts = 3;
            
            for (const model of models) {
                for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                    try {
                        attemptCount++;
                        console.log(`嘗試模型 ${model}，第 ${attempt} 次嘗試`);
                        
                        const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent`;
                        console.log('請求 URL:', url);
                        
                        // 根據模型調整配置
                        let generationConfig = {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 8192,
                        };
                        
                        // Gemini 2.0 Flash 優化配置
                        if (model === 'gemini-2.0-flash') {
                            generationConfig = {
                                temperature: 0.6,  // 降低溫度以獲得更穩定的輸出
                                topK: 30,          // 減少選項以提高速度
                                topP: 0.9,
                                maxOutputTokens: 8192,
                                stopSequences: [], // 避免不必要的停止
                            };
                        }
                        // 深度研究模型特殊配置
                        else if (model === 'gemini-1.5-pro') {
                            generationConfig = {
                                temperature: 0.6,  // 稍微降低溫度以獲得更穩定的輸出
                                topK: 50,
                                topP: 0.9,
                                maxOutputTokens: 16384,  // 支援更長的輸出
                            };
                        }
                        
                        const requestBody = {
                            contents: [{
                                parts: [{
                                    text: prompt
                                }]
                            }],
                            generationConfig: generationConfig
                        };
                        
                        console.log('請求內容:', JSON.stringify(requestBody, null, 2));

                        // 增加請求超時設定（根據模型類型調整）
                        let timeout = 30000; // 預設 30 秒
                        if (model === 'gemini-2.0-flash') {
                            timeout = 25000; // 2.0 Flash 更快，25 秒
                        } else if (model === 'gemini-1.5-pro') {
                            timeout = 60000; // Pro 模型需要更長時間
                        }
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), timeout);

                        const response = await fetch(`${url}?key=${apiKey}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Cache-Control': 'no-cache',
                                'Pragma': 'no-cache',
                                'User-Agent': 'Mediaplan-Engine/2.8',
                                'Accept': 'application/json',
                                'Accept-Encoding': 'gzip, deflate, br'
                            },
                            body: JSON.stringify(requestBody),
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);

                        if (!response.ok) {
                            let errorMessage = `HTTP ${response.status}`;
                            
                            // 嘗試讀取錯誤響應內容
                            let errorResponse = '';
                            try {
                                const errorData = await response.text();
                                errorResponse = errorData;
                                console.error('錯誤響應內容:', errorData);
                            } catch (e) {
                                console.error('無法讀取錯誤響應內容');
                            }
                            
                            // 根據 HTTP 狀態碼提供更具體的錯誤訊息
                            switch (response.status) {
                                case 400:
                                    errorMessage = `請求格式錯誤，可能是 API 金鑰無效或請求內容有問題。錯誤詳情: ${errorResponse.substring(0, 200)}`;
                                    break;
                                case 401:
                                    errorMessage = 'API 金鑰無效或已過期，請檢查您的 API 金鑰';
                                    break;
                                case 403:
                                    errorMessage = 'API 金鑰權限不足，請確認金鑰是否正確';
                                    break;
                                case 404:
                                    errorMessage = `模型 ${model} 不可用，可能是模型名稱錯誤或您的 API 金鑰沒有權限`;
                                    break;
                                case 429:
                                    errorMessage = 'API 請求頻率過高，請稍後再試';
                                    break;
                                case 500:
                                    errorMessage = 'Google 服務器錯誤，請稍後再試';
                                    break;
                                case 503:
                                    errorMessage = 'Google 服務暫時不可用，請稍後再試';
                                    break;
                                default:
                                    errorMessage = `HTTP 錯誤 ${response.status}: ${response.statusText}`;
                            }
                            
                            throw new Error(errorMessage);
                        }

                        const data = await response.json();
                        
                        if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                            const text = data.candidates[0].content.parts[0].text;
                            
                            if (expectJSON) {
                                try {
                                    // 嘗試解析 JSON
                                    const jsonMatch = text.match(/\{[\s\S]*\}/);
                                    if (jsonMatch) {
                                        let jsonText = jsonMatch[0];
                                        
                                        // 清理常見的 JSON 格式問題
                                        jsonText = jsonText
                                            .replace(/,\s*}/g, '}')  // 移除尾隨逗號
                                            .replace(/,\s*]/g, ']')  // 移除陣列尾隨逗號
                                            .replace(/[\u0000-\u001F\u007F-\u009F]/g, '') // 移除控制字符
                                            .replace(/[\u2018\u2019]/g, "'") // 標準化引號
                                            .replace(/[\u201C\u201D]/g, '"'); // 標準化雙引號
                                        
                                        try {
                                            return JSON.parse(jsonText);
                                        } catch (parseError) {
                                            console.error('JSON 解析失敗，嘗試修復格式:', parseError);
                                            console.log('原始 JSON:', jsonText);
                                            
                                            // 嘗試更激進的修復
                                            jsonText = jsonText
                                                .replace(/([^\\])"/g, '$1\\"') // 轉義未轉義的引號
                                                .replace(/\\"/g, '"') // 重新處理引號
                                                .replace(/,\s*([}\]])/g, '$1'); // 移除所有尾隨逗號
                                            
                                            return JSON.parse(jsonText);
                                        }
                                    } else {
                                        throw new Error('未找到有效的 JSON 格式');
                                    }
                                } catch (jsonError) {
                                    console.error('JSON 解析錯誤:', jsonError);
                                    console.log('原始回應:', text);
                                    
                                    // 如果 JSON 解析失敗，返回一個基本的錯誤結構
                                    return {
                                        error: 'JSON 解析失敗',
                                        original_response: text.substring(0, 500) + '...',
                                        message: 'AI 回應格式不正確，但已記錄原始回應'
                                    };
                                }
                            }
                            
                            console.log(`成功使用模型 ${model} 完成請求`);
                            // 更新模型狀態顯示
                            updateModelStatus(model);
                            return text;
                        } else {
                            throw new Error('AI 回應格式異常');
                        }
                    } catch (error) {
                        console.error(`模型 ${model} 第 ${attempt} 次嘗試失敗:`, error);
                        lastError = error;
                        
                        // 如果是網路錯誤或超時，等待後重試
                        if (error.name === 'AbortError' || error.message.includes('fetch')) {
                            if (attempt < maxAttempts) {
                                console.log(`等待 ${attempt * 2} 秒後重試...`);
                                await new Promise(resolve => setTimeout(resolve, attempt * 2000));
                                continue;
                            }
                        }
                        
                        // 如果是 API 金鑰錯誤，直接跳出
                        if (error.message.includes('API 金鑰') || error.message.includes('401') || error.message.includes('403')) {
                            throw error;
                        }
                        
                        // 如果是模型不可用錯誤，嘗試下一個模型
                        if (error.message.includes('404') || error.message.includes('模型') || error.message.includes('不可用')) {
                            console.log(`模型 ${model} 不可用，嘗試下一個模型`);
                            break;
                        }
                        
                        // 其他錯誤，嘗試下一個模型
                        break;
                    }
                }
            }
            
            // 如果所有模型都失敗了
            const errorMessage = `所有模型都失敗了。總共嘗試了 ${attemptCount} 次。最後錯誤: ${lastError.message}`;
            console.error(errorMessage);
            throw new Error(errorMessage);
        }
        

        
        // --- 分析任務定義 ---
        async function analyzeForumSentiment(context, apiKey) {
            const prompt = `
                你是一位專精台灣市場的資深市場分析師，具備策略思考的高度與學習能力。請你根據以下品牌情境，進行全面的輿情監測分析：
                
                **品牌情境:**
                - **目標品牌:** ${context.target}
                - **競爭對手:** ${context.competitors}
                - **所屬產業:** ${context.industry} (${context.industryStatus})
                - **商業模式:** ${context.businessModel}
                - **核心目標人群:** ${context.targetAudience}
                - **廣告目標與目的:** ${context.adObjective}
                - **廣告形式:** ${context.aiRecommendMedia ? 'AI建議' : context.selectedMedia.join(', ')}
                - **品牌行銷問題:** ${context.marketingProblems}

                **輿情監測範圍：**
                - 台灣主流論壇：Dcard、PTT、Mobile01、巴哈姆特
                - 社群媒體：Facebook、Instagram、YouTube、TikTok
                - 新聞媒體：各大新聞網站、財經媒體
                - 部落格與評論：各大部落格平台、Google評論
                - 專業平台：LinkedIn、產業論壇

                **策略思考要求：**
                - 從市場格局角度分析：產業競爭態勢、市場集中度、進入門檻
                - 從品牌定位角度思考：目標品牌在市場中的相對位置、差異化機會
                - 從未來趨勢角度預測：消費者行為變化、技術發展對產業的影響
                - 從學習角度總結：類似案例的成功模式、失敗教訓、最佳實踐
                - **從問題解決角度：針對品牌提出的行銷問題，分析根本原因與解決方向**

                **請特別補充：**
                - 競爭品牌在媒體上的曝光策略、創意表現、近期話題或市場動態
                - 若有可查詢的市場成效（如廣告投放量、社群聲量、媒體報導數量等），請簡要引用
                - 分析競品在不同廣告目標（如品牌知名度、銷售提升等）下的優劣勢
                - 從策略高度分析：如何建立長期競爭優勢、品牌資產累積
                - 輿情熱度分析：品牌聲量、情感傾向、話題傳播力
                - **針對性問題分析：基於品牌描述的行銷問題，提供具體的解決策略與機會點**

                你的任務是總結比較的結果，並以一個 JSON 物件的格式回傳。JSON 物件必須包含以下幾個 key: 
                "target_profile", "target_pros", "target_cons", "competitor_pros", "competitor_cons", "market_opportunity", "competitor_media_strategy", "market_trend", "reference_data", "strategic_insights", "learning_cases", "sentiment_analysis", "platform_performance", "positioning_analysis", "problem_analysis", "solution_strategies"。

                - **target_profile:** 在論壇中，最接近「${context.targetAudience}」這個輪廓的討論者是誰？他們有什麼特徵？
                - **target_pros:** 這些目標人群讚賞目標品牌的優點是什麼？ (至少 2 點)。
                - **target_cons:** 這些目標人群抱怨目標品牌的缺點是什麼？ (至少 2 點)。
                - **competitor_pros:** 競爭品牌吸引這些目標人群的優點。
                - **competitor_cons:** 競爭品牌讓這些目標人群卻步的缺點。
                - **market_opportunity:** 根據以上分析，找出一個能精準打動「${context.targetAudience}」的市場溝通機會點。
                - **competitor_media_strategy:** 競品的媒體策略、創意表現、近期市場動態
                - **market_trend:** 最新市場趨勢、消費者行為變化
                - **reference_data:** 若有查詢到的公開市場成效數據，請簡要列出
                - **strategic_insights:** 從策略高度分析市場格局、競爭態勢、未來機會
                - **learning_cases:** 從過往案例中學習的成功模式、失敗教訓、最佳實踐
                - **sentiment_analysis:** 輿情情感分析（正面、負面、中性比例）
                - **platform_performance:** 各平台表現分析（聲量、互動率、影響力）
                - **positioning_analysis:** 品牌定位分析，包含以下維度的評分（1-10分）：
                    - "price_position": 價格定位（1=低價，10=高價）
                    - "quality_position": 品質定位（1=基本，10=高端）
                    - "innovation_position": 創新程度（1=傳統，10=創新）
                    - "target_audience_position": 目標人群定位（1=大眾，10=小眾）
                    - "brand_personality": 品牌個性（1=實用，10=時尚）
                - **problem_analysis:** 針對品牌描述的行銷問題進行深度分析，找出根本原因
                - **solution_strategies:** 基於問題分析，提供具體的解決策略與執行建議

                請確保回傳的內容是純粹的 JSON 格式，沒有任何額外的文字或註解。
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        async function analyzeIndustrySentiment(context, apiKey) {
            const prompt = `
                你是一位資深的產業輿情分析師，專門監測台灣各產業的輿情狀況。請針對「${context.industry}」產業進行全面的輿情監測分析。

                **分析範圍：**
                - 產業整體輿情狀況
                - 主要競爭品牌輿情表現
                - 產業熱門話題與趨勢
                - 消費者對產業的整體認知與態度
                - 產業面臨的挑戰與機會

                **監測平台：**
                - 新聞媒體：各大新聞網站、財經媒體、產業專刊
                - 社群媒體：Facebook、Instagram、YouTube、TikTok
                - 論壇平台：PTT、Dcard、Mobile01、巴哈姆特
                - 專業平台：LinkedIn、產業論壇、專業社群
                - 評論平台：Google評論、各大評論網站

                **分析重點：**
                - 產業聲量趨勢（近3個月）
                - 熱門話題與關鍵字
                - 消費者情感傾向
                - 產業爭議與危機
                - 新興趨勢與機會

                你的任務是產出一個 JSON 物件，包含以下 key：
                "industry_overview", "trending_topics", "sentiment_distribution", "key_players", "crisis_opportunities", "consumer_insights", "future_trends"。

                - **industry_overview:** 產業整體輿情概況
                - **trending_topics:** 熱門話題與關鍵字（至少5個）
                - **sentiment_distribution:** 情感分布（正面、負面、中性比例）
                - **key_players:** 主要競爭品牌輿情表現排名
                - **crisis_opportunities:** 產業面臨的危機與機會
                - **consumer_insights:** 消費者對產業的認知與態度
                - **future_trends:** 未來趨勢預測

                請確保回傳的內容是純粹的 JSON 格式，沒有任何額外的文字或註解。
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        async function analyzeSeoStrategy(context, apiKey) {
            const prompt = `
                你是一位頂尖的 SEO 策略顧問，特別熟悉台灣的 google.com.tw 搜尋引擎生態。
                請模擬「${context.targetAudience}」這個目標人群，在搜尋與「${context.target}」相關的關鍵字時，他們會看到什麼樣的搜尋結果頁面 (SERP)。

                **品牌情境:**
                - **目標品牌:** ${context.target}
                - **競爭對手:** ${context.competitors}
                - **商業模式:** ${context.businessModel}
                - **核心目標人群:** ${context.targetAudience}
                - **廣告目標與目的:** ${context.adObjective}
                - **廣告形式:** ${context.aiRecommendMedia ? 'AI建議' : context.selectedMedia.join(', ')}

                你的任務是總結你的發現，並以一個 JSON 物件的格式回傳。JSON 物件必須包含以下幾個 key: 
                "main_competitors_in_serp", "dominant_content_format", "user_intent", "content_gap_opportunity"。

                - **main_competitors_in_serp:** 除了「${context.competitors}」之外，在自然搜尋結果中還常出現哪些競爭者？
                - **dominant_content_format:** 排名靠前的內容主要是長篇文章、產品比較頁、新聞稿，還是 YouTube 影片？
                - **user_intent:** 「${context.targetAudience}」在搜尋時，其主要的「搜尋意圖」是什麼？請根據 ${context.businessModel} 的特性來分析。
                - **content_gap_opportunity:** 根據 Google 的「其他人也問了」或「相關搜尋」，找出一個能解決「${context.targetAudience}」痛點，但市場上還沒有優質內容回答的問題，作為內容策略切入點。

                請確保回傳的內容是純粹的 JSON 格式，沒有任何額外的文字或註解。
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        async function analyzeBudgetFeasibility(context, apiKey) {
            const prompt = `
                你是一位資深的媒體策略顧問，專門評估廣告預算與目標的可行性。請針對以下情境進行預算可行性分析：

                **客戶情境:**
                - **目標品牌:** ${context.target}
                - **產業:** ${context.industry} (${context.industryStatus})
                - **商業模式:** ${context.businessModel}
                - **目標人群:** ${context.targetAudience}
                - **廣告目標與目的:** ${context.adObjective}
                - **廣告形式:** ${context.aiRecommendMedia ? 'AI建議' : context.selectedMedia.join(', ')}
                - **總預算 (TWD):** ${context.budget.toLocaleString()}

                **分析重點：**
                - 評估該預算在台灣市場達成目標的可行性
                - 分析不同預算規模下的策略選擇
                - 提供預算不足時的替代方案
                - 建議最優的預算分配策略

                **請參考台灣市場的實際數據：**
                - 不同媒體渠道的CPM/CPC基準
                - 各產業的典型廣告投資規模
                - 不同目標的達成門檻

                你的任務是產出一個 JSON 物件，包含以下 key：
                "feasibility_assessment", "budget_recommendations", "alternative_strategies", "risk_analysis", "success_probability"。

                - **feasibility_assessment:** 預算可行性評估（高/中/低）及理由
                - **budget_recommendations:** 基於目標的預算建議（理想預算範圍）
                - **alternative_strategies:** 預算不足時的替代策略（至少3個）
                - **risk_analysis:** 預算不足可能帶來的風險
                - **success_probability:** 達成目標的成功機率評估

                請確保回傳的內容是純粹的 JSON 格式，沒有任何額外的文字或註解。
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        async function estimateKpiAndBudget(context, opportunity, apiKey) {
            if (!context.budget || context.budget <= 0) {
                 return { budget_allocation: [], kpi_estimations: [], rationale: "未提供預算，無法進行估算。" };
            }
            const prompt = `
                你是一位經驗豐富的數位媒體規劃師 (Media Planner)，擅長台灣市場的媒體投資與成效預估，具備策略思考的高度與學習能力。
                根據以下客戶情境與你已知的市場機會點，規劃一份初步的預算分配與 KPI 預估。

                **客戶情境:**
                - **產業:** ${context.industry}
                - **商業模式:** ${context.businessModel}
                - **目標人群:** ${context.targetAudience}
                - **總預算 (TWD):** ${context.budget.toLocaleString()}
                - **廣告目標與目的:** ${context.adObjective}
                - **廣告形式:** ${context.aiRecommendMedia ? 'AI建議' : context.selectedMedia.join(', ')}
                - **核心策略機會點:** ${opportunity}

                **策略思考要求：**
                - 從投資回報角度思考：如何最大化每一分預算的效益
                - 從學習角度總結：類似預算規模的成功案例、失敗教訓
                - 從策略角度規劃：如何建立可持續的媒體投資模式
                - 從創新角度建議：新興媒體渠道、創意表現形式
                - **從可行性角度評估：該預算是否足夠達成目標，如不足請提供調整建議**

                **請參考台灣可查詢的公開媒體成效數據（如Nielsen、Comscore、Meta/Facebook/Google官方報告等），並根據廣告目標與目的，給出最具成效的媒體建議與KPI預估。**

                你的任務是產出一個 JSON 物件，包含 "budget_allocation", "kpi_estimations", "rationale", "reference_data", "strategic_recommendations", "learning_insights", "feasibility_warning", "budget_optimization" 八個 key。

                1.  **budget_allocation:** 一個陣列。根據「核心策略機會點」，建議將預算分配到 2-3 個最相關的媒體渠道 (例如：付費搜尋, 社群廣告, 內容行銷, 影音廣告)，並給出每個渠道的**百分比**和**金額**。
                2.  **kpi_estimations:** 一個陣列。為每個建議的渠道，提供**可量化的 KPI 預估**。請使用台灣市場的典型 benchmarks (基準)。
                    -   **對於 B2C:** 需包含 "Impressions" (曝光), "CTR" (點擊率), "Clicks" (點擊), "CPC" (單次點擊成本), "Est_Conversions" (預估訂單數，請自訂一個合理的轉換率)。
                    -   **對於 B2B:** 需包含 "Impressions", "CTR", "Clicks", "CPC", "Est_Leads" (預估潛在客戶數，請自訂一個合理的轉換率)。
                3.  **rationale:** 一段簡短文字，說明你這樣規劃預算優先級的理由。
                4.  **reference_data:** 若有查詢到的公開媒體成效數據，請簡要列出
                5.  **strategic_recommendations:** 從策略角度提供的長期建議、創新方向
                6.  **learning_insights:** 從過往案例中學習的經驗、最佳實踐
                7.  **feasibility_warning:** 如果預算明顯不足達成目標，請提供警告與建議
                8.  **budget_optimization:** 預算優化建議，如何在有限預算下最大化效益

                請確保回傳的內容是純粹的 JSON 格式。
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        async function analyzeMultiMarketStrategy(context, apiKey) {
            const prompt = `
                你是一位資深的國際市場策略顧問，專門規劃多市場媒體策略。請針對以下情境進行多市場策略分析：

                **客戶情境:**
                - **目標品牌:** ${context.target}
                - **產業:** ${context.industry}
                - **商業模式:** ${context.businessModel}
                - **目標人群:** ${context.targetAudience}
                - **廣告目標與目的:** ${context.adObjective}
                - **廣告形式:** ${context.aiRecommendMedia ? 'AI建議' : context.selectedMedia.join(', ')}
                - **目標市場:** ${context.targetMarkets}
                - **目標語言:** ${context.targetLanguages}
                - **總預算 (TWD):** ${context.budget.toLocaleString()}

                **分析重點：**
                - 各目標市場的媒體生態與消費者行為差異
                - 不同市場的媒體投資成本與效益比較
                - 跨市場品牌一致性與在地化平衡
                - 多語言內容策略與文化適應性
                - 預算在各市場的最優分配策略

                **請參考各市場的實際數據：**
                - 各市場的媒體滲透率與使用習慣
                - 不同市場的廣告成本基準
                - 文化差異對廣告效果的影響
                - 成功與失敗的跨市場案例

                你的任務是產出一個 JSON 物件，包含以下 key：
                "market_analysis", "budget_allocation", "localization_strategy", "cultural_considerations", "success_metrics", "risk_management"。

                - **market_analysis:** 各目標市場的媒體環境分析（包含市場規模、媒體習慣、競爭狀況）
                - **budget_allocation:** 建議的跨市場預算分配（百分比與金額）
                - **localization_strategy:** 在地化策略建議（內容、創意、媒體選擇）
                - **cultural_considerations:** 文化考量與注意事項
                - **success_metrics:** 各市場的KPI設定建議
                - **risk_management:** 跨市場執行的風險管理

                請確保回傳的內容是純粹的 JSON 格式，沒有任何額外的文字或註解。
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        async function analyzeLocalizationStrategy(context, multiMarketData, apiKey) {
            const prompt = `
                你是一位資深的在地化策略專家，專門規劃多語言內容與文化適應策略。請針對以下情境進行在地化策略分析：

                **客戶情境:**
                - **目標品牌:** ${context.target}
                - **產業:** ${context.industry}
                - **目標人群:** ${context.targetAudience}
                - **廣告目標與目的:** ${context.adObjective}
                - **廣告形式:** ${context.aiRecommendMedia ? 'AI建議' : context.selectedMedia.join(', ')}
                - **目標市場:** ${context.targetMarkets}
                - **目標語言:** ${context.targetLanguages}

                **多市場分析資料:**
                ${JSON.stringify(multiMarketData, null, 2)}

                **分析重點：**
                - 各語言的內容策略與表達方式
                - 文化符號與禁忌的識別與處理
                - 創意表現的在地化調整建議
                - 媒體渠道的語言偏好分析
                - 品牌訊息的一致性與適應性平衡

                **請參考各語言市場的實際案例：**
                - 成功的跨語言廣告案例
                - 文化失誤的教訓與避免方法
                - 各語言的創意表現特色
                - 媒體平台的語言使用習慣

                你的任務是產出一個 JSON 物件，包含以下 key：
                "language_strategy", "cultural_adaptation", "creative_localization", "media_language_preferences", "brand_consistency", "translation_guidelines"。

                - **language_strategy:** 各語言的內容策略建議
                - **cultural_adaptation:** 文化適應性建議與注意事項
                - **creative_localization:** 創意表現的在地化建議
                - **media_language_preferences:** 各媒體平台的語言偏好
                - **brand_consistency:** 品牌一致性的維護策略
                - **translation_guidelines:** 翻譯與本地化指導原則

                請確保回傳的內容是純粹的 JSON 格式，沒有任何額外的文字或註解。
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        async function analyzeCompetitorInsights(context, apiKey) {
            const prompt = `
                你是一位資深的競爭分析專家，專門分析競爭對手的品牌定位、產品策略與市場表現。請針對以下情境進行深度競爭對手分析：

                **客戶情境:**
                - **目標品牌:** ${context.target}
                - **產業:** ${context.industry} (${context.industryStatus})
                - **商業模式:** ${context.businessModel}
                - **目標人群:** ${context.targetAudience}
                - **競爭對手:** ${context.competitors}

                **重點標註資訊：**
                - **競爭對手近期活動時間線:** ${context.competitorTimeline}
                - **我們的競爭優勢:** ${context.competitiveAdvantage}
                - **需要彌補的差距:** ${context.competitiveGaps}
                - **季節性因素:** ${context.seasonalFactors}
                - **市場趨勢:** ${context.marketTrends}

                **分析重點：**
                - 詳細分析每個競爭對手的品牌定位與產品特色
                - 競爭對手的媒體策略與廣告表現
                - 競爭對手的目標人群與市場佔有率
                - 競爭對手的優勢與劣勢分析
                - 市場機會與威脅評估
                - 差異化策略建議
                - 基於時間線的競爭對手活動分析
                - 競爭優勢與差距的量化評估
                - 季節性因素對競爭策略的影響
                - 市場趨勢對競爭格局的影響

                **請參考台灣市場的實際數據：**
                - 各競爭對手的市場表現數據
                - 媒體投資規模與策略
                - 消費者對各品牌的認知與評價
                - 成功與失敗的競爭案例
                - 競爭對手的時間線活動對市場的影響

                你的任務是產出一個 JSON 物件，包含以下 key：
                "competitor_analysis", "market_positioning", "media_strategies", "opportunities", "threats", "differentiation_strategy", "timeline_analysis", "competitive_advantage_analysis", "gap_analysis", "seasonal_impact", "trend_impact"。

                - **competitor_analysis:** 各競爭對手的詳細分析（品牌、產品、定位、優勢劣勢）
                - **market_positioning:** 市場定位圖分析（價格vs品質、功能vs設計等維度）
                - **media_strategies:** 競爭對手的媒體策略分析
                - **opportunities:** 市場機會點識別
                - **threats:** 潛在威脅分析
                - **differentiation_strategy:** 差異化策略建議
                - **timeline_analysis:** 競爭對手時間線活動分析
                - **competitive_advantage_analysis:** 競爭優勢分析與量化評估
                - **gap_analysis:** 競爭差距分析與改善建議
                - **seasonal_impact:** 季節性因素對競爭策略的影響
                - **trend_impact:** 市場趨勢對競爭格局的影響

                請確保回傳的內容是純粹的 JSON 格式，沒有任何額外的文字或註解。
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        async function analyzeMarketingCalendar(context, apiKey) {
            const prompt = `
                你是一位資深的行銷策略顧問，專門規劃行銷時程與熱點事件整合。請針對以下情境進行行銷行事曆分析：

                **客戶情境:**
                - **目標品牌:** ${context.target}
                - **產業:** ${context.industry} (${context.industryStatus})
                - **目標人群:** ${context.targetAudience}
                - **行銷期間:** ${context.startDate} 至 ${context.endDate}
                - **目標市場:** ${context.targetMarkets}

                **重點標註資訊：**
                - **活動開始日期:** ${context.campaignStartDate}
                - **活動結束日期:** ${context.campaignEndDate}
                - **活動持續時間:** ${context.campaignDuration}
                - **重要里程碑:** ${context.keyMilestones}
                - **季節性因素:** ${context.seasonalFactors}
                - **市場趨勢:** ${context.marketTrends}

                **分析重點：**
                - 分析行銷期間內的熱點事件與節慶
                - 識別適合的活動合作機會（演唱會、展覽、運動賽事等）
                - 評估各事件的提前洽談時程
                - 建議最佳的行銷時機點
                - 分析競爭對手的行銷時程
                - 提供時程風險管理建議
                - 基於里程碑的時間線規劃
                - 季節性因素對時程的影響分析
                - 市場趨勢對時機選擇的影響
                - 重要節點的提醒與準備建議

                **請參考台灣市場的實際情況：**
                - 各月份的節慶與活動
                - 大型活動的提前洽談時程
                - 各產業的行銷旺季
                - 成功與失敗的時程規劃案例
                - 里程碑事件對行銷效果的影響

                你的任務是產出一個 JSON 物件，包含以下 key：
                "calendar_analysis", "hot_events", "partnership_opportunities", "timing_recommendations", "risk_management", "competitive_timing", "milestone_timeline", "seasonal_planning", "trend_timing", "key_dates_reminder"。

                - **calendar_analysis:** 行銷期間的整體時程分析
                - **hot_events:** 熱點事件清單與影響評估
                - **partnership_opportunities:** 合作機會與洽談時程
                - **timing_recommendations:** 最佳時機點建議
                - **risk_management:** 時程風險管理
                - **competitive_timing:** 競爭對手時程分析
                - **milestone_timeline:** 基於里程碑的時間線規劃
                - **seasonal_planning:** 季節性因素規劃
                - **trend_timing:** 市場趨勢時機分析
                - **key_dates_reminder:** 重要日期提醒與準備建議

                請確保回傳的內容是純粹的 JSON 格式，沒有任何額外的文字或註解。
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        async function analyzeCreativeStrategy(context, apiKey) {
            const prompt = `
                你是一位資深的創意策略總監，專門規劃創新且有影響力的創意策略。請針對以下情境進行創意策略分析：

                **客戶情境:**
                - **目標品牌:** ${context.target}
                - **產業:** ${context.industry} (${context.industryStatus})
                - **商業模式:** ${context.businessModel}
                - **目標人群:** ${context.targetAudience}
                - **廣告目標:** ${context.adObjective}
                - **廣告形式:** ${context.aiRecommendMedia ? 'AI建議' : context.selectedMedia.join(', ')}
                - **競爭對手:** ${context.competitors}

                **創意策略要求：**
                - 從品牌故事角度：如何講述動人的品牌故事
                - 從情感連結角度：如何建立深層的情感共鳴
                - 從創意表現角度：如何創造令人印象深刻的視覺與文案
                - 從互動體驗角度：如何設計參與感強的互動體驗
                - 從文化洞察角度：如何融入在地文化元素
                - 從趨勢創新角度：如何運用最新創意趨勢
                - 從差異化角度：如何與競爭對手區隔

                **請參考創意產業的最新趨勢：**
                - 全球創意獎項的得獎案例
                - 病毒式傳播的創意表現
                - 各媒體渠道的創意特色
                - 成功與失敗的創意案例

                你的任務是產出一個 JSON 物件，包含以下 key：
                "creative_concept", "visual_strategy", "copy_strategy", "interaction_design", "cultural_elements", "trend_innovation", "execution_plan"。

                - **creative_concept:** 核心創意概念與故事線
                - **visual_strategy:** 視覺策略與設計方向
                - **copy_strategy:** 文案策略與溝通訊息
                - **interaction_design:** 互動體驗設計
                - **cultural_elements:** 文化元素融入
                - **trend_innovation:** 趨勢創新應用
                - **execution_plan:** 執行計畫與時程

                請確保回傳的內容是純粹的 JSON 格式，沒有任何額外的文字或註解。
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        // --- Module 3: 提案生成引擎 ('合成引擎') ---
        async function synthesizeFinalReport(context, forumAnalysis, seoAnalysis, kpiEstimation, industrySentiment, budgetFeasibility, multiMarketStrategy, localizationStrategy, competitorAnalysis, marketingCalendar, creativeStrategy, apiKey) {
            try {
                // 數據驗證和預設值處理
                const validatedData = {
                    forumAnalysis: forumAnalysis || {},
                    seoAnalysis: seoAnalysis || {},
                    kpiEstimation: kpiEstimation || {},
                    industrySentiment: industrySentiment || {},
                    budgetFeasibility: budgetFeasibility || {},
                    multiMarketStrategy: multiMarketStrategy || {},
                    localizationStrategy: localizationStrategy || {},
                    competitorAnalysis: competitorAnalysis || {},
                    marketingCalendar: marketingCalendar || {},
                    creativeStrategy: creativeStrategy || {}
                };

                // 檢查關鍵數據是否存在
                const missingData = [];
                if (!validatedData.forumAnalysis || Object.keys(validatedData.forumAnalysis).length === 0) {
                    missingData.push('品牌輿情分析');
                }
                if (!validatedData.seoAnalysis || Object.keys(validatedData.seoAnalysis).length === 0) {
                    missingData.push('SEO 與內容策略分析');
                }
                if (!validatedData.kpiEstimation || Object.keys(validatedData.kpiEstimation).length === 0) {
                    missingData.push('預算與 KPI 預估');
                }

                // 如果缺少太多關鍵數據，提供警告
                let dataWarning = '';
                if (missingData.length > 0) {
                    dataWarning = `
**數據缺失警告：**
系統檢測到以下分析數據缺失：${missingData.join('、')}。
請根據可用的數據進行分析，對於缺失的部分，請提供基於產業經驗的一般性建議。
`;
                }

                // 新增：報告摘要生成
                const executiveSummary = generateExecutiveSummary(context, validatedData);
                
                // 新增：關鍵洞察提取
                const keyInsights = extractKeyInsights(validatedData);
                
                // 新增：行動建議優先級排序
                const prioritizedRecommendations = prioritizeRecommendations(context, validatedData);

                const prompt = `
                你是一位首席媒體策略總監，具備策略思考的高度與學習能力。你的任務是將下屬分析師提交的所有 JSON 資料，整合成一份給客戶看的、專業且有說服力的「市場機會與初步策略建議」報告。報告需以 HTML 格式呈現。

                **客戶資料:**
                - **目標品牌:** ${context.target}
                - **核心目標人群:** ${context.targetAudience}
                - **品牌行銷問題:** ${context.marketingProblems}
                - **總預算 (TWD):** ${context.budget > 0 ? context.budget.toLocaleString() : '未提供'}
                - **廣告目標與目的:** ${context.adObjective}
                - **廣告形式:** ${context.aiRecommendMedia ? 'AI建議' : context.selectedMedia.join(', ')}
                - **目標市場:** ${context.targetMarkets}
                - **目標語言:** ${context.targetLanguages}
                - **行銷期間:** ${context.startDate} 至 ${context.endDate}
                - **產業狀態:** ${context.industryStatus}

                **重點標註資訊:**
                - **活動時間段:** ${context.campaignStartDate} 至 ${context.campaignEndDate} (${context.campaignDuration})
                - **重要里程碑:** ${context.keyMilestones}
                - **競爭對手時間線:** ${context.competitorTimeline}
                - **競爭優勢:** ${context.competitiveAdvantage}
                - **競爭差距:** ${context.competitiveGaps}
                - **季節性因素:** ${context.seasonalFactors}
                - **市場趨勢:** ${context.marketTrends}
                - **重點標註設定:** 時間線視覺化(${context.highlightTimeline}), 競爭對手比較(${context.highlightCompetitors}), 市場機會點(${context.highlightOpportunities}), 重要里程碑(${context.highlightMilestones}), 風險評估(${context.highlightRisks}), 關鍵績效指標(${context.highlightKPIs})

                **市場變化因素分析:**
                - **宏觀經濟因素:** 經濟趨勢(${context.economicTrend}), 利率環境(${context.interestRate}), 匯率趨勢(${context.currencyTrend})
                - **產業變化因素:** 技術顛覆(${context.technologyDisruption}), 法規變化(${context.regulatoryChanges}), 供應鏈狀況(${context.supplyChainIssues})
                - **消費者行為變化:** 消費者信心(${context.consumerConfidence}), 數位化程度(${context.digitalAdoption}), 行為變化描述(${context.consumerBehaviorChanges})
                - **競爭環境變化:** 新進入者威脅(${context.newEntrants}), 市場整合程度(${context.marketConsolidation}), 競爭動態(${context.competitiveDynamics})

                ${dataWarning}

                **分析師提交的資料:**
                1.  **品牌輿情分析:** ${JSON.stringify(validatedData.forumAnalysis, null, 2)}
                2.  **產業輿情監測:** ${JSON.stringify(validatedData.industrySentiment, null, 2)}
                3.  **SEO 與內容策略分析:** ${JSON.stringify(validatedData.seoAnalysis, null, 2)}
                4.  **預算與 KPI 預估:** ${JSON.stringify(validatedData.kpiEstimation, null, 2)}
                5.  **預算可行性分析:** ${JSON.stringify(validatedData.budgetFeasibility, null, 2)}
                6.  **多市場策略分析:** ${JSON.stringify(validatedData.multiMarketStrategy, null, 2)}
                7.  **在地化策略分析:** ${JSON.stringify(validatedData.localizationStrategy, null, 2)}
                8.  **競爭對手分析:** ${JSON.stringify(validatedData.competitorAnalysis, null, 2)}
                9.  **行銷行事曆分析:** ${JSON.stringify(validatedData.marketingCalendar, null, 2)}
                10. **創意策略分析:** ${JSON.stringify(validatedData.creativeStrategy, null, 2)}

                **重要處理原則：**
                - 如果某個數據欄位為空或 null，請不要顯示「因資料缺失，此處無法呈現」的訊息
                - 對於缺失的數據，請基於產業經驗和常識提供合理的推測或一般性建議
                - 確保報告的完整性和專業性，不要因為數據缺失而影響報告的結構
                - 如果 kpiEstimation.rationale 或 kpiEstimation.feasibility_warning 等欄位缺失，請提供基於預算和目標的合理分析
                - **新增：使用更清晰的視覺層次和結構化呈現**
                - **新增：為每個章節添加執行摘要和關鍵要點**
                - **新增：使用圖表、表格和視覺元素增強可讀性**
                - **新增：市場變化因素分析章節，包含宏觀經濟、產業變化、消費者行為、競爭環境的影響評估**

                **策略思考框架：**
                - 從品牌策略角度：如何建立長期品牌資產、市場定位
                - 從競爭策略角度：如何在競爭中脫穎而出、建立護城河
                - 從學習角度：從成功案例中學習、避免失敗陷阱
                - 從創新角度：新興機會、未來趨勢、顛覆性思維
                - 從可行性角度：預算與目標的匹配度，提供務實建議
                - 從國際化角度：跨市場品牌一致性與在地化平衡
                - **從創意角度：如何創造令人印象深刻的品牌體驗**

                **你的任務:**
                請根據以上所有資訊，撰寫一份包含以下章節的 HTML 報告，並在你的分析與建議中，**始終緊扣如何打動「${context.targetAudience}」這個核心目標人群**，並強調：
                - 競品媒體策略、創意表現、最新市場動態
                - 創意趨勢與消費者行為變化
                - 參考可查詢的市場成效數據
                - 根據廣告目標與目的，調整每一章節的重點與建議
                - 從策略高度提供長期發展建議
                - 從學習角度總結最佳實踐
                - 產業輿情狀況與機會點
                - 預算可行性與務實建議
                - 多市場策略與在地化考量
                - **競爭對手深度分析與差異化策略**
                - **行銷時程規劃與熱點事件整合**
                - **創意策略與品牌體驗設計**

                0.  **<h2>📋 執行摘要</h2>**
                    - 一段簡短但有力的摘要，概述整個策略的核心要點
                    - 包含關鍵洞察、主要建議和預期效益
                    - 使用 <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-400"> 樣式突出顯示

                1.  **<h2>🎯 市場總體印象</h2>**
                    - 一段簡短總結，點出 ${context.target} 目前在「${context.targetAudience}」心中的形象與挑戰。
                    - 使用 <div class="bg-gray-50 p-3 rounded border"> 樣式呈現關鍵洞察

                2.  **<h2>📊 產業輿情監測</h2>**
                    -   <h3>產業概況</h3>
                    -   <h3>熱門話題與趨勢</h3>
                    -   <h3>競爭品牌輿情表現</h3>
                    -   <h3>消費者洞察</h3>
                    -   **新增：<h3>📈 輿情趨勢圖表</h3>** (使用 HTML 表格模擬圖表)

                3.  **<h2>⚔️ 競爭對手深度分析</h2>**
                    -   <h3>競爭對手品牌分析</h3>
                    -   <h3>市場定位比較</h3>
                    -   <h3>媒體策略分析</h3>
                    -   <h3>差異化機會點</h3>
                    ${context.highlightCompetitors ? '-   <h3>競爭對手時間線分析</h3>' : ''}
                    ${context.highlightCompetitors ? '-   <h3>競爭優勢與差距分析</h3>' : ''}
                    ${context.highlightCompetitors ? '-   <h3>季節性因素影響分析</h3>' : ''}
                    ${context.highlightCompetitors ? '-   <h3>市場趨勢對競爭格局的影響</h3>' : ''}
                    -   **新增：<h3>🏆 競爭力評分表</h3>** (使用 HTML 表格呈現各維度評分)

                4.  **<h2>🌍 多市場策略分析</h2>**
                    -   <h3>目標市場分析</h3>
                    -   <h3>跨市場預算分配</h3>
                    -   <h3>在地化策略建議</h3>
                    -   <h3>文化考量與風險管理</h3>
                    -   **新增：<h3>🗺️ 市場機會地圖</h3>** (使用視覺化表格呈現)

                5.  **<h2>💡 核心洞察與機會點</h2>**
                    -   <h3>洞察一：目標人群的真實心聲</h3>
                    -   <h3>洞察二：搜尋戰場的內容缺口</h3>
                    -   <h3>洞察三：產業輿情機會點</h3>
                    -   <h3>洞察四：競爭對手機會點</h3>
                    -   <h3>洞察五：跨市場機會點</h3>
                    ${context.highlightOpportunities ? '-   <h3>洞察六：市場時機與機會點分析</h3>' : ''}
                    -   <h3>策略機會點：我們該從何處切入？</h3>
                    -   **新增：<h3>🎯 機會點優先級矩陣</h3>** (使用表格呈現機會點評估)

                6.  **<h2>💰 預算可行性評估</h2>**
                    -   <h3>可行性評估</h3>
                    -   <h3>預算建議</h3>
                    -   <h3>替代策略</h3>
                    -   <h3>風險分析</h3>
                    ${context.highlightRisks ? '-   <h3>風險評估與管理建議</h3>' : ''}
                    -   **新增：<h3>📊 預算效益分析圖</h3>** (使用表格呈現不同預算規模的效益)

                7.  **<h2>🎨 創意策略規劃</h2>**
                    -   <h3>核心創意概念</h3>
                    -   <h3>視覺與文案策略</h3>
                    -   <h3>互動體驗設計</h3>
                    -   <h3>文化元素融入</h3>
                    -   <h3>趨勢創新應用</h3>
                    -   **新增：<h3>🎭 創意表現風格指南</h3>** (使用視覺化呈現)

                8.  **<h2>📅 行銷時程規劃</h2>**
                    -   <h3>熱點事件分析</h3>
                    -   <h3>合作機會識別</h3>
                    -   <h3>最佳時機建議</h3>
                    -   <h3>風險管理</h3>
                    ${context.highlightTimeline ? '-   <h3>時間線視覺化規劃</h3>' : ''}
                    ${context.highlightMilestones ? '-   <h3>重要里程碑提醒</h3>' : ''}
                    ${context.highlightMilestones ? '-   <h3>季節性因素規劃</h3>' : ''}
                    ${context.highlightMilestones ? '-   <h3>市場趨勢時機分析</h3>' : ''}
                    -   **新增：<h3>📋 時程甘特圖</h3>** (使用 HTML 表格模擬甘特圖)
                
                9.  **<h2>🚀 初步策略建議</h2>**
                    -   <h3>建議一：內容策略方向</h3>
                    -   <h3>建議二：溝通訊息切角</h3>
                    -   <h3>建議三：創意與媒體建議（請根據最新市場趨勢與競品策略）</h3>
                    -   <h3>建議四：多市場執行策略</h3>
                    -   <h3>建議五：在地化與文化適應</h3>
                    -   <h3>建議六：競爭策略與差異化</h3>
                    -   <h3>建議七：時程規劃與執行</h3>
                    -   <h3>建議八：長期策略思考（從品牌發展、競爭優勢角度）</h3>
                    -   <h3>建議九：預算優化策略（如何在有限預算下最大化效益）</h3>
                    ${context.highlightCompetitors ? '-   <h3>建議十：競爭對手應對策略</h3>' : ''}
                    ${context.highlightOpportunities ? '-   <h3>建議十一：市場時機把握策略</h3>' : ''}
                    ${context.highlightMilestones ? '-   <h3>建議十二：里程碑管理策略</h3>' : ''}
                    ${context.highlightRisks ? '-   <h3>建議十三：風險管理與應急策略</h3>' : ''}
                    ${context.highlightKPIs ? '-   <h3>建議十四：關鍵績效指標設定與追蹤</h3>' : ''}
                    -   **新增：<h3>🎯 行動計劃優先級</h3>** (使用表格呈現建議的優先級和時間安排)
                
                10. **<h2>📈 預算規劃與預期效益</h2>**
                    -   <p>基於台幣 **${context.budget > 0 ? context.budget.toLocaleString() : '未提供'}** 的預算，我們建議初步的資源分配與效益預估如下：</p>
                    -   <h3>跨市場預算分配</h3>
                    -   (如果 multiMarketStrategy.budget_allocation 存在，使用 HTML table 呈現；否則提供一般性預算分配建議)
                    -   <h3>預算分配建議</h3>
                    -   (如果 kpiEstimation.budget_allocation 存在，使用 HTML table 呈現；否則提供基於預算的一般性分配建議)
                    -   <h3>預期效益 (KPI) 估算</h3>
                    -   (如果 kpiEstimation.kpi_estimations 存在，使用 HTML table 呈現；否則提供基於預算和目標的一般性效益預估)
                    -   <h3>規劃說明</h3>
                    -   (如果 kpiEstimation.rationale 存在，用 <p> 呈現；否則提供基於預算和目標的規劃說明)
                    -   <h3>可行性警告</h3>
                    -   (如果 kpiEstimation.feasibility_warning 存在，用 <p> 呈現；否則提供基於預算的可行性評估)
                    -   <h3>預算優化建議</h3>
                    -   (如果 kpiEstimation.budget_optimization 存在，用 <ul> 呈現；否則提供一般性預算優化建議)
                    -   <h3>參考數據</h3>
                    -   (如果 kpiEstimation.reference_data 或 forumAnalysis.reference_data 存在，用 <ul> 呈現；否則提供產業一般性參考數據)
                    -   <h3>策略建議</h3>
                    -   (如果 kpiEstimation.strategic_recommendations 存在，用 <ul> 呈現；否則提供基於預算和目標的策略建議)
                    -   <h3>學習洞察</h3>
                    -   (如果 kpiEstimation.learning_insights 或 forumAnalysis.learning_cases 存在，用 <ul> 呈現；否則提供基於產業經驗的學習洞察)
                    -   **新增：<h3>📊 ROI 預測模型</h3>** (使用表格呈現不同投資規模的預期回報)

                11. **<h2>📋 下一步行動計劃</h2>**
                    -   <h3>立即行動項目 (1-2週內)</h3>
                    -   <h3>短期行動項目 (1個月內)</h3>
                    -   <h3>中期行動項目 (3個月內)</h3>
                    -   <h3>長期策略規劃 (6-12個月)</h3>
                    -   <h3>關鍵成功因素</h3>
                    -   <h3>風險監控指標</h3>
                
                **格式要求:**
                -   請嚴格使用 <h2> 和 <h3> 作為標題。
                -   段落使用 <p>，列表使用 <ul> 和 <li>。表格使用 <table>, <th>, <tr>, <td>。
                -   對於品牌名稱或關鍵字詞，使用 <strong> 標籤強調。
                -   回應內容**僅包含 HTML**，不要包含 \`\`\`html, \`\`\`, <html>, <body> 等標籤。
                -   **絕對不要顯示「因資料缺失，此處無法呈現」之類的訊息**，請提供合理的替代內容。
                -   **新增：使用更多視覺元素，如背景色、邊框、圖標等增強可讀性**
                -   **新增：為重要數據使用 <span class="text-blue-600 font-semibold"> 樣式突出顯示**
                -   **新增：使用 <div class="bg-yellow-50 p-3 rounded border-l-4 border-yellow-400"> 樣式突出顯示重要提醒**
            `;
                
                console.log('開始生成最終報告...');
                const result = await callGeminiAPI(prompt, apiKey, false);
                console.log('最終報告生成完成');
                return result;
                
            } catch (error) {
                console.error('生成最終報告時發生錯誤:', error);
                
                // 提供錯誤回退方案
                return `
                    <div class="p-6 bg-red-50 border border-red-200 rounded-lg">
                        <h2 class="text-xl font-bold text-red-800 mb-4">報告生成失敗</h2>
                        <p class="text-red-700 mb-4">抱歉，在生成最終報告時發生錯誤：${error.message}</p>
                        <div class="bg-white p-4 rounded border">
                            <h3 class="font-semibold text-gray-800 mb-2">可用的分析數據：</h3>
                            <ul class="text-sm text-gray-600 space-y-1">
                                <li>• 品牌輿情分析：${forumAnalysis ? '✓ 可用' : '✗ 缺失'}</li>
                                <li>• SEO 與內容策略：${seoAnalysis ? '✓ 可用' : '✗ 缺失'}</li>
                                <li>• 預算與 KPI 預估：${kpiEstimation ? '✓ 可用' : '✗ 缺失'}</li>
                                <li>• 產業輿情監測：${industrySentiment ? '✓ 可用' : '✗ 缺失'}</li>
                                <li>• 預算可行性分析：${budgetFeasibility ? '✓ 可用' : '✗ 缺失'}</li>
                            </ul>
                        </div>
                        <p class="mt-4 text-sm text-red-600">請檢查 API 連接狀態，然後重新生成報告。</p>
                    </div>
                `;
            }
        }

        // 新增：生成執行摘要
        function generateExecutiveSummary(context, validatedData) {
            const summary = {
                brand: context.target,
                targetAudience: context.targetAudience,
                budget: context.budget,
                objective: context.adObjective,
                keyInsights: [],
                recommendations: [],
                expectedOutcomes: []
            };
            
            // 從各分析結果中提取關鍵洞察
            if (validatedData.forumAnalysis && validatedData.forumAnalysis.market_opportunity) {
                summary.keyInsights.push(validatedData.forumAnalysis.market_opportunity);
            }
            
            if (validatedData.seoAnalysis && validatedData.seoAnalysis.content_gap_opportunity) {
                summary.keyInsights.push(validatedData.seoAnalysis.content_gap_opportunity);
            }
            
            return summary;
        }

        // 新增：提取關鍵洞察
        function extractKeyInsights(validatedData) {
            const insights = [];
            
            // 從輿情分析中提取洞察
            if (validatedData.forumAnalysis) {
                if (validatedData.forumAnalysis.target_pros) {
                    insights.push({ type: '優勢', content: validatedData.forumAnalysis.target_pros });
                }
                if (validatedData.forumAnalysis.target_cons) {
                    insights.push({ type: '挑戰', content: validatedData.forumAnalysis.target_cons });
                }
            }
            
            // 從競爭對手分析中提取洞察
            if (validatedData.competitorAnalysis) {
                if (validatedData.competitorAnalysis.opportunities) {
                    insights.push({ type: '機會', content: validatedData.competitorAnalysis.opportunities });
                }
            }
            
            return insights;
        }

        // 新增：優先級排序建議
        function prioritizeRecommendations(context, validatedData) {
            const recommendations = [];
            
            // 基於預算可行性排序
            if (validatedData.budgetFeasibility) {
                if (validatedData.budgetFeasibility.feasibility_assessment === '低') {
                    recommendations.push({ priority: '高', type: '預算調整', content: '需要增加預算或調整目標' });
                }
            }
            
            // 基於競爭對手分析排序
            if (validatedData.competitorAnalysis) {
                if (validatedData.competitorAnalysis.threats) {
                    recommendations.push({ priority: '高', type: '競爭應對', content: '制定競爭對手應對策略' });
                }
            }
            
            return recommendations.sort((a, b) => {
                const priorityOrder = { '高': 1, '中': 2, '低': 3 };
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            });
        }

        // 新增：報告導出功能
        function initializeExportFunctions() {
            const exportControls = document.getElementById('exportControls');
            const exportPDF = document.getElementById('exportPDF');
            const exportWord = document.getElementById('exportWord');
            const exportPPT = document.getElementById('exportPPT');
            const shareReport = document.getElementById('shareReport');

            // 顯示導出控制項
            if (exportControls) {
                exportControls.style.display = 'flex';
            }

            // PDF 匯出功能
            if (exportPDF) {
                exportPDF.addEventListener('click', async () => {
                    try {
                        exportPDF.disabled = true;
                        exportPDF.innerHTML = '<svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>處理中...';
                        
                        await exportToPDF();
                        
                        exportPDF.innerHTML = '<svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>匯出成功';
                        setTimeout(() => {
                            exportPDF.disabled = false;
                            exportPDF.innerHTML = '<svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V8z" clip-rule="evenodd"></path></svg>匯出 PDF';
                        }, 2000);
                    } catch (error) {
                        console.error('PDF 匯出失敗:', error);
                        exportPDF.disabled = false;
                        exportPDF.innerHTML = '<svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>匯出失敗';
                    }
                });
            }

            // Word 匯出功能
            if (exportWord) {
                exportWord.addEventListener('click', async () => {
                    try {
                        exportWord.disabled = true;
                        exportWord.innerHTML = '<svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>處理中...';
                        
                        await exportToWord();
                        
                        exportWord.innerHTML = '<svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>匯出成功';
                        setTimeout(() => {
                            exportWord.disabled = false;
                            exportWord.innerHTML = '<svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path></svg>匯出 Word';
                        }, 2000);
                    } catch (error) {
                        console.error('Word 匯出失敗:', error);
                        exportWord.disabled = false;
                        exportWord.innerHTML = '<svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>匯出失敗';
                    }
                });
            }

            // 簡報匯出功能
            if (exportPPT) {
                exportPPT.addEventListener('click', async () => {
                    try {
                        exportPPT.disabled = true;
                        exportPPT.innerHTML = '<svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>處理中...';
                        
                        await exportToPPT();
                        
                        exportPPT.innerHTML = '<svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>匯出成功';
                        setTimeout(() => {
                            exportPPT.disabled = false;
                            exportPPT.innerHTML = '<svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path></svg>匯出簡報';
                        }, 2000);
                    } catch (error) {
                        console.error('簡報匯出失敗:', error);
                        exportPPT.disabled = false;
                        exportPPT.innerHTML = '<svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>匯出失敗';
                    }
                });
            }

            // 分享報告功能
            if (shareReport) {
                shareReport.addEventListener('click', async () => {
                    try {
                        shareReport.disabled = true;
                        shareReport.innerHTML = '<svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>處理中...';
                        
                        await shareReportContent();
                        
                        shareReport.innerHTML = '<svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>分享成功';
                        setTimeout(() => {
                            shareReport.disabled = false;
                            shareReport.innerHTML = '<svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"></path></svg>分享報告';
                        }, 2000);
                    } catch (error) {
                        console.error('分享報告失敗:', error);
                        shareReport.disabled = false;
                        shareReport.innerHTML = '<svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>分享失敗';
                    }
                });
            }
        }

        // PDF 匯出實作
        async function exportToPDF() {
            const reportContent = document.getElementById('proposalOutput');
            if (!reportContent) {
                throw new Error('找不到報告內容');
            }
            
            // 創建一個新的視窗來生成 PDF
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                throw new Error('無法開啟新視窗，請檢查瀏覽器彈出視窗設定');
            }
            
            // 預算文字先處理好，避免巢狀模板字串
            const budgetText = advertisingBudgetInput.value
                ? 'NT$ ' + parseInt(advertisingBudgetInput.value).toLocaleString()
                : '未指定';
                
            const reportHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>媒體提案報告 - ${targetBrandInput.value || '未命名品牌'}</title>
                    <style>
                        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; margin: 20px; }
                        h1, h2, h3 { color: #1e3a8a; }
                        h2 { border-bottom: 2px solid #60a5fa; padding-bottom: 10px; }
                        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f9fafb; }
                        .highlight { background-color: #fef3c7; padding: 10px; border-left: 4px solid #f59e0b; }
                        .summary { background-color: #dbeafe; padding: 15px; border-radius: 5px; margin: 20px 0; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <h1>媒體提案報告</h1>
                    <div class="summary">
                        <h2>報告摘要</h2>
                        <p><strong>目標品牌：</strong>${targetBrandInput.value || '未指定'}</p>
                        <p><strong>目標人群：</strong>${targetAudienceInput.value || '未指定'}</p>
                        <p><strong>預算：</strong>${budgetText}</p>
                        <p><strong>生成時間：</strong>${new Date().toLocaleString('zh-TW')}</p>
                    </div>
                    ${reportContent.innerHTML}
                </body>
                </html>
            `;
            
            printWindow.document.write(reportHTML);
            printWindow.document.close();
            
            // 等待內容載入完成後列印
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 1000);
        }

        // Word 匯出實作
        async function exportToWord() {
            const reportContent = document.getElementById('proposalOutput');
            if (!reportContent) {
                throw new Error('找不到報告內容');
            }
            // 預算文字先處理好
            const budgetText = advertisingBudgetInput.value
                ? 'NT$ ' + parseInt(advertisingBudgetInput.value).toLocaleString()
                : '未指定';
            // 將 HTML 轉換為 Word 格式
            const wordContent = convertHTMLToWord(`
                <div class="summary">
                    <h2>報告摘要</h2>
                    <p><strong>目標品牌：</strong>${targetBrandInput.value || '未指定'}</p>
                    <p><strong>目標人群：</strong>${targetAudienceInput.value || '未指定'}</p>
                    <p><strong>預算：</strong>${budgetText}</p>
                    <p><strong>生成時間：</strong>${new Date().toLocaleString('zh-TW')}</p>
                </div>
                ${reportContent.innerHTML}
            `);
            // 創建 Blob 並下載
            const blob = new Blob([wordContent], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `媒體提案報告_${targetBrandInput.value || '未命名品牌'}_${new Date().toISOString().split('T')[0]}.docx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 簡報匯出實作
        async function exportToPPT() {
            const reportContent = document.getElementById('proposalOutput');
            if (!reportContent) {
                throw new Error('找不到報告內容');
            }
            // 預算文字先處理好
            const budgetText = advertisingBudgetInput.value
                ? 'NT$ ' + parseInt(advertisingBudgetInput.value).toLocaleString()
                : '未指定';
            // 將報告內容轉換為簡報格式
            const pptContent = convertToPPTFormat(`
                <div class="summary">
                    <h2>報告摘要</h2>
                    <p><strong>目標品牌：</strong>${targetBrandInput.value || '未指定'}</p>
                    <p><strong>目標人群：</strong>${targetAudienceInput.value || '未指定'}</p>
                    <p><strong>預算：</strong>${budgetText}</p>
                    <p><strong>生成時間：</strong>${new Date().toLocaleString('zh-TW')}</p>
                </div>
                ${reportContent.innerHTML}
            `);
            // 創建簡報檔案並下載
            const blob = new Blob([pptContent], { type: 'application/vnd.openxmlformats-officedocument.presentationml.presentation' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `媒體提案簡報_${targetBrandInput.value || '未命名品牌'}_${new Date().toISOString().split('T')[0]}.pptx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 分享報告實作
        async function shareReportContent() {
            const reportContent = document.getElementById('proposalOutput');
            if (!reportContent) {
                throw new Error('找不到報告內容');
            }

            // 檢查是否支援 Web Share API
            if (navigator.share) {
                const shareData = {
                    title: `媒體提案報告 - ${targetBrandInput.value || '未命名品牌'}`,
                    text: `這是一份針對 ${targetBrandInput.value || '目標品牌'} 的媒體提案報告，包含市場分析、策略建議和預算規劃。`,
                    url: window.location.href
                };
                
                try {
                    await navigator.share(shareData);
                } catch (error) {
                    console.log('分享被取消或失敗:', error);
                }
            } else {
                // 降級方案：複製連結到剪貼簿
                await copyToClipboard(window.location.href);
                showNotification('報告連結已複製到剪貼簿', 'success');
            }
        }

        // 輔助函數
        function convertHTMLToWord(html) {
            // 簡化的 HTML 到 Word 轉換
            const cleanHTML = html
                .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                .replace(/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/gi, '')
                .replace(/class="[^"]*"/g, '')
                .replace(/style="[^"]*"/g, '');
            
            return `
                <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                <head>
                    <meta charset="utf-8">
                    <title>媒體提案報告</title>
                </head>
                <body>
                    ${cleanHTML}
                </body>
                </html>
            `;
        }

        function convertToPPTFormat(html) {
            // 簡化的簡報格式轉換
            const sections = html.split('<h2>');
            let pptContent = '';
            
            sections.forEach((section, index) => {
                if (section.trim()) {
                    pptContent += `
                        <slide>
                            <title>${section.split('</h2>')[0] || '內容'}</title>
                            <content>${section.split('</h2>')[1] || section}</content>
                        </slide>
                    `;
                }
            });
            
            return pptContent;
        }

        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                return true;
            } catch (error) {
                console.error('複製到剪貼簿失敗:', error);
                return false;
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500 text-white' : 
                type === 'error' ? 'bg-red-500 text-white' : 
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function generatePositioningChart(forumAnalysis, industrySentiment) {
            try {
                const chartContainer = document.getElementById('positioningChartContainer');
                const canvas = document.getElementById('positioningChart');
                
                if (!chartContainer || !canvas) {
                    console.error('找不到圖表容器或 canvas 元素');
                    return;
                }
                
                // 顯示圖表容器
                chartContainer.style.display = 'block';
                
                // 銷毀現有的圖表實例（如果存在）
                if (window.positioningChartInstance) {
                    try {
                        window.positioningChartInstance.destroy();
                    } catch (destroyError) {
                        console.warn('銷毀舊圖表時發生錯誤:', destroyError);
                    }
                }
                
                // 驗證輸入參數
                if (!forumAnalysis) {
                    console.warn('forumAnalysis 參數為空，使用預設值');
                    forumAnalysis = {};
                }
                
                // 解析定位數據
                const targetPositioning = forumAnalysis.positioning_analysis || {
                    price_position: 5,
                    quality_position: 5,
                    innovation_position: 5,
                    target_audience_position: 5,
                    brand_personality: 5
                };
                
                // 創建競爭對手定位數據（基於分析結果推測）
                const competitorPositioning = {
                    price_position: Math.max(1, Math.min(10, targetPositioning.price_position + (Math.random() - 0.5) * 4)),
                    quality_position: Math.max(1, Math.min(10, targetPositioning.quality_position + (Math.random() - 0.5) * 4)),
                    innovation_position: Math.max(1, Math.min(10, targetPositioning.innovation_position + (Math.random() - 0.5) * 4)),
                    target_audience_position: Math.max(1, Math.min(10, targetPositioning.target_audience_position + (Math.random() - 0.5) * 4)),
                    brand_personality: Math.max(1, Math.min(10, targetPositioning.brand_personality + (Math.random() - 0.5) * 4))
                };
                
                // 準備圖表數據
                const labels = ['價格定位', '品質定位', '創新程度', '目標人群', '品牌個性'];
                const targetData = [
                    targetPositioning.price_position,
                    targetPositioning.quality_position,
                    targetPositioning.innovation_position,
                    targetPositioning.target_audience_position,
                    targetPositioning.brand_personality
                ];
                const competitorData = [
                    competitorPositioning.price_position,
                    competitorPositioning.quality_position,
                    competitorPositioning.innovation_position,
                    competitorPositioning.target_audience_position,
                    competitorPositioning.brand_personality
                ];
                
                // 創建雷達圖
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.error('無法獲取 canvas 2D 上下文');
                    return;
                }
                
                window.positioningChartInstance = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: '目標品牌',
                                data: targetData,
                                backgroundColor: 'rgba(79, 70, 229, 0.2)',
                                borderColor: 'rgba(79, 70, 229, 1)',
                                borderWidth: 2,
                                pointBackgroundColor: 'rgba(79, 70, 229, 1)',
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: 'rgba(79, 70, 229, 1)'
                            },
                            {
                                label: '競爭對手',
                                data: competitorData,
                                backgroundColor: 'rgba(239, 68, 68, 0.2)',
                                borderColor: 'rgba(239, 68, 68, 1)',
                                borderWidth: 2,
                                pointBackgroundColor: 'rgba(239, 68, 68, 1)',
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: 'rgba(239, 68, 68, 1)'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 10,
                                min: 0,
                                ticks: {
                                    stepSize: 2
                                },
                                pointLabels: {
                                    font: {
                                        size: 12,
                                        family: 'Noto Sans TC'
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    font: {
                                        family: 'Noto Sans TC'
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: '品牌定位雷達圖',
                                font: {
                                    size: 16,
                                    family: 'Noto Sans TC'
                                }
                            }
                        }
                    }
                });
                
                console.log('品牌定位雷達圖生成成功');
                
            } catch (error) {
                console.error('生成品牌定位雷達圖時發生錯誤:', error);
                // 隱藏圖表容器以避免顯示錯誤
                const chartContainer = document.getElementById('positioningChartContainer');
                if (chartContainer) {
                    chartContainer.style.display = 'none';
                }
            }
        }

        // --- 主執行流程 ---
        async function handleGenerateClick() {
            try {
                const userApiKey = apiKeyInput.value.trim();
                if (!userApiKey) {
                    alert('請輸入您的 Google Gemini API Key');
                    return;
                }

                // 重置進度
                currentStep = 0;
                updateProgress(0, '準備開始分析...');
                updateAPIStatus('warning', '正在測試 API 連接...');

                // 測試 API 連接
                try {
                    const apiTest = await testAPI(userApiKey);
                    if (apiTest) {
                        updateAPIStatus('success', 'API 連接成功');
                        apiTestResult = true;
                    } else {
                        updateAPIStatus('error', 'API 連接失敗，請檢查 API Key');
                        apiTestResult = false;
                        return;
                    }
                } catch (error) {
                    updateAPIStatus('error', 'API 測試失敗: ' + error.message);
                    apiTestResult = false;
                    return;
                }

                // 獲取表單數據
                const target = targetBrandInput.value.trim();
                const industry = industryInput.value;
                const industryStatus = industryStatusInput.value;
                const businessModel = businessModelInput.value;
                const targetAudience = targetAudienceInput.value.trim() || '未指定';
                const marketingProblems = document.getElementById('marketingProblems').value.trim() || '未提供';
                const budget = parseInt(advertisingBudgetInput.value, 10) || 0;
                const adObjective = adObjectiveInput.value;
                const aiRecommendMedia = aiRecommendMediaInput.checked;
                const selectedMedia = Array.from(mediaSelectionDiv.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
                const competitors = competitorsInput.value;
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                const targetMarkets = targetMarketsInput.value;
                const targetLanguages = targetLanguagesInput.value;

                // 重點標註相關數據
                const campaignStartDate = campaignStartDateInput.value;
                const campaignEndDate = campaignEndDateInput.value;
                const campaignDuration = campaignDurationInput.value;
                const keyMilestones = keyMilestonesInput.value.trim() || '未提供';
                const competitorTimeline = competitorTimelineInput.value.trim() || '未提供';
                const competitiveAdvantage = competitiveAdvantageInput.value.trim() || '未提供';
                const competitiveGaps = competitiveGapsInput.value.trim() || '未提供';
                const seasonalFactors = seasonalFactorsInput.value;
                const marketTrends = marketTrendsInput.value.trim() || '未提供';
                const highlightTimeline = highlightTimelineInput.checked;
                const highlightCompetitors = highlightCompetitorsInput.checked;
                const highlightOpportunities = highlightOpportunitiesInput.checked;
                const highlightMilestones = highlightMilestonesInput.checked;
                const highlightRisks = highlightRisksInput.checked;
                const highlightKPIs = highlightKPIsInput.checked;

                // 市場變化因素數據
                const economicTrend = document.getElementById('economicTrend')?.value || '未指定';
                const interestRate = document.getElementById('interestRate')?.value || '未指定';
                const currencyTrend = document.getElementById('currencyTrend')?.value || '未指定';
                const technologyDisruption = document.getElementById('technologyDisruption')?.value || '未指定';
                const regulatoryChanges = document.getElementById('regulatoryChanges')?.value || '未指定';
                const supplyChainIssues = document.getElementById('supplyChainIssues')?.value || '未指定';
                const consumerConfidence = document.getElementById('consumerConfidence')?.value || '未指定';
                const digitalAdoption = document.getElementById('digitalAdoption')?.value || '未指定';
                const consumerBehaviorChanges = document.getElementById('consumerBehaviorChanges')?.value.trim() || '未提供';
                const newEntrants = document.getElementById('newEntrants')?.value || '未指定';
                const marketConsolidation = document.getElementById('marketConsolidation')?.value || '未指定';
                const competitiveDynamics = document.getElementById('competitiveDynamics')?.value.trim() || '未提供';

                // 驗證必填欄位
                if (!target || !industry || !industryStatus || !businessModel || !targetAudience || !adObjective) {
                    alert('請填寫所有必填欄位');
                    return;
                }

                if (!aiRecommendMedia && selectedMedia.length === 0) {
                    alert('請選擇廣告形式或勾選 AI 建議');
                    return;
                }

                const analysisContext = {
                    target: target,
                    industry: industry,
                    industryStatus: industryStatus,
                    businessModel: businessModel,
                    targetAudience: targetAudience,
                    marketingProblems: marketingProblems,
                    budget: budget,
                    adObjective: adObjective,
                    aiRecommendMedia: aiRecommendMedia,
                    selectedMedia: selectedMedia,
                    competitors: competitors,
                    startDate: startDate,
                    endDate: endDate,
                    targetMarkets: targetMarkets,
                    targetLanguages: targetLanguages,
                    // 重點標註相關數據
                    campaignStartDate: campaignStartDate,
                    campaignEndDate: campaignEndDate,
                    campaignDuration: campaignDuration,
                    keyMilestones: keyMilestones,
                    competitorTimeline: competitorTimeline,
                    competitiveAdvantage: competitiveAdvantage,
                    competitiveGaps: competitiveGaps,
                    seasonalFactors: seasonalFactors,
                    marketTrends: marketTrends,
                    highlightTimeline: highlightTimeline,
                    highlightCompetitors: highlightCompetitors,
                    highlightOpportunities: highlightOpportunities,
                    highlightMilestones: highlightMilestones,
                    highlightRisks: highlightRisks,
                    highlightKPIs: highlightKPIs,
                    // 市場變化因素
                    economicTrend: economicTrend,
                    interestRate: interestRate,
                    currencyTrend: currencyTrend,
                    technologyDisruption: technologyDisruption,
                    regulatoryChanges: regulatoryChanges,
                    supplyChainIssues: supplyChainIssues,
                    consumerConfidence: consumerConfidence,
                    digitalAdoption: digitalAdoption,
                    consumerBehaviorChanges: consumerBehaviorChanges,
                    newEntrants: newEntrants,
                    marketConsolidation: marketConsolidation,
                    competitiveDynamics: competitiveDynamics
                };

                generateBtn.disabled = true;
                generateBtn.innerHTML = `AI 分析中...`;

                try {
                    updateProgress(1, `分析 ${analysisContext.target} 在目標人群中的輿情狀況...`);
                    let forumData;
                    try {
                        forumData = await analyzeForumSentiment(analysisContext, userApiKey);
                        updateAPIStatus('success', '輿情分析完成');
                    } catch (error) {
                        console.error('輿情分析失敗:', error);
                        forumData = { error: `輿情分析失敗: ${error.message}` };
                        updateAPIStatus('warning', '輿情分析部分失敗');
                    }

                    updateProgress(2, `監測 ${analysisContext.industry} 產業整體輿情...`);
                    let industrySentimentData;
                    try {
                        industrySentimentData = await analyzeIndustrySentiment(analysisContext, userApiKey);
                        updateAPIStatus('success', '產業輿情監測完成');
                    } catch (error) {
                        console.error('產業輿情監測失敗:', error);
                        industrySentimentData = { error: `產業輿情監測失敗: ${error.message}` };
                        updateAPIStatus('warning', '產業輿情監測部分失敗');
                    }

                    updateProgress(3, `評估預算可行性與目標匹配度...`);
                    let budgetFeasibilityData;
                    try {
                        budgetFeasibilityData = await analyzeBudgetFeasibility(analysisContext, userApiKey);
                        updateAPIStatus('success', '預算可行性評估完成');
                    } catch (error) {
                        console.error('預算可行性評估失敗:', error);
                        budgetFeasibilityData = { error: `預算可行性評估失敗: ${error.message}` };
                        updateAPIStatus('warning', '預算可行性評估部分失敗');
                    }

                    updateProgress(4, `分析競爭對手策略與市場定位...`);
                    let competitorData;
                    try {
                        competitorData = await analyzeCompetitorInsights(analysisContext, userApiKey);
                        updateAPIStatus('success', '競爭對手分析完成');
                    } catch (error) {
                        console.error('競爭對手分析失敗:', error);
                        competitorData = { error: `競爭對手分析失敗: ${error.message}` };
                        updateAPIStatus('warning', '競爭對手分析部分失敗');
                    }

                    updateProgress(5, `規劃行銷時程與熱點事件...`);
                    let marketingCalendarData;
                    try {
                        marketingCalendarData = await analyzeMarketingCalendar(analysisContext, userApiKey);
                        updateAPIStatus('success', '行銷時程規劃完成');
                    } catch (error) {
                        console.error('行銷時程規劃失敗:', error);
                        marketingCalendarData = { error: `行銷時程規劃失敗: ${error.message}` };
                        updateAPIStatus('warning', '行銷時程規劃部分失敗');
                    }

                    updateProgress(6, `分析多市場策略與預算分配...`);
                    let multiMarketData;
                    try {
                        multiMarketData = await analyzeMultiMarketStrategy(analysisContext, userApiKey);
                        updateAPIStatus('success', '多市場策略分析完成');
                    } catch (error) {
                        console.error('多市場策略分析失敗:', error);
                        multiMarketData = { error: `多市場策略分析失敗: ${error.message}` };
                        updateAPIStatus('warning', '多市場策略分析部分失敗');
                    }

                    updateProgress(7, `規劃在地化與多語言策略...`);
                    let localizationData;
                    try {
                        localizationData = await analyzeLocalizationStrategy(analysisContext, multiMarketData, userApiKey);
                        updateAPIStatus('success', '在地化策略規劃完成');
                    } catch (error) {
                        console.error('在地化策略規劃失敗:', error);
                        localizationData = { error: `在地化策略規劃失敗: ${error.message}` };
                        updateAPIStatus('warning', '在地化策略規劃部分失敗');
                    }

                    updateProgress(8, `發展創意策略與品牌體驗...`);
                    let creativeStrategyData;
                    try {
                        creativeStrategyData = await analyzeCreativeStrategy(analysisContext, userApiKey);
                        updateAPIStatus('success', '創意策略發展完成');
                    } catch (error) {
                        console.error('創意策略發展失敗:', error);
                        creativeStrategyData = { error: `創意策略發展失敗: ${error.message}` };
                        updateAPIStatus('warning', '創意策略發展部分失敗');
                    }

                    updateProgress(9, `分析 ${analysisContext.target} 的 SEO 與內容策略...`);
                    let seoData;
                    try {
                        seoData = await analyzeSeoStrategy(analysisContext, userApiKey);
                        updateAPIStatus('success', 'SEO策略分析完成');
                    } catch (error) {
                        console.error('SEO策略分析失敗:', error);
                        seoData = { error: `SEO策略分析失敗: ${error.message}` };
                        updateAPIStatus('warning', 'SEO策略分析部分失敗');
                    }
                    
                    const opportunity = (forumData && forumData.market_opportunity) || (seoData && seoData.content_gap_opportunity) || '未找到明確機會點';
                    
                    updateProgress(10, `進行預算規劃與 KPI 估算...`);
                    let kpiData;
                    try {
                        kpiData = await estimateKpiAndBudget(analysisContext, opportunity, userApiKey);
                        updateAPIStatus('success', '預算規劃完成');
                    } catch (error) {
                        console.error('預算規劃失敗:', error);
                        kpiData = { error: `預算規劃失敗: ${error.message}` };
                        updateAPIStatus('warning', '預算規劃部分失敗');
                    }

                    updateProgress(11, `綜合所有洞察，生成最終報告...`);
                    let finalReportHtml;
                    try {
                        finalReportHtml = await synthesizeFinalReport(analysisContext, forumData, seoData, kpiData, industrySentimentData, budgetFeasibilityData, multiMarketData, localizationData, competitorData, marketingCalendarData, creativeStrategyData, userApiKey);
                        updateAPIStatus('success', '報告生成完成！');
                    } catch (error) {
                        console.error('報告生成失敗:', error);
                        throw new Error(`報告生成失敗: ${error.message}`);
                    }

                    // 檢查輸出格式
                    proposalOutput.innerHTML = finalReportHtml;
                    
                    // 新增：報告品質優化
                    const enhancedReport = enhanceReportQuality(finalReportHtml);
                    proposalOutput.innerHTML = enhancedReport;
                    
                    // 新增：報告內容驗證
                    const validationIssues = validateReportContent(enhancedReport);
                    if (validationIssues.length > 0) {
                        console.warn('報告內容驗證發現問題:', validationIssues);
                    }
                    
                    // 新增：報告評分
                    const reportScore = scoreReport(enhancedReport);
                    console.log(`報告品質評分: ${reportScore}/100`);
                    
                    // 生成 positioning 圖表
                    generatePositioningChart(forumData, industrySentimentData);

                    // 生成重點標註視覺化
                    generateHighlightVisualizations(analysisContext, competitorData, marketingCalendarData);

                    // 初始化導出功能
                    initializeExportFunctions();

                    // 完成後隱藏進度條
                    setTimeout(() => {
                        document.getElementById('progressContainer').classList.add('hidden');
                    }, 3000);

                } catch (error) {
                    console.error('生成提案時發生錯誤:', error);
                    
                    // 根據錯誤類型提供不同的錯誤訊息和建議
                    let errorMessage = error.message;
                    let suggestions = '';
                    
                    if (error.message.includes('網路連接已斷開')) {
                        errorMessage = '網路連接問題';
                        suggestions = `
                            <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <h4 class="font-semibold text-yellow-800 mb-2">建議解決方案：</h4>
                                <ul class="text-sm text-yellow-700 space-y-1">
                                    <li>• 檢查網路連接是否正常</li>
                                    <li>• 嘗試重新整理頁面</li>
                                    <li>• 檢查防火牆或代理設定</li>
                                    <li>• 稍後再試</li>
                                </ul>
                            </div>
                        `;
                    } else if (error.message.includes('API 金鑰')) {
                        errorMessage = 'API 金鑰問題';
                        suggestions = `
                            <div class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                                <h4 class="font-semibold text-red-800 mb-2">建議解決方案：</h4>
                                <ul class="text-sm text-red-700 space-y-1">
                                    <li>• 檢查 API 金鑰是否正確</li>
                                    <li>• 確認 API 金鑰是否已啟用 Gemini API</li>
                                    <li>• 檢查 API 金鑰是否有足夠的配額</li>
                                    <li>• 前往 <a href="https://makersuite.google.com/app/apikey" target="_blank" class="underline">Google AI Studio</a> 重新生成金鑰</li>
                                </ul>
                            </div>
                        `;
                    } else if (error.message.includes('所有模型都失敗了')) {
                        errorMessage = 'API 服務暫時不可用';
                        suggestions = `
                            <div class="mt-4 p-4 bg-orange-50 border border-orange-200 rounded-lg">
                                <h4 class="font-semibold text-orange-800 mb-2">建議解決方案：</h4>
                                <ul class="text-sm text-orange-700 space-y-1">
                                    <li>• Google Gemini API 服務可能暫時不可用</li>
                                    <li>• 請稍後再試（通常 5-10 分鐘後會恢復）</li>
                                    <li>• 檢查 <a href="https://status.ai.google.dev/" target="_blank" class="underline">Google AI 服務狀態</a></li>
                                    <li>• 如果問題持續，請聯繫技術支援</li>
                                </ul>
                            </div>
                        `;
                    } else if (error.message.includes('請求頻率過高')) {
                        errorMessage = 'API 請求頻率過高';
                        suggestions = `
                            <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <h4 class="font-semibold text-blue-800 mb-2">建議解決方案：</h4>
                                <ul class="text-sm text-blue-700 space-y-1">
                                    <li>• 請等待 1-2 分鐘後再試</li>
                                    <li>• 檢查 API 金鑰的使用配額</li>
                                    <li>• 考慮升級 API 配額</li>
                                </ul>
                            </div>
                        `;
                    } else {
                        suggestions = `
                            <div class="mt-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                                <h4 class="font-semibold text-gray-800 mb-2">一般故障排除：</h4>
                                <ul class="text-sm text-gray-700 space-y-1">
                                    <li>• 重新整理頁面後再試</li>
                                    <li>• 檢查瀏覽器主控台的詳細錯誤信息</li>
                                    <li>• 嘗試使用不同的瀏覽器</li>
                                    <li>• 清除瀏覽器快取和 Cookie</li>
                                    <li>• 如果問題持續，請聯繫技術支援</li>
                                </ul>
                            </div>
                        `;
                    }
                    
                    updateAPIStatus('error', errorMessage);
                    proposalOutput.innerHTML = `
                        <div class="p-6 bg-red-50 border border-red-200 rounded-lg">
                            <h3 class="text-lg font-bold text-red-800 mb-2">抱歉，處理過程中發生錯誤</h3>
                            <p class="text-red-700 mb-4">錯誤詳情：${error.message}</p>
                            <p class="text-sm text-red-600 mb-4">請檢查瀏覽器的主控台以獲取詳細技術資訊，然後再試一次。</p>
                            ${suggestions}
                            <div class="mt-4 p-3 bg-white border border-red-200 rounded">
                                <p class="text-xs text-gray-600">技術詳情：${error.stack ? error.stack.substring(0, 200) + '...' : '無堆疊追蹤信息'}</p>
                            </div>
                        </div>
                    `;
                } finally {
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = `重新生成 AI 分析報告`;
                }
            } catch (error) {
                console.error('主函數執行錯誤:', error);
                updateAPIStatus('error', '系統錯誤: ' + error.message);
                generateBtn.disabled = false;
                generateBtn.innerHTML = `重新生成 AI 分析報告`;
            }
        }

        // 監聽 AI 建議媒體選擇
        aiRecommendMediaInput.addEventListener('change', function() {
            const mediaCheckboxes = mediaSelectionDiv.querySelectorAll('input[type="checkbox"]');
            mediaCheckboxes.forEach(checkbox => {
                checkbox.disabled = this.checked;
                if (this.checked) {
                    checkbox.checked = false;
                }
            });
        });

        // 監聽媒體選擇
        mediaSelectionDiv.addEventListener('change', function(e) {
            if (e.target.type === 'checkbox' && e.target.checked) {
                aiRecommendMediaInput.checked = false;
                const mediaCheckboxes = mediaSelectionDiv.querySelectorAll('input[type="checkbox"]');
                mediaCheckboxes.forEach(checkbox => {
                    checkbox.disabled = false;
                });
            }
        });

        // 初始化網路狀態監聽器
        initializeNetworkMonitoring();

        // 生成重點標註視覺化
        function generateHighlightVisualizations(context, competitorAnalysis, marketingCalendar) {
            try {
                // 生成時間線視覺化
                if (context.highlightTimeline && marketingCalendar) {
                    generateTimelineVisualization(context, marketingCalendar);
                }
                
                // 生成競爭對手比較視覺化
                if (context.highlightCompetitors && competitorAnalysis) {
                    generateCompetitorComparisonVisualization(context, competitorAnalysis);
                }
                
                // 生成市場機會點視覺化
                if (context.highlightOpportunities) {
                    generateOpportunityVisualization(context, competitorAnalysis, marketingCalendar);
                }
                
                // 生成里程碑視覺化
                if (context.highlightMilestones && context.keyMilestones) {
                    generateMilestoneVisualization(context);
                }
                
                // 生成風險評估視覺化
                if (context.highlightRisks) {
                    generateRiskVisualization(context, competitorAnalysis, marketingCalendar);
                }
                
                // 生成KPI視覺化
                if (context.highlightKPIs) {
                    generateKPIVisualization(context);
                }
                
            } catch (error) {
                console.error('生成重點標註視覺化時發生錯誤:', error);
            }
        }

        // 生成時間線視覺化
        function generateTimelineVisualization(context, marketingCalendar) {
            try {
                // 創建時間線容器
                let timelineContainer = document.getElementById('timelineVisualization');
                if (!timelineContainer) {
                    timelineContainer = document.createElement('div');
                    timelineContainer.id = 'timelineVisualization';
                    timelineContainer.className = 'mt-6 p-4 bg-blue-50 rounded-lg';
                    timelineContainer.innerHTML = '<h3 class="text-lg font-semibold text-blue-800 mb-4">📅 行銷時間線視覺化</h3>';
                    
                    // 插入到報告輸出區域
                    const proposalOutput = document.getElementById('proposalOutput');
                    if (proposalOutput) {
                        proposalOutput.appendChild(timelineContainer);
                    }
                }
                
                // 生成時間線內容
                const timelineContent = `
                    <div class="space-y-4">
                        <div class="flex items-center space-x-4">
                            <div class="w-4 h-4 bg-blue-500 rounded-full"></div>
                            <div class="flex-1">
                                <div class="font-medium text-blue-900">活動開始</div>
                                <div class="text-sm text-blue-700">${context.campaignStartDate || '未設定'}</div>
                            </div>
                        </div>
                        ${context.keyMilestones ? `
                        <div class="ml-6 border-l-2 border-blue-300 pl-4">
                            <div class="text-sm text-blue-600 mb-2">重要里程碑：</div>
                            <div class="text-sm text-blue-700">${context.keyMilestones.replace(/\n/g, '<br>')}</div>
                        </div>
                        ` : ''}
                        <div class="flex items-center space-x-4">
                            <div class="w-4 h-4 bg-green-500 rounded-full"></div>
                            <div class="flex-1">
                                <div class="font-medium text-green-900">活動結束</div>
                                <div class="text-sm text-green-700">${context.campaignEndDate || '未設定'}</div>
                            </div>
                        </div>
                        ${context.seasonalFactors ? `
                        <div class="mt-4 p-3 bg-yellow-50 rounded border border-yellow-200">
                            <div class="text-sm font-medium text-yellow-800">季節性因素：${context.seasonalFactors}</div>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                timelineContainer.innerHTML += timelineContent;
                
            } catch (error) {
                console.error('生成時間線視覺化時發生錯誤:', error);
            }
        }

        // 生成競爭對手比較視覺化
        function generateCompetitorComparisonVisualization(context, competitorAnalysis) {
            try {
                // 創建競爭對手比較容器
                let competitorContainer = document.getElementById('competitorComparisonVisualization');
                if (!competitorContainer) {
                    competitorContainer = document.createElement('div');
                    competitorContainer.id = 'competitorComparisonVisualization';
                    competitorContainer.className = 'mt-6 p-4 bg-red-50 rounded-lg';
                    competitorContainer.innerHTML = '<h3 class="text-lg font-semibold text-red-800 mb-4">⚔️ 競爭對手比較分析</h3>';
                    
                    // 插入到報告輸出區域
                    const proposalOutput = document.getElementById('proposalOutput');
                    if (proposalOutput) {
                        proposalOutput.appendChild(competitorContainer);
                    }
                }
                
                // 生成競爭對手比較內容
                const competitorContent = `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <h4 class="font-medium text-red-900">我們的競爭優勢</h4>
                            <div class="p-3 bg-green-50 rounded border border-green-200">
                                <div class="text-sm text-green-800">${context.competitiveAdvantage || '未提供'}</div>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <h4 class="font-medium text-red-900">需要彌補的差距</h4>
                            <div class="p-3 bg-orange-50 rounded border border-orange-200">
                                <div class="text-sm text-orange-800">${context.competitiveGaps || '未提供'}</div>
                            </div>
                        </div>
                    </div>
                    ${context.competitorTimeline ? `
                    <div class="mt-4">
                        <h4 class="font-medium text-red-900 mb-2">競爭對手近期活動時間線</h4>
                        <div class="p-3 bg-white rounded border border-red-200">
                            <div class="text-sm text-gray-700">${context.competitorTimeline.replace(/\n/g, '<br>')}</div>
                        </div>
                    </div>
                    ` : ''}
                `;
                
                competitorContainer.innerHTML += competitorContent;
                
            } catch (error) {
                console.error('生成競爭對手比較視覺化時發生錯誤:', error);
            }
        }

        // 生成市場機會點視覺化
        function generateOpportunityVisualization(context, competitorAnalysis, marketingCalendar) {
            try {
                // 創建機會點容器
                let opportunityContainer = document.getElementById('opportunityVisualization');
                if (!opportunityContainer) {
                    opportunityContainer = document.createElement('div');
                    opportunityContainer.id = 'opportunityVisualization';
                    opportunityContainer.className = 'mt-6 p-4 bg-green-50 rounded-lg';
                    opportunityContainer.innerHTML = '<h3 class="text-lg font-semibold text-green-800 mb-4">🎯 市場機會點分析</h3>';
                    
                    // 插入到報告輸出區域
                    const proposalOutput = document.getElementById('proposalOutput');
                    if (proposalOutput) {
                        proposalOutput.appendChild(opportunityContainer);
                    }
                }
                
                // 生成機會點內容
                const opportunityContent = `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <h4 class="font-medium text-green-900">季節性因素</h4>
                            <div class="p-3 bg-white rounded border border-green-200">
                                <div class="text-sm text-gray-700">${context.seasonalFactors || '未提供'}</div>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <h4 class="font-medium text-green-900">市場趨勢</h4>
                            <div class="p-3 bg-white rounded border border-green-200">
                                <div class="text-sm text-gray-700">${context.marketTrends || '未提供'}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                opportunityContainer.innerHTML += opportunityContent;
                
            } catch (error) {
                console.error('生成市場機會點視覺化時發生錯誤:', error);
            }
        }

        // 生成里程碑視覺化
        function generateMilestoneVisualization(context) {
            try {
                // 創建里程碑容器
                let milestoneContainer = document.getElementById('milestoneVisualization');
                if (!milestoneContainer) {
                    milestoneContainer = document.createElement('div');
                    milestoneContainer.id = 'milestoneVisualization';
                    milestoneContainer.className = 'mt-6 p-4 bg-purple-50 rounded-lg';
                    milestoneContainer.innerHTML = '<h3 class="text-lg font-semibold text-purple-800 mb-4">📌 重要里程碑提醒</h3>';
                    
                    // 插入到報告輸出區域
                    const proposalOutput = document.getElementById('proposalOutput');
                    if (proposalOutput) {
                        proposalOutput.appendChild(milestoneContainer);
                    }
                }
                
                // 生成里程碑內容
                const milestoneContent = `
                    <div class="space-y-3">
                        <div class="p-3 bg-white rounded border border-purple-200">
                            <div class="text-sm text-gray-700">${context.keyMilestones.replace(/\n/g, '<br>')}</div>
                        </div>
                        <div class="text-xs text-purple-600">
                            💡 建議：提前 2-4 週開始準備每個里程碑相關的行銷活動
                        </div>
                    </div>
                `;
                
                milestoneContainer.innerHTML += milestoneContent;
                
            } catch (error) {
                console.error('生成里程碑視覺化時發生錯誤:', error);
            }
        }

        // 生成風險評估視覺化
        function generateRiskVisualization(context, competitorAnalysis, marketingCalendar) {
            try {
                // 創建風險評估容器
                let riskContainer = document.getElementById('riskVisualization');
                if (!riskContainer) {
                    riskContainer = document.createElement('div');
                    riskContainer.id = 'riskVisualization';
                    riskContainer.className = 'mt-6 p-4 bg-orange-50 rounded-lg';
                    riskContainer.innerHTML = '<h3 class="text-lg font-semibold text-orange-800 mb-4">⚠️ 風險評估與管理</h3>';
                    
                    // 插入到報告輸出區域
                    const proposalOutput = document.getElementById('proposalOutput');
                    if (proposalOutput) {
                        proposalOutput.appendChild(riskContainer);
                    }
                }
                
                // 生成風險評估內容
                const riskContent = `
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                            <div class="p-3 bg-white rounded border border-orange-200">
                                <div class="font-medium text-orange-900 mb-2">競爭風險</div>
                                <div class="text-sm text-gray-700">競爭對手活動可能影響市場份額</div>
                            </div>
                            <div class="p-3 bg-white rounded border border-orange-200">
                                <div class="font-medium text-orange-900 mb-2">時程風險</div>
                                <div class="text-sm text-gray-700">重要日期可能與其他活動衝突</div>
                            </div>
                            <div class="p-3 bg-white rounded border border-orange-200">
                                <div class="font-medium text-orange-900 mb-2">預算風險</div>
                                <div class="text-sm text-gray-700">預算可能不足以達成目標</div>
                            </div>
                        </div>
                        <div class="p-3 bg-yellow-50 rounded border border-yellow-200">
                            <div class="text-sm text-yellow-800">
                                <strong>風險管理建議：</strong>建立應急預算、準備備選方案、密切監控競爭對手動態
                            </div>
                        </div>
                    </div>
                `;
                
                riskContainer.innerHTML += riskContent;
                
            } catch (error) {
                console.error('生成風險評估視覺化時發生錯誤:', error);
            }
        }

        // 生成KPI視覺化
        function generateKPIVisualization(context) {
            try {
                // 創建KPI容器
                let kpiContainer = document.getElementById('kpiVisualization');
                if (!kpiContainer) {
                    kpiContainer = document.createElement('div');
                    kpiContainer.id = 'kpiVisualization';
                    kpiContainer.className = 'mt-6 p-4 bg-indigo-50 rounded-lg';
                    kpiContainer.innerHTML = '<h3 class="text-lg font-semibold text-indigo-800 mb-4">📊 關鍵績效指標</h3>';
                    
                    // 插入到報告輸出區域
                    const proposalOutput = document.getElementById('proposalOutput');
                    if (proposalOutput) {
                        proposalOutput.appendChild(kpiContainer);
                    }
                }
                
                // 生成KPI內容
                const kpiContent = `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <h4 class="font-medium text-indigo-900">品牌相關 KPI</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center p-2 bg-white rounded border">
                                    <span class="text-sm text-gray-700">品牌知名度</span>
                                    <span class="text-sm font-medium text-indigo-600">目標: +15%</span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-white rounded border">
                                    <span class="text-sm text-gray-700">品牌好感度</span>
                                    <span class="text-sm font-medium text-indigo-600">目標: +10%</span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-white rounded border">
                                    <span class="text-sm text-gray-700">品牌提及度</span>
                                    <span class="text-sm font-medium text-indigo-600">目標: +20%</span>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <h4 class="font-medium text-indigo-900">轉換相關 KPI</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center p-2 bg-white rounded border">
                                    <span class="text-sm text-gray-700">點擊率 (CTR)</span>
                                    <span class="text-sm font-medium text-indigo-600">目標: 2.5%</span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-white rounded border">
                                    <span class="text-sm text-gray-700">轉換率</span>
                                    <span class="text-sm font-medium text-indigo-600">目標: 3.0%</span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-white rounded border">
                                    <span class="text-sm text-gray-700">投資報酬率 (ROI)</span>
                                    <span class="text-sm font-medium text-indigo-600">目標: 300%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                kpiContainer.innerHTML += kpiContent;
                
            } catch (error) {
                console.error('生成KPI視覺化時發生錯誤:', error);
            }
        }

        // 新增：報告品質優化功能
        function enhanceReportQuality(reportHTML) {
            try {
                // 創建臨時 DOM 元素來處理 HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = reportHTML;
                
                // 1. 添加視覺化圖表
                addVisualCharts(tempDiv);
                
                // 2. 優化表格樣式
                enhanceTableStyles(tempDiv);
                
                // 3. 添加互動元素
                addInteractiveElements(tempDiv);
                
                // 4. 優化文字格式
                enhanceTextFormatting(tempDiv);
                
                // 5. 添加摘要和導航
                addSummaryAndNavigation(tempDiv);
                
                return tempDiv.innerHTML;
            } catch (error) {
                console.error('報告品質優化失敗:', error);
                return reportHTML; // 返回原始內容
            }
        }

        // 添加視覺化圖表
        function addVisualCharts(container) {
            // 尋找適合添加圖表的位置
            const tables = container.querySelectorAll('table');
            tables.forEach((table, index) => {
                if (table.rows.length > 1) {
                    // 為表格添加圖表容器
                    const chartContainer = document.createElement('div');
                    chartContainer.className = 'mt-4 p-4 bg-gray-50 rounded-lg';
                    chartContainer.innerHTML = `
                        <h4 class="text-sm font-medium text-gray-700 mb-2">📊 數據視覺化</h4>
                        <div class="text-xs text-gray-500">圖表將根據表格數據自動生成</div>
                    `;
                    table.parentNode.insertBefore(chartContainer, table.nextSibling);
                }
            });
        }

        // 優化表格樣式
        function enhanceTableStyles(container) {
            const tables = container.querySelectorAll('table');
            tables.forEach(table => {
                table.className = 'w-full border-collapse border border-gray-300 rounded-lg overflow-hidden shadow-sm';
                
                // 為表格添加響應式設計
                const wrapper = document.createElement('div');
                wrapper.className = 'overflow-x-auto';
                table.parentNode.insertBefore(wrapper, table);
                wrapper.appendChild(table);
            });
        }

        // 添加互動元素
        function addInteractiveElements(container) {
            // 為重要數據添加工具提示
            const importantData = container.querySelectorAll('strong');
            importantData.forEach(element => {
                if (element.textContent.includes('NT$') || element.textContent.includes('%')) {
                    element.className = 'text-blue-600 font-semibold cursor-help';
                    element.title = '點擊查看詳細說明';
                }
            });
            
            // 為建議項目添加展開/收合功能
            const recommendations = container.querySelectorAll('h3');
            recommendations.forEach(h3 => {
                if (h3.textContent.includes('建議')) {
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = 'ml-2 text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded hover:bg-blue-200';
                    toggleBtn.textContent = '展開';
                    toggleBtn.onclick = function() {
                        const nextElement = h3.nextElementSibling;
                        if (nextElement && nextElement.style.display === 'none') {
                            nextElement.style.display = 'block';
                            this.textContent = '收合';
                        } else if (nextElement) {
                            nextElement.style.display = 'none';
                            this.textContent = '展開';
                        }
                    };
                    h3.appendChild(toggleBtn);
                }
            });
        }

        // 優化文字格式
        function enhanceTextFormatting(container) {
            // 為重要段落添加背景色
            const paragraphs = container.querySelectorAll('p');
            paragraphs.forEach(p => {
                if (p.textContent.includes('關鍵') || p.textContent.includes('重要') || p.textContent.includes('建議')) {
                    p.className = 'p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded-r';
                }
            });
            
            // 為數字添加特殊樣式
            const textContent = container.innerHTML;
            const enhancedContent = textContent.replace(/(\d{1,3}(,\d{3})*)/g, '<span class="text-green-600 font-semibold">$1</span>');
            container.innerHTML = enhancedContent;
        }

        // 添加摘要和導航
        function addSummaryAndNavigation(container) {
            // 創建目錄
            const headings = container.querySelectorAll('h2');
            if (headings.length > 0) {
                const toc = document.createElement('div');
                toc.className = 'mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200';
                toc.innerHTML = '<h3 class="text-lg font-semibold text-blue-800 mb-3">📋 報告目錄</h3>';
                
                const tocList = document.createElement('ul');
                tocList.className = 'space-y-2';
                
                headings.forEach((heading, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="#section-${index}" class="text-blue-600 hover:text-blue-800 underline">${heading.textContent}</a>`;
                    tocList.appendChild(li);
                    
                    // 為標題添加錨點
                    heading.id = `section-${index}`;
                });
                
                toc.appendChild(tocList);
                container.insertBefore(toc, container.firstChild);
            }
            
            // 添加返回頂部按鈕
            const backToTop = document.createElement('button');
            backToTop.className = 'fixed bottom-4 right-4 bg-blue-600 text-white p-3 rounded-full shadow-lg hover:bg-blue-700 transition-colors';
            backToTop.innerHTML = '↑';
            backToTop.onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });
            container.appendChild(backToTop);
        }

        // 新增：報告內容驗證
        function validateReportContent(reportHTML) {
            const issues = [];
            
            // 檢查是否包含必要的章節
            const requiredSections = ['執行摘要', '市場總體印象', '產業輿情監測', '競爭對手深度分析', '核心洞察與機會點', '預算可行性評估', '初步策略建議'];
            
            requiredSections.forEach(section => {
                if (!reportHTML.includes(section)) {
                    issues.push(`缺少章節：${section}`);
                }
            });
            
            // 檢查是否包含數據表格
            if (!reportHTML.includes('<table')) {
                issues.push('缺少數據表格');
            }
            
            // 檢查是否包含建議項目
            if (!reportHTML.includes('建議')) {
                issues.push('缺少具體建議');
            }
            
            return issues;
        }

        // 新增：報告評分系統
        function scoreReport(reportHTML) {
            let score = 0;
            const maxScore = 100;
            
            // 內容完整性 (30分)
            const requiredElements = ['執行摘要', '市場分析', '競爭分析', '策略建議', '預算規劃'];
            const completeness = requiredElements.filter(element => reportHTML.includes(element)).length;
            score += (completeness / requiredElements.length) * 30;
            
            // 數據豐富度 (25分)
            const dataElements = ['<table', '圖表', '統計', '百分比', '數字'];
            const dataRichness = dataElements.filter(element => reportHTML.includes(element)).length;
            score += (dataRichness / dataElements.length) * 25;
            
            // 建議實用性 (25分)
            const suggestionElements = ['建議', '策略', '方案', '行動', '執行'];
            const suggestionQuality = suggestionElements.filter(element => reportHTML.includes(element)).length;
            score += (suggestionQuality / suggestionElements.length) * 25;
            
            // 視覺呈現 (20分)
            const visualElements = ['<div', 'class', 'style', '背景', '顏色'];
            const visualQuality = visualElements.filter(element => reportHTML.includes(element)).length;
            score += (visualQuality / visualElements.length) * 20;
            
            return Math.round(score);
        }

        // 初始化事件監聽器
        document.addEventListener('DOMContentLoaded', function() {
            // 確保所有元素都已載入
            const generateBtn = document.getElementById('generateBtn');
            if (generateBtn) {
                generateBtn.addEventListener('click', handleGenerateClick);
            }
        });
    </script>
</body>
</html>


