<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªå‹•åŒ–åª’é«”ææ¡ˆå¼•æ“ (å°ç£å¸‚å ´ç‰¹åŒ–ç‰ˆ MVP)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%);
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #818cf8 100%);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(0,0,0,0.1);
        }
        .btn-primary:disabled {
            background: #a5b4fc;
            cursor: not-allowed;
            transform: translateY(0);
            box-shadow: none;
        }
        #proposalOutput h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e3a8a;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #60a5fa;
            padding-bottom: 0.5rem;
        }
        #proposalOutput h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1d4ed8;
            margin-top: 1.25rem;
            margin-bottom: 0.75rem;
        }
        #proposalOutput p, #proposalOutput li, #proposalOutput td, #proposalOutput th {
            color: #374151;
            line-height: 1.7;
        }
        #proposalOutput p, #proposalOutput ul {
             margin-bottom: 1rem;
        }
        #proposalOutput ul {
            list-style-type: disc;
            padding-left: 1.5rem;
        }
        #proposalOutput strong {
            color: #1e40af;
            font-weight: 600;
        }
        .status-update {
            transition: all 0.5s ease;
            overflow: hidden;
            max-height: 0;
            opacity: 0;
        }
        .status-update.active {
            max-height: 100px; /* or a suitable max-height */
            opacity: 1;
            margin-top: 1rem;
        }
        .input-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 1.5rem;
        }
        @media (min-width: 1024px) {
            .input-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        #proposalOutput table {
            width: 100%;
            margin-top: 1rem;
            margin-bottom: 1rem;
            border-collapse: collapse;
        }
        #proposalOutput th, #proposalOutput td {
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            text-align: left;
        }
        #proposalOutput th {
            background-color: #f9fafb;
            font-weight: 600;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-6xl mx-auto">
        <div class="card p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">è‡ªå‹•åŒ–åª’é«”ææ¡ˆå¼•æ“</h1>
                <p class="mt-2 text-gray-600">v2.6 DeepResearch ç‰ˆ (MVP)</p>
            </div>

            <!-- Module 1: ä½¿ç”¨è€…èˆ‡é…ç½®ä»‹é¢ ('é§•é§›è‰™') -->
            <div class="space-y-6">
                 <!-- API é‡‘é‘°è¼¸å…¥ -->
                <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <label for="apiKeyInput" class="block text-sm font-medium text-yellow-800 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 8a6 6 0 11-12 0 6 6 0 0112 0zM7 8a1 1 0 11-2 0 1 1 0 012 0zm5 0a1 1 0 11-2 0 1 1 0 012 0zm5 0a1 1 0 11-2 0 1 1 0 012 0z" clip-rule="evenodd"></path></svg>
                        Google Gemini API é‡‘é‘° <span class="text-red-500 ml-1">*</span>
                    </label>
                    <input type="password" id="apiKeyInput" class="mt-1 block w-full px-3 py-2 border border-yellow-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ API é‡‘é‘°">
                    <p class="mt-2 text-xs text-yellow-700">æ­¤é‡‘é‘°åƒ…å­˜æ–¼æ‚¨ç›®å‰çš„ç€è¦½å™¨åˆ†é ï¼Œé—œé–‰å¾Œå³æ¶ˆå¤±ï¼Œä¸æœƒè¢«å„²å­˜ã€‚</p>
                </div>

                <!-- AI æ¨¡å‹é¸æ“‡ -->
                <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                    <label for="modelSelection" class="block text-sm font-medium text-green-800 flex items-center mb-2">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
                        AI æ¨¡å‹é¸æ“‡
                    </label>
                    <div class="space-y-3">
                        <div class="flex items-center">
                            <input type="radio" id="modelAuto" name="modelSelection" value="auto" class="mr-2" checked>
                            <label for="modelAuto" class="text-sm text-green-700">
                                <span class="font-medium">è‡ªå‹•é¸æ“‡</span> - ç³»çµ±æœƒè‡ªå‹•é¸æ“‡æœ€ä½³å¯ç”¨æ¨¡å‹
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="modelDeepResearch" name="modelSelection" value="deepresearch" class="mr-2">
                            <label for="modelDeepResearch" class="text-sm text-green-700">
                                <span class="font-medium">Gemini 1.5 Pro</span> - æ·±åº¦åˆ†ææ¨¡å‹ï¼Œé©åˆè¤‡é›œç­–ç•¥è¦åŠƒ
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="modelFlash" name="modelSelection" value="flash" class="mr-2">
                            <label for="modelFlash" class="text-sm text-green-700">
                                <span class="font-medium">Gemini 1.5 Flash</span> - å¿«é€Ÿå›æ‡‰ï¼Œé©åˆä¸€èˆ¬åˆ†æ
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="modelPro" name="modelSelection" value="pro" class="mr-2">
                            <label for="modelPro" class="text-sm text-green-700">
                                <span class="font-medium">Gemini 1.5 Pro</span> - æ·±åº¦åˆ†ææ¨¡å‹ï¼Œé©åˆè¤‡é›œç­–ç•¥è¦åŠƒ
                            </label>
                        </div>
                    </div>
                    <p class="mt-2 text-xs text-green-600">
                        <strong>Pro æ¨¡å‹ç‰¹è‰²ï¼š</strong>æ”¯æ´æ›´é•·çš„ä¸Šä¸‹æ–‡ã€æ›´æ·±å…¥çš„æ¨ç†èƒ½åŠ›ã€æ›´å¥½çš„å¤šèªè¨€ç†è§£
                    </p>
                </div>

                <!-- ç³»çµ±ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
                <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <!-- ç¶²è·¯ç‹€æ…‹ -->
                            <div class="flex items-center">
                                <div id="networkStatus" class="w-3 h-3 rounded-full bg-green-500 mr-2"></div>
                                <span id="networkText" class="text-sm text-blue-800">ç¶²è·¯é€£æ¥æ­£å¸¸</span>
                            </div>
                            <!-- API ç‹€æ…‹ -->
                            <div class="flex items-center">
                                <div id="apiStatus" class="w-3 h-3 rounded-full bg-gray-400 mr-2"></div>
                                <span id="apiText" class="text-sm text-blue-800">API æœªæ¸¬è©¦</span>
                            </div>
                            <!-- ç•¶å‰æ¨¡å‹ -->
                            <div class="flex items-center">
                                <div id="modelStatus" class="w-3 h-3 rounded-full bg-purple-500 mr-2"></div>
                                <span id="modelText" class="text-sm text-blue-800">æ¨¡å‹æœªé¸æ“‡</span>
                            </div>
                        </div>
                        <!-- ç³»çµ±ç‰ˆæœ¬ -->
                        <div class="text-xs text-blue-600">
                            ç³»çµ±ç‰ˆæœ¬: v2.6 | æœ€å¾Œæ›´æ–°: 2024-12-19
                        </div>
                    </div>
                </div>
                
                <div class="border-t border-gray-200 pt-6">
                    <div class="input-grid">
                        <div>
                            <label for="targetBrand" class="block text-sm font-medium text-gray-700">ç›®æ¨™å“ç‰Œ / ç”¢å“ <span class="text-red-500">*</span></label>
                            <input type="text" id="targetBrand" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="ä¾‹å¦‚ï¼šgogoro, æ˜Ÿå®‡èˆªç©º">
                        </div>
                        <div>
                            <label for="competitorBrand" class="block text-sm font-medium text-gray-700">ä¸»è¦ç«¶çˆ­å°æ‰‹ <span class="text-red-500">*</span></label>
                            <input type="text" id="competitorBrand" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="ä¾‹å¦‚ï¼šå…‰é™½, é•·æ¦®èˆªç©º">
                        </div>
                         <div>
                            <label for="industry" class="block text-sm font-medium text-gray-700 mb-2">ç”¢æ¥­é¡åˆ¥ <span class="text-red-500">*</span></label>
                            <select id="industry" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">è«‹é¸æ“‡ç”¢æ¥­é¡åˆ¥</option>
                                <optgroup label="ç§‘æŠ€ç”¢æ¥­">
                                    <option value="è»Ÿé«”é–‹ç™¼">è»Ÿé«”é–‹ç™¼</option>
                                    <option value="é›»å­å•†å‹™">é›»å­å•†å‹™</option>
                                    <option value="äººå·¥æ™ºæ…§">äººå·¥æ™ºæ…§</option>
                                    <option value="ç‰©è¯ç¶²">ç‰©è¯ç¶²</option>
                                    <option value="å€å¡Šéˆ">å€å¡Šéˆ</option>
                                    <option value="é›²ç«¯æœå‹™">é›²ç«¯æœå‹™</option>
                                    <option value="æ•¸ä½è¡ŒéŠ·">æ•¸ä½è¡ŒéŠ·</option>
                                    <option value="éŠæˆ²ç”¢æ¥­">éŠæˆ²ç”¢æ¥­</option>
                                    <option value="ç¡¬é«”è£½é€ ">ç¡¬é«”è£½é€ </option>
                                    <option value="ç¶²è·¯æœå‹™">ç¶²è·¯æœå‹™</option>
                                </optgroup>
                                <optgroup label="æ¶ˆè²»å“ç”¢æ¥­">
                                    <option value="ç¾å¦ä¿é¤Š">ç¾å¦ä¿é¤Š</option>
                                    <option value="æœé£¾æ™‚å°š">æœé£¾æ™‚å°š</option>
                                    <option value="é£Ÿå“é£²æ–™">é£Ÿå“é£²æ–™</option>
                                    <option value="å®¶å±…ç”¨å“">å®¶å±…ç”¨å“</option>
                                    <option value="é‹å‹•ç”¨å“">é‹å‹•ç”¨å“</option>
                                    <option value="æ¯å¬°ç”¨å“">æ¯å¬°ç”¨å“</option>
                                    <option value="å¯µç‰©ç”¨å“">å¯µç‰©ç”¨å“</option>
                                    <option value="å€‹äººè­·ç†">å€‹äººè­·ç†</option>
                                </optgroup>
                                <optgroup label="é‡‘èæœå‹™">
                                    <option value="éŠ€è¡Œæ¥­">éŠ€è¡Œæ¥­</option>
                                    <option value="ä¿éšªæ¥­">ä¿éšªæ¥­</option>
                                    <option value="æŠ•è³‡ç†è²¡">æŠ•è³‡ç†è²¡</option>
                                    <option value="æ”¯ä»˜æœå‹™">æ”¯ä»˜æœå‹™</option>
                                    <option value="FinTech">FinTech</option>
                                    <option value="æˆ¿åœ°ç”¢">æˆ¿åœ°ç”¢</option>
                                </optgroup>
                                <optgroup label="æ•™è‚²èˆ‡åŸ¹è¨“">
                                    <option value="ç·šä¸Šæ•™è‚²">ç·šä¸Šæ•™è‚²</option>
                                    <option value="èªè¨€å­¸ç¿’">èªè¨€å­¸ç¿’</option>
                                    <option value="è·æ¥­åŸ¹è¨“">è·æ¥­åŸ¹è¨“</option>
                                    <option value="å…’ç«¥æ•™è‚²">å…’ç«¥æ•™è‚²</option>
                                    <option value="é«˜ç­‰æ•™è‚²">é«˜ç­‰æ•™è‚²</option>
                                    <option value="æŠ€èƒ½åŸ¹è¨“">æŠ€èƒ½åŸ¹è¨“</option>
                                </optgroup>
                                <optgroup label="å¥åº·é†«ç™‚">
                                    <option value="é†«ç™‚æœå‹™">é†«ç™‚æœå‹™</option>
                                    <option value="å¥åº·ç®¡ç†">å¥åº·ç®¡ç†</option>
                                    <option value="å¥èº«é‹å‹•">å¥èº«é‹å‹•</option>
                                    <option value="ç‡Ÿé¤Šä¿å¥">ç‡Ÿé¤Šä¿å¥</option>
                                    <option value="å¿ƒç†å¥åº·">å¿ƒç†å¥åº·</option>
                                    <option value="é†«ç¾æ•´å½¢">é†«ç¾æ•´å½¢</option>
                                </optgroup>
                                <optgroup label="äº¤é€šé‹è¼¸">
                                    <option value="å…±äº«äº¤é€š">å…±äº«äº¤é€š</option>
                                    <option value="ç‰©æµé…é€">ç‰©æµé…é€</option>
                                    <option value="æ—…éŠæœå‹™">æ—…éŠæœå‹™</option>
                                    <option value="èˆªç©ºé‹è¼¸">èˆªç©ºé‹è¼¸</option>
                                    <option value="æ±½è»Šç”¢æ¥­">æ±½è»Šç”¢æ¥­</option>
                                    <option value="å¤§çœ¾é‹è¼¸">å¤§çœ¾é‹è¼¸</option>
                                </optgroup>
                                <optgroup label="å¨›æ¨‚åª’é«”">
                                    <option value="å½±è¦–è£½ä½œ">å½±è¦–è£½ä½œ</option>
                                    <option value="éŸ³æ¨‚ç”¢æ¥­">éŸ³æ¨‚ç”¢æ¥­</option>
                                    <option value="å‡ºç‰ˆæ¥­">å‡ºç‰ˆæ¥­</option>
                                    <option value="ç›´æ’­å¹³å°">ç›´æ’­å¹³å°</option>
                                    <option value="çŸ­å½±ç‰‡">çŸ­å½±ç‰‡</option>
                                    <option value="Podcast">Podcast</option>
                                </optgroup>
                                <optgroup label="å…¶ä»–ç”¢æ¥­">
                                    <option value="æ”¿åºœæ©Ÿé—œ">æ”¿åºœæ©Ÿé—œ</option>
                                    <option value="éç‡Ÿåˆ©çµ„ç¹”">éç‡Ÿåˆ©çµ„ç¹”</option>
                                    <option value="è£½é€ æ¥­">è£½é€ æ¥­</option>
                                    <option value="èƒ½æºç”¢æ¥­">èƒ½æºç”¢æ¥­</option>
                                    <option value="ç’°ä¿ç”¢æ¥­">ç’°ä¿ç”¢æ¥­</option>
                                    <option value="è¾²æ¥­ç§‘æŠ€">è¾²æ¥­ç§‘æŠ€</option>
                                </optgroup>
                            </select>
                        </div>
                        <div>
                            <label for="industryStatus" class="block text-sm font-medium text-gray-700 mb-2">ç”¢æ¥­ç‹€æ…‹ <span class="text-red-500">*</span></label>
                            <select id="industryStatus" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">è«‹é¸æ“‡ç”¢æ¥­ç‹€æ…‹</option>
                                <option value="æ–°å‰µæœŸ">æ–°å‰µæœŸ - å¸‚å ´å‰›èµ·æ­¥ï¼Œç«¶çˆ­è¼ƒå°‘</option>
                                <option value="æˆé•·æœŸ">æˆé•·æœŸ - å¸‚å ´å¿«é€Ÿæ“´å¼µï¼Œç«¶çˆ­åŠ åŠ‡</option>
                                <option value="æˆç†ŸæœŸ">æˆç†ŸæœŸ - å¸‚å ´ç©©å®šï¼Œç«¶çˆ­æ¿€çƒˆ</option>
                                <option value="è¡°é€€æœŸ">è¡°é€€æœŸ - å¸‚å ´èç¸®ï¼Œéœ€è¦è½‰å‹</option>
                                <option value="è½‰å‹æœŸ">è½‰å‹æœŸ - ç”¢æ¥­çµæ§‹èª¿æ•´ï¼Œæ–°æ©Ÿæœƒå‡ºç¾</option>
                                <option value="å¾©ç”¦æœŸ">å¾©ç”¦æœŸ - å¸‚å ´é‡æ–°æ´»çµ¡</option>
                                <option value="å‰µæ–°æœŸ">å‰µæ–°æœŸ - æŠ€è¡“çªç ´å¸¶ä¾†æ–°æ©Ÿæœƒ</option>
                                <option value="æ•´åˆæœŸ">æ•´åˆæœŸ - ç”¢æ¥­ä½µè³¼æ•´åˆéšæ®µ</option>
                            </select>
                        </div>
                         <div>
                            <label for="businessModel" class="block text-sm font-medium text-gray-700">å•†æ¥­æ¨¡å¼ <span class="text-red-500">*</span></label>
                             <select id="businessModel" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="B2C">B2C (ä¼æ¥­å°æ¶ˆè²»è€…)</option>
                                <option value="B2B">B2B (ä¼æ¥­å°ä¼æ¥­)</option>
                            </select>
                        </div>
                         <div>
                            <label for="salesChannels" class="block text-sm font-medium text-gray-700">ä¸»è¦éŠ·å”®é€šè·¯</label>
                            <input type="text" id="salesChannels" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="ä¾‹å¦‚ï¼šç·šä¸Šå®˜ç¶²ã€MOMOã€å¯¦é«”é–€å¸‚">
                        </div>
                        <div>
                            <label for="targetAudience" class="block text-sm font-medium text-gray-700">ç›®æ¨™äººç¾¤æè¿°</label>
                            <input type="text" id="targetAudience" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="ä¾‹å¦‚ï¼š25-35æ­²éƒ½æœƒå¥³æ€§ã€ç§‘æŠ€æ¥­æ¡è³¼ä¸»ç®¡">
                        </div>
                        <div class="md:col-span-2">
                            <label for="marketingProblems" class="block text-sm font-medium text-gray-700">å“ç‰Œè¡ŒéŠ·å•é¡Œæè¿° <span class="text-blue-500">ğŸ’¡</span></label>
                            <textarea id="marketingProblems" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="è«‹æè¿°æ‚¨ç›®å‰é‡åˆ°çš„è¡ŒéŠ·å•é¡Œæˆ–æŒ‘æˆ°ï¼Œä¾‹å¦‚ï¼š&#10;â€¢ å“ç‰ŒçŸ¥ååº¦ä¸è¶³ï¼Œæ¶ˆè²»è€…å°æˆ‘å€‘ä¸ç†Ÿæ‚‰&#10;â€¢ ç«¶çˆ­å°æ‰‹å»£å‘ŠæŠ•æ”¾é‡å¤§ï¼Œæˆ‘å€‘é›£ä»¥çªåœ&#10;â€¢ ç›®æ¨™äººç¾¤å°æˆ‘å€‘çš„ç”¢å“åƒ¹å€¼èªçŸ¥ä¸æ¸…&#10;â€¢ è½‰æ›ç‡åä½ï¼Œå»£å‘Šé»æ“Šå¤šä½†è³¼è²·å°‘&#10;â€¢ é ç®—æœ‰é™ï¼Œä¸çŸ¥é“å¦‚ä½•æœ€å¤§åŒ–æ•ˆç›Š"></textarea>
                            <p class="mt-1 text-xs text-gray-500">è©³ç´°æè¿°å•é¡Œå°‡å¹«åŠ© AI æä¾›æ›´ç²¾æº–çš„ç­–ç•¥å»ºè­°</p>
                        </div>
                         <div class="md:col-span-3">
                            <label for="advertisingBudget" class="block text-sm font-medium text-gray-700">é è¨ˆå»£å‘Šé ç®— (å°å¹£)</label>
                            <input type="number" id="advertisingBudget" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="ä¾‹å¦‚ï¼š300000">
                        </div>
                        <div>
                            <label for="adObjective" class="block text-sm font-medium text-gray-700">å»£å‘Šç›®æ¨™èˆ‡ç›®çš„ <span class="text-red-500">*</span></label>
                            <select id="adObjective" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="å“ç‰ŒçŸ¥ååº¦">å“ç‰ŒçŸ¥ååº¦</option>
                                <option value="éŠ·å”®æå‡">éŠ·å”®æå‡</option>
                                <option value="æœƒå“¡æ‹›å‹Ÿ">æœƒå“¡æ‹›å‹Ÿ</option>
                                <option value="æ´»å‹•æ¨å»£">æ´»å‹•æ¨å»£</option>
                                <option value="APPä¸‹è¼‰">APPä¸‹è¼‰</option>
                                <option value="å…¶ä»–">å…¶ä»–</option>
                            </select>
                        </div>
                        <div>
                            <label for="adFormat" class="block text-sm font-medium text-gray-700 mb-2">å»£å‘Šå½¢å¼</label>
                            <div class="space-y-3">
                                <div class="flex items-center">
                                    <input type="checkbox" id="aiRecommendMedia" class="mr-2">
                                    <label for="aiRecommendMedia" class="text-sm text-gray-700">è«‹ AI å»ºè­°æœ€é©åˆçš„åª’é«”çµ„åˆ</label>
                                </div>
                                <div id="mediaSelection" class="space-y-2">
                                    <div class="grid grid-cols-2 gap-3">
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="æ•¸ä½å»£å‘Š" class="mr-2">
                                            <span class="text-sm">æ•¸ä½å»£å‘Š</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="ç¤¾ç¾¤åª’é«”å»£å‘Š" class="mr-2">
                                            <span class="text-sm">ç¤¾ç¾¤åª’é«”å»£å‘Š</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="æœå°‹å¼•æ“å»£å‘Š" class="mr-2">
                                            <span class="text-sm">æœå°‹å¼•æ“å»£å‘Š</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="å½±éŸ³å»£å‘Š" class="mr-2">
                                            <span class="text-sm">å½±éŸ³å»£å‘Š</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="å±•ç¤ºå»£å‘Š" class="mr-2">
                                            <span class="text-sm">å±•ç¤ºå»£å‘Š</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="åŸç”Ÿå»£å‘Š" class="mr-2">
                                            <span class="text-sm">åŸç”Ÿå»£å‘Š</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="å½±éŸ¿è€…è¡ŒéŠ·" class="mr-2">
                                            <span class="text-sm">å½±éŸ¿è€…è¡ŒéŠ·</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="å…§å®¹è¡ŒéŠ·" class="mr-2">
                                            <span class="text-sm">å…§å®¹è¡ŒéŠ·</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="æ•´åˆè¡ŒéŠ·" class="mr-2">
                                            <span class="text-sm">æ•´åˆè¡ŒéŠ·</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="æˆ¶å¤–å»£å‘Š" class="mr-2">
                                            <span class="text-sm">æˆ¶å¤–å»£å‘Š</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="é›»è¦–å»£å‘Š" class="mr-2">
                                            <span class="text-sm">é›»è¦–å»£å‘Š</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="å»£æ’­å»£å‘Š" class="mr-2">
                                            <span class="text-sm">å»£æ’­å»£å‘Š</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="é›œèªŒå»£å‘Š" class="mr-2">
                                            <span class="text-sm">é›œèªŒå»£å‘Š</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="å ±ç´™å»£å‘Š" class="mr-2">
                                            <span class="text-sm">å ±ç´™å»£å‘Š</span>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input type="checkbox" name="media" value="æ´»å‹•è¡ŒéŠ·" class="mr-2">
                                            <span class="text-sm">æ´»å‹•è¡ŒéŠ·</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="competitors" class="block text-sm font-medium text-gray-700 mb-2">ä¸»è¦ç«¶çˆ­å°æ‰‹</label>
                    <textarea id="competitors" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è«‹åˆ—å‡ºä¸»è¦ç«¶çˆ­å°æ‰‹çš„å“ç‰Œåç¨±èˆ‡ç”¢å“åç¨±ï¼Œä¾‹å¦‚ï¼š&#10;Apple iPhone 15&#10;Samsung Galaxy S24&#10;Google Pixel 8"></textarea>
                </div>

                <div class="mb-4">
                    <label for="marketingPeriod" class="block text-sm font-medium text-gray-700 mb-2">è¡ŒéŠ·æ´»å‹•æœŸé–“</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="startDate" class="block text-xs text-gray-600 mb-1">é–‹å§‹æ—¥æœŸ</label>
                            <input type="date" id="startDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="endDate" class="block text-xs text-gray-600 mb-1">çµæŸæ—¥æœŸ</label>
                            <input type="date" id="endDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="targetMarkets" class="block text-sm font-medium text-gray-700 mb-2">ç›®æ¨™å¸‚å ´</label>
                    <select id="targetMarkets" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="å°ç£">å°ç£</option>
                        <option value="å°ç£,é¦™æ¸¯">å°ç£ + é¦™æ¸¯</option>
                        <option value="å°ç£,æ–°åŠ å¡">å°ç£ + æ–°åŠ å¡</option>
                        <option value="å°ç£,é¦¬ä¾†è¥¿äº">å°ç£ + é¦¬ä¾†è¥¿äº</option>
                        <option value="å°ç£,æ³°åœ‹">å°ç£ + æ³°åœ‹</option>
                        <option value="å°ç£,è¶Šå—">å°ç£ + è¶Šå—</option>
                        <option value="å°ç£,è²å¾‹è³“">å°ç£ + è²å¾‹è³“</option>
                        <option value="å°ç£,å°å°¼">å°ç£ + å°å°¼</option>
                        <option value="å°ç£,æ—¥æœ¬">å°ç£ + æ—¥æœ¬</option>
                        <option value="å°ç£,éŸ“åœ‹">å°ç£ + éŸ“åœ‹</option>
                        <option value="å°ç£,ä¸­åœ‹">å°ç£ + ä¸­åœ‹</option>
                        <option value="å°ç£,ç¾åœ‹">å°ç£ + ç¾åœ‹</option>
                        <option value="å°ç£,åŠ æ‹¿å¤§">å°ç£ + åŠ æ‹¿å¤§</option>
                        <option value="å°ç£,æ¾³æ´²">å°ç£ + æ¾³æ´²</option>
                        <option value="å°ç£,è‹±åœ‹">å°ç£ + è‹±åœ‹</option>
                        <option value="å°ç£,å¾·åœ‹">å°ç£ + å¾·åœ‹</option>
                        <option value="å°ç£,æ³•åœ‹">å°ç£ + æ³•åœ‹</option>
                        <option value="å…¨çƒ">å…¨çƒç­–ç•¥</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label for="targetLanguages" class="block text-sm font-medium text-gray-700 mb-2">ç›®æ¨™èªè¨€</label>
                    <select id="targetLanguages" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="ç¹é«”ä¸­æ–‡">ç¹é«”ä¸­æ–‡</option>
                        <option value="ç¹é«”ä¸­æ–‡,ç°¡é«”ä¸­æ–‡">ç¹é«”ä¸­æ–‡ + ç°¡é«”ä¸­æ–‡</option>
                        <option value="ç¹é«”ä¸­æ–‡,è‹±æ–‡">ç¹é«”ä¸­æ–‡ + è‹±æ–‡</option>
                        <option value="ç¹é«”ä¸­æ–‡,æ—¥æ–‡">ç¹é«”ä¸­æ–‡ + æ—¥æ–‡</option>
                        <option value="ç¹é«”ä¸­æ–‡,éŸ“æ–‡">ç¹é«”ä¸­æ–‡ + éŸ“æ–‡</option>
                        <option value="ç¹é«”ä¸­æ–‡,æ³°æ–‡">ç¹é«”ä¸­æ–‡ + æ³°æ–‡</option>
                        <option value="ç¹é«”ä¸­æ–‡,è¶Šå—æ–‡">ç¹é«”ä¸­æ–‡ + è¶Šå—æ–‡</option>
                        <option value="ç¹é«”ä¸­æ–‡,å°å°¼æ–‡">ç¹é«”ä¸­æ–‡ + å°å°¼æ–‡</option>
                        <option value="ç¹é«”ä¸­æ–‡,é¦¬ä¾†æ–‡">ç¹é«”ä¸­æ–‡ + é¦¬ä¾†æ–‡</option>
                        <option value="ç¹é«”ä¸­æ–‡,è²å¾‹è³“æ–‡">ç¹é«”ä¸­æ–‡ + è²å¾‹è³“æ–‡</option>
                        <option value="ç¹é«”ä¸­æ–‡,å¾·æ–‡">ç¹é«”ä¸­æ–‡ + å¾·æ–‡</option>
                        <option value="ç¹é«”ä¸­æ–‡,æ³•æ–‡">ç¹é«”ä¸­æ–‡ + æ³•æ–‡</option>
                        <option value="ç¹é«”ä¸­æ–‡,è¥¿ç­ç‰™æ–‡">ç¹é«”ä¸­æ–‡ + è¥¿ç­ç‰™æ–‡</option>
                        <option value="å¤šèªè¨€">å¤šèªè¨€ç­–ç•¥</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">è¼¸å‡ºæ ¼å¼</label>
                    <div class="flex space-x-4">
                        <label class="flex items-center">
                            <input type="radio" name="outputFormat" value="html" checked class="mr-2">
                            <span class="text-sm">ç¶²é å ±å‘Š</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="outputFormat" value="slides" class="mr-2">
                            <span class="text-sm">Google Slides</span>
                        </label>
                    </div>
                </div>

                <button id="generateBtn" class="btn-primary px-8 py-3 rounded-lg text-lg font-semibold w-full">
                    ç”Ÿæˆ AI åˆ†æå ±å‘Š
                </button>
            </div>

            <!-- å‹•æ…‹ç‹€æ…‹æ›´æ–°å€åŸŸ -->

            <!-- Module 4: è¼¸å‡ºèˆ‡äº¤ä»˜æ¨¡çµ„ ('æ¸²æŸ“å±¤') -->
            <div id="proposalOutput" class="mt-8 p-6 bg-white rounded-lg shadow-lg">
                <div class="text-center text-gray-500">
                    <svg class="mx-auto h-12 w-12 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <p>AI åˆ†æå ±å‘Šå°‡åœ¨æ­¤è™•é¡¯ç¤º</p>
                </div>
            </div>

            <div id="slidesOutput" class="mt-8 p-6 bg-white rounded-lg shadow-lg hidden">
                <div class="text-center text-gray-500">
                    <svg class="mx-auto h-12 w-12 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zM21 5a2 2 0 00-2-2h-4a2 2 0 00-2 2v12a4 4 0 004 4h4a2 2 0 002-2V5z"></path>
                    </svg>
                    <p>Google Slides å°‡åœ¨æ­¤è™•é¡¯ç¤º</p>
                </div>
            </div>

            <div id="slidesActions" class="mt-4 flex space-x-4 hidden">
                <button id="downloadSlidesBtn" class="btn-secondary px-6 py-2 rounded-lg flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                    ä¸‹è¼‰ç°¡å ± (å¤šæ ¼å¼)
                </button>
                <button id="openSlidesBtn" class="btn-primary px-6 py-2 rounded-lg flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                    </svg>
                    åœ¨ Google Slides ä¸­é–‹å•Ÿ
                </button>
            </div>
            
            <!-- Positioning åœ–è¡¨å€åŸŸ -->
            <div id="positioningChartContainer" class="mt-8 border-t-2 border-gray-200 pt-6" style="display: none;">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">å“ç‰Œå®šä½åˆ†æåœ–è¡¨</h2>
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <canvas id="positioningChart" width="400" height="400"></canvas>
                </div>
            </div>
        </div>
        <footer class="text-center mt-4 text-sm text-gray-500">
            <p>æœ¬åŸå‹ç”± Google Gemini é©…å‹•ï¼Œæ‰€æœ‰åˆ†æçš†ç‚ºå³æ™‚ç”Ÿæˆã€‚</p>
        </footer>
    </div>

    <script type="module">
        // --- Module 1: ä»‹é¢æ§åˆ¶èˆ‡è³‡æ–™æ”¶é›† ('æ§åˆ¶å±¤') ---
        const apiKeyInput = document.getElementById('apiKeyInput');
        const targetBrandInput = document.getElementById('targetBrand');
        const competitorBrandInput = document.getElementById('competitorBrand');
        const industryInput = document.getElementById('industry');
        const industryStatusInput = document.getElementById('industryStatus');
        const businessModelInput = document.getElementById('businessModel');
        const salesChannelsInput = document.getElementById('salesChannels');
        const targetAudienceInput = document.getElementById('targetAudience');
        const advertisingBudgetInput = document.getElementById('advertisingBudget');
        const proposalOutput = document.getElementById('proposalOutput');
        const adObjectiveInput = document.getElementById('adObjective');
        const aiRecommendMediaInput = document.getElementById('aiRecommendMedia');
        const mediaSelectionDiv = document.getElementById('mediaSelection');
        const competitorsInput = document.getElementById('competitors');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const targetMarketsInput = document.getElementById('targetMarkets');
        const targetLanguagesInput = document.getElementById('targetLanguages');
        const outputFormatInputs = document.querySelectorAll('input[name="outputFormat"]');
        const slidesOutput = document.getElementById('slidesOutput');
        const slidesActions = document.getElementById('slidesActions');
        const downloadSlidesBtn = document.getElementById('downloadSlidesBtn');
        const openSlidesBtn = document.getElementById('openSlidesBtn');
        const generateBtn = document.getElementById('generateBtn');

        // æ–°å¢é€²åº¦è¿½è¹¤è®Šæ•¸
        let currentStep = 0;
        let totalSteps = 10;
        let apiTestResult = null;

        // æ–°å¢é€²åº¦æ¢å…ƒç´ 
        const progressContainer = document.createElement('div');
        progressContainer.id = 'progressContainer';
        progressContainer.className = 'mt-4 p-4 bg-blue-50 rounded-lg hidden';
        progressContainer.innerHTML = `
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-blue-800">AI åˆ†æé€²åº¦</span>
                <span id="progressText" class="text-sm text-blue-600">0 / ${totalSteps}</span>
            </div>
            <div class="w-full bg-blue-200 rounded-full h-2">
                <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <div id="currentStepText" class="mt-2 text-sm text-blue-700"></div>
            <div id="apiStatus" class="mt-2 text-sm"></div>
        `;
        
        // å°‡é€²åº¦å®¹å™¨æ·»åŠ åˆ°ç”ŸæˆæŒ‰éˆ•ä¹‹å¾Œ
        if (generateBtn && generateBtn.parentNode) {
            generateBtn.parentNode.insertBefore(progressContainer, generateBtn.nextSibling);
        }

        // æ–°å¢APIæ¸¬è©¦åŠŸèƒ½
        async function testAPI(apiKey) {
            const testPrompt = "è«‹å›è¦† 'API é€£æ¥æˆåŠŸ' ä¾†ç¢ºèªé€£æ¥ç‹€æ…‹ã€‚";
            try {
                console.log('é–‹å§‹ API æ¸¬è©¦...');
                const response = await callGeminiAPI(testPrompt, apiKey, false);
                console.log('API æ¸¬è©¦å›æ‡‰:', response);
                return response.includes('API é€£æ¥æˆåŠŸ') || response.includes('æˆåŠŸ') || response.includes('é€£æ¥');
            } catch (error) {
                console.error('API æ¸¬è©¦å¤±æ•—:', error);
                return false;
            }
        }

        // æ›´æ–°é€²åº¦æ¢
        function updateProgress(step, stepText) {
            currentStep = step;
            const progressPercentage = (currentStep / totalSteps) * 100;
            
            document.getElementById('progressBar').style.width = `${progressPercentage}%`;
            document.getElementById('progressText').textContent = `${currentStep} / ${totalSteps}`;
            document.getElementById('currentStepText').textContent = stepText;
            
            // é¡¯ç¤ºé€²åº¦å®¹å™¨
            document.getElementById('progressContainer').classList.remove('hidden');
        }

        // æ›´æ–°APIç‹€æ…‹
        function updateAPIStatus(status, message) {
            const apiStatusElement = document.getElementById('apiStatus');
            const apiTextElement = document.getElementById('apiText');
            
            if (apiStatusElement && apiTextElement) {
                // æ›´æ–°ç‹€æ…‹æŒ‡ç¤ºå™¨é¡è‰²
                apiStatusElement.className = 'w-3 h-3 rounded-full mr-2';
                if (status === 'success') {
                    apiStatusElement.classList.add('bg-green-500');
                    apiTextElement.textContent = message;
                    apiTextElement.className = 'text-sm text-green-800';
                } else if (status === 'error') {
                    apiStatusElement.classList.add('bg-red-500');
                    apiTextElement.textContent = message;
                    apiTextElement.className = 'text-sm text-red-800';
                } else if (status === 'warning') {
                    apiStatusElement.classList.add('bg-yellow-500');
                    apiTextElement.textContent = message;
                    apiTextElement.className = 'text-sm text-yellow-800';
                } else {
                    apiStatusElement.classList.add('bg-gray-400');
                    apiTextElement.textContent = message;
                    apiTextElement.className = 'text-sm text-gray-800';
                }
            }
        }

        // æ›´æ–°ç¶²è·¯ç‹€æ…‹
        function updateNetworkStatus() {
            const networkStatusElement = document.getElementById('networkStatus');
            const networkTextElement = document.getElementById('networkText');
            
            if (networkStatusElement && networkTextElement) {
                if (navigator.onLine) {
                    networkStatusElement.className = 'w-3 h-3 rounded-full bg-green-500 mr-2';
                    networkTextElement.textContent = 'ç¶²è·¯é€£æ¥æ­£å¸¸';
                    networkTextElement.className = 'text-sm text-green-800';
                } else {
                    networkStatusElement.className = 'w-3 h-3 rounded-full bg-red-500 mr-2';
                    networkTextElement.textContent = 'ç¶²è·¯é€£æ¥å·²æ–·é–‹';
                    networkTextElement.className = 'text-sm text-red-800';
                }
            }
        }

        // æ›´æ–°æ¨¡å‹ç‹€æ…‹
        function updateModelStatus(modelName = null) {
            const modelStatusElement = document.getElementById('modelStatus');
            const modelTextElement = document.getElementById('modelText');
            
            if (modelStatusElement && modelTextElement) {
                if (modelName) {
                    modelStatusElement.className = 'w-3 h-3 rounded-full bg-green-500 mr-2';
                    modelTextElement.textContent = `ä½¿ç”¨: ${modelName}`;
                    modelTextElement.className = 'text-sm text-green-800';
                } else {
                    const selectedModel = document.querySelector('input[name="modelSelection"]:checked');
                    if (selectedModel) {
                        let modelDisplayName = '';
                        switch(selectedModel.value) {
                            case 'deepresearch':
                                modelDisplayName = 'Gemini 1.5 Pro';
                                break;
                            case 'flash':
                                modelDisplayName = 'Gemini 1.5 Flash';
                                break;
                            case 'pro':
                                modelDisplayName = 'Gemini 1.5 Pro';
                                break;
                            case 'auto':
                                modelDisplayName = 'è‡ªå‹•é¸æ“‡';
                                break;
                            default:
                                modelDisplayName = 'æœªé¸æ“‡';
                        }
                        modelStatusElement.className = 'w-3 h-3 rounded-full bg-purple-500 mr-2';
                        modelTextElement.textContent = `å·²é¸æ“‡: ${modelDisplayName}`;
                        modelTextElement.className = 'text-sm text-purple-800';
                    } else {
                        modelStatusElement.className = 'w-3 h-3 rounded-full bg-gray-400 mr-2';
                        modelTextElement.textContent = 'æ¨¡å‹æœªé¸æ“‡';
                        modelTextElement.className = 'text-sm text-gray-800';
                    }
                }
            }
        }

        // åˆå§‹åŒ–ç¶²è·¯ç‹€æ…‹ç›£è½å™¨
        function initializeNetworkMonitoring() {
            // åˆå§‹ç‹€æ…‹
            updateNetworkStatus();
            updateModelStatus();
            
            // ç›£è½ç¶²è·¯ç‹€æ…‹è®ŠåŒ–
            window.addEventListener('online', function() {
                console.log('ç¶²è·¯é€£æ¥å·²æ¢å¾©');
                updateNetworkStatus();
                updateAPIStatus('warning', 'ç¶²è·¯å·²æ¢å¾©ï¼Œè«‹é‡æ–°æ¸¬è©¦ API');
            });
            
            window.addEventListener('offline', function() {
                console.log('ç¶²è·¯é€£æ¥å·²æ–·é–‹');
                updateNetworkStatus();
                updateAPIStatus('error', 'ç¶²è·¯é€£æ¥å·²æ–·é–‹');
            });
            
            // ç›£è½æ¨¡å‹é¸æ“‡è®ŠåŒ–
            document.querySelectorAll('input[name="modelSelection"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    updateModelStatus();
                    console.log('æ¨¡å‹é¸æ“‡å·²æ›´æ”¹:', this.value);
                });
            });
        }

        // --- Module 2: AI ä»»å‹™å”èª¿èˆ‡åŸ·è¡Œæ ¸å¿ƒ ('èåˆä¸­æ¨') ---
        async function callGeminiAPI(prompt, apiKey, expectJSON = false) {
            // æª¢æŸ¥ç¶²è·¯é€£æ¥
            if (!navigator.onLine) {
                throw new Error('ç¶²è·¯é€£æ¥å·²æ–·é–‹ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ç‹€æ…‹');
            }

            // æª¢æŸ¥ API é‡‘é‘°
            if (!apiKey || apiKey.trim() === '') {
                throw new Error('API é‡‘é‘°ä¸èƒ½ç‚ºç©º');
            }

            // ç²å–ç”¨æˆ¶é¸æ“‡çš„æ¨¡å‹
            const selectedModelElement = document.querySelector('input[name="modelSelection"]:checked');
            if (!selectedModelElement) {
                throw new Error('è«‹é¸æ“‡ä¸€å€‹ AI æ¨¡å‹');
            }
            const selectedModel = selectedModelElement.value;
            
            // æ ¹æ“šç”¨æˆ¶é¸æ“‡æ±ºå®šæ¨¡å‹åˆ—è¡¨
            let models = [];
            if (selectedModel === 'deepresearch') {
                models = ['gemini-1.5-pro'];  // ä½¿ç”¨ 1.5 Pro ä½œç‚ºæ·±åº¦ç ”ç©¶æ›¿ä»£
            } else if (selectedModel === 'flash') {
                models = ['gemini-1.5-flash'];
            } else if (selectedModel === 'pro') {
                models = ['gemini-1.5-pro'];
            } else {
                // è‡ªå‹•é¸æ“‡æ¨¡å¼ - æŒ‰å„ªå…ˆé †åºå˜—è©¦
                models = [
                    'gemini-1.5-flash',             // å¿«é€Ÿå›æ‡‰ï¼Œæœ€ç©©å®š
                    'gemini-1.5-pro',               // å¹³è¡¡æ€§èƒ½
                    'gemini-pro'                    // å‚™ç”¨æ¨¡å‹
                ];
            }
            
            let lastError = null;
            let attemptCount = 0;
            const maxAttempts = 3;
            
            for (const model of models) {
                for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                    try {
                        attemptCount++;
                        console.log(`å˜—è©¦æ¨¡å‹ ${model}ï¼Œç¬¬ ${attempt} æ¬¡å˜—è©¦`);
                        
                        const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent`;
                        console.log('è«‹æ±‚ URL:', url);
                        
                        // æ ¹æ“šæ¨¡å‹èª¿æ•´é…ç½®
                        let generationConfig = {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 8192,
                        };
                        
                        // æ·±åº¦ç ”ç©¶æ¨¡å‹ç‰¹æ®Šé…ç½®
                        if (model === 'gemini-1.5-pro') {
                            generationConfig = {
                                temperature: 0.6,  // ç¨å¾®é™ä½æº«åº¦ä»¥ç²å¾—æ›´ç©©å®šçš„è¼¸å‡º
                                topK: 50,
                                topP: 0.9,
                                maxOutputTokens: 16384,  // æ”¯æ´æ›´é•·çš„è¼¸å‡º
                            };
                        }
                        
                        const requestBody = {
                            contents: [{
                                parts: [{
                                    text: prompt
                                }]
                            }],
                            generationConfig: generationConfig
                        };
                        
                        console.log('è«‹æ±‚å…§å®¹:', JSON.stringify(requestBody, null, 2));

                        // å¢åŠ è«‹æ±‚è¶…æ™‚è¨­å®šï¼ˆPro æ¨¡å‹å¯èƒ½éœ€è¦æ›´é•·æ™‚é–“ï¼‰
                        const timeout = model === 'gemini-1.5-pro' ? 60000 : 30000; // 60ç§’ vs 30ç§’
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), timeout);

                        const response = await fetch(`${url}?key=${apiKey}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Cache-Control': 'no-cache',
                                'Pragma': 'no-cache'
                            },
                            body: JSON.stringify(requestBody),
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);

                        if (!response.ok) {
                            let errorMessage = `HTTP ${response.status}`;
                            
                            // å˜—è©¦è®€å–éŒ¯èª¤éŸ¿æ‡‰å…§å®¹
                            let errorResponse = '';
                            try {
                                const errorData = await response.text();
                                errorResponse = errorData;
                                console.error('éŒ¯èª¤éŸ¿æ‡‰å…§å®¹:', errorData);
                            } catch (e) {
                                console.error('ç„¡æ³•è®€å–éŒ¯èª¤éŸ¿æ‡‰å…§å®¹');
                            }
                            
                            // æ ¹æ“š HTTP ç‹€æ…‹ç¢¼æä¾›æ›´å…·é«”çš„éŒ¯èª¤è¨Šæ¯
                            switch (response.status) {
                                case 400:
                                    errorMessage = `è«‹æ±‚æ ¼å¼éŒ¯èª¤ï¼Œå¯èƒ½æ˜¯ API é‡‘é‘°ç„¡æ•ˆæˆ–è«‹æ±‚å…§å®¹æœ‰å•é¡Œã€‚éŒ¯èª¤è©³æƒ…: ${errorResponse.substring(0, 200)}`;
                                    break;
                                case 401:
                                    errorMessage = 'API é‡‘é‘°ç„¡æ•ˆæˆ–å·²éæœŸï¼Œè«‹æª¢æŸ¥æ‚¨çš„ API é‡‘é‘°';
                                    break;
                                case 403:
                                    errorMessage = 'API é‡‘é‘°æ¬Šé™ä¸è¶³ï¼Œè«‹ç¢ºèªé‡‘é‘°æ˜¯å¦æ­£ç¢º';
                                    break;
                                case 404:
                                    errorMessage = `æ¨¡å‹ ${model} ä¸å¯ç”¨ï¼Œå¯èƒ½æ˜¯æ¨¡å‹åç¨±éŒ¯èª¤æˆ–æ‚¨çš„ API é‡‘é‘°æ²’æœ‰æ¬Šé™`;
                                    break;
                                case 429:
                                    errorMessage = 'API è«‹æ±‚é »ç‡éé«˜ï¼Œè«‹ç¨å¾Œå†è©¦';
                                    break;
                                case 500:
                                    errorMessage = 'Google æœå‹™å™¨éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦';
                                    break;
                                case 503:
                                    errorMessage = 'Google æœå‹™æš«æ™‚ä¸å¯ç”¨ï¼Œè«‹ç¨å¾Œå†è©¦';
                                    break;
                                default:
                                    errorMessage = `HTTP éŒ¯èª¤ ${response.status}: ${response.statusText}`;
                            }
                            
                            throw new Error(errorMessage);
                        }

                        const data = await response.json();
                        
                        if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                            const text = data.candidates[0].content.parts[0].text;
                            
                            if (expectJSON) {
                                try {
                                    // å˜—è©¦è§£æ JSON
                                    const jsonMatch = text.match(/\{[\s\S]*\}/);
                                    if (jsonMatch) {
                                        let jsonText = jsonMatch[0];
                                        
                                        // æ¸…ç†å¸¸è¦‹çš„ JSON æ ¼å¼å•é¡Œ
                                        jsonText = jsonText
                                            .replace(/,\s*}/g, '}')  // ç§»é™¤å°¾éš¨é€—è™Ÿ
                                            .replace(/,\s*]/g, ']')  // ç§»é™¤é™£åˆ—å°¾éš¨é€—è™Ÿ
                                            .replace(/[\u0000-\u001F\u007F-\u009F]/g, '') // ç§»é™¤æ§åˆ¶å­—ç¬¦
                                            .replace(/[\u2018\u2019]/g, "'") // æ¨™æº–åŒ–å¼•è™Ÿ
                                            .replace(/[\u201C\u201D]/g, '"'); // æ¨™æº–åŒ–é›™å¼•è™Ÿ
                                        
                                        try {
                                            return JSON.parse(jsonText);
                                        } catch (parseError) {
                                            console.error('JSON è§£æå¤±æ•—ï¼Œå˜—è©¦ä¿®å¾©æ ¼å¼:', parseError);
                                            console.log('åŸå§‹ JSON:', jsonText);
                                            
                                            // å˜—è©¦æ›´æ¿€é€²çš„ä¿®å¾©
                                            jsonText = jsonText
                                                .replace(/([^\\])"/g, '$1\\"') // è½‰ç¾©æœªè½‰ç¾©çš„å¼•è™Ÿ
                                                .replace(/\\"/g, '"') // é‡æ–°è™•ç†å¼•è™Ÿ
                                                .replace(/,\s*([}\]])/g, '$1'); // ç§»é™¤æ‰€æœ‰å°¾éš¨é€—è™Ÿ
                                            
                                            return JSON.parse(jsonText);
                                        }
                                    } else {
                                        throw new Error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„ JSON æ ¼å¼');
                                    }
                                } catch (jsonError) {
                                    console.error('JSON è§£æéŒ¯èª¤:', jsonError);
                                    console.log('åŸå§‹å›æ‡‰:', text);
                                    
                                    // å¦‚æœ JSON è§£æå¤±æ•—ï¼Œè¿”å›ä¸€å€‹åŸºæœ¬çš„éŒ¯èª¤çµæ§‹
                                    return {
                                        error: 'JSON è§£æå¤±æ•—',
                                        original_response: text.substring(0, 500) + '...',
                                        message: 'AI å›æ‡‰æ ¼å¼ä¸æ­£ç¢ºï¼Œä½†å·²è¨˜éŒ„åŸå§‹å›æ‡‰'
                                    };
                                }
                            }
                            
                            console.log(`æˆåŠŸä½¿ç”¨æ¨¡å‹ ${model} å®Œæˆè«‹æ±‚`);
                            // æ›´æ–°æ¨¡å‹ç‹€æ…‹é¡¯ç¤º
                            updateModelStatus(model);
                            return text;
                        } else {
                            throw new Error('AI å›æ‡‰æ ¼å¼ç•°å¸¸');
                        }
                    } catch (error) {
                        console.error(`æ¨¡å‹ ${model} ç¬¬ ${attempt} æ¬¡å˜—è©¦å¤±æ•—:`, error);
                        lastError = error;
                        
                        // å¦‚æœæ˜¯ç¶²è·¯éŒ¯èª¤æˆ–è¶…æ™‚ï¼Œç­‰å¾…å¾Œé‡è©¦
                        if (error.name === 'AbortError' || error.message.includes('fetch')) {
                            if (attempt < maxAttempts) {
                                console.log(`ç­‰å¾… ${attempt * 2} ç§’å¾Œé‡è©¦...`);
                                await new Promise(resolve => setTimeout(resolve, attempt * 2000));
                                continue;
                            }
                        }
                        
                        // å¦‚æœæ˜¯ API é‡‘é‘°éŒ¯èª¤ï¼Œç›´æ¥è·³å‡º
                        if (error.message.includes('API é‡‘é‘°') || error.message.includes('401') || error.message.includes('403')) {
                            throw error;
                        }
                        
                        // å¦‚æœæ˜¯æ¨¡å‹ä¸å¯ç”¨éŒ¯èª¤ï¼Œå˜—è©¦ä¸‹ä¸€å€‹æ¨¡å‹
                        if (error.message.includes('404') || error.message.includes('æ¨¡å‹') || error.message.includes('ä¸å¯ç”¨')) {
                            console.log(`æ¨¡å‹ ${model} ä¸å¯ç”¨ï¼Œå˜—è©¦ä¸‹ä¸€å€‹æ¨¡å‹`);
                            break;
                        }
                        
                        // å…¶ä»–éŒ¯èª¤ï¼Œå˜—è©¦ä¸‹ä¸€å€‹æ¨¡å‹
                        break;
                    }
                }
            }
            
            // å¦‚æœæ‰€æœ‰æ¨¡å‹éƒ½å¤±æ•—äº†
            const errorMessage = `æ‰€æœ‰æ¨¡å‹éƒ½å¤±æ•—äº†ã€‚ç¸½å…±å˜—è©¦äº† ${attemptCount} æ¬¡ã€‚æœ€å¾ŒéŒ¯èª¤: ${lastError.message}`;
            console.error(errorMessage);
            throw new Error(errorMessage);
        }
        

        
        // --- åˆ†æä»»å‹™å®šç¾© ---
        async function analyzeForumSentiment(context, apiKey) {
            const prompt = `
                ä½ æ˜¯ä¸€ä½å°ˆç²¾å°ç£å¸‚å ´çš„è³‡æ·±å¸‚å ´åˆ†æå¸«ï¼Œå…·å‚™ç­–ç•¥æ€è€ƒçš„é«˜åº¦èˆ‡å­¸ç¿’èƒ½åŠ›ã€‚è«‹ä½ æ ¹æ“šä»¥ä¸‹å“ç‰Œæƒ…å¢ƒï¼Œé€²è¡Œå…¨é¢çš„è¼¿æƒ…ç›£æ¸¬åˆ†æï¼š
                
                **å“ç‰Œæƒ…å¢ƒ:**
                - **ç›®æ¨™å“ç‰Œ:** ${context.target}
                - **ç«¶çˆ­å°æ‰‹:** ${context.competitors}
                - **æ‰€å±¬ç”¢æ¥­:** ${context.industry} (${context.industryStatus})
                - **å•†æ¥­æ¨¡å¼:** ${context.businessModel}
                - **æ ¸å¿ƒç›®æ¨™äººç¾¤:** ${context.targetAudience}
                - **å»£å‘Šç›®æ¨™èˆ‡ç›®çš„:** ${context.adObjective}
                - **å»£å‘Šå½¢å¼:** ${context.aiRecommendMedia ? 'AIå»ºè­°' : context.selectedMedia.join(', ')}
                - **å“ç‰Œè¡ŒéŠ·å•é¡Œ:** ${context.marketingProblems}

                **è¼¿æƒ…ç›£æ¸¬ç¯„åœï¼š**
                - å°ç£ä¸»æµè«–å£‡ï¼šDcardã€PTTã€Mobile01ã€å·´å“ˆå§†ç‰¹
                - ç¤¾ç¾¤åª’é«”ï¼šFacebookã€Instagramã€YouTubeã€TikTok
                - æ–°èåª’é«”ï¼šå„å¤§æ–°èç¶²ç«™ã€è²¡ç¶“åª’é«”
                - éƒ¨è½æ ¼èˆ‡è©•è«–ï¼šå„å¤§éƒ¨è½æ ¼å¹³å°ã€Googleè©•è«–
                - å°ˆæ¥­å¹³å°ï¼šLinkedInã€ç”¢æ¥­è«–å£‡

                **ç­–ç•¥æ€è€ƒè¦æ±‚ï¼š**
                - å¾å¸‚å ´æ ¼å±€è§’åº¦åˆ†æï¼šç”¢æ¥­ç«¶çˆ­æ…‹å‹¢ã€å¸‚å ´é›†ä¸­åº¦ã€é€²å…¥é–€æª»
                - å¾å“ç‰Œå®šä½è§’åº¦æ€è€ƒï¼šç›®æ¨™å“ç‰Œåœ¨å¸‚å ´ä¸­çš„ç›¸å°ä½ç½®ã€å·®ç•°åŒ–æ©Ÿæœƒ
                - å¾æœªä¾†è¶¨å‹¢è§’åº¦é æ¸¬ï¼šæ¶ˆè²»è€…è¡Œç‚ºè®ŠåŒ–ã€æŠ€è¡“ç™¼å±•å°ç”¢æ¥­çš„å½±éŸ¿
                - å¾å­¸ç¿’è§’åº¦ç¸½çµï¼šé¡ä¼¼æ¡ˆä¾‹çš„æˆåŠŸæ¨¡å¼ã€å¤±æ•—æ•™è¨“ã€æœ€ä½³å¯¦è¸
                - **å¾å•é¡Œè§£æ±ºè§’åº¦ï¼šé‡å°å“ç‰Œæå‡ºçš„è¡ŒéŠ·å•é¡Œï¼Œåˆ†ææ ¹æœ¬åŸå› èˆ‡è§£æ±ºæ–¹å‘**

                **è«‹ç‰¹åˆ¥è£œå……ï¼š**
                - ç«¶çˆ­å“ç‰Œåœ¨åª’é«”ä¸Šçš„æ›å…‰ç­–ç•¥ã€å‰µæ„è¡¨ç¾ã€è¿‘æœŸè©±é¡Œæˆ–å¸‚å ´å‹•æ…‹
                - è‹¥æœ‰å¯æŸ¥è©¢çš„å¸‚å ´æˆæ•ˆï¼ˆå¦‚å»£å‘ŠæŠ•æ”¾é‡ã€ç¤¾ç¾¤è²é‡ã€åª’é«”å ±å°æ•¸é‡ç­‰ï¼‰ï¼Œè«‹ç°¡è¦å¼•ç”¨
                - åˆ†æç«¶å“åœ¨ä¸åŒå»£å‘Šç›®æ¨™ï¼ˆå¦‚å“ç‰ŒçŸ¥ååº¦ã€éŠ·å”®æå‡ç­‰ï¼‰ä¸‹çš„å„ªåŠ£å‹¢
                - å¾ç­–ç•¥é«˜åº¦åˆ†æï¼šå¦‚ä½•å»ºç«‹é•·æœŸç«¶çˆ­å„ªå‹¢ã€å“ç‰Œè³‡ç”¢ç´¯ç©
                - è¼¿æƒ…ç†±åº¦åˆ†æï¼šå“ç‰Œè²é‡ã€æƒ…æ„Ÿå‚¾å‘ã€è©±é¡Œå‚³æ’­åŠ›
                - **é‡å°æ€§å•é¡Œåˆ†æï¼šåŸºæ–¼å“ç‰Œæè¿°çš„è¡ŒéŠ·å•é¡Œï¼Œæä¾›å…·é«”çš„è§£æ±ºç­–ç•¥èˆ‡æ©Ÿæœƒé»**

                ä½ çš„ä»»å‹™æ˜¯ç¸½çµæ¯”è¼ƒçš„çµæœï¼Œä¸¦ä»¥ä¸€å€‹ JSON ç‰©ä»¶çš„æ ¼å¼å›å‚³ã€‚JSON ç‰©ä»¶å¿…é ˆåŒ…å«ä»¥ä¸‹å¹¾å€‹ key: 
                "target_profile", "target_pros", "target_cons", "competitor_pros", "competitor_cons", "market_opportunity", "competitor_media_strategy", "market_trend", "reference_data", "strategic_insights", "learning_cases", "sentiment_analysis", "platform_performance", "positioning_analysis", "problem_analysis", "solution_strategies"ã€‚

                - **target_profile:** åœ¨è«–å£‡ä¸­ï¼Œæœ€æ¥è¿‘ã€Œ${context.targetAudience}ã€é€™å€‹è¼ªå»“çš„è¨è«–è€…æ˜¯èª°ï¼Ÿä»–å€‘æœ‰ä»€éº¼ç‰¹å¾µï¼Ÿ
                - **target_pros:** é€™äº›ç›®æ¨™äººç¾¤è®šè³ç›®æ¨™å“ç‰Œçš„å„ªé»æ˜¯ä»€éº¼ï¼Ÿ (è‡³å°‘ 2 é»)ã€‚
                - **target_cons:** é€™äº›ç›®æ¨™äººç¾¤æŠ±æ€¨ç›®æ¨™å“ç‰Œçš„ç¼ºé»æ˜¯ä»€éº¼ï¼Ÿ (è‡³å°‘ 2 é»)ã€‚
                - **competitor_pros:** ç«¶çˆ­å“ç‰Œå¸å¼•é€™äº›ç›®æ¨™äººç¾¤çš„å„ªé»ã€‚
                - **competitor_cons:** ç«¶çˆ­å“ç‰Œè®“é€™äº›ç›®æ¨™äººç¾¤å»æ­¥çš„ç¼ºé»ã€‚
                - **market_opportunity:** æ ¹æ“šä»¥ä¸Šåˆ†æï¼Œæ‰¾å‡ºä¸€å€‹èƒ½ç²¾æº–æ‰“å‹•ã€Œ${context.targetAudience}ã€çš„å¸‚å ´æºé€šæ©Ÿæœƒé»ã€‚
                - **competitor_media_strategy:** ç«¶å“çš„åª’é«”ç­–ç•¥ã€å‰µæ„è¡¨ç¾ã€è¿‘æœŸå¸‚å ´å‹•æ…‹
                - **market_trend:** æœ€æ–°å¸‚å ´è¶¨å‹¢ã€æ¶ˆè²»è€…è¡Œç‚ºè®ŠåŒ–
                - **reference_data:** è‹¥æœ‰æŸ¥è©¢åˆ°çš„å…¬é–‹å¸‚å ´æˆæ•ˆæ•¸æ“šï¼Œè«‹ç°¡è¦åˆ—å‡º
                - **strategic_insights:** å¾ç­–ç•¥é«˜åº¦åˆ†æå¸‚å ´æ ¼å±€ã€ç«¶çˆ­æ…‹å‹¢ã€æœªä¾†æ©Ÿæœƒ
                - **learning_cases:** å¾éå¾€æ¡ˆä¾‹ä¸­å­¸ç¿’çš„æˆåŠŸæ¨¡å¼ã€å¤±æ•—æ•™è¨“ã€æœ€ä½³å¯¦è¸
                - **sentiment_analysis:** è¼¿æƒ…æƒ…æ„Ÿåˆ†æï¼ˆæ­£é¢ã€è² é¢ã€ä¸­æ€§æ¯”ä¾‹ï¼‰
                - **platform_performance:** å„å¹³å°è¡¨ç¾åˆ†æï¼ˆè²é‡ã€äº’å‹•ç‡ã€å½±éŸ¿åŠ›ï¼‰
                - **positioning_analysis:** å“ç‰Œå®šä½åˆ†æï¼ŒåŒ…å«ä»¥ä¸‹ç¶­åº¦çš„è©•åˆ†ï¼ˆ1-10åˆ†ï¼‰ï¼š
                    - "price_position": åƒ¹æ ¼å®šä½ï¼ˆ1=ä½åƒ¹ï¼Œ10=é«˜åƒ¹ï¼‰
                    - "quality_position": å“è³ªå®šä½ï¼ˆ1=åŸºæœ¬ï¼Œ10=é«˜ç«¯ï¼‰
                    - "innovation_position": å‰µæ–°ç¨‹åº¦ï¼ˆ1=å‚³çµ±ï¼Œ10=å‰µæ–°ï¼‰
                    - "target_audience_position": ç›®æ¨™äººç¾¤å®šä½ï¼ˆ1=å¤§çœ¾ï¼Œ10=å°çœ¾ï¼‰
                    - "brand_personality": å“ç‰Œå€‹æ€§ï¼ˆ1=å¯¦ç”¨ï¼Œ10=æ™‚å°šï¼‰
                - **problem_analysis:** é‡å°å“ç‰Œæè¿°çš„è¡ŒéŠ·å•é¡Œé€²è¡Œæ·±åº¦åˆ†æï¼Œæ‰¾å‡ºæ ¹æœ¬åŸå› 
                - **solution_strategies:** åŸºæ–¼å•é¡Œåˆ†æï¼Œæä¾›å…·é«”çš„è§£æ±ºç­–ç•¥èˆ‡åŸ·è¡Œå»ºè­°

                è«‹ç¢ºä¿å›å‚³çš„å…§å®¹æ˜¯ç´”ç²¹çš„ JSON æ ¼å¼ï¼Œæ²’æœ‰ä»»ä½•é¡å¤–çš„æ–‡å­—æˆ–è¨»è§£ã€‚
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        async function analyzeIndustrySentiment(context, apiKey) {
            const prompt = `
                ä½ æ˜¯ä¸€ä½è³‡æ·±çš„ç”¢æ¥­è¼¿æƒ…åˆ†æå¸«ï¼Œå°ˆé–€ç›£æ¸¬å°ç£å„ç”¢æ¥­çš„è¼¿æƒ…ç‹€æ³ã€‚è«‹é‡å°ã€Œ${context.industry}ã€ç”¢æ¥­é€²è¡Œå…¨é¢çš„è¼¿æƒ…ç›£æ¸¬åˆ†æã€‚

                **åˆ†æç¯„åœï¼š**
                - ç”¢æ¥­æ•´é«”è¼¿æƒ…ç‹€æ³
                - ä¸»è¦ç«¶çˆ­å“ç‰Œè¼¿æƒ…è¡¨ç¾
                - ç”¢æ¥­ç†±é–€è©±é¡Œèˆ‡è¶¨å‹¢
                - æ¶ˆè²»è€…å°ç”¢æ¥­çš„æ•´é«”èªçŸ¥èˆ‡æ…‹åº¦
                - ç”¢æ¥­é¢è‡¨çš„æŒ‘æˆ°èˆ‡æ©Ÿæœƒ

                **ç›£æ¸¬å¹³å°ï¼š**
                - æ–°èåª’é«”ï¼šå„å¤§æ–°èç¶²ç«™ã€è²¡ç¶“åª’é«”ã€ç”¢æ¥­å°ˆåˆŠ
                - ç¤¾ç¾¤åª’é«”ï¼šFacebookã€Instagramã€YouTubeã€TikTok
                - è«–å£‡å¹³å°ï¼šPTTã€Dcardã€Mobile01ã€å·´å“ˆå§†ç‰¹
                - å°ˆæ¥­å¹³å°ï¼šLinkedInã€ç”¢æ¥­è«–å£‡ã€å°ˆæ¥­ç¤¾ç¾¤
                - è©•è«–å¹³å°ï¼šGoogleè©•è«–ã€å„å¤§è©•è«–ç¶²ç«™

                **åˆ†æé‡é»ï¼š**
                - ç”¢æ¥­è²é‡è¶¨å‹¢ï¼ˆè¿‘3å€‹æœˆï¼‰
                - ç†±é–€è©±é¡Œèˆ‡é—œéµå­—
                - æ¶ˆè²»è€…æƒ…æ„Ÿå‚¾å‘
                - ç”¢æ¥­çˆ­è­°èˆ‡å±æ©Ÿ
                - æ–°èˆˆè¶¨å‹¢èˆ‡æ©Ÿæœƒ

                ä½ çš„ä»»å‹™æ˜¯ç”¢å‡ºä¸€å€‹ JSON ç‰©ä»¶ï¼ŒåŒ…å«ä»¥ä¸‹ keyï¼š
                "industry_overview", "trending_topics", "sentiment_distribution", "key_players", "crisis_opportunities", "consumer_insights", "future_trends"ã€‚

                - **industry_overview:** ç”¢æ¥­æ•´é«”è¼¿æƒ…æ¦‚æ³
                - **trending_topics:** ç†±é–€è©±é¡Œèˆ‡é—œéµå­—ï¼ˆè‡³å°‘5å€‹ï¼‰
                - **sentiment_distribution:** æƒ…æ„Ÿåˆ†å¸ƒï¼ˆæ­£é¢ã€è² é¢ã€ä¸­æ€§æ¯”ä¾‹ï¼‰
                - **key_players:** ä¸»è¦ç«¶çˆ­å“ç‰Œè¼¿æƒ…è¡¨ç¾æ’å
                - **crisis_opportunities:** ç”¢æ¥­é¢è‡¨çš„å±æ©Ÿèˆ‡æ©Ÿæœƒ
                - **consumer_insights:** æ¶ˆè²»è€…å°ç”¢æ¥­çš„èªçŸ¥èˆ‡æ…‹åº¦
                - **future_trends:** æœªä¾†è¶¨å‹¢é æ¸¬

                è«‹ç¢ºä¿å›å‚³çš„å…§å®¹æ˜¯ç´”ç²¹çš„ JSON æ ¼å¼ï¼Œæ²’æœ‰ä»»ä½•é¡å¤–çš„æ–‡å­—æˆ–è¨»è§£ã€‚
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        async function analyzeSeoStrategy(context, apiKey) {
            const prompt = `
                ä½ æ˜¯ä¸€ä½é ‚å°–çš„ SEO ç­–ç•¥é¡§å•ï¼Œç‰¹åˆ¥ç†Ÿæ‚‰å°ç£çš„ google.com.tw æœå°‹å¼•æ“ç”Ÿæ…‹ã€‚
                è«‹æ¨¡æ“¬ã€Œ${context.targetAudience}ã€é€™å€‹ç›®æ¨™äººç¾¤ï¼Œåœ¨æœå°‹èˆ‡ã€Œ${context.target}ã€ç›¸é—œçš„é—œéµå­—æ™‚ï¼Œä»–å€‘æœƒçœ‹åˆ°ä»€éº¼æ¨£çš„æœå°‹çµæœé é¢ (SERP)ã€‚

                **å“ç‰Œæƒ…å¢ƒ:**
                - **ç›®æ¨™å“ç‰Œ:** ${context.target}
                - **ç«¶çˆ­å°æ‰‹:** ${context.competitors}
                - **å•†æ¥­æ¨¡å¼:** ${context.businessModel}
                - **æ ¸å¿ƒç›®æ¨™äººç¾¤:** ${context.targetAudience}
                - **å»£å‘Šç›®æ¨™èˆ‡ç›®çš„:** ${context.adObjective}
                - **å»£å‘Šå½¢å¼:** ${context.aiRecommendMedia ? 'AIå»ºè­°' : context.selectedMedia.join(', ')}

                ä½ çš„ä»»å‹™æ˜¯ç¸½çµä½ çš„ç™¼ç¾ï¼Œä¸¦ä»¥ä¸€å€‹ JSON ç‰©ä»¶çš„æ ¼å¼å›å‚³ã€‚JSON ç‰©ä»¶å¿…é ˆåŒ…å«ä»¥ä¸‹å¹¾å€‹ key: 
                "main_competitors_in_serp", "dominant_content_format", "user_intent", "content_gap_opportunity"ã€‚

                - **main_competitors_in_serp:** é™¤äº†ã€Œ${context.competitors}ã€ä¹‹å¤–ï¼Œåœ¨è‡ªç„¶æœå°‹çµæœä¸­é‚„å¸¸å‡ºç¾å“ªäº›ç«¶çˆ­è€…ï¼Ÿ
                - **dominant_content_format:** æ’åé å‰çš„å…§å®¹ä¸»è¦æ˜¯é•·ç¯‡æ–‡ç« ã€ç”¢å“æ¯”è¼ƒé ã€æ–°èç¨¿ï¼Œé‚„æ˜¯ YouTube å½±ç‰‡ï¼Ÿ
                - **user_intent:** ã€Œ${context.targetAudience}ã€åœ¨æœå°‹æ™‚ï¼Œå…¶ä¸»è¦çš„ã€Œæœå°‹æ„åœ–ã€æ˜¯ä»€éº¼ï¼Ÿè«‹æ ¹æ“š ${context.businessModel} çš„ç‰¹æ€§ä¾†åˆ†æã€‚
                - **content_gap_opportunity:** æ ¹æ“š Google çš„ã€Œå…¶ä»–äººä¹Ÿå•äº†ã€æˆ–ã€Œç›¸é—œæœå°‹ã€ï¼Œæ‰¾å‡ºä¸€å€‹èƒ½è§£æ±ºã€Œ${context.targetAudience}ã€ç—›é»ï¼Œä½†å¸‚å ´ä¸Šé‚„æ²’æœ‰å„ªè³ªå…§å®¹å›ç­”çš„å•é¡Œï¼Œä½œç‚ºå…§å®¹ç­–ç•¥åˆ‡å…¥é»ã€‚

                è«‹ç¢ºä¿å›å‚³çš„å…§å®¹æ˜¯ç´”ç²¹çš„ JSON æ ¼å¼ï¼Œæ²’æœ‰ä»»ä½•é¡å¤–çš„æ–‡å­—æˆ–è¨»è§£ã€‚
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        async function analyzeBudgetFeasibility(context, apiKey) {
            const prompt = `
                ä½ æ˜¯ä¸€ä½è³‡æ·±çš„åª’é«”ç­–ç•¥é¡§å•ï¼Œå°ˆé–€è©•ä¼°å»£å‘Šé ç®—èˆ‡ç›®æ¨™çš„å¯è¡Œæ€§ã€‚è«‹é‡å°ä»¥ä¸‹æƒ…å¢ƒé€²è¡Œé ç®—å¯è¡Œæ€§åˆ†æï¼š

                **å®¢æˆ¶æƒ…å¢ƒ:**
                - **ç›®æ¨™å“ç‰Œ:** ${context.target}
                - **ç”¢æ¥­:** ${context.industry} (${context.industryStatus})
                - **å•†æ¥­æ¨¡å¼:** ${context.businessModel}
                - **ç›®æ¨™äººç¾¤:** ${context.targetAudience}
                - **å»£å‘Šç›®æ¨™èˆ‡ç›®çš„:** ${context.adObjective}
                - **å»£å‘Šå½¢å¼:** ${context.aiRecommendMedia ? 'AIå»ºè­°' : context.selectedMedia.join(', ')}
                - **ç¸½é ç®— (TWD):** ${context.budget.toLocaleString()}

                **åˆ†æé‡é»ï¼š**
                - è©•ä¼°è©²é ç®—åœ¨å°ç£å¸‚å ´é”æˆç›®æ¨™çš„å¯è¡Œæ€§
                - åˆ†æä¸åŒé ç®—è¦æ¨¡ä¸‹çš„ç­–ç•¥é¸æ“‡
                - æä¾›é ç®—ä¸è¶³æ™‚çš„æ›¿ä»£æ–¹æ¡ˆ
                - å»ºè­°æœ€å„ªçš„é ç®—åˆ†é…ç­–ç•¥

                **è«‹åƒè€ƒå°ç£å¸‚å ´çš„å¯¦éš›æ•¸æ“šï¼š**
                - ä¸åŒåª’é«”æ¸ é“çš„CPM/CPCåŸºæº–
                - å„ç”¢æ¥­çš„å…¸å‹å»£å‘ŠæŠ•è³‡è¦æ¨¡
                - ä¸åŒç›®æ¨™çš„é”æˆé–€æª»

                ä½ çš„ä»»å‹™æ˜¯ç”¢å‡ºä¸€å€‹ JSON ç‰©ä»¶ï¼ŒåŒ…å«ä»¥ä¸‹ keyï¼š
                "feasibility_assessment", "budget_recommendations", "alternative_strategies", "risk_analysis", "success_probability"ã€‚

                - **feasibility_assessment:** é ç®—å¯è¡Œæ€§è©•ä¼°ï¼ˆé«˜/ä¸­/ä½ï¼‰åŠç†ç”±
                - **budget_recommendations:** åŸºæ–¼ç›®æ¨™çš„é ç®—å»ºè­°ï¼ˆç†æƒ³é ç®—ç¯„åœï¼‰
                - **alternative_strategies:** é ç®—ä¸è¶³æ™‚çš„æ›¿ä»£ç­–ç•¥ï¼ˆè‡³å°‘3å€‹ï¼‰
                - **risk_analysis:** é ç®—ä¸è¶³å¯èƒ½å¸¶ä¾†çš„é¢¨éšª
                - **success_probability:** é”æˆç›®æ¨™çš„æˆåŠŸæ©Ÿç‡è©•ä¼°

                è«‹ç¢ºä¿å›å‚³çš„å…§å®¹æ˜¯ç´”ç²¹çš„ JSON æ ¼å¼ï¼Œæ²’æœ‰ä»»ä½•é¡å¤–çš„æ–‡å­—æˆ–è¨»è§£ã€‚
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        async function estimateKpiAndBudget(context, opportunity, apiKey) {
            if (!context.budget || context.budget <= 0) {
                 return { budget_allocation: [], kpi_estimations: [], rationale: "æœªæä¾›é ç®—ï¼Œç„¡æ³•é€²è¡Œä¼°ç®—ã€‚" };
            }
            const prompt = `
                ä½ æ˜¯ä¸€ä½ç¶“é©—è±å¯Œçš„æ•¸ä½åª’é«”è¦åŠƒå¸« (Media Planner)ï¼Œæ“…é•·å°ç£å¸‚å ´çš„åª’é«”æŠ•è³‡èˆ‡æˆæ•ˆé ä¼°ï¼Œå…·å‚™ç­–ç•¥æ€è€ƒçš„é«˜åº¦èˆ‡å­¸ç¿’èƒ½åŠ›ã€‚
                æ ¹æ“šä»¥ä¸‹å®¢æˆ¶æƒ…å¢ƒèˆ‡ä½ å·²çŸ¥çš„å¸‚å ´æ©Ÿæœƒé»ï¼Œè¦åŠƒä¸€ä»½åˆæ­¥çš„é ç®—åˆ†é…èˆ‡ KPI é ä¼°ã€‚

                **å®¢æˆ¶æƒ…å¢ƒ:**
                - **ç”¢æ¥­:** ${context.industry}
                - **å•†æ¥­æ¨¡å¼:** ${context.businessModel}
                - **ç›®æ¨™äººç¾¤:** ${context.targetAudience}
                - **ç¸½é ç®— (TWD):** ${context.budget.toLocaleString()}
                - **å»£å‘Šç›®æ¨™èˆ‡ç›®çš„:** ${context.adObjective}
                - **å»£å‘Šå½¢å¼:** ${context.aiRecommendMedia ? 'AIå»ºè­°' : context.selectedMedia.join(', ')}
                - **æ ¸å¿ƒç­–ç•¥æ©Ÿæœƒé»:** ${opportunity}

                **ç­–ç•¥æ€è€ƒè¦æ±‚ï¼š**
                - å¾æŠ•è³‡å›å ±è§’åº¦æ€è€ƒï¼šå¦‚ä½•æœ€å¤§åŒ–æ¯ä¸€åˆ†é ç®—çš„æ•ˆç›Š
                - å¾å­¸ç¿’è§’åº¦ç¸½çµï¼šé¡ä¼¼é ç®—è¦æ¨¡çš„æˆåŠŸæ¡ˆä¾‹ã€å¤±æ•—æ•™è¨“
                - å¾ç­–ç•¥è§’åº¦è¦åŠƒï¼šå¦‚ä½•å»ºç«‹å¯æŒçºŒçš„åª’é«”æŠ•è³‡æ¨¡å¼
                - å¾å‰µæ–°è§’åº¦å»ºè­°ï¼šæ–°èˆˆåª’é«”æ¸ é“ã€å‰µæ„è¡¨ç¾å½¢å¼
                - **å¾å¯è¡Œæ€§è§’åº¦è©•ä¼°ï¼šè©²é ç®—æ˜¯å¦è¶³å¤ é”æˆç›®æ¨™ï¼Œå¦‚ä¸è¶³è«‹æä¾›èª¿æ•´å»ºè­°**

                **è«‹åƒè€ƒå°ç£å¯æŸ¥è©¢çš„å…¬é–‹åª’é«”æˆæ•ˆæ•¸æ“šï¼ˆå¦‚Nielsenã€Comscoreã€Meta/Facebook/Googleå®˜æ–¹å ±å‘Šç­‰ï¼‰ï¼Œä¸¦æ ¹æ“šå»£å‘Šç›®æ¨™èˆ‡ç›®çš„ï¼Œçµ¦å‡ºæœ€å…·æˆæ•ˆçš„åª’é«”å»ºè­°èˆ‡KPIé ä¼°ã€‚**

                ä½ çš„ä»»å‹™æ˜¯ç”¢å‡ºä¸€å€‹ JSON ç‰©ä»¶ï¼ŒåŒ…å« "budget_allocation", "kpi_estimations", "rationale", "reference_data", "strategic_recommendations", "learning_insights", "feasibility_warning", "budget_optimization" å…«å€‹ keyã€‚

                1.  **budget_allocation:** ä¸€å€‹é™£åˆ—ã€‚æ ¹æ“šã€Œæ ¸å¿ƒç­–ç•¥æ©Ÿæœƒé»ã€ï¼Œå»ºè­°å°‡é ç®—åˆ†é…åˆ° 2-3 å€‹æœ€ç›¸é—œçš„åª’é«”æ¸ é“ (ä¾‹å¦‚ï¼šä»˜è²»æœå°‹, ç¤¾ç¾¤å»£å‘Š, å…§å®¹è¡ŒéŠ·, å½±éŸ³å»£å‘Š)ï¼Œä¸¦çµ¦å‡ºæ¯å€‹æ¸ é“çš„**ç™¾åˆ†æ¯”**å’Œ**é‡‘é¡**ã€‚
                2.  **kpi_estimations:** ä¸€å€‹é™£åˆ—ã€‚ç‚ºæ¯å€‹å»ºè­°çš„æ¸ é“ï¼Œæä¾›**å¯é‡åŒ–çš„ KPI é ä¼°**ã€‚è«‹ä½¿ç”¨å°ç£å¸‚å ´çš„å…¸å‹ benchmarks (åŸºæº–)ã€‚
                    -   **å°æ–¼ B2C:** éœ€åŒ…å« "Impressions" (æ›å…‰), "CTR" (é»æ“Šç‡), "Clicks" (é»æ“Š), "CPC" (å–®æ¬¡é»æ“Šæˆæœ¬), "Est_Conversions" (é ä¼°è¨‚å–®æ•¸ï¼Œè«‹è‡ªè¨‚ä¸€å€‹åˆç†çš„è½‰æ›ç‡)ã€‚
                    -   **å°æ–¼ B2B:** éœ€åŒ…å« "Impressions", "CTR", "Clicks", "CPC", "Est_Leads" (é ä¼°æ½›åœ¨å®¢æˆ¶æ•¸ï¼Œè«‹è‡ªè¨‚ä¸€å€‹åˆç†çš„è½‰æ›ç‡)ã€‚
                3.  **rationale:** ä¸€æ®µç°¡çŸ­æ–‡å­—ï¼Œèªªæ˜ä½ é€™æ¨£è¦åŠƒé ç®—å„ªå…ˆç´šçš„ç†ç”±ã€‚
                4.  **reference_data:** è‹¥æœ‰æŸ¥è©¢åˆ°çš„å…¬é–‹åª’é«”æˆæ•ˆæ•¸æ“šï¼Œè«‹ç°¡è¦åˆ—å‡º
                5.  **strategic_recommendations:** å¾ç­–ç•¥è§’åº¦æä¾›çš„é•·æœŸå»ºè­°ã€å‰µæ–°æ–¹å‘
                6.  **learning_insights:** å¾éå¾€æ¡ˆä¾‹ä¸­å­¸ç¿’çš„ç¶“é©—ã€æœ€ä½³å¯¦è¸
                7.  **feasibility_warning:** å¦‚æœé ç®—æ˜é¡¯ä¸è¶³é”æˆç›®æ¨™ï¼Œè«‹æä¾›è­¦å‘Šèˆ‡å»ºè­°
                8.  **budget_optimization:** é ç®—å„ªåŒ–å»ºè­°ï¼Œå¦‚ä½•åœ¨æœ‰é™é ç®—ä¸‹æœ€å¤§åŒ–æ•ˆç›Š

                è«‹ç¢ºä¿å›å‚³çš„å…§å®¹æ˜¯ç´”ç²¹çš„ JSON æ ¼å¼ã€‚
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        async function analyzeMultiMarketStrategy(context, apiKey) {
            const prompt = `
                ä½ æ˜¯ä¸€ä½è³‡æ·±çš„åœ‹éš›å¸‚å ´ç­–ç•¥é¡§å•ï¼Œå°ˆé–€è¦åŠƒå¤šå¸‚å ´åª’é«”ç­–ç•¥ã€‚è«‹é‡å°ä»¥ä¸‹æƒ…å¢ƒé€²è¡Œå¤šå¸‚å ´ç­–ç•¥åˆ†æï¼š

                **å®¢æˆ¶æƒ…å¢ƒ:**
                - **ç›®æ¨™å“ç‰Œ:** ${context.target}
                - **ç”¢æ¥­:** ${context.industry}
                - **å•†æ¥­æ¨¡å¼:** ${context.businessModel}
                - **ç›®æ¨™äººç¾¤:** ${context.targetAudience}
                - **å»£å‘Šç›®æ¨™èˆ‡ç›®çš„:** ${context.adObjective}
                - **å»£å‘Šå½¢å¼:** ${context.aiRecommendMedia ? 'AIå»ºè­°' : context.selectedMedia.join(', ')}
                - **ç›®æ¨™å¸‚å ´:** ${context.targetMarkets}
                - **ç›®æ¨™èªè¨€:** ${context.targetLanguages}
                - **ç¸½é ç®— (TWD):** ${context.budget.toLocaleString()}

                **åˆ†æé‡é»ï¼š**
                - å„ç›®æ¨™å¸‚å ´çš„åª’é«”ç”Ÿæ…‹èˆ‡æ¶ˆè²»è€…è¡Œç‚ºå·®ç•°
                - ä¸åŒå¸‚å ´çš„åª’é«”æŠ•è³‡æˆæœ¬èˆ‡æ•ˆç›Šæ¯”è¼ƒ
                - è·¨å¸‚å ´å“ç‰Œä¸€è‡´æ€§èˆ‡åœ¨åœ°åŒ–å¹³è¡¡
                - å¤šèªè¨€å…§å®¹ç­–ç•¥èˆ‡æ–‡åŒ–é©æ‡‰æ€§
                - é ç®—åœ¨å„å¸‚å ´çš„æœ€å„ªåˆ†é…ç­–ç•¥

                **è«‹åƒè€ƒå„å¸‚å ´çš„å¯¦éš›æ•¸æ“šï¼š**
                - å„å¸‚å ´çš„åª’é«”æ»²é€ç‡èˆ‡ä½¿ç”¨ç¿’æ…£
                - ä¸åŒå¸‚å ´çš„å»£å‘Šæˆæœ¬åŸºæº–
                - æ–‡åŒ–å·®ç•°å°å»£å‘Šæ•ˆæœçš„å½±éŸ¿
                - æˆåŠŸèˆ‡å¤±æ•—çš„è·¨å¸‚å ´æ¡ˆä¾‹

                ä½ çš„ä»»å‹™æ˜¯ç”¢å‡ºä¸€å€‹ JSON ç‰©ä»¶ï¼ŒåŒ…å«ä»¥ä¸‹ keyï¼š
                "market_analysis", "budget_allocation", "localization_strategy", "cultural_considerations", "success_metrics", "risk_management"ã€‚

                - **market_analysis:** å„ç›®æ¨™å¸‚å ´çš„åª’é«”ç’°å¢ƒåˆ†æï¼ˆåŒ…å«å¸‚å ´è¦æ¨¡ã€åª’é«”ç¿’æ…£ã€ç«¶çˆ­ç‹€æ³ï¼‰
                - **budget_allocation:** å»ºè­°çš„è·¨å¸‚å ´é ç®—åˆ†é…ï¼ˆç™¾åˆ†æ¯”èˆ‡é‡‘é¡ï¼‰
                - **localization_strategy:** åœ¨åœ°åŒ–ç­–ç•¥å»ºè­°ï¼ˆå…§å®¹ã€å‰µæ„ã€åª’é«”é¸æ“‡ï¼‰
                - **cultural_considerations:** æ–‡åŒ–è€ƒé‡èˆ‡æ³¨æ„äº‹é …
                - **success_metrics:** å„å¸‚å ´çš„KPIè¨­å®šå»ºè­°
                - **risk_management:** è·¨å¸‚å ´åŸ·è¡Œçš„é¢¨éšªç®¡ç†

                è«‹ç¢ºä¿å›å‚³çš„å…§å®¹æ˜¯ç´”ç²¹çš„ JSON æ ¼å¼ï¼Œæ²’æœ‰ä»»ä½•é¡å¤–çš„æ–‡å­—æˆ–è¨»è§£ã€‚
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        async function analyzeLocalizationStrategy(context, multiMarketData, apiKey) {
            const prompt = `
                ä½ æ˜¯ä¸€ä½è³‡æ·±çš„åœ¨åœ°åŒ–ç­–ç•¥å°ˆå®¶ï¼Œå°ˆé–€è¦åŠƒå¤šèªè¨€å…§å®¹èˆ‡æ–‡åŒ–é©æ‡‰ç­–ç•¥ã€‚è«‹é‡å°ä»¥ä¸‹æƒ…å¢ƒé€²è¡Œåœ¨åœ°åŒ–ç­–ç•¥åˆ†æï¼š

                **å®¢æˆ¶æƒ…å¢ƒ:**
                - **ç›®æ¨™å“ç‰Œ:** ${context.target}
                - **ç”¢æ¥­:** ${context.industry}
                - **ç›®æ¨™äººç¾¤:** ${context.targetAudience}
                - **å»£å‘Šç›®æ¨™èˆ‡ç›®çš„:** ${context.adObjective}
                - **å»£å‘Šå½¢å¼:** ${context.aiRecommendMedia ? 'AIå»ºè­°' : context.selectedMedia.join(', ')}
                - **ç›®æ¨™å¸‚å ´:** ${context.targetMarkets}
                - **ç›®æ¨™èªè¨€:** ${context.targetLanguages}

                **å¤šå¸‚å ´åˆ†æè³‡æ–™:**
                ${JSON.stringify(multiMarketData, null, 2)}

                **åˆ†æé‡é»ï¼š**
                - å„èªè¨€çš„å…§å®¹ç­–ç•¥èˆ‡è¡¨é”æ–¹å¼
                - æ–‡åŒ–ç¬¦è™Ÿèˆ‡ç¦å¿Œçš„è­˜åˆ¥èˆ‡è™•ç†
                - å‰µæ„è¡¨ç¾çš„åœ¨åœ°åŒ–èª¿æ•´å»ºè­°
                - åª’é«”æ¸ é“çš„èªè¨€åå¥½åˆ†æ
                - å“ç‰Œè¨Šæ¯çš„ä¸€è‡´æ€§èˆ‡é©æ‡‰æ€§å¹³è¡¡

                **è«‹åƒè€ƒå„èªè¨€å¸‚å ´çš„å¯¦éš›æ¡ˆä¾‹ï¼š**
                - æˆåŠŸçš„è·¨èªè¨€å»£å‘Šæ¡ˆä¾‹
                - æ–‡åŒ–å¤±èª¤çš„æ•™è¨“èˆ‡é¿å…æ–¹æ³•
                - å„èªè¨€çš„å‰µæ„è¡¨ç¾ç‰¹è‰²
                - åª’é«”å¹³å°çš„èªè¨€ä½¿ç”¨ç¿’æ…£

                ä½ çš„ä»»å‹™æ˜¯ç”¢å‡ºä¸€å€‹ JSON ç‰©ä»¶ï¼ŒåŒ…å«ä»¥ä¸‹ keyï¼š
                "language_strategy", "cultural_adaptation", "creative_localization", "media_language_preferences", "brand_consistency", "translation_guidelines"ã€‚

                - **language_strategy:** å„èªè¨€çš„å…§å®¹ç­–ç•¥å»ºè­°
                - **cultural_adaptation:** æ–‡åŒ–é©æ‡‰æ€§å»ºè­°èˆ‡æ³¨æ„äº‹é …
                - **creative_localization:** å‰µæ„è¡¨ç¾çš„åœ¨åœ°åŒ–å»ºè­°
                - **media_language_preferences:** å„åª’é«”å¹³å°çš„èªè¨€åå¥½
                - **brand_consistency:** å“ç‰Œä¸€è‡´æ€§çš„ç¶­è­·ç­–ç•¥
                - **translation_guidelines:** ç¿»è­¯èˆ‡æœ¬åœ°åŒ–æŒ‡å°åŸå‰‡

                è«‹ç¢ºä¿å›å‚³çš„å…§å®¹æ˜¯ç´”ç²¹çš„ JSON æ ¼å¼ï¼Œæ²’æœ‰ä»»ä½•é¡å¤–çš„æ–‡å­—æˆ–è¨»è§£ã€‚
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        async function analyzeCompetitorInsights(context, apiKey) {
            const prompt = `
                ä½ æ˜¯ä¸€ä½è³‡æ·±çš„ç«¶çˆ­åˆ†æå°ˆå®¶ï¼Œå°ˆé–€åˆ†æç«¶çˆ­å°æ‰‹çš„å“ç‰Œå®šä½ã€ç”¢å“ç­–ç•¥èˆ‡å¸‚å ´è¡¨ç¾ã€‚è«‹é‡å°ä»¥ä¸‹æƒ…å¢ƒé€²è¡Œæ·±åº¦ç«¶çˆ­å°æ‰‹åˆ†æï¼š

                **å®¢æˆ¶æƒ…å¢ƒ:**
                - **ç›®æ¨™å“ç‰Œ:** ${context.target}
                - **ç”¢æ¥­:** ${context.industry} (${context.industryStatus})
                - **å•†æ¥­æ¨¡å¼:** ${context.businessModel}
                - **ç›®æ¨™äººç¾¤:** ${context.targetAudience}
                - **ç«¶çˆ­å°æ‰‹:** ${context.competitors}

                **åˆ†æé‡é»ï¼š**
                - è©³ç´°åˆ†ææ¯å€‹ç«¶çˆ­å°æ‰‹çš„å“ç‰Œå®šä½èˆ‡ç”¢å“ç‰¹è‰²
                - ç«¶çˆ­å°æ‰‹çš„åª’é«”ç­–ç•¥èˆ‡å»£å‘Šè¡¨ç¾
                - ç«¶çˆ­å°æ‰‹çš„ç›®æ¨™äººç¾¤èˆ‡å¸‚å ´ä½”æœ‰ç‡
                - ç«¶çˆ­å°æ‰‹çš„å„ªå‹¢èˆ‡åŠ£å‹¢åˆ†æ
                - å¸‚å ´æ©Ÿæœƒèˆ‡å¨è„…è©•ä¼°
                - å·®ç•°åŒ–ç­–ç•¥å»ºè­°

                **è«‹åƒè€ƒå°ç£å¸‚å ´çš„å¯¦éš›æ•¸æ“šï¼š**
                - å„ç«¶çˆ­å°æ‰‹çš„å¸‚å ´è¡¨ç¾æ•¸æ“š
                - åª’é«”æŠ•è³‡è¦æ¨¡èˆ‡ç­–ç•¥
                - æ¶ˆè²»è€…å°å„å“ç‰Œçš„èªçŸ¥èˆ‡è©•åƒ¹
                - æˆåŠŸèˆ‡å¤±æ•—çš„ç«¶çˆ­æ¡ˆä¾‹

                ä½ çš„ä»»å‹™æ˜¯ç”¢å‡ºä¸€å€‹ JSON ç‰©ä»¶ï¼ŒåŒ…å«ä»¥ä¸‹ keyï¼š
                "competitor_analysis", "market_positioning", "media_strategies", "opportunities", "threats", "differentiation_strategy"ã€‚

                - **competitor_analysis:** å„ç«¶çˆ­å°æ‰‹çš„è©³ç´°åˆ†æï¼ˆå“ç‰Œã€ç”¢å“ã€å®šä½ã€å„ªå‹¢åŠ£å‹¢ï¼‰
                - **market_positioning:** å¸‚å ´å®šä½åœ–åˆ†æï¼ˆåƒ¹æ ¼vså“è³ªã€åŠŸèƒ½vsè¨­è¨ˆç­‰ç¶­åº¦ï¼‰
                - **media_strategies:** ç«¶çˆ­å°æ‰‹çš„åª’é«”ç­–ç•¥åˆ†æ
                - **opportunities:** å¸‚å ´æ©Ÿæœƒé»è­˜åˆ¥
                - **threats:** æ½›åœ¨å¨è„…åˆ†æ
                - **differentiation_strategy:** å·®ç•°åŒ–ç­–ç•¥å»ºè­°

                è«‹ç¢ºä¿å›å‚³çš„å…§å®¹æ˜¯ç´”ç²¹çš„ JSON æ ¼å¼ï¼Œæ²’æœ‰ä»»ä½•é¡å¤–çš„æ–‡å­—æˆ–è¨»è§£ã€‚
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        async function analyzeMarketingCalendar(context, apiKey) {
            const prompt = `
                ä½ æ˜¯ä¸€ä½è³‡æ·±çš„è¡ŒéŠ·ç­–ç•¥é¡§å•ï¼Œå°ˆé–€è¦åŠƒè¡ŒéŠ·æ™‚ç¨‹èˆ‡ç†±é»äº‹ä»¶æ•´åˆã€‚è«‹é‡å°ä»¥ä¸‹æƒ…å¢ƒé€²è¡Œè¡ŒéŠ·è¡Œäº‹æ›†åˆ†æï¼š

                **å®¢æˆ¶æƒ…å¢ƒ:**
                - **ç›®æ¨™å“ç‰Œ:** ${context.target}
                - **ç”¢æ¥­:** ${context.industry} (${context.industryStatus})
                - **ç›®æ¨™äººç¾¤:** ${context.targetAudience}
                - **è¡ŒéŠ·æœŸé–“:** ${context.startDate} è‡³ ${context.endDate}
                - **ç›®æ¨™å¸‚å ´:** ${context.targetMarkets}

                **åˆ†æé‡é»ï¼š**
                - åˆ†æè¡ŒéŠ·æœŸé–“å…§çš„ç†±é»äº‹ä»¶èˆ‡ç¯€æ…¶
                - è­˜åˆ¥é©åˆçš„æ´»å‹•åˆä½œæ©Ÿæœƒï¼ˆæ¼”å”±æœƒã€å±•è¦½ã€é‹å‹•è³½äº‹ç­‰ï¼‰
                - è©•ä¼°å„äº‹ä»¶çš„æå‰æ´½è«‡æ™‚ç¨‹
                - å»ºè­°æœ€ä½³çš„è¡ŒéŠ·æ™‚æ©Ÿé»
                - åˆ†æç«¶çˆ­å°æ‰‹çš„è¡ŒéŠ·æ™‚ç¨‹
                - æä¾›æ™‚ç¨‹é¢¨éšªç®¡ç†å»ºè­°

                **è«‹åƒè€ƒå°ç£å¸‚å ´çš„å¯¦éš›æƒ…æ³ï¼š**
                - å„æœˆä»½çš„ç¯€æ…¶èˆ‡æ´»å‹•
                - å¤§å‹æ´»å‹•çš„æå‰æ´½è«‡æ™‚ç¨‹
                - å„ç”¢æ¥­çš„è¡ŒéŠ·æ—ºå­£
                - æˆåŠŸèˆ‡å¤±æ•—çš„æ™‚ç¨‹è¦åŠƒæ¡ˆä¾‹

                ä½ çš„ä»»å‹™æ˜¯ç”¢å‡ºä¸€å€‹ JSON ç‰©ä»¶ï¼ŒåŒ…å«ä»¥ä¸‹ keyï¼š
                "calendar_analysis", "hot_events", "partnership_opportunities", "timing_recommendations", "risk_management", "competitive_timing"ã€‚

                - **calendar_analysis:** è¡ŒéŠ·æœŸé–“çš„æ•´é«”æ™‚ç¨‹åˆ†æ
                - **hot_events:** ç†±é»äº‹ä»¶æ¸…å–®èˆ‡å½±éŸ¿è©•ä¼°
                - **partnership_opportunities:** åˆä½œæ©Ÿæœƒèˆ‡æ´½è«‡æ™‚ç¨‹
                - **timing_recommendations:** æœ€ä½³æ™‚æ©Ÿé»å»ºè­°
                - **risk_management:** æ™‚ç¨‹é¢¨éšªç®¡ç†
                - **competitive_timing:** ç«¶çˆ­å°æ‰‹æ™‚ç¨‹åˆ†æ

                è«‹ç¢ºä¿å›å‚³çš„å…§å®¹æ˜¯ç´”ç²¹çš„ JSON æ ¼å¼ï¼Œæ²’æœ‰ä»»ä½•é¡å¤–çš„æ–‡å­—æˆ–è¨»è§£ã€‚
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        async function analyzeCreativeStrategy(context, apiKey) {
            const prompt = `
                ä½ æ˜¯ä¸€ä½è³‡æ·±çš„å‰µæ„ç­–ç•¥ç¸½ç›£ï¼Œå°ˆé–€è¦åŠƒå‰µæ–°ä¸”æœ‰å½±éŸ¿åŠ›çš„å‰µæ„ç­–ç•¥ã€‚è«‹é‡å°ä»¥ä¸‹æƒ…å¢ƒé€²è¡Œå‰µæ„ç­–ç•¥åˆ†æï¼š

                **å®¢æˆ¶æƒ…å¢ƒ:**
                - **ç›®æ¨™å“ç‰Œ:** ${context.target}
                - **ç”¢æ¥­:** ${context.industry} (${context.industryStatus})
                - **å•†æ¥­æ¨¡å¼:** ${context.businessModel}
                - **ç›®æ¨™äººç¾¤:** ${context.targetAudience}
                - **å»£å‘Šç›®æ¨™:** ${context.adObjective}
                - **å»£å‘Šå½¢å¼:** ${context.aiRecommendMedia ? 'AIå»ºè­°' : context.selectedMedia.join(', ')}
                - **ç«¶çˆ­å°æ‰‹:** ${context.competitors}

                **å‰µæ„ç­–ç•¥è¦æ±‚ï¼š**
                - å¾å“ç‰Œæ•…äº‹è§’åº¦ï¼šå¦‚ä½•è¬›è¿°å‹•äººçš„å“ç‰Œæ•…äº‹
                - å¾æƒ…æ„Ÿé€£çµè§’åº¦ï¼šå¦‚ä½•å»ºç«‹æ·±å±¤çš„æƒ…æ„Ÿå…±é³´
                - å¾å‰µæ„è¡¨ç¾è§’åº¦ï¼šå¦‚ä½•å‰µé€ ä»¤äººå°è±¡æ·±åˆ»çš„è¦–è¦ºèˆ‡æ–‡æ¡ˆ
                - å¾äº’å‹•é«”é©—è§’åº¦ï¼šå¦‚ä½•è¨­è¨ˆåƒèˆ‡æ„Ÿå¼·çš„äº’å‹•é«”é©—
                - å¾æ–‡åŒ–æ´å¯Ÿè§’åº¦ï¼šå¦‚ä½•èå…¥åœ¨åœ°æ–‡åŒ–å…ƒç´ 
                - å¾è¶¨å‹¢å‰µæ–°è§’åº¦ï¼šå¦‚ä½•é‹ç”¨æœ€æ–°å‰µæ„è¶¨å‹¢
                - å¾å·®ç•°åŒ–è§’åº¦ï¼šå¦‚ä½•èˆ‡ç«¶çˆ­å°æ‰‹å€éš”

                **è«‹åƒè€ƒå‰µæ„ç”¢æ¥­çš„æœ€æ–°è¶¨å‹¢ï¼š**
                - å…¨çƒå‰µæ„çé …çš„å¾—çæ¡ˆä¾‹
                - ç—…æ¯’å¼å‚³æ’­çš„å‰µæ„è¡¨ç¾
                - å„åª’é«”æ¸ é“çš„å‰µæ„ç‰¹è‰²
                - æˆåŠŸèˆ‡å¤±æ•—çš„å‰µæ„æ¡ˆä¾‹

                ä½ çš„ä»»å‹™æ˜¯ç”¢å‡ºä¸€å€‹ JSON ç‰©ä»¶ï¼ŒåŒ…å«ä»¥ä¸‹ keyï¼š
                "creative_concept", "visual_strategy", "copy_strategy", "interaction_design", "cultural_elements", "trend_innovation", "execution_plan"ã€‚

                - **creative_concept:** æ ¸å¿ƒå‰µæ„æ¦‚å¿µèˆ‡æ•…äº‹ç·š
                - **visual_strategy:** è¦–è¦ºç­–ç•¥èˆ‡è¨­è¨ˆæ–¹å‘
                - **copy_strategy:** æ–‡æ¡ˆç­–ç•¥èˆ‡æºé€šè¨Šæ¯
                - **interaction_design:** äº’å‹•é«”é©—è¨­è¨ˆ
                - **cultural_elements:** æ–‡åŒ–å…ƒç´ èå…¥
                - **trend_innovation:** è¶¨å‹¢å‰µæ–°æ‡‰ç”¨
                - **execution_plan:** åŸ·è¡Œè¨ˆç•«èˆ‡æ™‚ç¨‹

                è«‹ç¢ºä¿å›å‚³çš„å…§å®¹æ˜¯ç´”ç²¹çš„ JSON æ ¼å¼ï¼Œæ²’æœ‰ä»»ä½•é¡å¤–çš„æ–‡å­—æˆ–è¨»è§£ã€‚
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        // --- Module 3: ææ¡ˆç”Ÿæˆå¼•æ“ ('åˆæˆå¼•æ“') ---
        async function synthesizeFinalReport(context, forumAnalysis, seoAnalysis, kpiEstimation, industrySentiment, budgetFeasibility, multiMarketStrategy, localizationStrategy, competitorAnalysis, marketingCalendar, creativeStrategy, apiKey) {
            try {
                // æ•¸æ“šé©—è­‰å’Œé è¨­å€¼è™•ç†
                const validatedData = {
                    forumAnalysis: forumAnalysis || {},
                    seoAnalysis: seoAnalysis || {},
                    kpiEstimation: kpiEstimation || {},
                    industrySentiment: industrySentiment || {},
                    budgetFeasibility: budgetFeasibility || {},
                    multiMarketStrategy: multiMarketStrategy || {},
                    localizationStrategy: localizationStrategy || {},
                    competitorAnalysis: competitorAnalysis || {},
                    marketingCalendar: marketingCalendar || {},
                    creativeStrategy: creativeStrategy || {}
                };

                // æª¢æŸ¥é—œéµæ•¸æ“šæ˜¯å¦å­˜åœ¨
                const missingData = [];
                if (!validatedData.forumAnalysis || Object.keys(validatedData.forumAnalysis).length === 0) {
                    missingData.push('å“ç‰Œè¼¿æƒ…åˆ†æ');
                }
                if (!validatedData.seoAnalysis || Object.keys(validatedData.seoAnalysis).length === 0) {
                    missingData.push('SEO èˆ‡å…§å®¹ç­–ç•¥åˆ†æ');
                }
                if (!validatedData.kpiEstimation || Object.keys(validatedData.kpiEstimation).length === 0) {
                    missingData.push('é ç®—èˆ‡ KPI é ä¼°');
                }

                // å¦‚æœç¼ºå°‘å¤ªå¤šé—œéµæ•¸æ“šï¼Œæä¾›è­¦å‘Š
                let dataWarning = '';
                if (missingData.length > 0) {
                    dataWarning = `
**æ•¸æ“šç¼ºå¤±è­¦å‘Šï¼š**
ç³»çµ±æª¢æ¸¬åˆ°ä»¥ä¸‹åˆ†ææ•¸æ“šç¼ºå¤±ï¼š${missingData.join('ã€')}ã€‚
è«‹æ ¹æ“šå¯ç”¨çš„æ•¸æ“šé€²è¡Œåˆ†æï¼Œå°æ–¼ç¼ºå¤±çš„éƒ¨åˆ†ï¼Œè«‹æä¾›åŸºæ–¼ç”¢æ¥­ç¶“é©—çš„ä¸€èˆ¬æ€§å»ºè­°ã€‚
`;
                }

                const prompt = `
                ä½ æ˜¯ä¸€ä½é¦–å¸­åª’é«”ç­–ç•¥ç¸½ç›£ï¼Œå…·å‚™ç­–ç•¥æ€è€ƒçš„é«˜åº¦èˆ‡å­¸ç¿’èƒ½åŠ›ã€‚ä½ çš„ä»»å‹™æ˜¯å°‡ä¸‹å±¬åˆ†æå¸«æäº¤çš„æ‰€æœ‰ JSON è³‡æ–™ï¼Œæ•´åˆæˆä¸€ä»½çµ¦å®¢æˆ¶çœ‹çš„ã€å°ˆæ¥­ä¸”æœ‰èªªæœåŠ›çš„ã€Œå¸‚å ´æ©Ÿæœƒèˆ‡åˆæ­¥ç­–ç•¥å»ºè­°ã€å ±å‘Šã€‚å ±å‘Šéœ€ä»¥ HTML æ ¼å¼å‘ˆç¾ã€‚

                **å®¢æˆ¶è³‡æ–™:**
                - **ç›®æ¨™å“ç‰Œ:** ${context.target}
                - **æ ¸å¿ƒç›®æ¨™äººç¾¤:** ${context.targetAudience}
                - **å“ç‰Œè¡ŒéŠ·å•é¡Œ:** ${context.marketingProblems}
                - **ç¸½é ç®— (TWD):** ${context.budget > 0 ? context.budget.toLocaleString() : 'æœªæä¾›'}
                - **å»£å‘Šç›®æ¨™èˆ‡ç›®çš„:** ${context.adObjective}
                - **å»£å‘Šå½¢å¼:** ${context.aiRecommendMedia ? 'AIå»ºè­°' : context.selectedMedia.join(', ')}
                - **ç›®æ¨™å¸‚å ´:** ${context.targetMarkets}
                - **ç›®æ¨™èªè¨€:** ${context.targetLanguages}
                - **è¡ŒéŠ·æœŸé–“:** ${context.startDate} è‡³ ${context.endDate}
                - **ç”¢æ¥­ç‹€æ…‹:** ${context.industryStatus}

                ${dataWarning}

                **åˆ†æå¸«æäº¤çš„è³‡æ–™:**
                1.  **å“ç‰Œè¼¿æƒ…åˆ†æ:** ${JSON.stringify(validatedData.forumAnalysis, null, 2)}
                2.  **ç”¢æ¥­è¼¿æƒ…ç›£æ¸¬:** ${JSON.stringify(validatedData.industrySentiment, null, 2)}
                3.  **SEO èˆ‡å…§å®¹ç­–ç•¥åˆ†æ:** ${JSON.stringify(validatedData.seoAnalysis, null, 2)}
                4.  **é ç®—èˆ‡ KPI é ä¼°:** ${JSON.stringify(validatedData.kpiEstimation, null, 2)}
                5.  **é ç®—å¯è¡Œæ€§åˆ†æ:** ${JSON.stringify(validatedData.budgetFeasibility, null, 2)}
                6.  **å¤šå¸‚å ´ç­–ç•¥åˆ†æ:** ${JSON.stringify(validatedData.multiMarketStrategy, null, 2)}
                7.  **åœ¨åœ°åŒ–ç­–ç•¥åˆ†æ:** ${JSON.stringify(validatedData.localizationStrategy, null, 2)}
                8.  **ç«¶çˆ­å°æ‰‹åˆ†æ:** ${JSON.stringify(validatedData.competitorAnalysis, null, 2)}
                9.  **è¡ŒéŠ·è¡Œäº‹æ›†åˆ†æ:** ${JSON.stringify(validatedData.marketingCalendar, null, 2)}
                10. **å‰µæ„ç­–ç•¥åˆ†æ:** ${JSON.stringify(validatedData.creativeStrategy, null, 2)}

                **é‡è¦è™•ç†åŸå‰‡ï¼š**
                - å¦‚æœæŸå€‹æ•¸æ“šæ¬„ä½ç‚ºç©ºæˆ– nullï¼Œè«‹ä¸è¦é¡¯ç¤ºã€Œå› è³‡æ–™ç¼ºå¤±ï¼Œæ­¤è™•ç„¡æ³•å‘ˆç¾ã€çš„è¨Šæ¯
                - å°æ–¼ç¼ºå¤±çš„æ•¸æ“šï¼Œè«‹åŸºæ–¼ç”¢æ¥­ç¶“é©—å’Œå¸¸è­˜æä¾›åˆç†çš„æ¨æ¸¬æˆ–ä¸€èˆ¬æ€§å»ºè­°
                - ç¢ºä¿å ±å‘Šçš„å®Œæ•´æ€§å’Œå°ˆæ¥­æ€§ï¼Œä¸è¦å› ç‚ºæ•¸æ“šç¼ºå¤±è€Œå½±éŸ¿å ±å‘Šçš„çµæ§‹
                - å¦‚æœ kpiEstimation.rationale æˆ– kpiEstimation.feasibility_warning ç­‰æ¬„ä½ç¼ºå¤±ï¼Œè«‹æä¾›åŸºæ–¼é ç®—å’Œç›®æ¨™çš„åˆç†åˆ†æ

                **ç­–ç•¥æ€è€ƒæ¡†æ¶ï¼š**
                - å¾å“ç‰Œç­–ç•¥è§’åº¦ï¼šå¦‚ä½•å»ºç«‹é•·æœŸå“ç‰Œè³‡ç”¢ã€å¸‚å ´å®šä½
                - å¾ç«¶çˆ­ç­–ç•¥è§’åº¦ï¼šå¦‚ä½•åœ¨ç«¶çˆ­ä¸­è„«ç©è€Œå‡ºã€å»ºç«‹è­·åŸæ²³
                - å¾å­¸ç¿’è§’åº¦ï¼šå¾æˆåŠŸæ¡ˆä¾‹ä¸­å­¸ç¿’ã€é¿å…å¤±æ•—é™·é˜±
                - å¾å‰µæ–°è§’åº¦ï¼šæ–°èˆˆæ©Ÿæœƒã€æœªä¾†è¶¨å‹¢ã€é¡›è¦†æ€§æ€ç¶­
                - å¾å¯è¡Œæ€§è§’åº¦ï¼šé ç®—èˆ‡ç›®æ¨™çš„åŒ¹é…åº¦ï¼Œæä¾›å‹™å¯¦å»ºè­°
                - å¾åœ‹éš›åŒ–è§’åº¦ï¼šè·¨å¸‚å ´å“ç‰Œä¸€è‡´æ€§èˆ‡åœ¨åœ°åŒ–å¹³è¡¡
                - **å¾å‰µæ„è§’åº¦ï¼šå¦‚ä½•å‰µé€ ä»¤äººå°è±¡æ·±åˆ»çš„å“ç‰Œé«”é©—**

                **ä½ çš„ä»»å‹™:**
                è«‹æ ¹æ“šä»¥ä¸Šæ‰€æœ‰è³‡è¨Šï¼Œæ’°å¯«ä¸€ä»½åŒ…å«ä»¥ä¸‹ç« ç¯€çš„ HTML å ±å‘Šï¼Œä¸¦åœ¨ä½ çš„åˆ†æèˆ‡å»ºè­°ä¸­ï¼Œ**å§‹çµ‚ç·Šæ‰£å¦‚ä½•æ‰“å‹•ã€Œ${context.targetAudience}ã€é€™å€‹æ ¸å¿ƒç›®æ¨™äººç¾¤**ï¼Œä¸¦å¼·èª¿ï¼š
                - ç«¶å“åª’é«”ç­–ç•¥ã€å‰µæ„è¡¨ç¾ã€æœ€æ–°å¸‚å ´å‹•æ…‹
                - å‰µæ„è¶¨å‹¢èˆ‡æ¶ˆè²»è€…è¡Œç‚ºè®ŠåŒ–
                - åƒè€ƒå¯æŸ¥è©¢çš„å¸‚å ´æˆæ•ˆæ•¸æ“š
                - æ ¹æ“šå»£å‘Šç›®æ¨™èˆ‡ç›®çš„ï¼Œèª¿æ•´æ¯ä¸€ç« ç¯€çš„é‡é»èˆ‡å»ºè­°
                - å¾ç­–ç•¥é«˜åº¦æä¾›é•·æœŸç™¼å±•å»ºè­°
                - å¾å­¸ç¿’è§’åº¦ç¸½çµæœ€ä½³å¯¦è¸
                - ç”¢æ¥­è¼¿æƒ…ç‹€æ³èˆ‡æ©Ÿæœƒé»
                - é ç®—å¯è¡Œæ€§èˆ‡å‹™å¯¦å»ºè­°
                - å¤šå¸‚å ´ç­–ç•¥èˆ‡åœ¨åœ°åŒ–è€ƒé‡
                - **ç«¶çˆ­å°æ‰‹æ·±åº¦åˆ†æèˆ‡å·®ç•°åŒ–ç­–ç•¥**
                - **è¡ŒéŠ·æ™‚ç¨‹è¦åŠƒèˆ‡ç†±é»äº‹ä»¶æ•´åˆ**
                - **å‰µæ„ç­–ç•¥èˆ‡å“ç‰Œé«”é©—è¨­è¨ˆ**

                1.  **<h2>å¸‚å ´ç¸½é«”å°è±¡</h2>**
                    - ä¸€æ®µç°¡çŸ­ç¸½çµï¼Œé»å‡º ${context.target} ç›®å‰åœ¨ã€Œ${context.targetAudience}ã€å¿ƒä¸­çš„å½¢è±¡èˆ‡æŒ‘æˆ°ã€‚

                2.  **<h2>ç”¢æ¥­è¼¿æƒ…ç›£æ¸¬</h2>**
                    -   <h3>ç”¢æ¥­æ¦‚æ³</h3>
                    -   <h3>ç†±é–€è©±é¡Œèˆ‡è¶¨å‹¢</h3>
                    -   <h3>ç«¶çˆ­å“ç‰Œè¼¿æƒ…è¡¨ç¾</h3>
                    -   <h3>æ¶ˆè²»è€…æ´å¯Ÿ</h3>

                3.  **<h2>ç«¶çˆ­å°æ‰‹æ·±åº¦åˆ†æ</h2>**
                    -   <h3>ç«¶çˆ­å°æ‰‹å“ç‰Œåˆ†æ</h3>
                    -   <h3>å¸‚å ´å®šä½æ¯”è¼ƒ</h3>
                    -   <h3>åª’é«”ç­–ç•¥åˆ†æ</h3>
                    -   <h3>å·®ç•°åŒ–æ©Ÿæœƒé»</h3>

                4.  **<h2>å¤šå¸‚å ´ç­–ç•¥åˆ†æ</h2>**
                    -   <h3>ç›®æ¨™å¸‚å ´åˆ†æ</h3>
                    -   <h3>è·¨å¸‚å ´é ç®—åˆ†é…</h3>
                    -   <h3>åœ¨åœ°åŒ–ç­–ç•¥å»ºè­°</h3>
                    -   <h3>æ–‡åŒ–è€ƒé‡èˆ‡é¢¨éšªç®¡ç†</h3>

                5.  **<h2>æ ¸å¿ƒæ´å¯Ÿèˆ‡æ©Ÿæœƒé»</h2>**
                    -   <h3>æ´å¯Ÿä¸€ï¼šç›®æ¨™äººç¾¤çš„çœŸå¯¦å¿ƒè²</h3>
                    -   <h3>æ´å¯ŸäºŒï¼šæœå°‹æˆ°å ´çš„å…§å®¹ç¼ºå£</h3>
                    -   <h3>æ´å¯Ÿä¸‰ï¼šç”¢æ¥­è¼¿æƒ…æ©Ÿæœƒé»</h3>
                    -   <h3>æ´å¯Ÿå››ï¼šç«¶çˆ­å°æ‰‹æ©Ÿæœƒé»</h3>
                    -   <h3>æ´å¯Ÿäº”ï¼šè·¨å¸‚å ´æ©Ÿæœƒé»</h3>
                    -   <h3>ç­–ç•¥æ©Ÿæœƒé»ï¼šæˆ‘å€‘è©²å¾ä½•è™•åˆ‡å…¥ï¼Ÿ</h3>

                6.  **<h2>é ç®—å¯è¡Œæ€§è©•ä¼°</h2>**
                    -   <h3>å¯è¡Œæ€§è©•ä¼°</h3>
                    -   <h3>é ç®—å»ºè­°</h3>
                    -   <h3>æ›¿ä»£ç­–ç•¥</h3>
                    -   <h3>é¢¨éšªåˆ†æ</h3>

                7.  **<h2>å‰µæ„ç­–ç•¥è¦åŠƒ</h2>**
                    -   <h3>æ ¸å¿ƒå‰µæ„æ¦‚å¿µ</h3>
                    -   <h3>è¦–è¦ºèˆ‡æ–‡æ¡ˆç­–ç•¥</h3>
                    -   <h3>äº’å‹•é«”é©—è¨­è¨ˆ</h3>
                    -   <h3>æ–‡åŒ–å…ƒç´ èå…¥</h3>
                    -   <h3>è¶¨å‹¢å‰µæ–°æ‡‰ç”¨</h3>

                8.  **<h2>è¡ŒéŠ·æ™‚ç¨‹è¦åŠƒ</h2>**
                    -   <h3>ç†±é»äº‹ä»¶åˆ†æ</h3>
                    -   <h3>åˆä½œæ©Ÿæœƒè­˜åˆ¥</h3>
                    -   <h3>æœ€ä½³æ™‚æ©Ÿå»ºè­°</h3>
                    -   <h3>é¢¨éšªç®¡ç†</h3>

                9.  **<h2>åˆæ­¥ç­–ç•¥å»ºè­°</h2>**
                    -   <h3>å»ºè­°ä¸€ï¼šå…§å®¹ç­–ç•¥æ–¹å‘</h3>
                    -   <h3>å»ºè­°äºŒï¼šæºé€šè¨Šæ¯åˆ‡è§’</h3>
                    -   <h3>å»ºè­°ä¸‰ï¼šå‰µæ„èˆ‡åª’é«”å»ºè­°ï¼ˆè«‹æ ¹æ“šæœ€æ–°å¸‚å ´è¶¨å‹¢èˆ‡ç«¶å“ç­–ç•¥ï¼‰</h3>
                    -   <h3>å»ºè­°å››ï¼šå¤šå¸‚å ´åŸ·è¡Œç­–ç•¥</h3>
                    -   <h3>å»ºè­°äº”ï¼šåœ¨åœ°åŒ–èˆ‡æ–‡åŒ–é©æ‡‰</h3>
                    -   <h3>å»ºè­°å…­ï¼šç«¶çˆ­ç­–ç•¥èˆ‡å·®ç•°åŒ–</h3>
                    -   <h3>å»ºè­°ä¸ƒï¼šæ™‚ç¨‹è¦åŠƒèˆ‡åŸ·è¡Œ</h3>
                    -   <h3>å»ºè­°å…«ï¼šé•·æœŸç­–ç•¥æ€è€ƒï¼ˆå¾å“ç‰Œç™¼å±•ã€ç«¶çˆ­å„ªå‹¢è§’åº¦ï¼‰</h3>
                    -   <h3>å»ºè­°ä¹ï¼šé ç®—å„ªåŒ–ç­–ç•¥ï¼ˆå¦‚ä½•åœ¨æœ‰é™é ç®—ä¸‹æœ€å¤§åŒ–æ•ˆç›Šï¼‰</h3>
                
                10. **<h2>é ç®—è¦åŠƒèˆ‡é æœŸæ•ˆç›Š</h2>**
                    -   <p>åŸºæ–¼å°å¹£ **${context.budget > 0 ? context.budget.toLocaleString() : 'æœªæä¾›'}** çš„é ç®—ï¼Œæˆ‘å€‘å»ºè­°åˆæ­¥çš„è³‡æºåˆ†é…èˆ‡æ•ˆç›Šé ä¼°å¦‚ä¸‹ï¼š</p>
                    -   <h3>è·¨å¸‚å ´é ç®—åˆ†é…</h3>
                    -   (å¦‚æœ multiMarketStrategy.budget_allocation å­˜åœ¨ï¼Œä½¿ç”¨ HTML table å‘ˆç¾ï¼›å¦å‰‡æä¾›ä¸€èˆ¬æ€§é ç®—åˆ†é…å»ºè­°)
                    -   <h3>é ç®—åˆ†é…å»ºè­°</h3>
                    -   (å¦‚æœ kpiEstimation.budget_allocation å­˜åœ¨ï¼Œä½¿ç”¨ HTML table å‘ˆç¾ï¼›å¦å‰‡æä¾›åŸºæ–¼é ç®—çš„ä¸€èˆ¬æ€§åˆ†é…å»ºè­°)
                    -   <h3>é æœŸæ•ˆç›Š (KPI) ä¼°ç®—</h3>
                    -   (å¦‚æœ kpiEstimation.kpi_estimations å­˜åœ¨ï¼Œä½¿ç”¨ HTML table å‘ˆç¾ï¼›å¦å‰‡æä¾›åŸºæ–¼é ç®—å’Œç›®æ¨™çš„ä¸€èˆ¬æ€§æ•ˆç›Šé ä¼°)
                    -   <h3>è¦åŠƒèªªæ˜</h3>
                    -   (å¦‚æœ kpiEstimation.rationale å­˜åœ¨ï¼Œç”¨ <p> å‘ˆç¾ï¼›å¦å‰‡æä¾›åŸºæ–¼é ç®—å’Œç›®æ¨™çš„è¦åŠƒèªªæ˜)
                    -   <h3>å¯è¡Œæ€§è­¦å‘Š</h3>
                    -   (å¦‚æœ kpiEstimation.feasibility_warning å­˜åœ¨ï¼Œç”¨ <p> å‘ˆç¾ï¼›å¦å‰‡æä¾›åŸºæ–¼é ç®—çš„å¯è¡Œæ€§è©•ä¼°)
                    -   <h3>é ç®—å„ªåŒ–å»ºè­°</h3>
                    -   (å¦‚æœ kpiEstimation.budget_optimization å­˜åœ¨ï¼Œç”¨ <ul> å‘ˆç¾ï¼›å¦å‰‡æä¾›ä¸€èˆ¬æ€§é ç®—å„ªåŒ–å»ºè­°)
                    -   <h3>åƒè€ƒæ•¸æ“š</h3>
                    -   (å¦‚æœ kpiEstimation.reference_data æˆ– forumAnalysis.reference_data å­˜åœ¨ï¼Œç”¨ <ul> å‘ˆç¾ï¼›å¦å‰‡æä¾›ç”¢æ¥­ä¸€èˆ¬æ€§åƒè€ƒæ•¸æ“š)
                    -   <h3>ç­–ç•¥å»ºè­°</h3>
                    -   (å¦‚æœ kpiEstimation.strategic_recommendations å­˜åœ¨ï¼Œç”¨ <ul> å‘ˆç¾ï¼›å¦å‰‡æä¾›åŸºæ–¼é ç®—å’Œç›®æ¨™çš„ç­–ç•¥å»ºè­°)
                    -   <h3>å­¸ç¿’æ´å¯Ÿ</h3>
                    -   (å¦‚æœ kpiEstimation.learning_insights æˆ– forumAnalysis.learning_cases å­˜åœ¨ï¼Œç”¨ <ul> å‘ˆç¾ï¼›å¦å‰‡æä¾›åŸºæ–¼ç”¢æ¥­ç¶“é©—çš„å­¸ç¿’æ´å¯Ÿ)
                
                **æ ¼å¼è¦æ±‚:**
                -   è«‹åš´æ ¼ä½¿ç”¨ <h2> å’Œ <h3> ä½œç‚ºæ¨™é¡Œã€‚
                -   æ®µè½ä½¿ç”¨ <p>ï¼Œåˆ—è¡¨ä½¿ç”¨ <ul> å’Œ <li>ã€‚è¡¨æ ¼ä½¿ç”¨ <table>, <th>, <tr>, <td>ã€‚
                -   å°æ–¼å“ç‰Œåç¨±æˆ–é—œéµå­—è©ï¼Œä½¿ç”¨ <strong> æ¨™ç±¤å¼·èª¿ã€‚
                -   å›æ‡‰å…§å®¹**åƒ…åŒ…å« HTML**ï¼Œä¸è¦åŒ…å« \`\`\`html, \`\`\`, <html>, <body> ç­‰æ¨™ç±¤ã€‚
                -   **çµ•å°ä¸è¦é¡¯ç¤ºã€Œå› è³‡æ–™ç¼ºå¤±ï¼Œæ­¤è™•ç„¡æ³•å‘ˆç¾ã€ä¹‹é¡çš„è¨Šæ¯**ï¼Œè«‹æä¾›åˆç†çš„æ›¿ä»£å…§å®¹ã€‚
            `;
                
                console.log('é–‹å§‹ç”Ÿæˆæœ€çµ‚å ±å‘Š...');
                const result = await callGeminiAPI(prompt, apiKey, false);
                console.log('æœ€çµ‚å ±å‘Šç”Ÿæˆå®Œæˆ');
                return result;
                
            } catch (error) {
                console.error('ç”Ÿæˆæœ€çµ‚å ±å‘Šæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                
                // æä¾›éŒ¯èª¤å›é€€æ–¹æ¡ˆ
                return `
                    <div class="p-6 bg-red-50 border border-red-200 rounded-lg">
                        <h2 class="text-xl font-bold text-red-800 mb-4">å ±å‘Šç”Ÿæˆå¤±æ•—</h2>
                        <p class="text-red-700 mb-4">æŠ±æ­‰ï¼Œåœ¨ç”Ÿæˆæœ€çµ‚å ±å‘Šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}</p>
                        <div class="bg-white p-4 rounded border">
                            <h3 class="font-semibold text-gray-800 mb-2">å¯ç”¨çš„åˆ†ææ•¸æ“šï¼š</h3>
                            <ul class="text-sm text-gray-600 space-y-1">
                                <li>â€¢ å“ç‰Œè¼¿æƒ…åˆ†æï¼š${forumAnalysis ? 'âœ“ å¯ç”¨' : 'âœ— ç¼ºå¤±'}</li>
                                <li>â€¢ SEO èˆ‡å…§å®¹ç­–ç•¥ï¼š${seoAnalysis ? 'âœ“ å¯ç”¨' : 'âœ— ç¼ºå¤±'}</li>
                                <li>â€¢ é ç®—èˆ‡ KPI é ä¼°ï¼š${kpiEstimation ? 'âœ“ å¯ç”¨' : 'âœ— ç¼ºå¤±'}</li>
                                <li>â€¢ ç”¢æ¥­è¼¿æƒ…ç›£æ¸¬ï¼š${industrySentiment ? 'âœ“ å¯ç”¨' : 'âœ— ç¼ºå¤±'}</li>
                                <li>â€¢ é ç®—å¯è¡Œæ€§åˆ†æï¼š${budgetFeasibility ? 'âœ“ å¯ç”¨' : 'âœ— ç¼ºå¤±'}</li>
                            </ul>
                        </div>
                        <p class="mt-4 text-sm text-red-600">è«‹æª¢æŸ¥ API é€£æ¥ç‹€æ…‹ï¼Œç„¶å¾Œé‡æ–°ç”Ÿæˆå ±å‘Šã€‚</p>
                    </div>
                `;
            }
        }

        function generatePositioningChart(forumAnalysis, industrySentiment) {
            try {
                const chartContainer = document.getElementById('positioningChartContainer');
                const canvas = document.getElementById('positioningChart');
                
                if (!chartContainer || !canvas) {
                    console.error('æ‰¾ä¸åˆ°åœ–è¡¨å®¹å™¨æˆ– canvas å…ƒç´ ');
                    return;
                }
                
                // é¡¯ç¤ºåœ–è¡¨å®¹å™¨
                chartContainer.style.display = 'block';
                
                // éŠ·æ¯€ç¾æœ‰çš„åœ–è¡¨å¯¦ä¾‹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (window.positioningChartInstance) {
                    try {
                        window.positioningChartInstance.destroy();
                    } catch (destroyError) {
                        console.warn('éŠ·æ¯€èˆŠåœ–è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤:', destroyError);
                    }
                }
                
                // é©—è­‰è¼¸å…¥åƒæ•¸
                if (!forumAnalysis) {
                    console.warn('forumAnalysis åƒæ•¸ç‚ºç©ºï¼Œä½¿ç”¨é è¨­å€¼');
                    forumAnalysis = {};
                }
                
                // è§£æå®šä½æ•¸æ“š
                const targetPositioning = forumAnalysis.positioning_analysis || {
                    price_position: 5,
                    quality_position: 5,
                    innovation_position: 5,
                    target_audience_position: 5,
                    brand_personality: 5
                };
                
                // å‰µå»ºç«¶çˆ­å°æ‰‹å®šä½æ•¸æ“šï¼ˆåŸºæ–¼åˆ†æçµæœæ¨æ¸¬ï¼‰
                const competitorPositioning = {
                    price_position: Math.max(1, Math.min(10, targetPositioning.price_position + (Math.random() - 0.5) * 4)),
                    quality_position: Math.max(1, Math.min(10, targetPositioning.quality_position + (Math.random() - 0.5) * 4)),
                    innovation_position: Math.max(1, Math.min(10, targetPositioning.innovation_position + (Math.random() - 0.5) * 4)),
                    target_audience_position: Math.max(1, Math.min(10, targetPositioning.target_audience_position + (Math.random() - 0.5) * 4)),
                    brand_personality: Math.max(1, Math.min(10, targetPositioning.brand_personality + (Math.random() - 0.5) * 4))
                };
                
                // æº–å‚™åœ–è¡¨æ•¸æ“š
                const labels = ['åƒ¹æ ¼å®šä½', 'å“è³ªå®šä½', 'å‰µæ–°ç¨‹åº¦', 'ç›®æ¨™äººç¾¤', 'å“ç‰Œå€‹æ€§'];
                const targetData = [
                    targetPositioning.price_position,
                    targetPositioning.quality_position,
                    targetPositioning.innovation_position,
                    targetPositioning.target_audience_position,
                    targetPositioning.brand_personality
                ];
                const competitorData = [
                    competitorPositioning.price_position,
                    competitorPositioning.quality_position,
                    competitorPositioning.innovation_position,
                    competitorPositioning.target_audience_position,
                    competitorPositioning.brand_personality
                ];
                
                // å‰µå»ºé›·é”åœ–
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.error('ç„¡æ³•ç²å– canvas 2D ä¸Šä¸‹æ–‡');
                    return;
                }
                
                window.positioningChartInstance = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'ç›®æ¨™å“ç‰Œ',
                                data: targetData,
                                backgroundColor: 'rgba(79, 70, 229, 0.2)',
                                borderColor: 'rgba(79, 70, 229, 1)',
                                borderWidth: 2,
                                pointBackgroundColor: 'rgba(79, 70, 229, 1)',
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: 'rgba(79, 70, 229, 1)'
                            },
                            {
                                label: 'ç«¶çˆ­å°æ‰‹',
                                data: competitorData,
                                backgroundColor: 'rgba(239, 68, 68, 0.2)',
                                borderColor: 'rgba(239, 68, 68, 1)',
                                borderWidth: 2,
                                pointBackgroundColor: 'rgba(239, 68, 68, 1)',
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: 'rgba(239, 68, 68, 1)'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 10,
                                min: 0,
                                ticks: {
                                    stepSize: 2
                                },
                                pointLabels: {
                                    font: {
                                        size: 12,
                                        family: 'Noto Sans TC'
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    font: {
                                        family: 'Noto Sans TC'
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: 'å“ç‰Œå®šä½é›·é”åœ–',
                                font: {
                                    size: 16,
                                    family: 'Noto Sans TC'
                                }
                            }
                        }
                    }
                });
                
                console.log('å“ç‰Œå®šä½é›·é”åœ–ç”ŸæˆæˆåŠŸ');
                
            } catch (error) {
                console.error('ç”Ÿæˆå“ç‰Œå®šä½é›·é”åœ–æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                // éš±è—åœ–è¡¨å®¹å™¨ä»¥é¿å…é¡¯ç¤ºéŒ¯èª¤
                const chartContainer = document.getElementById('positioningChartContainer');
                if (chartContainer) {
                    chartContainer.style.display = 'none';
                }
            }
        }

        // --- ä¸»åŸ·è¡Œæµç¨‹ ---
        async function handleGenerateClick() {
            const userApiKey = apiKeyInput.value.trim();
            if (!userApiKey) {
                alert('è«‹è¼¸å…¥æ‚¨çš„ Google Gemini API Key');
                return;
            }

            // é‡ç½®é€²åº¦
            currentStep = 0;
            updateProgress(0, 'æº–å‚™é–‹å§‹åˆ†æ...');
            updateAPIStatus('warning', 'æ­£åœ¨æ¸¬è©¦ API é€£æ¥...');

            // æ¸¬è©¦ API é€£æ¥
            try {
                const apiTest = await testAPI(userApiKey);
                if (apiTest) {
                    updateAPIStatus('success', 'API é€£æ¥æˆåŠŸ');
                    apiTestResult = true;
                } else {
                    updateAPIStatus('error', 'API é€£æ¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key');
                    apiTestResult = false;
                    return;
                }
            } catch (error) {
                updateAPIStatus('error', 'API æ¸¬è©¦å¤±æ•—: ' + error.message);
                apiTestResult = false;
                return;
            }

            // ç²å–è¡¨å–®æ•¸æ“š
            const target = targetBrandInput.value.trim();
            const industry = industryInput.value;
            const industryStatus = industryStatusInput.value;
            const businessModel = businessModelInput.value;
            const targetAudience = targetAudienceInput.value.trim() || 'æœªæŒ‡å®š';
            const marketingProblems = document.getElementById('marketingProblems').value.trim() || 'æœªæä¾›';
            const budget = parseInt(advertisingBudgetInput.value, 10) || 0;
            const adObjective = adObjectiveInput.value;
            const aiRecommendMedia = aiRecommendMediaInput.checked;
            const selectedMedia = Array.from(mediaSelectionDiv.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
            const competitors = competitorsInput.value;
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            const targetMarkets = targetMarketsInput.value;
            const targetLanguages = targetLanguagesInput.value;

            // é©—è­‰å¿…å¡«æ¬„ä½
            if (!target || !industry || !industryStatus || !businessModel || !targetAudience || !adObjective) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
                return;
            }

            if (!aiRecommendMedia && selectedMedia.length === 0) {
                alert('è«‹é¸æ“‡å»£å‘Šå½¢å¼æˆ–å‹¾é¸ AI å»ºè­°');
                return;
            }

            const analysisContext = {
                target: target,
                industry: industry,
                industryStatus: industryStatus,
                businessModel: businessModel,
                targetAudience: targetAudience,
                marketingProblems: marketingProblems,
                budget: budget,
                adObjective: adObjective,
                aiRecommendMedia: aiRecommendMedia,
                selectedMedia: selectedMedia,
                competitors: competitors,
                startDate: startDate,
                endDate: endDate,
                targetMarkets: targetMarkets,
                targetLanguages: targetLanguages
            };

            generateBtn.disabled = true;
            generateBtn.innerHTML = `AI åˆ†æä¸­...`;

            try {
                updateProgress(1, `åˆ†æ ${analysisContext.target} åœ¨ç›®æ¨™äººç¾¤ä¸­çš„è¼¿æƒ…ç‹€æ³...`);
                const forumData = await analyzeForumSentiment(analysisContext, userApiKey);
                updateAPIStatus('success', 'è¼¿æƒ…åˆ†æå®Œæˆ');

                updateProgress(2, `ç›£æ¸¬ ${analysisContext.industry} ç”¢æ¥­æ•´é«”è¼¿æƒ…...`);
                const industrySentimentData = await analyzeIndustrySentiment(analysisContext, userApiKey);
                updateAPIStatus('success', 'ç”¢æ¥­è¼¿æƒ…ç›£æ¸¬å®Œæˆ');

                updateProgress(3, `è©•ä¼°é ç®—å¯è¡Œæ€§èˆ‡ç›®æ¨™åŒ¹é…åº¦...`);
                const budgetFeasibilityData = await analyzeBudgetFeasibility(analysisContext, userApiKey);
                updateAPIStatus('success', 'é ç®—å¯è¡Œæ€§è©•ä¼°å®Œæˆ');

                updateProgress(4, `åˆ†æç«¶çˆ­å°æ‰‹ç­–ç•¥èˆ‡å¸‚å ´å®šä½...`);
                const competitorData = await analyzeCompetitorInsights(analysisContext, userApiKey);
                updateAPIStatus('success', 'ç«¶çˆ­å°æ‰‹åˆ†æå®Œæˆ');

                updateProgress(5, `è¦åŠƒè¡ŒéŠ·æ™‚ç¨‹èˆ‡ç†±é»äº‹ä»¶...`);
                const marketingCalendarData = await analyzeMarketingCalendar(analysisContext, userApiKey);
                updateAPIStatus('success', 'è¡ŒéŠ·æ™‚ç¨‹è¦åŠƒå®Œæˆ');

                updateProgress(6, `åˆ†æå¤šå¸‚å ´ç­–ç•¥èˆ‡é ç®—åˆ†é…...`);
                const multiMarketData = await analyzeMultiMarketStrategy(analysisContext, userApiKey);
                updateAPIStatus('success', 'å¤šå¸‚å ´ç­–ç•¥åˆ†æå®Œæˆ');

                updateProgress(7, `è¦åŠƒåœ¨åœ°åŒ–èˆ‡å¤šèªè¨€ç­–ç•¥...`);
                const localizationData = await analyzeLocalizationStrategy(analysisContext, multiMarketData, userApiKey);
                updateAPIStatus('success', 'åœ¨åœ°åŒ–ç­–ç•¥è¦åŠƒå®Œæˆ');

                updateProgress(8, `ç™¼å±•å‰µæ„ç­–ç•¥èˆ‡å“ç‰Œé«”é©—...`);
                const creativeStrategyData = await analyzeCreativeStrategy(analysisContext, userApiKey);
                updateAPIStatus('success', 'å‰µæ„ç­–ç•¥ç™¼å±•å®Œæˆ');

                updateProgress(9, `åˆ†æ ${analysisContext.target} çš„ SEO èˆ‡å…§å®¹ç­–ç•¥...`);
                const seoData = await analyzeSeoStrategy(analysisContext, userApiKey);
                updateAPIStatus('success', 'SEOç­–ç•¥åˆ†æå®Œæˆ');
                
                const opportunity = forumData.market_opportunity || seoData.content_gap_opportunity;
                
                updateProgress(10, `é€²è¡Œé ç®—è¦åŠƒèˆ‡ KPI ä¼°ç®—...`);
                const kpiData = await estimateKpiAndBudget(analysisContext, opportunity, userApiKey);
                updateAPIStatus('success', 'é ç®—è¦åŠƒå®Œæˆ');

                updateProgress(10, `ç¶œåˆæ‰€æœ‰æ´å¯Ÿï¼Œç”Ÿæˆæœ€çµ‚å ±å‘Š...`);
                const finalReportHtml = await synthesizeFinalReport(analysisContext, forumData, seoData, kpiData, industrySentimentData, budgetFeasibilityData, multiMarketData, localizationData, competitorData, marketingCalendarData, creativeStrategyData, userApiKey);
                updateAPIStatus('success', 'å ±å‘Šç”Ÿæˆå®Œæˆï¼');

                // æª¢æŸ¥è¼¸å‡ºæ ¼å¼
                const selectedFormat = document.querySelector('input[name="outputFormat"]:checked').value;
                
                if (selectedFormat === 'slides') {
                    // ç”Ÿæˆ Google Slides æ ¼å¼
                    currentSlidesData = generateGoogleSlides(analysisContext, forumData, seoData, kpiData, industrySentimentData, budgetFeasibilityData, multiMarketData, localizationData, competitorData, marketingCalendarData, creativeStrategyData);
                    renderSlides(currentSlidesData);
                } else {
                    // é¡¯ç¤º HTML å ±å‘Š
                    proposalOutput.innerHTML = finalReportHtml;
                }
                
                // ç”Ÿæˆ positioning åœ–è¡¨
                generatePositioningChart(forumData, industrySentimentData);

                // å®Œæˆå¾Œéš±è—é€²åº¦æ¢
                setTimeout(() => {
                    document.getElementById('progressContainer').classList.add('hidden');
                }, 3000);

            } catch (error) {
                console.error('ç”Ÿæˆææ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                
                // æ ¹æ“šéŒ¯èª¤é¡å‹æä¾›ä¸åŒçš„éŒ¯èª¤è¨Šæ¯å’Œå»ºè­°
                let errorMessage = error.message;
                let suggestions = '';
                
                if (error.message.includes('ç¶²è·¯é€£æ¥å·²æ–·é–‹')) {
                    errorMessage = 'ç¶²è·¯é€£æ¥å•é¡Œ';
                    suggestions = `
                        <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <h4 class="font-semibold text-yellow-800 mb-2">å»ºè­°è§£æ±ºæ–¹æ¡ˆï¼š</h4>
                            <ul class="text-sm text-yellow-700 space-y-1">
                                <li>â€¢ æª¢æŸ¥ç¶²è·¯é€£æ¥æ˜¯å¦æ­£å¸¸</li>
                                <li>â€¢ å˜—è©¦é‡æ–°æ•´ç†é é¢</li>
                                <li>â€¢ æª¢æŸ¥é˜²ç«ç‰†æˆ–ä»£ç†è¨­å®š</li>
                                <li>â€¢ ç¨å¾Œå†è©¦</li>
                            </ul>
                        </div>
                    `;
                } else if (error.message.includes('API é‡‘é‘°')) {
                    errorMessage = 'API é‡‘é‘°å•é¡Œ';
                    suggestions = `
                        <div class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                            <h4 class="font-semibold text-red-800 mb-2">å»ºè­°è§£æ±ºæ–¹æ¡ˆï¼š</h4>
                            <ul class="text-sm text-red-700 space-y-1">
                                <li>â€¢ æª¢æŸ¥ API é‡‘é‘°æ˜¯å¦æ­£ç¢º</li>
                                <li>â€¢ ç¢ºèª API é‡‘é‘°æ˜¯å¦å·²å•Ÿç”¨ Gemini API</li>
                                <li>â€¢ æª¢æŸ¥ API é‡‘é‘°æ˜¯å¦æœ‰è¶³å¤ çš„é…é¡</li>
                                <li>â€¢ å‰å¾€ <a href="https://makersuite.google.com/app/apikey" target="_blank" class="underline">Google AI Studio</a> é‡æ–°ç”Ÿæˆé‡‘é‘°</li>
                            </ul>
                        </div>
                    `;
                } else if (error.message.includes('æ‰€æœ‰æ¨¡å‹éƒ½å¤±æ•—äº†')) {
                    errorMessage = 'API æœå‹™æš«æ™‚ä¸å¯ç”¨';
                    suggestions = `
                        <div class="mt-4 p-4 bg-orange-50 border border-orange-200 rounded-lg">
                            <h4 class="font-semibold text-orange-800 mb-2">å»ºè­°è§£æ±ºæ–¹æ¡ˆï¼š</h4>
                            <ul class="text-sm text-orange-700 space-y-1">
                                <li>â€¢ Google Gemini API æœå‹™å¯èƒ½æš«æ™‚ä¸å¯ç”¨</li>
                                <li>â€¢ è«‹ç¨å¾Œå†è©¦ï¼ˆé€šå¸¸ 5-10 åˆ†é˜å¾Œæœƒæ¢å¾©ï¼‰</li>
                                <li>â€¢ æª¢æŸ¥ <a href="https://status.ai.google.dev/" target="_blank" class="underline">Google AI æœå‹™ç‹€æ…‹</a></li>
                                <li>â€¢ å¦‚æœå•é¡ŒæŒçºŒï¼Œè«‹è¯ç¹«æŠ€è¡“æ”¯æ´</li>
                            </ul>
                        </div>
                    `;
                } else if (error.message.includes('è«‹æ±‚é »ç‡éé«˜')) {
                    errorMessage = 'API è«‹æ±‚é »ç‡éé«˜';
                    suggestions = `
                        <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <h4 class="font-semibold text-blue-800 mb-2">å»ºè­°è§£æ±ºæ–¹æ¡ˆï¼š</h4>
                            <ul class="text-sm text-blue-700 space-y-1">
                                <li>â€¢ è«‹ç­‰å¾… 1-2 åˆ†é˜å¾Œå†è©¦</li>
                                <li>â€¢ æª¢æŸ¥ API é‡‘é‘°çš„ä½¿ç”¨é…é¡</li>
                                <li>â€¢ è€ƒæ…®å‡ç´š API é…é¡</li>
                            </ul>
                        </div>
                    `;
                } else {
                    suggestions = `
                        <div class="mt-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                            <h4 class="font-semibold text-gray-800 mb-2">ä¸€èˆ¬æ•…éšœæ’é™¤ï¼š</h4>
                            <ul class="text-sm text-gray-700 space-y-1">
                                <li>â€¢ é‡æ–°æ•´ç†é é¢å¾Œå†è©¦</li>
                                <li>â€¢ æª¢æŸ¥ç€è¦½å™¨ä¸»æ§å°çš„è©³ç´°éŒ¯èª¤ä¿¡æ¯</li>
                                <li>â€¢ å˜—è©¦ä½¿ç”¨ä¸åŒçš„ç€è¦½å™¨</li>
                                <li>â€¢ æ¸…é™¤ç€è¦½å™¨å¿«å–å’Œ Cookie</li>
                                <li>â€¢ å¦‚æœå•é¡ŒæŒçºŒï¼Œè«‹è¯ç¹«æŠ€è¡“æ”¯æ´</li>
                            </ul>
                        </div>
                    `;
                }
                
                updateAPIStatus('error', errorMessage);
                proposalOutput.innerHTML = `
                    <div class="p-6 bg-red-50 border border-red-200 rounded-lg">
                        <h3 class="text-lg font-bold text-red-800 mb-2">æŠ±æ­‰ï¼Œè™•ç†éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤</h3>
                        <p class="text-red-700 mb-4">éŒ¯èª¤è©³æƒ…ï¼š${error.message}</p>
                        <p class="text-sm text-red-600 mb-4">è«‹æª¢æŸ¥ç€è¦½å™¨çš„ä¸»æ§å°ä»¥ç²å–è©³ç´°æŠ€è¡“è³‡è¨Šï¼Œç„¶å¾Œå†è©¦ä¸€æ¬¡ã€‚</p>
                        ${suggestions}
                        <div class="mt-4 p-3 bg-white border border-red-200 rounded">
                            <p class="text-xs text-gray-600">æŠ€è¡“è©³æƒ…ï¼š${error.stack ? error.stack.substring(0, 200) + '...' : 'ç„¡å †ç–Šè¿½è¹¤ä¿¡æ¯'}</p>
                        </div>
                    </div>
                `;
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = `é‡æ–°ç”Ÿæˆ AI åˆ†æå ±å‘Š`;
            }
        }

        generateBtn.addEventListener('click', handleGenerateClick);

        // ç›£è½è¼¸å‡ºæ ¼å¼é¸æ“‡
        outputFormatInputs.forEach(input => {
            input.addEventListener('change', function() {
                if (this.value === 'slides') {
                    proposalOutput.classList.add('hidden');
                    slidesOutput.classList.remove('hidden');
                    slidesActions.classList.remove('hidden');
                } else {
                    proposalOutput.classList.remove('hidden');
                    slidesOutput.classList.add('hidden');
                    slidesActions.classList.add('hidden');
                }
            });
        });

        // ä¸‹è¼‰ç°¡å ±åŠŸèƒ½
        downloadSlidesBtn.addEventListener('click', function() {
            downloadSlides();
        });

        // åœ¨ Google Slides ä¸­é–‹å•Ÿ
        openSlidesBtn.addEventListener('click', function() {
            openInGoogleSlides();
        });

        let currentSlidesData = null;

        function generateGoogleSlides(context, forumAnalysis, seoAnalysis, kpiEstimation, industrySentiment, budgetFeasibility, multiMarketStrategy, localizationStrategy, competitorAnalysis, marketingCalendar, creativeStrategy) {
            // æ•¸æ“šé©—è­‰å’Œé è¨­å€¼è™•ç†
            const validatedData = {
                forumAnalysis: forumAnalysis || {},
                seoAnalysis: seoAnalysis || {},
                kpiEstimation: kpiEstimation || {},
                industrySentiment: industrySentiment || {},
                budgetFeasibility: budgetFeasibility || {},
                multiMarketStrategy: multiMarketStrategy || {},
                localizationStrategy: localizationStrategy || {},
                competitorAnalysis: competitorAnalysis || {},
                marketingCalendar: marketingCalendar || {},
                creativeStrategy: creativeStrategy || {}
            };

            const slides = [];
            
            // å°é¢é 
            slides.push({
                title: `${context.target} åª’é«”ä¼åŠƒææ¡ˆ`,
                subtitle: `${context.industry} | ${context.targetAudience}`,
                type: 'cover',
                content: {
                    client: context.target,
                    industry: context.industry,
                    targetAudience: context.targetAudience,
                    budget: context.budget.toLocaleString(),
                    date: new Date().toLocaleDateString('zh-TW')
                }
            });

            // ç›®éŒ„é 
            slides.push({
                title: 'å ±å‘Šå¤§ç¶±',
                type: 'toc',
                content: [
                    'å¸‚å ´ç¸½é«”å°è±¡',
                    'ç”¢æ¥­è¼¿æƒ…ç›£æ¸¬',
                    'å¤šå¸‚å ´ç­–ç•¥åˆ†æ',
                    'æ ¸å¿ƒæ´å¯Ÿèˆ‡æ©Ÿæœƒé»',
                    'é ç®—å¯è¡Œæ€§è©•ä¼°',
                    'åˆæ­¥ç­–ç•¥å»ºè­°',
                    'é ç®—è¦åŠƒèˆ‡é æœŸæ•ˆç›Š'
                ]
            });

            // å¸‚å ´ç¸½é«”å°è±¡
            slides.push({
                title: 'å¸‚å ´ç¸½é«”å°è±¡',
                type: 'content',
                content: createSlideContent('market_overview', {
                    target: context.target,
                    targetAudience: context.targetAudience,
                    industry: context.industry,
                    forumAnalysis: validatedData.forumAnalysis
                })
            });

            // ç”¢æ¥­è¼¿æƒ…ç›£æ¸¬
            slides.push({
                title: 'ç”¢æ¥­è¼¿æƒ…ç›£æ¸¬',
                type: 'content',
                content: createSlideContent('industry_sentiment', {
                    industry: context.industry,
                    industrySentiment: validatedData.industrySentiment
                })
            });

            // å¤šå¸‚å ´ç­–ç•¥åˆ†æ
            if (context.targetMarkets !== 'å°ç£') {
                slides.push({
                    title: 'å¤šå¸‚å ´ç­–ç•¥åˆ†æ',
                    type: 'content',
                    content: createSlideContent('multi_market', {
                        targetMarkets: context.targetMarkets,
                        targetLanguages: context.targetLanguages,
                        multiMarketStrategy: validatedData.multiMarketStrategy,
                        localizationStrategy: validatedData.localizationStrategy
                    })
                });
            }

            // æ ¸å¿ƒæ´å¯Ÿèˆ‡æ©Ÿæœƒé»
            slides.push({
                title: 'æ ¸å¿ƒæ´å¯Ÿèˆ‡æ©Ÿæœƒé»',
                type: 'content',
                content: createSlideContent('insights', {
                    forumAnalysis: validatedData.forumAnalysis,
                    seoAnalysis: validatedData.seoAnalysis,
                    industrySentiment: validatedData.industrySentiment
                })
            });

            // é ç®—å¯è¡Œæ€§è©•ä¼°
            slides.push({
                title: 'é ç®—å¯è¡Œæ€§è©•ä¼°',
                type: 'content',
                content: createSlideContent('budget_feasibility', {
                    budget: context.budget,
                    budgetFeasibility: validatedData.budgetFeasibility
                })
            });

            // åˆæ­¥ç­–ç•¥å»ºè­°
            slides.push({
                title: 'åˆæ­¥ç­–ç•¥å»ºè­°',
                type: 'content',
                content: createSlideContent('strategy_recommendations', {
                    context: context,
                    forumAnalysis: validatedData.forumAnalysis,
                    seoAnalysis: validatedData.seoAnalysis
                })
            });

            // é ç®—è¦åŠƒèˆ‡é æœŸæ•ˆç›Š
            slides.push({
                title: 'é ç®—è¦åŠƒèˆ‡é æœŸæ•ˆç›Š',
                type: 'content',
                content: createSlideContent('budget_planning', {
                    budget: context.budget,
                    kpiEstimation: validatedData.kpiEstimation,
                    multiMarketStrategy: validatedData.multiMarketStrategy
                })
            });

            // çµå°¾é 
            slides.push({
                title: 'è¬è¬è†è½',
                subtitle: 'æœ‰ä»»ä½•å•é¡Œæ­¡è¿è¨è«–',
                type: 'ending',
                content: {
                    contact: 'mediaplan@example.com',
                    nextSteps: [
                        'è©³ç´°åŸ·è¡Œè¨ˆç•«è¨è«–',
                        'å‰µæ„æ¦‚å¿µç™¼å±•',
                        'åª’é«”è³¼è²·ç­–ç•¥'
                    ]
                }
            });

            return slides;
        }

        function createSlideContent(type, data) {
            switch(type) {
                case 'market_overview':
                    return {
                        summary: `${data.target} åœ¨ ${data.targetAudience} ä¸­çš„å¸‚å ´å®šä½èˆ‡æŒ‘æˆ°`,
                        keyPoints: [
                            `å“ç‰ŒèªçŸ¥åº¦ï¼š${data.forumAnalysis?.brand_sentiment?.overall_sentiment || 'å¾…è©•ä¼°'}`,
                            `ä¸»è¦æŒ‘æˆ°ï¼š${data.forumAnalysis?.challenges?.main_challenge || 'å¾…åˆ†æ'}`,
                            `å¸‚å ´æ©Ÿæœƒï¼š${data.forumAnalysis?.market_opportunity || 'å¾…ç™¼æ˜'}`
                        ],
                        visualData: data.forumAnalysis?.brand_sentiment
                    };

                case 'industry_sentiment':
                    return {
                        summary: `${data.industry} ç”¢æ¥­æ•´é«”è¼¿æƒ…ç‹€æ³`,
                        keyPoints: [
                            `ç”¢æ¥­ç†±åº¦ï¼š${data.industrySentiment?.industry_overview?.trend || 'ç©©å®š'}`,
                            `ç†±é–€è©±é¡Œï¼š${data.industrySentiment?.hot_topics?.top_topic || 'å¾…åˆ†æ'}`,
                            `æ¶ˆè²»è€…æ…‹åº¦ï¼š${data.industrySentiment?.consumer_insights?.overall_attitude || 'æ­£é¢'}`
                        ],
                        visualData: data.industrySentiment?.sentiment_distribution
                    };

                case 'multi_market':
                    return {
                        summary: `${data.targetMarkets} å¸‚å ´ç­–ç•¥è¦åŠƒ`,
                        keyPoints: [
                            `å¸‚å ´è¦æ¨¡ï¼š${data.multiMarketStrategy?.market_analysis?.market_size || 'å¾…è©•ä¼°'}`,
                            `é ç®—åˆ†é…ï¼š${data.multiMarketStrategy?.budget_allocation?.primary_market || 'å°ç£'} ç‚ºä¸»`,
                            `åœ¨åœ°åŒ–é‡é»ï¼š${data.localizationStrategy?.cultural_adaptation?.key_considerations || 'æ–‡åŒ–é©æ‡‰'}`
                        ],
                        visualData: data.multiMarketStrategy?.budget_allocation
                    };

                case 'insights':
                    return {
                        summary: 'é—œéµæ´å¯Ÿèˆ‡ç­–ç•¥æ©Ÿæœƒé»',
                        keyPoints: [
                            `ç›®æ¨™äººç¾¤å¿ƒè²ï¼š${data.forumAnalysis?.consumer_insights?.key_insight || 'å¾…åˆ†æ'}`,
                            `å…§å®¹ç¼ºå£ï¼š${data.seoAnalysis?.content_gap_opportunity || 'å¾…ç™¼æ˜'}`,
                            `ç”¢æ¥­æ©Ÿæœƒï¼š${data.industrySentiment?.opportunities?.primary_opportunity || 'å¾…è­˜åˆ¥'}`
                        ],
                        visualData: data.forumAnalysis?.sentiment_trends
                    };

                case 'budget_feasibility':
                    return {
                        summary: `é ç®— ${data.budget.toLocaleString()} å¯è¡Œæ€§è©•ä¼°`,
                        keyPoints: [
                            `å¯è¡Œæ€§ï¼š${data.budgetFeasibility?.feasibility_assessment?.level || 'å¾…è©•ä¼°'}`,
                            `æˆåŠŸæ©Ÿç‡ï¼š${data.budgetFeasibility?.success_probability?.percentage || 'å¾…è©•ä¼°'}%`,
                            `é¢¨éšªç­‰ç´šï¼š${data.budgetFeasibility?.risk_analysis?.risk_level || 'å¾…è©•ä¼°'}`
                        ],
                        visualData: data.budgetFeasibility?.budget_recommendations
                    };

                case 'strategy_recommendations':
                    return {
                        summary: 'æ ¸å¿ƒç­–ç•¥å»ºè­°',
                        keyPoints: [
                            `å…§å®¹ç­–ç•¥ï¼š${data.seoAnalysis?.content_strategy?.primary_focus || 'å¾…è¦åŠƒ'}`,
                            `æºé€šè¨Šæ¯ï¼š${data.forumAnalysis?.communication_insights?.key_message || 'å¾…å®šç¾©'}`,
                            `åª’é«”å»ºè­°ï¼š${data.seoAnalysis?.media_recommendations?.primary_channel || 'å¾…é¸æ“‡'}`
                        ],
                        visualData: data.seoAnalysis?.content_gap_analysis
                    };

                case 'budget_planning':
                    return {
                        summary: 'é ç®—åˆ†é…èˆ‡æ•ˆç›Šé ä¼°',
                        keyPoints: [
                            `ç¸½é ç®—ï¼š${data.budget.toLocaleString()} å…ƒ`,
                            `ä¸»è¦æ¸ é“ï¼š${data.kpiEstimation?.budget_allocation?.[0]?.channel || 'å¾…åˆ†é…'}`,
                            `é æœŸæ•ˆç›Šï¼š${data.kpiEstimation?.kpi_estimations?.[0]?.Est_Conversions || data.kpiEstimation?.kpi_estimations?.[0]?.Est_Leads || 'å¾…ä¼°ç®—'}`
                        ],
                        visualData: data.kpiEstimation?.budget_allocation
                    };

                default:
                    return { summary: 'å…§å®¹æº–å‚™ä¸­...', keyPoints: [] };
            }
        }

        function renderSlides(slides) {
            const slidesContainer = document.getElementById('slidesOutput');
            slidesContainer.innerHTML = '';

            slides.forEach((slide, index) => {
                const slideElement = document.createElement('div');
                slideElement.className = 'slide mb-8 bg-white border rounded-lg shadow-lg overflow-hidden';
                slideElement.style.minHeight = '400px';

                let slideHTML = '';
                
                switch(slide.type) {
                    case 'cover':
                        slideHTML = `
                            <div class="bg-gradient-to-br from-blue-600 to-purple-700 text-white p-8 text-center">
                                <h1 class="text-4xl font-bold mb-4">${slide.title}</h1>
                                <p class="text-xl mb-8">${slide.subtitle}</p>
                                <div class="grid grid-cols-2 gap-4 text-left max-w-2xl mx-auto">
                                    <div><strong>å®¢æˆ¶ï¼š</strong>${slide.content.client}</div>
                                    <div><strong>ç”¢æ¥­ï¼š</strong>${slide.content.industry}</div>
                                    <div><strong>ç›®æ¨™äººç¾¤ï¼š</strong>${slide.content.targetAudience}</div>
                                    <div><strong>é ç®—ï¼š</strong>${slide.content.budget} å…ƒ</div>
                                </div>
                                <div class="mt-8 text-sm opacity-75">${slide.content.date}</div>
                            </div>
                        `;
                        break;

                    case 'toc':
                        slideHTML = `
                            <div class="p-8">
                                <h2 class="text-3xl font-bold text-gray-800 mb-6">${slide.title}</h2>
                                <div class="grid grid-cols-1 gap-3">
                                    ${slide.content.map((item, i) => 
                                        '<div class="flex items-center p-3 bg-gray-50 rounded-lg">' +
                                        '<span class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold mr-4">' + (i + 1) + '</span>' +
                                        '<span class="text-lg">' + item + '</span>' +
                                        '</div>'
                                    ).join('')}
                                </div>
                            </div>
                        `;
                        break;

                    case 'content':
                        slideHTML = `
                            <div class="p-8">
                                <h2 class="text-3xl font-bold text-gray-800 mb-6">${slide.title}</h2>
                                <div class="mb-6">
                                    <h3 class="text-xl font-semibold text-gray-700 mb-3">æ‘˜è¦</h3>
                                    <p class="text-gray-600">${slide.content.summary}</p>
                                </div>
                                <div class="mb-6">
                                    <h3 class="text-xl font-semibold text-gray-700 mb-3">é‡é»</h3>
                                    <ul class="space-y-2">
                                        ${slide.content.keyPoints.map(point => 
                                            '<li class="flex items-start">' +
                                            '<span class="text-blue-500 mr-2">â€¢</span>' +
                                            '<span class="text-gray-600">' + point + '</span>' +
                                            '</li>'
                                        ).join('')}
                                    </ul>
                                </div>
                                ${slide.content.visualData ? 
                                    '<div class="mt-6 p-4 bg-gray-50 rounded-lg">' +
                                    '<h4 class="font-semibold text-gray-700 mb-2">æ•¸æ“šåœ–è¡¨</h4>' +
                                    '<p class="text-sm text-gray-500">åœ–è¡¨å°‡åœ¨ Google Slides ä¸­å‘ˆç¾</p>' +
                                    '</div>'
                                : ''}
                            </div>
                        `;
                        break;

                    case 'ending':
                        slideHTML = `
                            <div class="bg-gradient-to-br from-green-600 to-blue-700 text-white p-8 text-center">
                                <h1 class="text-4xl font-bold mb-4">${slide.title}</h1>
                                <p class="text-xl mb-8">${slide.subtitle}</p>
                                <div class="mb-6">
                                    <h3 class="text-xl font-semibold mb-3">å¾ŒçºŒæ­¥é©Ÿ</h3>
                                    <ul class="space-y-2">
                                        ${slide.content.nextSteps.map(step => 
                                            '<li class="flex items-center justify-center">' +
                                            '<span class="text-green-300 mr-2">â†’</span>' +
                                            '<span>' + step + '</span>' +
                                            '</li>'
                                        ).join('')}
                                    </ul>
                                </div>
                                <div class="text-sm opacity-75">è¯çµ¡æˆ‘å€‘ï¼š${slide.content.contact}</div>
                            </div>
                        `;
                        break;
                }

                slideElement.innerHTML = slideHTML;
                slidesContainer.appendChild(slideElement);
            });
        }

        function downloadSlides() {
            if (!currentSlidesData) {
                alert('è«‹å…ˆç”Ÿæˆç°¡å ±å…§å®¹');
                return;
            }
            
            // å‰µå»ºä¸‹è¼‰é¸é …å°è©±æ¡†
            const downloadDialog = document.createElement('div');
            downloadDialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            downloadDialog.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">é¸æ“‡ä¸‹è¼‰æ ¼å¼</h3>
                    <div class="space-y-3">
                        <button id="downloadJson" class="w-full p-3 text-left border rounded-lg hover:bg-blue-50">
                            <div class="font-medium text-blue-600">JSON æ ¼å¼</div>
                            <div class="text-sm text-gray-600">åŸå§‹æ•¸æ“šï¼Œå¯å°å…¥å…¶ä»–å·¥å…·</div>
                        </button>
                        <button id="downloadHtml" class="w-full p-3 text-left border rounded-lg hover:bg-green-50">
                            <div class="font-medium text-green-600">HTML æ ¼å¼</div>
                            <div class="text-sm text-gray-600">å¯ç›´æ¥åœ¨ç€è¦½å™¨ä¸­æŸ¥çœ‹</div>
                        </button>
                        <button id="downloadTxt" class="w-full p-3 text-left border rounded-lg hover:bg-purple-50">
                            <div class="font-medium text-purple-600">ç´”æ–‡å­—æ ¼å¼</div>
                            <div class="text-sm text-gray-600">ç°¡æ½”çš„æ–‡å­—ç‰ˆæœ¬</div>
                        </button>
                    </div>
                    <div class="mt-4 p-3 bg-yellow-50 rounded-lg">
                        <h4 class="font-medium text-yellow-800 mb-2">ä½¿ç”¨èªªæ˜ï¼š</h4>
                        <ul class="text-sm text-yellow-700 space-y-1">
                            <li>â€¢ <strong>JSON æ ¼å¼ï¼š</strong>åŒ…å«å®Œæ•´æ•¸æ“šçµæ§‹ï¼Œå¯ç”¨æ–¼æ•¸æ“šåˆ†ææˆ–å°å…¥å…¶ä»–ç³»çµ±</li>
                            <li>â€¢ <strong>HTML æ ¼å¼ï¼š</strong>å¯ç›´æ¥åœ¨ç€è¦½å™¨ä¸­æ‰“é–‹æŸ¥çœ‹ï¼Œæ”¯æ´åˆ—å°</li>
                            <li>â€¢ <strong>ç´”æ–‡å­—æ ¼å¼ï¼š</strong>ç°¡æ½”æ˜“è®€ï¼Œé©åˆå¿«é€Ÿç€è¦½æˆ–è¤‡è£½è²¼ä¸Š</li>
                        </ul>
                    </div>
                    <button id="cancelDownload" class="mt-4 w-full p-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                        å–æ¶ˆ
                    </button>
                </div>
            `;
            
            document.body.appendChild(downloadDialog);
            
            // ç¶å®šäº‹ä»¶
            document.getElementById('downloadJson').addEventListener('click', () => {
                downloadSlidesAsJson();
                document.body.removeChild(downloadDialog);
            });
            
            document.getElementById('downloadHtml').addEventListener('click', () => {
                downloadSlidesAsHtml();
                document.body.removeChild(downloadDialog);
            });
            
            document.getElementById('downloadTxt').addEventListener('click', () => {
                downloadSlidesAsText();
                document.body.removeChild(downloadDialog);
            });
            
            document.getElementById('cancelDownload').addEventListener('click', () => {
                document.body.removeChild(downloadDialog);
            });
        }
        
        function downloadSlidesAsJson() {
            const slidesText = JSON.stringify(currentSlidesData, null, 2);
            const blob = new Blob([slidesText], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentSlidesData[0]?.content?.client || 'mediaplan'}_slides.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // é¡¯ç¤ºä½¿ç”¨èªªæ˜
            setTimeout(() => {
                alert('JSON æ–‡ä»¶ä¸‹è¼‰å®Œæˆï¼\n\nä½¿ç”¨æ–¹å¼ï¼š\n1. æ­¤æ–‡ä»¶åŒ…å«å®Œæ•´çš„ç°¡å ±æ•¸æ“šçµæ§‹\n2. å¯ç”¨æ–¼æ•¸æ“šåˆ†ææˆ–å°å…¥å…¶ä»–ç³»çµ±\n3. å¦‚éœ€è½‰æ›ç‚º Google Slidesï¼Œè«‹ä½¿ç”¨ Google Slides API æˆ–æ‰‹å‹•å‰µå»º');
            }, 100);
        }
        
        function downloadSlidesAsHtml() {
            let htmlContent = `
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${currentSlidesData[0]?.content?.client || 'Mediaplan'} åª’é«”ä¼åŠƒææ¡ˆ</title>
    <style>
        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .slide { background: white; margin: 20px 0; padding: 40px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .cover { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center; }
        .ending { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; text-align: center; }
        h1 { font-size: 2.5em; margin-bottom: 20px; }
        h2 { font-size: 2em; color: #333; margin-bottom: 15px; }
        h3 { font-size: 1.5em; color: #555; margin-bottom: 10px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .toc-item { background: #f8f9fa; padding: 15px; border-radius: 8px; display: flex; align-items: center; }
        .toc-number { background: #007bff; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; }
        ul { padding-left: 20px; }
        li { margin: 8px 0; }
        @media print { body { background: white; } .slide { box-shadow: none; margin: 10px 0; } }
    </style>
</head>
<body>
`;
            
            currentSlidesData.forEach((slide, index) => {
                switch(slide.type) {
                    case 'cover':
                        htmlContent += `
<div class="slide cover">
    <h1>${slide.title}</h1>
    <p style="font-size: 1.3em; margin-bottom: 30px;">${slide.subtitle}</p>
    <div class="grid">
        <div><strong>å®¢æˆ¶ï¼š</strong>${slide.content.client}</div>
        <div><strong>ç”¢æ¥­ï¼š</strong>${slide.content.industry}</div>
        <div><strong>ç›®æ¨™äººç¾¤ï¼š</strong>${slide.content.targetAudience}</div>
        <div><strong>é ç®—ï¼š</strong>${slide.content.budget} å…ƒ</div>
    </div>
    <div style="margin-top: 30px; opacity: 0.8;">${slide.content.date}</div>
</div>`;
                        break;
                        
                    case 'toc':
                        htmlContent += `
<div class="slide">
    <h2>${slide.title}</h2>
    <div>
        ${slide.content.map((item, i) => 
            `<div class="toc-item">
                <div class="toc-number">${i + 1}</div>
                <span style="font-size: 1.1em;">${item}</span>
            </div>`
        ).join('')}
    </div>
</div>`;
                        break;
                        
                    case 'content':
                        htmlContent += `
<div class="slide">
    <h2>${slide.title}</h2>
    <div style="margin-bottom: 20px;">
        <h3>æ‘˜è¦</h3>
        <p>${slide.content.summary}</p>
    </div>
    <div>
        <h3>é‡é»</h3>
        <ul>
            ${slide.content.keyPoints.map(point => `<li>${point}</li>`).join('')}
        </ul>
    </div>
</div>`;
                        break;
                        
                    case 'ending':
                        htmlContent += `
<div class="slide ending">
    <h1>${slide.title}</h1>
    <p style="font-size: 1.3em; margin-bottom: 30px;">${slide.subtitle}</p>
    <div style="margin-bottom: 20px;">
        <h3>å¾ŒçºŒæ­¥é©Ÿ</h3>
        <ul style="list-style: none; padding: 0;">
            ${slide.content.nextSteps.map(step => 
                `<li style="margin: 10px 0; display: flex; align-items: center; justify-content: center;">
                    <span style="margin-right: 10px;">â†’</span>
                    <span>${step}</span>
                </li>`
            ).join('')}
        </ul>
    </div>
    <div style="opacity: 0.8;">è¯çµ¡æˆ‘å€‘ï¼š${slide.content.contact}</div>
</div>`;
                        break;
                }
            });
            
            htmlContent += `
</body>
</html>`;
            
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentSlidesData[0]?.content?.client || 'mediaplan'}_slides.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            setTimeout(() => {
                alert('HTML æ–‡ä»¶ä¸‹è¼‰å®Œæˆï¼\n\nä½¿ç”¨æ–¹å¼ï¼š\n1. é›™æ“Šæ–‡ä»¶å¯åœ¨ç€è¦½å™¨ä¸­æ‰“é–‹\n2. æ”¯æ´åˆ—å°åŠŸèƒ½ (Ctrl+P)\n3. å¯å¦å­˜ç‚º PDF æ ¼å¼');
            }, 100);
        }
        
        function downloadSlidesAsText() {
            let textContent = `${currentSlidesData[0]?.content?.client || 'Mediaplan'} åª’é«”ä¼åŠƒææ¡ˆ\n`;
            textContent += `ç”Ÿæˆæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}\n`;
            textContent += '='.repeat(50) + '\n\n';
            
            currentSlidesData.forEach((slide, index) => {
                textContent += `ã€ç¬¬ ${index + 1} é ã€‘${slide.title}\n`;
                textContent += '-'.repeat(30) + '\n';
                
                switch(slide.type) {
                    case 'cover':
                        textContent += `å®¢æˆ¶ï¼š${slide.content.client}\n`;
                        textContent += `ç”¢æ¥­ï¼š${slide.content.industry}\n`;
                        textContent += `ç›®æ¨™äººç¾¤ï¼š${slide.content.targetAudience}\n`;
                        textContent += `é ç®—ï¼š${slide.content.budget} å…ƒ\n`;
                        textContent += `æ—¥æœŸï¼š${slide.content.date}\n`;
                        break;
                        
                    case 'toc':
                        textContent += 'å ±å‘Šå¤§ç¶±ï¼š\n';
                        slide.content.forEach((item, i) => {
                            textContent += `${i + 1}. ${item}\n`;
                        });
                        break;
                        
                    case 'content':
                        textContent += `æ‘˜è¦ï¼š${slide.content.summary}\n\n`;
                        textContent += 'é‡é»ï¼š\n';
                        slide.content.keyPoints.forEach((point, i) => {
                            textContent += `${i + 1}. ${point}\n`;
                        });
                        break;
                        
                    case 'ending':
                        textContent += 'å¾ŒçºŒæ­¥é©Ÿï¼š\n';
                        slide.content.nextSteps.forEach((step, i) => {
                            textContent += `${i + 1}. ${step}\n`;
                        });
                        textContent += `\nè¯çµ¡æˆ‘å€‘ï¼š${slide.content.contact}\n`;
                        break;
                }
                
                textContent += '\n' + '='.repeat(50) + '\n\n';
            });
            
            const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentSlidesData[0]?.content?.client || 'mediaplan'}_slides.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            setTimeout(() => {
                alert('ç´”æ–‡å­—æ–‡ä»¶ä¸‹è¼‰å®Œæˆï¼\n\nä½¿ç”¨æ–¹å¼ï¼š\n1. å¯ç”¨ä»»ä½•æ–‡å­—ç·¨è¼¯å™¨æ‰“é–‹\n2. é©åˆå¿«é€Ÿç€è¦½å’Œè¤‡è£½è²¼ä¸Š\n3. æª”æ¡ˆå¤§å°æœ€å°ï¼Œå‚³è¼¸æ–¹ä¾¿');
            }, 100);
        }

        function openInGoogleSlides() {
            if (!currentSlidesData) return;
            
            // é€™è£¡å¯ä»¥æ•´åˆ Google Slides API ä¾†å¯¦éš›å‰µå»ºç°¡å ±
            // ç›®å‰æä¾›ä¸‹è¼‰ JSON æ ¼å¼ï¼Œå¯ä»¥æ‰‹å‹•å°å…¥åˆ° Google Slides
            alert('Google Slides æ•´åˆåŠŸèƒ½é–‹ç™¼ä¸­ã€‚ç›®å‰è«‹ä½¿ç”¨ä¸‹è¼‰åŠŸèƒ½ï¼Œç„¶å¾Œæ‰‹å‹•å°å…¥åˆ° Google Slidesã€‚');
        }

        // ç›£è½ AI å»ºè­°åª’é«”é¸æ“‡
        aiRecommendMediaInput.addEventListener('change', function() {
            const mediaCheckboxes = mediaSelectionDiv.querySelectorAll('input[type="checkbox"]');
            mediaCheckboxes.forEach(checkbox => {
                checkbox.disabled = this.checked;
                if (this.checked) {
                    checkbox.checked = false;
                }
            });
        });

        // ç›£è½åª’é«”é¸æ“‡
        mediaSelectionDiv.addEventListener('change', function(e) {
            if (e.target.type === 'checkbox' && e.target.checked) {
                aiRecommendMediaInput.checked = false;
                const mediaCheckboxes = mediaSelectionDiv.querySelectorAll('input[type="checkbox"]');
                mediaCheckboxes.forEach(checkbox => {
                    checkbox.disabled = false;
                });
            }
        });

        // åˆå§‹åŒ–ç¶²è·¯ç‹€æ…‹ç›£è½å™¨
        initializeNetworkMonitoring();
    </script>
</body>
</html>


